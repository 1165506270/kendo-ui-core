<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5" DefaultTargets="DeployCDN">
    <Import Project="Config.proj" />
    <Import Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\TeamBuild\Microsoft.TeamFoundation.Build.targets" />

    <UsingTask TaskName="Telerik.MSBuildTasks.GenerateVersionDependentSuffix" AssemblyFile="MSBuildTasks\Telerik.MSBuildTasks.dll"/>
    <UsingTask TaskName="UploadResources" AssemblyFile="MSBuildTasks\ResourceUploader.MSBuildTasks.dll" />

    <PropertyGroup>
        <BundleRoot>$(ResourcesRoot)\kendoui.web-dataviz.open-source</BundleRoot>
        <BundleScripts>$(BundleRoot)\js</BundleScripts>
        <BundleStyles>$(BundleRoot)\styles</BundleStyles>
        <ExamplesRoot>$(ResourcesRoot)\online-examples</ExamplesRoot>
        <ExamplesScripts>$(ExamplesRoot)\shared\js</ExamplesScripts>
        <ExamplesStyles>$(ExamplesRoot)\shared\styles</ExamplesStyles>
    </PropertyGroup>

    <ItemGroup>
        <CDNTargets Include="$(BundleRoot)\js">
            <DestinationPath>/js</DestinationPath>
        </CDNTargets>
        <CDNTargets Include="$(BundleRoot)\styles">
            <DestinationPath>/styles</DestinationPath>
        </CDNTargets>
    </ItemGroup>

    <Target Name="DeployCDN">
        <BuildStep TeamFoundationServerUrl="$(TeamFoundationServerUrl)" BuildUri="$(BuildUri)" Name="DeployCDNStep" Message="Deploying CDN resources">
            <Output TaskParameter="Id" PropertyName="StepId" />
        </BuildStep>

        <GenerateVersionDependentSuffix ReleaseYear="$(Year)" ReleaseQ="$(Release)" Separator=".">
            <Output TaskParameter="Suffix" PropertyName="DateSuffixDots" />
        </GenerateVersionDependentSuffix>

        <UploadResources
            SourcePath="%(CDNTargets)" AccessKeyID="$(CDNAccessKeyId)" SecretAccessKey="$(CDNSecretAccessKey)"
            BucketName="$(CDNBucketName)" DestinationPath="$(DateSuffixDots)%(CDNTargets.DestinationPath)" Compress="True" />

        <UploadResources
            SourcePath="$(ExamplesScripts)" AccessKeyID="$(CDNAccessKeyId)" SecretAccessKey="$(CDNSecretAccessKey)"
            BucketName="$(CDNBucketName)" DestinationPath="$(DateSuffixDots)/examples/shared/js" Compress="True" />

        <UploadResources
            SourcePath="$(ExamplesStyles)" AccessKeyID="$(CDNAccessKeyId)" SecretAccessKey="$(CDNSecretAccessKey)"
            BucketName="$(CDNBucketName)" DestinationPath="$(DateSuffixDots)/examples/shared/styles" Compress="True" />

        <BuildStep  TeamFoundationServerUrl="$(TeamFoundationServerUrl)" BuildUri="$(BuildUri)"
            Id="$(StepId)"
            Status="Succeeded" />

        <OnError ExecuteTargets="MarkBuildStepAsFailed" />
    </Target>

    <Target Name="MarkBuildStepAsFailed">
        <BuildStep
            TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
            BuildUri="$(BuildUri)"
            Id="$(StepId)"
            Status="Failed" />
    </Target>
</Project>
