#!/usr/bin/env bash

export NODE_PATH=.:/usr/lib/node_modules


jake merge-scripts

source build/temp-browser-profiles.sh

tests/tests.js tests/ 8887 1>test-results.xml || exit 1

# Update docs submodule
sh -c 'cd docs && git fetch && git reset --hard origin/production'

# Check the generated VSDoc
jake vsdoc > /tmp/vsdoc-production.js && /usr/lib/node_modules/jshint/bin/hint /tmp/vsdoc-production.js || exit 1

rm -f release/*zip

jake demos:staging && rsync -avc deploy/staging/ /var/www/production/

jake bundles && cp deploy/kendoui.aspnetmvc.commercial/changelog.html /var/www/changelog/index.html

jake demos:pack-production

cp -rf release/*zip deploy/online-examples.zip /kendo-builds/Production

jake winjs && cp -R release/winjs/* /kendo-builds/WinJS/Production/

find /kendo-builds/Production/* -mtime +2 -exec rm {} \; ; rm -rf release/*
