<!DOCTYPE html>
<html>
    <head>
        <title>Bar Chart</title>
        <script src="../src/jquery.js"></script>
        <script src="../src/kendo.core.js"></script>
        <script src="../src/kendo.data.js"></script>
        <script src="../src/kendo.dataviz.core.js"></script>
        <script src="../src/kendo.dataviz.chart.js"></script>
        <script src="../src/kendo.dataviz.themes.js"></script>
        <script src="../src/kendo.dataviz.vml.js"></script>
        <script src="../src/kendo.dataviz.svg.js"></script>
        <script src="../src/kendo.userevents.js"></script>
        <script src="../src/kendo.draganddrop.js"></script>
        <script src="../src/kendo.slider.js"></script>
        <link href="../styles/web/kendo.common.css" rel="stylesheet" />
        <link href="http://mvc-kendobuild/staging/content/cdn/styles/kendo.default.min.css" rel="stylesheet" />
        <style>
            .k-label { display: none; }

            .wrapper {
                position: absolute;
            }

            .selection {
                border: 1px solid #d2d2d2;
                border-bottom: 0;
                position: absolute;
            }

            .handle {
                background: #d2d2d2;
                width: 7px;
                height: 40px;
                cursor: e-resize;
                z-index: 1;
                -moz-border-radius: 4px;
                -webkit-border-radius: 4px;
                border-radius: 4px;
                position: absolute;
                margin-left: -3px;
            }

            .mask {
                background: white;
                opacity: 0.7;
                position: absolute;
            }

        </style>
    </head>
    <body>
        <div id="chart" style="width: 900px; height: 400px;"></div>
        <div id="rangeslider" style="width: 845px; margin-left: 50px;">
            <input />
            <input />
        </div>
        <div id="scatterChart"></div>
        <div class="wrapper">
            <div class="mask"></div>
            <div class="selection"></div>
            <div class="handle leftHandle"></div>
            <div class="handle rightHandle"></div>
            <div class="mask"></div>
        </div>
        <script>
            var updateCount = 0;
            var navigatorDataSource;
            var salesData = [];
            var startDate = new Date("2007/06/01");

            $(function() {
                function generate() {
                    var date = startDate;
                    var endDate = new Date("2012/06/01");

                    while (date <= endDate) {
                        var open = Math.random() * 100;
                        var close = open + (Math.random() * 100 * (Math.random() > 0.5 ? 1 : -1));
                        var high = open + 100;
                        var low = open - 100;
                        salesData.push({
                            date: date,
                            open: open,
                            high: high,
                            low: low,
                            close: close,
                            sales: date.getYear() * 100 + Math.random() * 1000
                        });

                        date = kendo.dataviz.addDuration(date, 1, "days");
                    }

                    return salesData;
                }

                var data = generate(),
                navigatorDataSource = new kendo.data.DataSource({
                    data: data
                });

                navigatorDataSource.read();

                $("#chart").kendoChart({
                    dataSource: {
                        data: data
                    },
                    panes: [{
                        name: "top"
                    }, {
                        name: "bottom",
                        height: 80
                    }],
                    valueAxes: [{
                        name: "topValueAxis",
                        line: {
                            visible: false
                        }
                    }, {
                        name: "bottomValueAxis",
                        pane: "bottom",
                        majorGridLines: {
                            visible: false
                        },
                        visible: false
                    }],
                    categoryAxes: [{
                        type: "date",
                        field: "date",
                        baseUnit: "fit",
                        maxDateGroups: 20,
                        justified: true,
                        min: startDate,
                        max: kendo.dataviz.addDuration(startDate, 1, "years")
                    }, {
                        field: "date",
                        baseUnit: "fit",
                        maxDateGroups: 200,
                        baseUnitStep: "auto",
                        justified: true,
                        name: "bottomCategoryAxis",
                        pane: "bottom",
                        labels: { visible: false },
                        majorTicks: { visible: false }
                    }, {
                        field: "date",
                        baseUnit: "years",
                        maxDateGroups: 20,
                        baseUnitStep: "auto",
                        justified: true,
                        pane: "bottom",
                        _exact: true
                    }, {
                        name: "kur",
                        field: "date",
                        baseUnit: "months",
                        baseUnitStep: 1,
                        justified: true,
                        pane: "bottom",
                        _exact: true,
                        labels: { visible: false, mirror: true }
                    }],
                    series: [{
                        type: "line",
                        field: "sales",
                        axis: "topValueAxis",
                        width: 1
                    }, {
                        type: "area",
                        axis: "bottomValueAxis",
                        categoryAxis: "bottomCategoryAxis",
                        field: "sales",
                        markers: {
                            visible: false
                        },
                        tooltip: {
                            visible: true,
                            template: "#= kendo.toString(category, 'd') #"
                        },
                        width: 1
                    }],
                    legend: {
                        visible: false
                    },
                    transitions: false
                });

                function sliderChange(e) {
                    var chart = $("#chart").data("kendoChart");
                    var detailAxis = chart.options.categoryAxes[0];
                    detailAxis.min = kendo.dataviz.addDuration(
                        startDate,
                        e.values[0] * 12,
                        "months"
                    );

                    detailAxis.max = kendo.dataviz.addDuration(
                        startDate,
                        e.values[1] * 12,
                        "months"
                    );

                    chart.refresh();
                }

                $("#rangeslider").kendoRangeSlider({
                    change: sliderChange,
                    min: 0,
                    max: 20,
                    smallStep: 1,
                    largeStep: 5,
                    selectionStart: 1,
                    selectionEnd: 2,
                    tooltip: {
                        template: "#= formatTooltip(selectionStart, selectionEnd) #"
                    }
                });

                // Navigator

                // Insert navigator in the chart
                $("#chart").append($(".wrapper"));

                // Chart
                var chart = $("#chart").data("kendoChart");
                // Set size to the navigator
                var plotArea = chart._plotArea,
                    pane = plotArea.panes[1],
                    categoryAxis = pane.axes[0],
                    valueAxis = pane.axes[3],
                    width = categoryAxis.box.width(),
                    height = valueAxis.box.height(),
                    wrapper = $(".wrapper");

                wrapper
                    .width(width)
                    .height(height)
                    .css("left", categoryAxis.box.x1)
                    .css("top", valueAxis.box.y1);

                var selection = wrapper.find(".selection").width(0);

                selection.height(height);
                selection.height(height - (selection.outerHeight() - selection.height()));
                var borderWidth = selection.outerWidth() - selection.width(),
                    masks = wrapper.find(".mask"),
                    leftMask = masks.first().height(height),
                    rightMask = masks.last().height(height),
                    leftHandle = wrapper.find(".leftHandle"),
                    rightHandle = wrapper.find(".rightHandle");

                rightMask.width(width - borderWidth);
                rightMask.css("left", borderWidth);
                leftMask.width(0);

                leftHandle.css("left", leftMask.width());
                rightHandle.css("left", leftMask.width() + selection.width() + borderWidth / 2);
                leftHandle.css("top", (wrapper.height() - leftHandle.height()) / 2);
                rightHandle.css("top", (wrapper.height() - rightHandle.height()) / 2);

                var leftHandleDraggable = new DragHandleDrag(leftHandle, { isFirst: true, borderWidth: borderWidth });

                var rightHandleDraggable = new DragHandleDrag(rightHandle, { isFirst: false, borderWidth: borderWidth });

                var selectionDraggable = new SelectionDrag(wrapper, leftHandle, rightHandle);
            });


            function DragHandleDrag(dragHandle, options) {
                var that = this,
                    wrapper = dragHandle.closest(".wrapper"),
                    masks = wrapper.find(".mask");
                that.dragHandle = dragHandle;

                that.options = options;

                that.wrapperWidth = wrapper.width();
                that.leftMask = masks.first();
                that.rightMask = masks.last();
                that.selection = wrapper.find(".selection");

                that.draggable = new kendo.ui.Draggable(dragHandle, {
                    dragend: $.proxy(that.dragEnd, that),
                    drag: $.proxy(that.drag, that),
                    dragstart: $.proxy(that.dragStart, that)
                })
            }

            DragHandleDrag.prototype = {
                dragStart: function(e) {
                    var that = this;
                    that.currentLocation = parseFloat(that.dragHandle.css("left"));
                    that.dragHandle.css("cursor", "default");
                },
                drag: function(e) {
                    var that = this,
                        options = that.options,
                        borderWidth = options.borderWidth,
                        distance = Math.min(Math.max(that.currentLocation + (e.x.location - e.x.startLocation), borderWidth), that.wrapperWidth);

                    if (options.isFirst) {
                        if (distance > that.wrapperWidth - that.rightMask.width() - borderWidth) {
                            distance = that.wrapperWidth - that.rightMask.width() - borderWidth;
                        }
                        that.leftMask.width(distance);
                    } else {
                        if (distance < that.leftMask.width() + borderWidth) {
                            distance = that.leftMask.width() + borderWidth;
                        }
                        that.rightMask.width(that.wrapperWidth - distance);
                        that.rightMask.css("left", distance);
                        if (distance > 0) {
                            distance -= borderWidth / 2;
                        }
                    }

                    that.selection.css("left", that.leftMask.width());
                    that.selection.width(that.wrapperWidth - that.rightMask.width() - that.leftMask.width() - borderWidth);

                    that.dragHandle.css("left", distance);
                },
                dragEnd: function() {
                    var that = this;
                    that.dragHandle.css("cursor", "e-resize");
                    console.log("drag end");
                }
            };

            function SelectionDrag(wrapper, leftHandle, rightHandle) {
                var that = this,
                    wrapper = wrapper,
                    masks = wrapper.find(".mask");

                that.wrapperWidth = wrapper.width();
                that.leftMask = masks.first();
                that.rightMask = masks.last();
                that.selection = wrapper.find(".selection");
                that.leftHandle = leftHandle;
                that.rightHandle = rightHandle;

                that.draggable = new kendo.ui.Draggable(that.selection, {
                    dragend: $.proxy(that.dragEnd, that),
                    drag: $.proxy(that.drag, that),
                    dragstart: $.proxy(that.dragStart, that)
                })
            }

            SelectionDrag.prototype = {
                dragStart: function(e) {
                    var that = this;
                    that.currentLocation = parseFloat(that.dragHandle.css("left"));
                    that.dragHandle.css("cursor", "default");
                },

                drag: function(e) {
                    var that = this,
                        options = that.options,
                        borderWidth = options.borderWidth,
                        distance = Math.min(Math.max(that.currentLocation + (e.x.location - e.x.startLocation), borderWidth), that.wrapperWidth);

                    if (options.isFirst) {
                        if (distance > that.wrapperWidth - that.rightMask.width() - borderWidth) {
                            distance = that.wrapperWidth - that.rightMask.width() - borderWidth;
                        }
                        that.leftMask.width(distance);
                    } else {
                        if (distance < that.leftMask.width() + borderWidth) {
                            distance = that.leftMask.width() + borderWidth;
                        }
                        that.rightMask.width(that.wrapperWidth - distance);
                        that.rightMask.css("left", distance);
                        if (distance > 0) {
                            distance -= borderWidth / 2;
                        }
                    }

                    that.selection.css("left", that.leftMask.width());
                    that.selection.width(that.wrapperWidth - that.rightMask.width() - that.leftMask.width() - borderWidth);

                    that.dragHandle.css("left", distance);
                },

                dragEnd: function() {
                    var that = this;
                    that.dragHandle.css("cursor", "e-resize");
                    console.log("drag end");
                }
            };

            function formatTooltip(from, to) {
                var min = kendo.dataviz.addDuration(
                    startDate,
                    from * 12,
                    "months"
                );

                var max = kendo.dataviz.addDuration(
                    startDate,
                    to * 12,
                    "months"
                );

                return kendo.toString(min, "d") + " " + kendo.toString(max, "d");
            }
        </script>
    </body>
</html>

