#!upstart
description "node.js server for the <%= @app[:name] %> application"
author      "Kendo UI Team"

start on startup
stop on shutdown

env APPLICATION_DIRECTORY="/var/www/<%= @app[:name] %>-staging"
env LOG="/var/log/<%= @app[:name] %>-staging.sys.log"
env NODE_ENV="production"
env NODE_PATH="/usr/lib/node_modules"
env APIKEY="zqFMFiXOMLAxq9Or"
env EDITORIGIN="http://kendobuild.telerik.com/dojo-staging"
env RUNORIGIN="http://kendobuild/dojo-runner-staging"
env PORT="<%= @app[:port] %>"
env RUNNER="<%= @app[:name] == 'dojo-runner' ? 'true' : 'false' %>"
env PIDFILE="/var/run/<%= @app[:name] %>.pid"

script
    export HOME="/root"

    echo $$ > $PIDFILE

    exec /usr/bin/supervisor --poll-interval 3000 -- $APPLICATION_DIRECTORY/app.js >> $LOG
end script

pre-start script
    echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Starting" >> $LOG
end script

pre-stop script
    echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Stopping" >> $LOG
    rm $PIDFILE
end script
