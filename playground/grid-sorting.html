<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <script src="../src/jquery.js"></script>
        <script src="../src/kendo.core.js"></script>
        <script src="../src/kendo.data.js"></script>
        <script src="../src/kendo.grid.js"></script>
        <style>
            table {
                border: 1px solid black;
                border-collapse: collapse;
                width: 100%;
                table-layout: fixed;
            }

            td, th {
                border: 1px solid black;
                height: 22px;
            }

            th {
                background: magenta;
            }

            .grid {
                width: 700px;
            }

            .grid-header {
                padding-right: 100px;
                background: magenta;
            }

            .grid-data {
                overflow: hidden;
            }

            .grid-content {
                position: relative;
                padding-right: 100px;
                overflow: hidden;
            }

            .grid-scroller {
                overflow-y: scroll;
                overflow-x: hidden;
                position: absolute;
                right:0;
                top:0;
                height: 100%;
            }
            .grid-scroller div div
            {
                border-top: 1px solid black;
                height: 24px;
            }

            fieldset {
                float:right;
                width: 300px;
            }

            dt {
                margin-right: 10px;
                float:left;
            }

            dt:after {
                content: ":";
            }
        </style>
    </head>
    <body>
        <fieldset>
            <legend>stats</legend>
            <dl>
                <dt>pageSize</dt>
                <dd id="pageSize"></dd>
            </dl>
            <dl>
                <dt>scrollTop</dt>
                <dd id="scrollTop"></dd>
            </dl>
            <dl>
                <dt>totalHeight</dt>
                <dd id="totalHeight"></dd>
            </dl>
            <dl>
                <dt>scrollHeight</dt>
                <dd id="scrollHeight"></dd>
            </dl>
            <dl>
                <dt>rowHeight</dt>
                <dd id="rowHeight"></dd>
            </dl>
            <dl>
                <dt>page</dt>
                <dd id="page"></dd>
            </dl>
            <dl>
                <dt>skip</dt>
                <dd id="skip"></dd>
            </dl>
            <dl>
                <dt>rowsPerPage</dt>
                <dd id="rowsPerPage"></dd>
            </dl>
            <dl>
                <dt>totalRows</dt>
                <dd id="totalRows"></dd>
            </dl>
            <dl>
                <dt>rows</dt>
                <dd id="rows"></dd>
            </dl>
            <dl>
                <dt>firstRowIndex</dt>
                <dd id="firstRowIndex"></dd>
            </dl>
            <dl>
                <dt>lastRowIndex</dt>
                <dd id="lastRowIndex"></dd>
            </dl>
            <dl>
                <dt>firstTableRowIndex</dt>
                <dd id="firstTableRowIndex"></dd>
            </dl>
            <dl>
                <dt>lastTableRowIndex</dt>
                <dd id="lastTableRowIndex"></dd>
            </dl>
            <dl>
                <dt>last</dt>
                <dd id="last"></dd>
            </dl>
        </fieldset>
        <div class="grid">
            <div class="grid-header">
                <table>
                    <thead>
                        <tr>
                            <th data-field="OrderID">
                                OrderID
                            </th>
                            <th data-field="ContactName">
                                ContactName
                            </th>
                            <th data-field="ShipAddress">
                                ShipAddress
                            </th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="grid-content">
                <div class="grid-data">
                    <table id="grid">
                        <thead>
                            <tr>
                                <th data-field="OrderID">
                                    OrderID
                                </th>
                                <th data-field="ContactName">
                                    ContactName
                                </th>
                                <th data-field="ShipAddress">
                                    ShipAddress
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="grid-scroller">
                </div>
            </div>
        </div>
        <script>
            var dataSource = new kendo.data.DataSource({
                serverPaging: true,
                transport: {
                    read: function(options) {
                        var take = options.data.take,
                            skip = options.data.skip;

                        var data = [];

                        for (var i = skip; i < skip + take; i++) {
                            data.push({ OrderID: i, ContactName: "Contact " + i, ShipAddress: "Ship Address " + i });
                        }

                        options.success(data);
                    }
                } ,
                schema: {
                    data: function(data) {
                        return data;
                    },
                    total: function() {
                        return 1000000;
                    }
                },
                pageSize: 16
            });

            $("table#grid").kendoGrid({
                dataSource: dataSource
            }).find("thead").remove();

            var rowHeight = $("table#grid td:first")[0].offsetHeight;
            var visibleHeight = 300;

            $(".grid-data, .grid-scroller").height(Math.min(visibleHeight, dataSource.pageSize() * rowHeight));

            var totalHeight = dataSource.total() * rowHeight;
            var sliceHeight = 250000;

            for (var i = 0; i < Math.floor(totalHeight / sliceHeight); i++) {
                $("<div />").height(sliceHeight).width(50).appendTo($(".grid-scroller"));
            }

            if (totalHeight % sliceHeight) {
                $("<div />").height(totalHeight % sliceHeight).width(50).appendTo($(".grid-scroller"));
            }

            var rowsPerPage = $(".grid-data").outerHeight() / rowHeight;

            var firstRowIndex;
            var firstTableRowIndex = 0;
            var lastTableRowIndex = 0;
            var lastRowIndex;
            var skip = 0;
            var last;
            var first;
            var scroll = 0;
            var timeout;
            var take = dataSource.pageSize();
            var scrollTop = 0;
            var table = $("#grid")[0];
            var tableParent = table.parentNode;


            $(".grid-scroller").bind("scroll", function(e) {
               // clearTimeout(timeout);
               // timeout = setTimeout($.proxy(function() {
                    var scrollTop = this.scrollTop;// * scale;
                    firstRowIndex = Math.floor(scrollTop / rowHeight);
                    lastRowIndex = Math.floor((scrollTop + take * rowHeight) / rowHeight);

                    skip = first = dataSource._skip || 0;

                    last = first + take;

                    if (firstRowIndex < first) {
                        skip = Math.max(0, lastRowIndex - take);

                        dataSource.range(skip, take);

                        tableParent.scrollTop = 0;
                    } else if (lastRowIndex > last) {
                        skip = firstRowIndex;

                        dataSource.range(skip, take);

                        tableParent.scrollTop = rowHeight;
                    } else {
                        scroll = scrollTop - (skip * rowHeight);
                        tableParent.scrollTop = scroll;
                    }

                    log();
               // }, this), 0);
            });

            function log() {
                $("#pageSize").text(dataSource.pageSize());
                $("#scrollTop").text($(".grid-scroller")[0].scrollTop);
                $("#rowHeight").text(rowHeight);
                $("#totalHeight").text(totalHeight);
                $("#skip").text(skip);
                $("#rowsPerPage").text(rowsPerPage);
                $("#totalRows").text($("#grid tbody tr").length);
                $("#lastRowIndex").text(lastRowIndex);
                $("#firstRowIndex").text(firstRowIndex);
                $("#firstTableRowIndex").text(firstTableRowIndex);
                $("#lastTableRowIndex").text(lastTableRowIndex);
                $("#last").text(last);
                $("#rows").text($(".grid-data tr").length);
            }

            log();

            </script>
        </body>
    </html>
