<!doctype html>
<html>
    <head>
        <script src="mithril.js"></script>
        <script src="http://fb.me/react-0.8.0.js"></script>
        <script src="../src/jquery.js"></script>
        <script src="../src/kendo.core.js"></script>
        <script src="../src/kendo.dom.js"></script>
        <script src="../src/kendo.data.js"></script>
        <script src="../src/kendo.data.odata.js"></script>
        <script src="../src/kendo.grid.js"></script>
        <link rel="stylesheet" href="../dist/styles/web/kendo.common.min.css">
        <link rel="stylesheet" href="../dist/styles/web/kendo.default.min.css">
        <style>
            fieldset {
                width: 400px;
                float:left;
            }
        </style>
    </head>
    <body>
        <button>shuffle columns</button>

        <fieldset>
            <legend>Mithril</legend>
            <div id="m-grid" class="k-grid k-widget"></div>
        </fieldset>

        <fieldset>
            <legend>ReactJS</legend>
            <div id="r-grid" class="k-grid k-widget"></div>
        </fieldset>

        <fieldset>
           <legend>Kendo UI</legend>
           <div id="k-grid"></div>
        </fieldset>

        <fieldset>
           <legend>Kendo UI Virtual DOM</legend>
           <div id="kv-grid" class="k-grid k-widget"></div>
        </fieldset>

        <script>
            var element = kendo.dom.element;
            var text = kendo.dom.text;

            function now() {
                return window.performance && window.performance.now ? window.performance.now() : new window.Date().getTime()
            }

            $("button").click(function() {
                columns.push(columns.shift());
                dataSource.fetch();
            });

            var dataSource = new kendo.data.DataSource({
                type: "odata",
                transport: {
                    read: {
                        url: "http://demos.telerik.com/kendo-ui/service/Northwind.svc/Orders",
                        dataType: "jsonp"
                    }
                },
                change: function() {
                    var start = now();
                    m.redraw();
                    var end = now();
                    console.log("Mithril", end-start);
                }
            });

            var columns = [
                { field: "OrderID", title: "Order ID" },
                { field: "ShipName", title: "Ship Name" }
            ];
            // Kendo

            function kendo_table() {
                return element("table", { role: "grid" }, [kendo_colgroup(), kendo_thead(), kendo_tbody()]);
            }

            function kendo_thead() {
                return element("thead", { role: "rowgroup", className: "k-grid-header" }, [kendo_theadrow()]);
            }

            function kendo_theadrow() {
                return element("tr", { role: "row" }, kendo_ths());
            }

            function kendo_ths() {
                return columns.map(function(column) {
                    return kendo_th(column);
                });
            }

            function kendo_th(column) {
                return element("th", { "data-field": column.field, className: "k-header", role: "columnheader" }, [text(column.title)]);
            }

            function kendo_tbody() {
                return element("tbody", null, kendo_rows());
            }

            function kendo_colgroup() {
                return element("colgroup", null, kendo_cols());
            }

            function kendo_cols() {
                return columns.map(function() {
                    return element("col");
                });
            }

            function kendo_rows() {
                return kvds.view().map(kendo_row);
            }

            function kendo_row(dataItem, index) {
                var attr = {
                    "data-uid": dataItem.uid
                };

                if (index % 2) {
                    attr["className"] = "k-alt";
                }

                return element("tr", attr, kendo_cells(dataItem));
            }

            function kendo_cells(dataItem) {
                return columns.map(function(column) {
                    return kendo_cell(column.field, dataItem);
                });
            }

            function kendo_cell(field, dataItem) {
                return element("td", null, [ text(String(dataItem[field]))]);
            }

            // Mithril
            function table() {
                return m("table", { role: "grid" }, [colgroup(), thead(), tbody()]);
            }

            function thead() {
                return m("thead", { role: "rowgroup", className: "k-grid-header" }, [theadrow()]);
            }

            function theadrow() {
                return m("tr", { role: "row" }, ths());
            }

            function ths() {
                return columns.map(function(column) {
                    return th(column);
                });
            }

            function th(column) {
                return m("th", { "data-field": column.field, className: "k-header", role: "columnheader" }, column.title);
            }

            function tbody() {
                return m("tbody", rows());
            }

            function colgroup() {
                return m("colgroup", cols());
            }

            function cols() {
                return columns.map(function() {
                    return m("col");
                });
            }

            function rows() {
                return dataSource.view().map(row);
            }

            function row(dataItem, index) {
                var attr = {
                    "data-uid": dataItem.uid
                };

                if (index % 2) {
                    attr["className"] = "k-alt";
                }

                return m("tr", attr, cells(dataItem));
            }

            function cells(dataItem) {
                return columns.map(function(column) {
                    return cell(column.field, dataItem);
                });
            }

            function cell(field, dataItem) {
                return m("td", dataItem[field]);
            }

            //ReactJS

            var Grid = React.createClass({
                getInitialState: function() {
                    return { data: [] };
                },
                componentWillMount: function() {
                    this.setState({ data: this.props.dataSource });
                },
                render: function() {
                    return (
                        GridTable( {
                            columns: this.props.columns,
                            data: this.state.data
                        } )
                    );
                }
            });

            var GridTable = React.createClass({
                tbody: function() {
                    var rows = this.props.data.map(function(item, index) {
                        var attr = {
                            "data-uid": item.uid
                        };

                        if (index % 2) {
                            attr["className"] = "k-alt";
                        }

                        return React.DOM.tr(attr, {
                            children: this.props.columns.map(function(column) {
                                return React.DOM.td(null, item[column.field]);
                            }.bind(this))
                        });
                    }.bind(this));

                    return React.DOM.tbody({
                        children: rows
                    });
                },
                thead: function() {
                    return React.DOM.thead({ className: "k-grid-header" }, {
                        children: [React.DOM.tr( { role: "rowgroup" }, {
                            children: this.props.columns.map(function(column) {
                                return React.DOM.th({
                                    className: "k-header",
                                    role: "columnehader",
                                    "data-field": column.field
                                }, column.title);
                            })
                        }
                        ) ]
                    });
                },
                render: function() {
                    return React.DOM.table({
                        children: [
                            this.thead(),
                            this.tbody()
                        ]
                    });
                }
            });

            var kvds;

            dataSource.fetch(function() {
                $("#k-grid").kendoGrid({
                    dataSource: this.data(),
                    columns: columns,
                    scrollable: false,
                    sortable: true,
                    dataBinding: function() {
                        this.__time__ = now();
                    },
                    dataBound: function() {
                        console.log("kendo", now()-this.__time__);
                    }
                });

                var kv = document.getElementById("kv-grid");

                kvds = new kendo.data.DataSource({
                    data: this.data(),
                    change: function() {
                        var start = now();
                        kendo.dom.render(kv, kendo_table());
                        var end = now();
                        console.log("Kendo Virtual DOM", end-start);
                    }
                });

                kvds.fetch();

                m.module(document.getElementById("m-grid"), {
                    controller: function() {
                    },
                    view: function() {
                        var dom = table();
                        return dom;
                    }
                });

                var start = now();
                kendo.dom.render(kv, kendo_table());
                var end = now();
                console.log("Kendo Virtual DOM", end-start);

                var reactDataSource = new kendo.data.DataSource({
                    data: this.data(),
                    change: function() {
                        var start = now();
                        grid.setState({ data: this.view() });
                        var end = now();
                        console.log("ReactJS", end-start);
                    }
                });

                var grid = Grid({
                    dataSource: this.data(),
                    columns: columns
                });

                var start = now();
                React.renderComponent(grid, document.getElementById("r-grid"));
                var end = now();
                console.log("ReactJS", end-start);

                $("#m-grid").find("th").kendoSorter({ dataSource: dataSource });
                $("#kv-grid").find("th").kendoSorter({ dataSource: kvds });
                $("#r-grid").find("th").kendoSorter({ dataSource: reactDataSource });
            });

        </script>
    </body>
</html>
