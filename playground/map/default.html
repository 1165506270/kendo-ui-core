<!DOCTYPE html>
<html>
    <head>
        <title>Map sandbox</title>
        <script src="../../src/jquery.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.fx.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.mobile.scroller.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.dataviz.core.js"></script>
        <script src="../../src/kendo.dataviz.vml.js"></script>
        <script src="../../src/kendo.dataviz.svg.js"></script>
        <script src="../../src/kendo.dataviz.canvas.js"></script>
        <script src="../../src/kendo.dataviz.map.js"></script>
        <script src="proj4.js"></script>
        <style>
            .layer {
                position: absolute;
            }

            .tile {
                position: absolute;
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
            }
        </style>
    </head>
    <body>
        <div id="view">
            <div id="tile-layer" class="layer"></div>
            <div id="vector-layer" class="layer"> </div>
        </div>
        <script id="tile-template" type="text/x-kendo-template">
            <img class="tile" src="#= img #"
                 unselectable="on"
                 style="left: #= left #px; top: #= top #px;"></img>
        </script>
        <script>
            var Point = kendo.dataviz.Point2D;
            var Location = kendo.dataviz.map.Location;
            var proj = new kendo.dataviz.map.projections.SphericalMercator();
            var crs = new kendo.dataviz.map.crs.EPSG3857();

            var TILE_SIZE = 256;
            var zoomLevel = 2;
            var scale = 256 * Math.pow(2, zoomLevel);

            // TILE
            var tileTemplate = kendo.template($("#tile-template").html());
            var imgTemplate = kendo.template("tiles/#= zoom #/#= x #/#= y #.png");

            function loadTiles(element, zoom) {
                element.empty();

                var size = Math.pow(2, zoom);
                for (var x = 0; x < size; x++) {
                    for (var y = 0; y < size; y++) {
                        var img = imgTemplate({ zoom: zoom, x: x, y: y });

                        $($.trim(tileTemplate({
                            img: img,
                            tileSize: TILE_SIZE,
                            left: x * TILE_SIZE,
                            top: y * TILE_SIZE
                        })))
                        .appendTo(element);
                    }
                }
            }

            loadTiles($("#tile-layer"), zoomLevel);

            // VECTOR
            var view = new kendo.dataviz.SVGView({ width: scale, height: scale });

            function drawPolygon(coords) {
                for (var i = 0; i < coords.length; i++) {
                    var ring = coords[i];
                    var ringPoints = [];

                    for (var j = 0; j < ring.length; j++) {
                        var point = ring[j];
                        var l = Location.fromLngLat(point);
                        var p = crs.toPoint(l, scale);

                        ringPoints.push(p);
                    }

                    var poly = view.createPolyline(ringPoints, true, {
                        stroke: "#ff0000",
                        strokeWidth: 1,
                        strokeOpacity: 0.5,
                        fill: "#006ec8",
                        fillOpacity: 0.2,
                        align: false
                    });
                    view.children.push(poly);
                }
            }

            function draw(geometry, props) {
                var coords = geometry.coordinates;
                if (geometry.type === "Polygon") {
                    drawPolygon(coords);
                } else if (geometry.type === "MultiPolygon") {
                    for (var i = 0; i < coords.length; i++) {
                        drawPolygon(coords[i]);
                    }
                }
            }

            $.getJSON("countries.geo.json", function(data) {
                if (data.type == "FeatureCollection") {
                    var items = data.features;

                    for (var i = 0; i < items.length; i++) {
                        var feature = items[i];
                        if (feature.geometry) {
                            draw(feature.geometry, feature.properties);
                        }
                    }

                    view.renderTo($("#vector-layer")[0]);
                }
            });

        </script>

        <script>
            $("#map").kendoMap({
                view: {
                    center: [51.505, -0.09],
                    zoom: 12
                },
                layers: [{
                    type: "tile",
                    url: "http://{s}.tile.osm.org/{z}/{x}/{y}.png",
                    copyright: "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors"
                }],
                markers: [{
                    position: [51.5, -0.09],
                    text: "Marker with popup",
                    open: true // ?
                }]
            });
        </script>
        <div id="map"></div>
    </body>
</html>

