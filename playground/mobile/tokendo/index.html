 <!DOCTYPE html>
 <html>
 <head>
     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
     <title>ToKenDo</title>

    <link rel="stylesheet" href="layout.css" />
    
    <style>
        body {
            font-family: Verdana, sans-serif;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        .list {
            padding: 0;
            margin: 0;
        }
        
        .item
        {
            list-style-type: none;
            margin: 0;
            padding: 0;
            line-height: 2.4em;
            display: block;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        .item label
        {
            display: block;
        }

        .more-details
        {
            position: absolute;
            height: 1.2em;
            top: .6em;
            right: .6em;
            line-height: 1.2em;
        }

        .touch-scrollbar
        {
            position: absolute;
            display: none;
            z-index: 200000;
            height: .2em;
            width: .2em;
            border: 1px solid #7a7a7a;
            background-color: #858585;
            right: 0;
            bottom: 0;
            -moz-transform-origin: 0 0;
            -webkit-transform-origin: 0 0;
            -o-transform-origin: 0 0;
            transform-origin: 0 0;
        }

        .vertical-scrollbar
        {
            height: 100%;
            right: 1px;
            bottom: 0;
        }

        .horizontal-scrollbar
        {
            width: 100%;
            right: 0;
            bottom: 1px;
        }

        .scroll-container
        {
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
            background: #FFF;
        }

        .data-container
        {
            width: 100%;
            height: 100%;
            background: #555;
        }

        input[type=checkbox]
        {
            visibility: hidden;
            width: 2em;
            height: 2em;
            margin-left: .4em;
        }

        label:before
        {
            position: absolute;
            content: " ";
            display: block;
            top: 50%;
            margin-top: -1em;
            left: .2em;
            width: 2em;
            height: 2em;
            border: 1px solid #999;
            -moz-border-radius: .3em;
            -webkit-border-radius: .3em;
            border-radius: .3em;
        }
    </style>

    <script src="../src/zepto.js"></script>
    <script src="../src/detect.js"></script>
    <script src="../src/fx.js"></script>
    <script src="../src/event.js"></script>

    <script type="text/html" id="item_tmpl">
        <ul class="list">
        <% for (var i = 0; i < data.length; i++) {
            var item = data[i]; %>
            <li class="item">
                <label for="isdone_<%= i %>">
                    <input type="checkbox" id="isdone_<%= i %>" <%= (item.done ? " checked='checked'" : "") %> />
                    <%= item.title %>
                    <a href="#" class="more-details">More...</a>
                </label>
            </li>
        <% } %>
        </ul>
    </script>    
        
    <script>
        // Simple JavaScript Templating
        // John Resig - http://ejohn.org/ - MIT Licensed
        (function(){
          var cache = {};
         
          this.tmpl = function tmpl(str, data){
            // Figure out if we're getting a template, or if we need to
            // load the template - and be sure to cache the result.
            var fn = !/\W/.test(str) ?
              cache[str] = cache[str] ||
                tmpl(document.getElementById(str).innerHTML) :
             
              // Generate a reusable function that will serve as a template
              // generator (and which will be cached).
              new Function("obj",
                "var p=[],print=function(){p.push.apply(p,arguments);};" +
               
                // Introduce the data as local variables using with(){}
                "with(obj){p.push('" +
               
                // Convert the template into pure JavaScript
                str
                  .replace(/[\r\t\n]/g, " ")
                  .split("<%").join("\t")
                  .replace(/((^|%>)[^\t]*)'/g, "$1\r")
                  .replace(/\t=(.*?)%>/g, "',$1,'")
                  .split("\t").join("');")
                  .split("%>").join("p.push('")
                  .split("\r").join("\\'")
              + "');}return p.join('');");
           
            // Provide some basic currying to the user
            return data ? fn( data ) : fn;
          };
        })();

        /// kendo.mobile

        var isTouch = (/iphone|ipad|android/gi).test(navigator.appVersion);

        function Scroller (element) {
            this.element = element;
            this.wrapper = $(element);

            this._horizontalScrollbar = $('<div class="touch-scrollbar horizontal-scrollbar" />');
            this._verticalScrollbar = this._horizontalScrollbar.clone().replaceClass('horizontal-scrollbar', 'vertical-scrollbar');
            this._scrollbars = this._horizontalScrollbar.add(this._verticalScrollbar);

            this._startProxy = $.proxy(this._start, this);
            this._stopProxy = $.proxy(this._stop, this);
            this._dragProxy = $.proxy(this._drag, this);

            this._transformProperty = $.getCssPrefix() + 'transform';
            this._transformOrigin = $.getCssPrefix() + 'transform-origin';

            this._create();
        }

        function touchLocation(e) {
            var changedTouches = e.changedTouches ? e.changedTouches : null;

            if (changedTouches && changedTouches.length < 2) {
                return {
                    x: changedTouches[0].pageX,
                    y: changedTouches[0].pageY
                };
            }

            return {
                x: e.pageX,
                y: e.pageY
            };
        }

        $.throttle = function(delay, callback) {
            var timeout_id,
                last_call = 0,
                omit_ending = arguments[2] || false;

            return function () {
                var that = this,
                    time_span = +new Date() - last_call,
                    args = arguments;

                function execute() {
                    last_call = +new Date();
                    callback.apply(that, args);
                }

                function clear() {
                    timeout_id = undefined;
                }

                timeout_id && clearTimeout(timeout_id);

                if (time_span > delay)
                    execute();
                else
                    if (!omit_ending)
                        timeout_id = setTimeout( execute, delay - time_span);
            };
        };

        Scroller.prototype = {
            _create: function () {
                if (isTouch) {
                    this._moveEvent = "touchmove",
                    this._startEvent = "touchstart",
                    this._endEvent = "touchend";
                } else {
                    this._moveEvent = "mousemove",
                    this._startEvent = "mousedown",
                    this._endEvent = "mouseup";
                }
                var scrollElement = '<div class="scroll-container"></div>';
                var children = this.wrapper.children();

                this.wrapper
                    .css("overflow", "hidden")
                    .bind(this._startEvent, $.proxy(this._wait, this));

                if (children.length)
                    children.wrapAll(scrollElement);
                else
                    this.wrapper.append(scrollElement);

                this.scrollElement = this.wrapper.children();

                this._scrollbars.appendTo(this.wrapper);

                this._storeLastLocation = $.throttle(100, function(location) {
                    this._lastLocation = location;
                });
            },

            _getScrollOffsets: function () {
                var transforms = this.scrollElement.css(this._transformProperty).match(/(translate|matrix)\([,\s\w\d]*?\s*(-?\d+)[\w\s]*,\s*(-?\d+)[\w\s]*\)/i) || [0, 0, 0, 0];

                return {
                    x: +transforms[2],
                    y: +transforms[3]
                };
            },

            _wait: function (e) {
                var startLocation = touchLocation(e);
                var scrollOffsets = this._getScrollOffsets();

                this.start = {
                    location: startLocation,
                    x: startLocation.x - scrollOffsets.x,
                    y: startLocation.y - scrollOffsets.y
                };
                this.lastLocation = this.start;

                $(document)
                    .bind(this._moveEvent, this._startProxy)
                    .bind(this._endEvent, this._stopProxy);
            },

            _start: function (e) {
                var currentLocation = touchLocation(e);
                this._dragged = false;

                if (Math.abs(this.start.location.x - currentLocation.x) > 10 || Math.abs(this.start.location.y - currentLocation.y) > 10) {
                    
                    e.preventDefault();
                    this._dragged = true;

                    $(document).unbind(this._moveEvent, this._startProxy)
                               .bind(this._moveEvent, this._dragProxy);
                    
                    this._width = this.wrapper.innerWidth();
                    this._height = this.wrapper.innerHeight();
                    this._scrollWidth = this.scrollElement.innerWidth();
                    this._scrollHeight = this.scrollElement.innerHeight();

                    if (this._scrollWidth > this._width) {
                        this._horizontalScrollbar
                            .css(
                                this._transformProperty, 'scaleX(' + (this._width / this._scrollWidth) + ')'
                            )
                            .show()
                            .stop()
                            .fadeTo(200, .7);
                    }

                    if (this._scrollHeight > this._height) {
                        this._verticalScrollbar
                            .css(
                                this._transformProperty, 'scaleY(' + (this._height / this._scrollHeight) + ')'
                            )
                            .show()
                            .stop()
                            .fadeTo(200, .7);
                    }

                }
            },

            _drag: function (e) {
                e.preventDefault();

                var currentLocation = touchLocation(e),
                    horizontalDifference = 0,
                    verticalDifference = 0,
                    vsCompensate = 0,
                    hsCompensate = 0,
                    offset = 0;

                if (this._scrollWidth > this._width) {
                    horizontalDifference = currentLocation.x - this.start.x;
                    offset = ~~(-horizontalDifference * 100 / (this._scrollWidth - this._width));
                    hsCompensate = Math.max(-100, Math.min(100, (offset > 100 ? (offset - 100)*5 : 0) || (offset < 0 ? offset*5 : 0)));
                    offset = Math.min(100, Math.max(0, offset));

                    this._horizontalScrollbar
                            .css( this._transformOrigin, offset + '% 0' );
                    if (hsCompensate)
                        this._horizontalScrollbar
                            .css( this._transformProperty, 'scaleX(' + ((this._width - Math.abs(hsCompensate)) / this._scrollWidth) + ')' );
                }

                if (this._scrollHeight > this._height) {
                    verticalDifference = currentLocation.y - this.start.y;
                    offset = ~~(-verticalDifference * 100 / (this._scrollHeight - this._height));
                    vsCompensate = Math.max(-100, Math.min(100, (offset > 100 ? (offset - 100)*5 : 0) || (offset < 0 ? offset*5 : 0)));
                    offset = Math.min(100, Math.max(0, offset));

                    this._verticalScrollbar
                            .css( this._transformOrigin, '0 ' + offset + '%' );
                    if (vsCompensate)
                        this._verticalScrollbar
                            .css( this._transformProperty, 'scaleY(' + ((this._height - Math.abs(vsCompensate)) / this._scrollHeight) + ')' );
                }

                this.scrollElement.css( this._transformProperty, 'translate(' + horizontalDifference + 'px,' + verticalDifference + 'px)' );

                this._storeLastLocation(currentLocation);
            },

            _stop: function (e) {
                $(document).unbind(this._moveEvent, this._startProxy)
                           .unbind(this._moveEvent, this._dragProxy)
                           .unbind(this._endEvent, this._stopProxy);

                if (this._dragged) {
                    e.preventDefault();
                    
                    var currentLocation = touchLocation(e),
                        scrollOffsets = this._getScrollOffsets(),
                        horizontal = scrollOffsets.x + this.lastLocation.x - currentLocation.x,
                        vertical = scrollOffsets.y + this.lastLocation.y - currentLocation.y;

                    this.scrollElement
                        .stop(true)
                        .animate({
                                translate: horizontal + 'px,' + vertical + 'px)'
                            }, 500, 'ease-out');

                    this._scrollbars
                        .stop(true)
                        .fadeTo(400, 0);
                }
            }
        };


        function View(options) {
            $.extend(this, options);
            this.element = $('<div class="data-container"/>');
            this.scroller = new Scroller(this.element);
            this.scrollElement = this.scroller.scrollElement;
        }

        View.prototype = {
            bind: function(data) {
                this.onBind(data, this.scrollElement || this.element);
            }
        };

        function Application(options) {
            $.extend(this, options);
            this.running = false;
        }

        Application.prototype = {
            run: function() {
                if (this.running)
                    return;

                this.running = true;

                var that = this;

                window.addEventListener("DOMContentLoaded", function() {
                    that.root = document.body;

                    that.show(0);
                }, false);

                window.scrollTo(0,1);
            },

            show: function(viewIndex) {
                this.views[viewIndex].element.appendTo(this.root);
            }
        };

        // ToKenDo application code

        var taskList = new View({
            onBind: function(data, element) {
                element.html(tmpl("item_tmpl", { data: data }));
            }
        });

        taskList.bind([
            { title: "Change a lightbulb together with the team", done: true },
            { title: "Shop groceries", done: false },
            { title: "Go through issues on GitHub", done: false },
            { title: "Run qUnit tests", done: true },
            { title: "Get cat food", done: false },
            { title: "Clean the living room", done: false },
            { title: "Cook something nice with George", done: false },
            { title: "Perform a miracle", done: false },
            { title: "Ship a product", done: false },
            { title: "Buy a nice bottle of wine for anniversary celebration", done: false },
            { title: "Eat cake", done: false },
            { title: "Create orange portal", done: false },
            { title: "Create blue portal", done: false },
            { title: "Jump fanatically through portals", done: false },
            { title: "Create orange portal", done: false },
            { title: "Create blue portal", done: true },
            { title: "Jump fanatically through portals", done: false },
            { title: "Buy a nice bottle of wine for anniversary celebration", done: false },
            { title: "Eat cake", done: false },
            { title: "Create orange portal", done: false },
            { title: "Create blue portal", done: false },
            { title: "Jump fanatically through portals", done: false },
            { title: "Create orange portal", done: false },
            { title: "Create blue portal", done: true },
            { title: "Jump fanatically through portals", done: false },
            { title: "Make another list of tommorow's tasks", done: false }
        ]);

        (new Application({
            views: [ taskList ]
        })).run();

    </script>
 </head>
 <body></body>
 </html>

