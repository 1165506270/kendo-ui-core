<!DOCTYPE html>
<html>
    <head>
        <link href="../../styles/web/kendo.common.css" rel="stylesheet" />
        <link href="../../styles/web/kendo.default.less" rel="stylesheet/less" />
        <link href="../../styles/mobile/kendo.mobile.all.less" rel="stylesheet/less" />
        <script src="../../demos/mvc/content/shared/js/less.js"></script>

        <script src="../../src/jquery.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.router.js"></script>
        <script src="../../src/kendo.fx.js"></script>
        <script src="../../src/kendo.mobile.shim.js"></script>
        <script src="../../src/kendo.mobile.popover.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.mobile.scroller.js"></script>
        <script src="../../src/kendo.mobile.shim.js"></script>
        <script src="../../src/kendo.mobile.view.js"></script>
        <script src="../../src/kendo.mobile.loader.js"></script>
        <script src="../../src/kendo.mobile.pane.js"></script>
        <script src="../../src/kendo.mobile.application.js"></script>
        <script src="../../src/kendo.mobile.button.js"></script>
        <script src="../../src/kendo.mobile.actionsheet.js"></script>
        <script src="../../src/kendo.mobile.tabstrip.js"></script>
        <style>
            .virtual-cell, .loading {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }

            .loading {
                color: gray;
            }

            .item {
                display: table;
                width: 100%;
                background: #f0f0f0;
                color: #808080;
                border-top: 1px solid #fafafa;
                border-bottom: 1px solid #e3e3e3;
                font-weight: normal;
            }

            .item h3 {
                font-weight: normal;
                color: #181818;
            }

            .item-thumb, .item-summary, .item-comments {
                display: table-cell;
                vertical-align: top;
                padding-bottom: .5em;
            }

            .item-thumb {
                width: 50px;
                padding-left: 1em;
            }

            .item-comments {
                width: 50px;
                text-align: center;
                color: #af5555;
                vertical-align: middle;
            }

            .thumb {
                width: 50px;
                height: 50px;
                background-repeat: no-repeat;
                background-position: center center;
                background-size: 100% 100%;
                -webkit-border-radius: 10px;
                -webkit-box-shadow: inset 0 0 10px #000000;
                box-shadow:         inset 0 0 10px #000000;
                border-radius: 10px;
                overflow: hidden;
                margin-top: 1em;
                display: inline-block;
            }

            .item-summary li {
                float: left;
                margin-right: 15px;
            }
        </style>
    </head>
    <body>
        <div data-role="view" data-init="buildVirtual">
            <div data-role="virtuallist" data-template="item-template" data-source="ds" style="-webkit-transform:translatez(0)">
            </div>
        </div>

        <div data-role="view" id="foo" data-transition="slide">
            Foo
        </div>

        <script type="text/x-kendo-template" id="item-template">
            <div class="item">
                <div class="item-thumb">
                    <a data-role="listview-link" href="\#foo">
                        <span class='thumb' style="background-image: url(#: data.thumbnail #)"></span>
                    </a>
                </div>
                <div class="item-summary">
                   <h3>#: data.title #</h3>
                   <p> #: data.subreddit # | #: data.ups - data.downs # | #: kendo.toString(new Date(data.created_utc * 1000), 'HH:mm') # </p>
                </div>
                <div class="item-comments">
                    #: data.num_comments #
                </div>
            </div>
        </script>
        <script>
            var PAGE_SIZE = 100;

            var ds = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: 'http://www.reddit.com/r/aww.json',
                        dataType: 'jsonp',
                        jsonp: 'jsonp',
                        cache: true,
                    },

                    parameterMap: function(data, type) {
                        var items = ds.data();
                        if (items.length) {
                            data.after = items[items.length - 1].data.name;
                        }

                        data.limit = PAGE_SIZE;
                        return data;
                    }
                },

                serverPaging: true,
                pageSize: PAGE_SIZE,
                schema: {
                    data: "data.children",
                    total: function() { return 100000; }
                }
            });

            ds.fetch(function() {
                new kendo.mobile.Application();
            });

            var VirtualList = kendo.mobile.ui.Widget.extend({
                init: function(element, options) {

                    kendo.mobile.ui.Widget.fn.init.call(this, element, options);

                    var that = this,
                        view = that.view(),
                        dataSource = that.options.dataSource,
                        template = that.options.template,
                        element = that.element,
                        height = view.content.height(),
                        targetHeight = height * 3,
                        cell,
                        prevCell,
                        itemCount = 0;

                    this.cells = [];
                    this.top = 0;
                    this.bottom = 0;

                    this.loading = $("<div class='loading'>Loading</div>").hide().appendTo(element);

                    while(this.bottom < targetHeight) {
                        cell = new Cell(element);
                        cell.content(template(dataSource.at(itemCount ++)));
                        cell.below(prevCell);
                        prevCell = cell;
                        this.cells.push(cell);
                        this.bottom = cell.bottom;
                    }

                    window.buffer = this.buffer = new kendo.data.Buffer(dataSource, itemCount);

                    var offset = 0,
                        scroller = view.scroller;

                    dataSource.bind('change', function() {
                        scroller.resetVirtual();
                        that.loading.hide();
                    });

                    scroller.bind("scroll", function(e) {
                        var height = view.element.height(),
                            bottom = e.scrollTop + height;

                        if (that.bottom < bottom) {
                            while (that.bottom < bottom + height) {
                                console.log("snap to bottom", offset, that.bottom);

                                if (!that.buffer.at(offset + itemCount + 1)) {
                                    that.loading.show().css("transform", "translate3d(0, " + this.bottom + "px, 0)");
                                    scroller.virtualHeight(that.bottom + that.loading.height());
                                    break;
                                }

                                offset++;
                                var topCell = that.cells.shift(), bottomCell = that.cells[that.cells.length - 1];
                                topCell.content(that.cellContent(offset + itemCount));
                                topCell.below(bottomCell);
                                that.cells.push(topCell);
                                that.bottom = topCell.bottom;
                                that.top = that.cells[0].top;
                            }
                        }

                        while (that.top > e.scrollTop) {
                            if (offset === 0) {
                                scroller.virtualOffset(that.top);
                                break;
                            }

                            offset --;
                            var topCell = that.cells[0], bottomCell = that.cells.pop();
                            bottomCell.content(that.cellContent(offset));
                            bottomCell.above(topCell);
                            that.bottom = that.cells[that.cells.length - 1].bottom;
                            that.top = bottomCell.top;
                            that.cells.unshift(bottomCell);
                        }
                    });
                },

                options: {
                    name: "VirtualList",
                    template: "#: data #",
                    dataSource: null
                },

                cellContent: function(i) {
                    return this.options.template(this.buffer.at(i));
                }
            });

            kendo.mobile.ui.plugin(VirtualList);

            var Cell = kendo.Class.extend({
                init: function(container) {
                    this.element = $("<div class='virtual-cell' />");
                    container.append(this.element);
                    this.top = 0;
                },

                content: function(theContent) {
                    this.element.html(theContent);
                    this.height = this.element.outerHeight(true);
                    this.bottom = this.height + this.top;
                },

                above: function(cell) {
                    if (cell) {
                        this.top = cell.top - this.height;
                        this.bottom = cell.top;
                        this.element.css("transform", "translate3d(0, " + this.top + "px, 0)");
                    }
                },

                below: function(cell) {
                    if (cell) {
                        this.top = cell.bottom;
                        this.bottom = this.height + this.top;
                        this.element.css("transform", "translate3d(0, " + this.top + "px, 0)");
                    }
                }
            });
        </script>
    </body>
</html>
