<!DOCTYPE html>
<html>
<head>
    <link href="../../styles/web/kendo.common.css" rel="stylesheet" />
    <link href="../../styles/web/kendo.default.less" rel="stylesheet/less" />
    <link href="../../styles/mobile/kendo.mobile.all.less" rel="stylesheet/less" />
    <script src="../../demos/mvc/content/shared/js/less.js"></script>

    <script src="../../src/jquery.js"></script>
    
    <script src="../../src/kendo.core.js"></script>
    <script src="../../src/kendo.userevents.js"></script>
    <script src="../../src/kendo.data.js"></script>
    <script src="../../src/kendo.router.js"></script>
    <script src="../../src/kendo.fx.js"></script>
    <script src="../../src/kendo.draganddrop.js"></script>
    <script src="../../src/kendo.mobile.scroller.js"></script>
    <script src="../../src/kendo.mobile.view.js"></script>
    <script src="../../src/kendo.mobile.loader.js"></script>
    <script src="../../src/kendo.mobile.pane.js"></script>
    <script src="../../src/kendo.mobile.application.js"></script>
    <script src="../../src/kendo.mobile.navbar.js"></script>
    <script src="../../src/kendo.mobile.scrollview.js"></script>
    <script src="../../src/kendo.touch.js"></script>

    <style>
        .km-virtual-scrollview {
            overflow-x: hidden;
            white-space: nowrap;
            width: 100%;
            position: relative;

            display: flex;
            display: -webkit-flex;
            display: -webkit-box;
        }

        .km-virtual-scrollview > div {
            position: relative;
            flex: 1;
            -webkit-flex: 1;
            -webkit-box-flex: 1;
        }

        .virtual-page {
            min-height: 1px;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: inline-block;
        }

        .tile {
            width: 50%;
            height: 33%;
            background-color: #c5c5c5;
            display: inline-block;
            float: left;
            box-sizing: border-box;
            -webkit-box-sizing: border-box;
            border: 1px solid #000;
        }

        .item-img {
            height: 100%;
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
        }

    </style>
</head>
<body>
    <div id="home" data-role="view" data-init="onInit" data-title="Canvas View" data-stretch="true">
        <header data-role="header">
            <div data-role="navbar">
                <span data-role="view-title"></span>
            </div>
        </header>
        <div id="virtual" class="km-virtual-scrollview">
        </div>
    </div>
    <div id="detail" data-role="view" data-init="detailInit" data-show="detailShow" data-stretch="true">
        <div id="album"></div>
    </div>
    
    <script type="text/x-kendo-template" id="item-template">
        <div data-offset="#= getOffset(data[0]) #" class="tile">#= data[0] #</div>
        <div data-offset="#= getOffset(data[1]) #" class="tile">#= data[1] #</div>
        <div data-offset="#= getOffset(data[2]) #" class="tile">#= data[2] #</div>
        <div data-offset="#= getOffset(data[3]) #" class="tile">#= data[3] #</div>
        <div data-offset="#= getOffset(data[4]) #" class="tile">#= data[4] #</div>
        <div data-offset="#= getOffset(data[5]) #" class="tile">#= data[5] #</div>
    </script>

    <!--
    <script type="text/x-kendo-template" id="item-template">
        <div data-uid="#: data[0].uid #" class="tile">
            #= createImage(data[0].data) #
        </div>
        <div data-uid="#: data[1].uid #" class="tile">
            #= createImage(data[1].data) #
        </div>
        <div data-uid="#: data[2].uid #" class="tile">
            #= createImage(data[2].data) #
        </div>
        <div data-uid="#: data[3].uid #" class="tile">
            #= createImage(data[3].data) #
        </div>
        <div data-uid="#: data[4].uid #" class="tile">
            #= createImage(data[4].data) #
        </div>
        <div data-uid="#: data[5].uid #" class="tile">
            #= createImage(data[5].data) #
        </div>
    </script>
    -->

    <script type="text/x-kendo-template" id="empty-template">
        <div style="background-color: \\#FF0000;">empty</div>
    </script>

    <script>
        var app = new kendo.mobile.Application(),
            virtualScrollView,
            PAGE_SIZE = 36,
            imgurAlbumRegex = /http:\/\/imgur.com\/a\//,
            imgurGalleryRegex = /http:\/\/imgur.com\/gallery\//,
            imgurSingleRegex = /http:\/\/imgur.com\/.[^\/]/,
            imgExtensionRegex = /\.(png|jpg|gif|jpeg)$/,
            DEFAULTIMAGEURL = "reddit-default.png",
            ds = new kendo.data.DataSource({
                transport: {
                    read: function(options) {

                        var results = [], data = options.data;
                        for (var i = data.skip; i < data.skip + data.take; i ++) {
                            results.push(i);
                        }
                        setTimeout(function () {
                            options.success(results);
                        }, 400);
                    }
                },
                serverPaging: true,
                pageSize: PAGE_SIZE,
                schema: {
                    total: function() { return 100000; }
                }
            });

            /*
            ds = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: 'http://www.reddit.com/r/aww.json',
                        dataType: 'jsonp',
                        jsonp: 'jsonp',
                        cache: true,
                    },

                    parameterMap: function(data, type) {
                        var items = ds.data();
                        if (items.length) {
                            data.after = items[items.length - 1].data.name;
                        }

                        data.limit = PAGE_SIZE;
                        return data;
                    }
                },
                serverPaging: true,
                pageSize: PAGE_SIZE,
                schema: {
                    data: "data.children",
                    total: function() { return 100000; }
                },
                change: function (e) {
                    console.log(this.data());
                }
            });
            */


        function onInit(e) {
            virtualScrollView = $("#virtual").kendoMobileVirtualScrollView({
                contentHeight: 500,
                dataSource: ds,
                batchSize: 6,
                template: kendo.template($("#item-template").html()),
                emptyTemplate: kendo.template($("#empty-template").html()),
                changed: updateSrc
            }).data("kendoMobileVirtualScrollView");

            virtualScrollView.element.find(".virtual-page").kendoTouch({
                tap: function (e) {
                    var tile = $(e.event.target).closest("div.tile"),
                    index = tile.data("offset");

                    app.navigate("#detail?id=" + index);
                }
            });
        }

        function detailInit() {
            $("#album").kendoMobileVirtualScrollView({
                dataSource: ds,
                autoBind: false,
                batchSize: 1,
                template: kendo.template("<div class='tile'>#= data #</div>")
            });
        }

        function detailShow(e) {
            $("#album").data("kendoMobileVirtualScrollView").scrollTo(parseInt(e.view.params.id));
        }

        function getOffset(data) {
            return virtualScrollView.batchBuffer.buffer.indexOf(data);
        }

        function buildUrl(url) {
            var link = url;

            if(!link.match(imgExtensionRegex)) {
                link = link.concat(".jpg");
            }

            if(link.match(imgurAlbumRegex)) {
                return '<span style="color: red">Imgur Album...</span>'
            }

            if(link.match(imgurGalleryRegex)) {
                return '<span style="color: red">Imgur Gallery...</span>'
            }

            return '<img class="item-image" src="' + link + '" />';
        }

        function updateSrc(e) {
            var element = e.element;

            element.find(".item-img").each(function(idx, item) {
                $(item).css("background-image", "url(" + $(item).data("url") + ")");
            });
        }

        function createImage(data) {
            var domain = data.domain,
                subreddit = data.subreddit,
                thumbnail = data.thumbnail,
                url = data.url,
                imageTemplate = kendo.template('<div class="item-img" style="background-image: url(' + DEFAULTIMAGEURL + ');" data-url="#= data #"></div>');

            if(url.match(imgExtensionRegex)) {
                return imageTemplate(url);
            }

            if(url.match(imgurAlbumRegex) || url.match(imgurGalleryRegex)) {
                return imageTemplate(DEFAULTIMAGEURL);
            }

            if(url.match(imgurSingleRegex)) {
                return imageTemplate(url.concat(".jpg"));
            }

            return imageTemplate(DEFAULTIMAGEURL);
        }
    </script>
</body>
</html>
