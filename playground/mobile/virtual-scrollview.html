<!DOCTYPE html>
<html>
<head>
    <link href="../../styles/web/kendo.common.css" rel="stylesheet" />
    <link href="../../styles/web/kendo.default.less" rel="stylesheet/less" />
    <link href="../../styles/mobile/kendo.mobile.all.less" rel="stylesheet/less" />
    <script src="../../demos/mvc/content/shared/js/less.js"></script>

    <script src="../../src/jquery.js"></script>
    
    <script src="../../src/kendo.core.js"></script>
    <script src="../../src/kendo.userevents.js"></script>
    <script src="../../src/kendo.data.js"></script>
    <script src="../../src/kendo.router.js"></script>
    <script src="../../src/kendo.fx.js"></script>
    <script src="../../src/kendo.draganddrop.js"></script>
    <script src="../../src/kendo.mobile.scroller.js"></script>
    <script src="../../src/kendo.mobile.view.js"></script>
    <script src="../../src/kendo.mobile.loader.js"></script>
    <script src="../../src/kendo.mobile.pane.js"></script>
    <script src="../../src/kendo.mobile.application.js"></script>
    <script src="../../src/kendo.mobile.scrollview.js"></script>

    <style>
        .km-pageview {
            overflow: hidden;
            white-space: nowrap;
            width: 100%;
            position: relative;
        }

        .virtual-page {
            min-height: 1px;
            height: 100%;
            position: absolute;
            overflow: hidden;
        }

        .item-image {
            min-width:100%;
        }

        .tile {
            height: 50px;
            padding: 10px 0;
            line-height: 50px;
            text-align: center;
            font-size: 3em;
            border: 1px solid yellow;
        }
    </style>
</head>
<body>
    <div id="home" data-role="view" data-init="onInit">
        <div id="virtual"></div>
    </div>

    <script type="text/x-kendo-template" id="item-template">
        <div class="tile">#= data[0].foo #</div>
        <div class="tile">#= data[1].foo #</div>
        <div class="tile">#= data[2].foo #</div>
        <div class="tile">#= data[3].foo #</div>
        <div class="tile">#= data[4].foo #</div>
        <div class="tile">#= data[5].foo #</div>
    </script>

    <script type="text/x-kendo-template" id="empty-template">
        <div>empty</div>
    </script>

    <script>
        var app,
            virtualScrollView,
            PAGE_SIZE = 10,
            imgurAlbumRegex = /http:\/\/imgur.com\/a\//,
            imgurGalleryRegex = /http:\/\/imgur.com\/gallery\//,
            imgurSingleRegex = /http:\/\/imgur.com\/.[^\/]/,
            imgExtensionRegex = /\.(png|jpg|gif|jpeg)$/,
            ds = new kendo.data.DataSource({
                /*transport: {
                    read: {
                        url: 'http://www.reddit.com/r/pics/.json',
                        dataType: 'jsonp',
                        jsonp: 'jsonp',
                        cache: true,
                    },

                    parameterMap: function(data, type) {
                        var items = ds.data();
                        if (items.length) {
                            data.after = items[items.length - 1].data.name;
                        }

                        data.limit = PAGE_SIZE;
                        return data;
                    }
                },
                serverPaging: true,
                pageSize: PAGE_SIZE,
                schema: {
                    data: "data.children",
                    total: function() { return 100000; }
                }*/
                data: generateData(100)
            });

        ds.fetch(function() {
            app = new kendo.mobile.Application();
        });

        function onInit(e) {
            virtualScrollView = $("#virtual").kendoMobileVirtualScrollView({
                contentHeight: e.view.content.height(),
                dataSource: ds,
                batchSize: 6,
                template: kendo.template($("#item-template").html()),
                emptyTemplate: kendo.template($("#empty-template").html())
            }).data("kendoMobileVirtualScrollView");
        }

        function buildUrl(url) {
            var link = url;

            if(!link.match(imgExtensionRegex)) {
                link = link.concat(".jpg");
            }

            if(link.match(imgurAlbumRegex)) {
                return '<span style="color: red">Imgur Album...</span>'
            }

            if(link.match(imgurGalleryRegex)) {
                return '<span style="color: red">Imgur Gallery...</span>'
            }

            return '<img class="item-image" src="' + link + '" />';
        }

        function generateData(n) {
            var data = [],
                obj = {};

            for (var i = 1; i < n+1; i++) {
                obj = { id: i, foo: i };
                data.push(obj);
            }

            return data;
        }
/*
        (function($, undefined) {
            var kendo = window.kendo,
                mobile = kendo.mobile,
                ui = mobile.ui,
                proxy = $.proxy,
                Transition = kendo.fx.Transition,
                Pane = kendo.ui.Pane,
                PaneDimensions = kendo.ui.PaneDimensions,
                Widget = ui.Widget,
                DataSource = kendo.data.DataSource,

                // Math
                math = Math,
                abs  = math.abs,
                ceil = math.ceil,
                round = math.round,
                max = math.max,
                min = math.min,
                floor = math.floor,
                CHANGE = "change",
                CURRENT_PAGE_CLASS = "km-current-page";

            var PageView = Widget.extend({
                init: function(element, options) {
                    var that = this;

                    Widget.fn.init.call(that, element, options);

                    element = that.element;

                    element
                        .append("<div/>")
                        .addClass("km-pageview");

                    that.inner = element.children().first();
                    that.pages = [];
                    that.itemCount = 0;
                    that._endReached = false;

                    that.inner.css("height", that.options.contentHeight);

                    var movable,
                        transition,
                        dimensions,
                        dimension,
                        userEvents,
                        pane,
                        width = element.width();

                    movable = new kendo.ui.Movable(that.inner);

                    transition = new Transition({
                        axis: "x",
                        movable: movable,
                        onEnd: proxy(that._transitionEnd, that)
                    });

                    dimensions = new PaneDimensions({
                        element: that.inner,
                        container: that.element
                    });

                    dimension = dimensions.x;
                    dimension.bind(CHANGE, proxy(that.refresh, that));
                    dimension.forceEnabled();

                    userEvents = new kendo.UserEvents(element, {
                        start: function(e) {
                            if (abs(e.x.velocity) * 2 >= abs(e.y.velocity)) {
                                userEvents.capture();
                            } else {
                                userEvents.cancel();
                            }

                            transition.cancel();
                        },
                        allowSelection: true,
                        end: proxy(that._dragEnd, that)
                    });

                    pane = new Pane({
                        dimensions: dimensions,
                        movable: movable,
                        userEvents: userEvents,
                        elastic: true
                    });

                    $.extend(that, {
                        movable: movable,
                        transition: transition,
                        userEvents: userEvents,
                        dimensions: dimensions,
                        dimension: dimension,
                        pane: pane,
                        width: width
                    });

                    if(that.options.batchSize > 1) {
                        that.batchBuffer = new BatchBuffer(that.options.dataSource, that.options.batchSize);
                    } else {
                        that.batchBuffer = new kendo.data.Buffer(that.options.dataSource, that.itemCount);
                    }

                    that.batchBuffer.bind({
                        "endreached": proxy(that._onEndReached, that),
                        "reset": proxy(that._onReset, that)
                    });

                    that._initPages();
                },

                options: {
                    name: "PageView",
                    duration: 300,
                    velocityThreshold: 0.8,
                    contentHeight: "auto",
                    bounceVelocityThreshold: 1.6,
                    dataSource: new DataSource({ data: [] }),
                    batchSize: 1,
                    template: kendo.template(""),
                    emptyTemplate: kendo.template("empty")
                },

                refresh: function () {
                    var that = this,
                        dimension = that.dimension,
                        pages = that.pages,
                        width = dimension.getSize();

                    for(var i = 0; i < pages.length; i++) {
                        pages[i].width = width;
                        pages[i].element.width(width);
                    }

                    pages[0].first();
                    pages[1].center();
                    pages[2].last();

                    that.width = width;
                    that.dimension.update(true);
                },

                _initPages: function () {
                    var that = this,
                        dimension = that.dimension,
                        pages = that.pages,
                        inner = that.inner,
                        page;

                    page = new Page(inner);
                    page.content(that.options.emptyTemplate({}));
                    page.first();
                    pages.push(page);

                    page = new Page(inner);
                    that.setPageContent(page, that.itemCount ++);
                    page.center();
                    pages.push(page);

                    page = new Page(inner);
                    that.setPageContent(page, that.itemCount ++);
                    page.last();
                    pages.push(page);

                    that.dimension.update(true);
                },

                _moveTo: function (location, ease, instant) {
                    this.transition.moveTo({ location: location, duration: (instant ? 1 : this.options.duration), ease: ease });
                },

                _resetMovable: function () {
                    this.movable.moveTo({ x: 0 });
                },

                forward: function (instant) {
                    this._moveTo(-this.width, Transition.easeOutExpo, instant);
                },

                backward: function (instant) {
                    this._moveTo(this.width, Transition.easeOutBack, instant);
                },

                reset: function (ease) {
                    this._moveTo(0, ease, false);   
                },

                _dragEnd: function (e) {
                    var that = this,
                        velocity = e.x.velocity,
                        width = that.width,
                        velocityThreshold = that.options.velocityThreshold,
                        ease = Transition.easeOutExpo;

                    if (velocity > velocityThreshold) {
                        if(that.itemCount === 2) {
                            that.reset(ease);
                            return;
                        }
                        that.backward();
                        return;
                    } else if(velocity < -velocityThreshold && !that._endReached) {
                        that.forward();
                        return;
                    }

                    if(that.movable.x < 0 && (abs(that.movable.x) >= width / 3 && !that._endReached)) {
                        that.forward();
                        return;
                    } else if(that.movable.x > 0 && (abs(that.movable.x) >= width / 3)) {
                        if(that.itemCount === 2) {
                            that.reset(ease);
                            return;           
                        }
                        that.backward();
                        return;
                    } else {
                        that.reset(ease);
                    }
                },

                _transitionEnd: function (e) {
                    var that = this,
                        pages = that.pages,
                        pageToBeUpdated;

                    if(that.movable.x === 0) {
                        return;
                    }

                    if(that.movable.x < 0) { 
                        pages.push(that.pages.shift()); //forward
                        that.setPageContent(pages[2], that.itemCount ++);
                    } else {
                        pages.unshift(that.pages.pop()); //back
                        that.itemCount--;
                        that.setPageContent(pages[0], that.itemCount - 3);
                    }

                    pages[0].first();
                    pages[1].center();
                    pages[2].last();
                    
                    that._resetMovable();
                },

                _onEndReached: function (e) {
                    console.log("end reached");
                    this._endReached = true;
                },

                _onReset: function (e) {
                    console.log("reset");   
                },

                setPageContent: function (page, index) {
                    var batchBuffer = this.batchBuffer,
                        template = this.options.template,
                        emptyTemplate = this.options.emptyTemplate;

                    if(index >= 0) {
                        page.content(template(batchBuffer.at(index)));
                    } else {
                        page.content(emptyTemplate({}));
                    }
                }

            });

            ui.plugin(PageView);

            var Page = kendo.Class.extend({
                init: function (container) {
                    this.element = $("<div class='virtual-page'></div>");
                    this.width = container.width();
                    this.element.width(this.width);
                    container.append(this.element);
                },
                content: function (theContent) {
                    this.element.html(theContent);
                },
                center: function () {
                    this.element.css("transform", "translate3d(0, 0, 0)");
                },
                first: function () {
                    this.element.css("transform", "translate3d(-" + this.width + "px, 0, 0)");
                },
                last: function () {
                    this.element.css("transform", "translate3d(" + this.width + "px, 0, 0)"); 
                }
            });

            var BatchBuffer = kendo.Observable.extend({
                init: function (dataSource, batchSize) {
                    var batchBuffer = this;

                    kendo.Observable.fn.init.call(batchBuffer);

                    this.dataSource = dataSource;
                    this.batchSize = batchSize;
                    this.buffer = new kendo.data.Buffer(dataSource, batchSize*2);

                    this.buffer.bind({
                        "endreached": function (e) {
                            batchBuffer.trigger("endreached", { index: e.index });
                        },
                        "prefetching": function (e) {
                            batchBuffer.trigger("prefetching", { skip: e.skip, take: e.take });
                        },
                        "prefetched": function (e) {
                            batchBuffer.trigger("prefetched", { skip: e.skip, take: e.take });
                        },
                        "reset": function (e) {
                            batchBuffer.trigger("reset");
                        }
                    });
                },
                at: function (index) {
                    var buffer = this.buffer,
                        skip = index * this.batchSize,
                        take = this.batchSize,
                        view = [];

                    for (var i = 0; i < take; i++) {
                        view.push(buffer.at(skip + i));
                    }

                    return view;
                }
            })

        })(window.kendo.jQuery);
        */
    </script>
</body>
</html>
