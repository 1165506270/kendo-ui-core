<!DOCTYPE html>
<html>
    <head>
        <title>MVVM</title>


        <link rel="stylesheet" href="../styles/web/kendo.common.css"/>
        <link rel="stylesheet/less" type="text/css" href="../styles/web/kendo.default.less"/>

        <script src="../demos/mvc/content/shared/js/less.js"></script>

        <script src="../src/jquery.js"></script>
        <script src="../src/kendo.core.js"></script>
        <script src="../src/kendo.data.js"></script>
        <script src="../src/kendo.binder.js"></script>
        <script src="../src/kendo.popup.js"></script>
        <script src="../src/kendo.list.js"></script>
        <script src="../src/kendo.dropdownlist.js"></script>

        <style>
            table, td, th {
                border: 1px solid black;
                border-collapse: collapse;
            }
        </style>

        <script>
            var Class = kendo.Class,
                Observable = kendo.Observable;

            var Binding = Observable.extend( {
                init: function(source, path) {
                    var that = this;

                    Observable.fn.init.call(that);

                    that.source = source;
                    that.path = path;

                    that.source.bind("change", function(e) {
                        if (that.path.indexOf(e.field) >= 0) {
                            that.change();
                        }
                    });
                },

                change: function() {
                    this.trigger("change");
                },

                get: function() {
                    return this.source.get(this.path);
                },

                set: function(value) {
                    this.source.set(this.path, value);
                }
            });

            var DomElement = Class.extend( {
                init: function(target) {
                    this.target = target;
                },

                setBinding: function(path, binding) {
                    path = {
                        "text": "innerText",
                        "title": "title",
                        "value": "value"
                    }[path];

                    var property = new Property(this.target, path);

                    var expression = new BindingExpression(property, binding);

                    expression.updateTarget();

                    property.bind("change", function() {
                        expression.updateSource();
                    });

                    binding.bind("change", function() {
                        expression.updateTarget();
                    });
                }
            });

            var BindingExpression = Class.extend( {
                init: function(property, binding) {
                    this.property = property;
                    this.binding = binding;
                },

                updateTarget: function() {
                    this.property.set(this.binding.get());
                },

                updateSource: function() {
                    this.binding.set(this.property.get());
                }
            });

            var Property = Observable.extend( {
                init: function(target, path) {
                    Observable.fn.init.call(this);

                    this.target = target;
                    this.path = path;

                    $(this.target).bind("change", $.proxy(this.change, this));
                },

                change: function() {
                    this.trigger("change");
                },

                get: function() {
                    return this.target[this.path];
                },

                set: function(value) {
                    this.target[this.path] = value;
                }
            });

            function bind(target, source) {
                var element = new DomElement(target);

                ["text", "title", "value"].forEach(function(path) {
                    var sourcePath = target.getAttribute("data-" + path);

                    if (sourcePath) {
                        var binding = new Binding(source, sourcePath);

                        element.setBinding(path, binding);
                    }
                });
            }
        </script>
    </head>
    <body>
        <form>
            <div data-text="foo" data-title="bar"></div>
            <input data-value="baz" />
            Input value is: <span data-text="baz"></span>
        </form>

        <script>
            var viewModel = kendo.observable({
                foo: "foo",
                bar: "bar",
                baz: "baz"
            });

            bind($("div")[0], viewModel);
            bind($("input")[0], viewModel);
            bind($("span")[0], viewModel);
        </script>
    </body>
</html>

