<!DOCTYPE html>
<html>
    <head>
        <title>MVVM</title>


        <link rel="stylesheet" href="../styles/web/kendo.common.css"/>
        <link rel="stylesheet/less" type="text/css" href="../styles/web/kendo.default.less"/>

        <script src="../demos/mvc/content/shared/js/less.js"></script>

        <script src="../src/jquery.js"></script>
        <script src="../src/kendo.core.js"></script>
        <script src="../src/kendo.data.js"></script>
        <script src="../src/kendo.binder.js"></script>
        <script src="../src/kendo.popup.js"></script>
        <script src="../src/kendo.list.js"></script>
        <script src="../src/kendo.dropdownlist.js"></script>

        <script>
            var Class = kendo.Class,
                Observable = kendo.Observable;

            var Binding = Observable.extend( {
                init: function(source, path) {
                    var that = this;

                    Observable.fn.init.call(that);

                    that.source = source;
                    that.path = path;

                    that.source.bind("change", function(e) {
                        if (that.path.indexOf(e.field) >= 0) {
                            that.change();
                        }
                    });
                },

                change: function() {
                    this.trigger("change");
                },

                get: function() {
                    return this.source.get(this.path);
                },

                set: function(value) {
                    this.source.set(this.path, value);
                }
            });

            var BindingTarget = Class.extend( {
                init: function(target) {
                    this.target = target;
                },

                setBinding: function(path, binding) {
                    var property = this.createProperty(path);

                    var expression = this.createExpression(property, binding);

                    expression.updateTarget();

                    property.bind("change", function() {
                        expression.updateSource();
                    });

                    binding.bind("change", function() {
                        expression.updateTarget();
                    });
                },

                createExpression: function(property, binding) {
                    return new BindingExpression(property, binding);
                },

                createProperty: function(path) {
                    path = {
                        "text": "innerText",
                        "title": "title",
                        "value": "value"
                    }[path];

                    if (path == "value") {
                        return new TwoWayProperty(this.target, path);
                    }
                    return new Property(this.target, path);
                }
            });

            var SelectBindingTarget = BindingTarget.extend( {
                createExpression: function(property, binding) {
                    return new MultipleBindingExpression(property, binding);
                },
                createProperty: function(path) {
                    if (path == "value") {
                        return new MultipleProperty(this.target, path);
                    } else if (path == "source") {
                        return new SourceProperty(this.target, path);
                    }
                }
            });

            var BindingExpression = Class.extend( {
                init: function(property, binding) {
                    this.property = property;
                    this.binding = binding;
                },

                updateTarget: function() {
                    this.property.set(this.binding.get());
                },

                updateSource: function() {
                    this.binding.set(this.property.get());
                }
            });

            var MultipleBindingExpression = BindingExpression.extend( {
                updateSource: function() {
                    var source = this.binding.get();
                    var target = this.property.get();

                    source.splice.apply(source, [0, source.length].concat(target));
                }
            });

            var Property = Class.extend( {
                init: function(target, path) {
                    this.target = target;
                    this.path = path;
                },

                bind: function() {
                },

                set: function(value) {
                    this.target[this.path] = value;
                }
            });

            var TwoWayProperty = Observable.extend( {
                init: function(target, path) {
                    Observable.fn.init.call(this);

                    this.target = target;
                    this.path = path;

                    $(this.target).bind("change", $.proxy(this.change, this));
                },

                change: function() {
                    this.trigger("change");
                },

                get: function() {
                    return this.target[this.path];
                },

                set: function(value) {
                    this.target[this.path] = value;
                }
            });

            var MultipleProperty = TwoWayProperty.extend({
                get: function() {
                    var optionIndex, value = [];

                    for (optionIndex = 0; optionIndex < this.target.length; optionIndex++) {
                        if (this.target[optionIndex].selected) {
                            value.push(this.target[optionIndex].value);
                        }
                    }

                    return value;
                },

                set: function(value) {
                    var valueIndex, optionIndex;

                    for (valueIndex = 0; valueIndex < value.length; valueIndex++) {
                        for (optionIndex = 0; optionIndex < this.target.length; optionIndex++) {
                            if (this.target[optionIndex].value == value[valueIndex]) {
                                this.target[optionIndex].selected = true;
                            }
                        }
                    }
                }
            });

            var SourceProperty = Property.extend({
                set: function(value) {
                    this.target.innerHTML = kendo.render(kendo.template("<option>#:data#</option>"), value);
                }
            });

            var WidgetBindingTarget = BindingTarget.extend( {
                createProperty: function(path) {
                    path = {
                        "value": "value"
                    }[path];

                    return new WidgetProperty(this.target, path);
                }
            });

            var WidgetProperty = Observable.extend( {
                init: function(target, path) {
                    Observable.fn.init.call(this);

                    this.target = target;
                    this.path = path;

                    this.target.bind("change", $.proxy(this.change, this));
                },

                change: function() {
                    this.trigger("change");
                },

                get: function() {
                    return this.target[this.path]();
                },

                set: function(value) {
                    this.target[this.path](value);
                }
            });

            function bind(element, source) {
                var role = element.getAttribute("data-role");
                var target;

                if (role) {
                    target = new WidgetBindingTarget(new kendo.ui.DropDownList(element));
                } else {
                    target = element.nodeName.toLowerCase() === "select" ? new SelectBindingTarget(element) : new BindingTarget(element);
                }

                ["text", "title", "value", "source"].forEach(function(path) {
                    var sourcePath = element.getAttribute("data-" + path);

                    if (sourcePath) {
                        var binding = new Binding(source, sourcePath);

                        target.setBinding(path, binding);
                    }
                });
            }
        </script>
    </head>
    <body>
        <form>
            <div data-text="foo" data-title="bar"></div>

            <input data-value="baz" />

            Input value is: <span data-text="baz"></span>

            <select multiple style="display:block" data-value="selectedValues">
                <option>one</option>
                <option>two</option>
                <option>three</option>
            </select>

            <select data-role="dropdownlist" style="display:block" data-value="selectedValue">
                <option>one</option>
                <option>two</option>
                <option>three</option>
            </select>
            DropDownList value is: <span id="selectedValue" data-text="selectedValue"></span>
            <select style="display:block" data-source="items"></select>
        </form>

        <script>
            var viewModel = kendo.observable({
                foo: "foo",
                bar: "bar",
                baz: "baz",
                selectedValues: ["two"],
                selectedValue: "two",
                items: ["one", "two", "three"]
            });

            bind($("div")[0], viewModel);
            bind($("input")[0], viewModel);
            bind($("span")[0], viewModel);
            bind($("select")[0], viewModel);
            bind($("select")[1], viewModel);
            bind($("#selectedValue")[0], viewModel);
            bind($("select")[2], viewModel);
        </script>
    </body>
</html>
