<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" >
    <head>
        <title>Kendo MVVM Benchmark</title>
        <script src="../../src/jquery.js"></script>
        <script src="benchmark.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <script type="text/javascript" src="http://underscorejs.org/underscore-min.js"></script>
        <script type="text/javascript" src="http://backbonejs.org/backbone-min.js"></script>
        <script type="text/javascript" src="http://cloud.github.com/downloads/SteveSanderson/knockout/knockout-2.0.0.js"></script>
    <style type="text/css">
        p {
          font: 12px/16px Arial;
          margin: 10px 10px 15px;
        }

        button {
          font: bold 14px/14px Arial;
          margin-left: 10px;
        }

        #ko-grid {
          margin: 10px;
        }

        #kendo-grid {
          margin: 10px;
        }

        .box-view {
          width: 20px; height: 20px;
          float: left;
          position: relative;
          margin: 8px;
        }

        .box {
          border-radius: 100px;
          width: 20px; height: 10px;
          padding: 5px 0;
          color: #ccc;
          font: 10px/10px Arial;
          text-align: center;
          position: absolute;
        }
    </style>
</head>
<body>
    <button onclick="runBackbone()">Animate with Backbone</button>
    <button onclick="runKnockout()">Animate with Knockout</button>
    <button onclick="runKendoMVVM()">Animate with Kendo MVVM</button>

    <div id="kendo-grid">
    </div>

    <div id="ko-grid">
    </div>

    <script type='x-template' id='box-template'>
        <!-- ko foreach:boxes -->
        <div class="box-view" data-bind="">
        <div class="box" data-bind="style: { top: top+'px', left: left+'px', backgroundColor: 'rgb(0,0,' + color + ')' }, text: content()"></div>
        </div>
        <!-- /ko -->
    </script>

    <script type="x-template" id="underscore-template">
      <div class="box" id="box-<%= number %>" style="top: <%= top %>px; left: <%= left %>px; background: rgb(0,0,<%= color %>);">
        <%= content %>
      </div>
    </script>

    <script type="text/x-kendo-template" id="kendo-template">
        <div class="box-view">
            <div class="box" data-bind="style: {top: top, left: left, backgroundColor: color}, text: content">
            </div>
        </div>
    </script>

    <script type="text/javascript">
        // Change N to change the number of drawn circles.
        var N = 100;

        //The Kendo MVVM implementation:
        (function() {
            var boxes;

            var kendoInit = function() {
                boxes = _.map(_.range(N), function(i) {
                    return kendo.observable({
                        count : 0,
                        top: "",
                        left: "",
                        color: "rgb(0,0,0)",
                        number: i,
                        content: function() {
                            return this.get('count') % 100;
                        },
                        tick: function() {
                            var count = this.get('count') + 1;
                            this.set('count', count);
                            this.set('top', Math.sin(count / 10) * 10 + "px");
                            this.set('left', Math.cos(count / 10) * 10 + "px");
                            this.set('color', 'rgb(0,0,' + count % 255 + ')');
                        }
                    });
                });

                var $grid = $("#kendo-grid");
                $grid.attr("data-bind", "source:boxes")
                     .attr("data-template", "kendo-template");

                kendo.bind($grid[0], {
                    boxes: boxes
                });
            };

            var kendoAnimate = function() {
                for (var i = 0, l = boxes.length; i < l; i++) {
                    boxes[i].tick();
                }

                window.timeout = _.defer(kendoAnimate);
            };

            window.runKendoMVVM = function() {
                reset();
                kendoInit();
                kendoAnimate();
            }
        })();

        // The Knockout implementation:
        (function() {
            var BoxViewModel = function() {

                this.top = 0;
                this.left = 0;
                this.content = ko.observable(0);
                this.count = 0;
                this.number = 0;
                this.color = '';

                this.tick = function() {
                    var count = this.count + 1;
                    this.count = count;
                    this.top = Math.sin(count / 10) * 10;
                    this.left = Math.cos(count / 10) * 10;
                    this.color = count % 255;
                    this.content(count % 100);
                };
            };

            var boxes;

            var knockoutInit = function() {
                boxes = ko.observableArray(_.map(_.range(N), function(i) {
                    var boxViewModel = new BoxViewModel();
                    boxViewModel.number = i;
                    return boxViewModel;
                }));

                $("#ko-grid").attr("data-bind", "template: { name: 'box-template' }");

                ko.applyBindings({
                    boxes: boxes
                });
            };

            var knockoutAnimate = function() {
                for (var i = 0, l = boxes().length; i < l; i++) {
                    boxes()[i].tick();
                }
                window.timeout = _.defer(knockoutAnimate);
            };

            window.runKnockout = function() {
                reset();
                knockoutInit();
                knockoutAnimate();
            };

        })();

        // The Backbone implementation:
        (function() {

            var Box = Backbone.Model.extend({

                defaults: {
                    top: 0,
                    left: 0,
                    color: 0,
                    content: 0
                },

                initialize: function() {
                    this.count = 0;
                },

                tick: function() {
                    var count = this.count += 1;
                    this.set({
                        top: Math.sin(count / 10) * 10,
                        left: Math.cos(count / 10) * 10,
                        color: (count) % 255,
                        content: count % 100
                    });
                }

            });


            var BoxView = Backbone.View.extend({

                className: 'box-view',

                template: _.template($('#underscore-template').html()),

                initialize: function() {
                    this.model.bind('change', this.render, this);
                },

                render: function() {
                    this.$el.html(this.template(this.model.attributes));
                    return this;
                }

            });

            var boxes;

            var backboneInit = function() {
                boxes = _.map(_.range(N), function(i) {
                    var box = new Box({
                        number: i
                    });
                    var view = new BoxView({
                        model: box
                    });
                    $('#grid').append(view.render().el);
                    return box;
                });
            };

            var backboneAnimate = function() {
                for (var i = 0, l = boxes.length; i < l; i++) {
                    boxes[i].tick();
                }
                window.timeout = _.defer(backboneAnimate);
            };

            window.runBackbone = function() {
                reset();
                backboneInit();
                backboneAnimate();
            };

        })();

        window.timeout = null;
        window.reset = function() {
            //$('#grid').empty();
//            clearTimeout(timeout);
        };
    </script>
</body>
</html>
