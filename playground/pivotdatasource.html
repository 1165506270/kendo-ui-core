<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>pivot columns</title>
        <script src="../src/jquery.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.core.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.data.odata.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.data.xml.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.data.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.pivotgrid.js" type="text/javascript" charset="utf-8"></script>
        <link rel="stylesheet" href="../dist/styles/web/kendo.common.css"/>
        <link rel="stylesheet/less" type="text/css" href="../dist/styles/web/kendo.default.less"/>
        <script src="../demos/mvc/content/shared/js/less.js"></script>
    </head>
    <body>
        <button>Expand</button>
        <div class="k-grid k-widget" style="overflow: scroll;height: 1000px">
            <table id="container"></table>
        </div>

        <script>
/*           var PivotDataSource = kendo.data.PivotDataSource.extend({
               _readData: function(data) {
                    debugger;
                    var originalData = this._data;
                    var cellData = this.reader.data(data);
                    var axes = this.reader.axes(data);

                    this._axes = axes;

                    //merge data with this._data;
                    return cellData;
                },
                execute: function(descriptors) {
                    this.read($.extend({ columns: [], rows: [], measures: [], filter: {}}, descriptors));
                },
                discover: function(descriptors) {
                }
            });

*/
            function crossJoin(names) {
                var result = "CROSSJOIN({";
                var r;
                if (names.length > 2) {
                    r = names.pop();
                    result += crossJoin(names);
                } else {
                    result += names.shift();
                    r = names.pop();
                }
                result += "},{";
                result += r;
                result += "})";
                return result;
            }

           /* {
                columns: [{ field: "[MemberPath]", expand: true}, { field: "[MemberPath2]", expand: false }],
                values: ["Measure1"], // on which axes?
                rows: [{ field: "[MemberPath]", expand: true}, { field: "[MemberPath2]", expand: false }],
                filter: {}
            }*/

            function expandMembers(members) {
                var result = [];
                var name;

                for (var idx = 0; idx < members.length; idx++) {
                    if (typeof members[idx] == "string") {
                        result.push(members[idx])
                    } else {
                        if (members[idx].expand) {
                            result.push(members[idx].name + ".[ALL].Children");
                        } else {
                            result.push(members[idx].name);
                        }
                    }
                }

                return result;
            }

            var converters = {
                read: function(options) {
                    var command = '<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/"><Header/><Body><Execute xmlns="urn:schemas-microsoft-com:xml-analysis"><Command><Statement>';

                    command += "SELECT NON EMPTY {";

                    var columns = expandMembers(options.columns);
                    var rows = expandMembers(options.rows);

                    if (options.columns.length) {
                        if (options.columns.length > 1 || options.measures.length > 1) {
                            var tmp = columns;
                            if (options.measures.length > 1) {
                                tmp.push("{" + options.measures.join(",") + "}");
                            }

                            command += crossJoin(tmp);
                        } else {
                            command += columns.join(",");
                        }
                    } else if (options.measures.length) {
                        command += options.measures.join(",");
                    }

                    command += "} DIMENSION PROPERTIES CHILDREN_CARDINALITY, PARENT_UNIQUE_NAME ON COLUMNS";

                    if (rows.length) {
                        command += ", NON EMPTY {" + rows.join(",") + "} DIMENSION PROPERTIES CHILDREN_CARDINALITY, PARENT_UNIQUE_NAME ON ROWS";
                    }

                    command += " FROM [" + options.connection.cube + "]";

                    if (options.measures.length == 1 && options.columns.length) {
                        command += " WHERE (" + options.measures.join(",") + ")";
                    }

                    command += '</Statement></Command><Properties><PropertyList><Catalog>' + options.connection.catalog + '</Catalog></PropertyList></Properties></Execute></Body></Envelope>';

                    return command;
                },
                discover: function(options) {
                }
            };

            var dataSource = new kendo.data.PivotDataSource({
                type: "xmla",
                columns: ["[Date].[Calendar]"],
                rows: ["[Product].[Product Name]"],
                measures: ["[Measures].[Internet Order Lines Count]"],
                transport: {
                    connection: {
                        catalog: "Adventure Works Internet Sales Model",
                        cube: "Adventure Works Internet Sales Model"
                    },
                    parameterMap: function(data, type) {
                        return converters[type](data);
                    },
                    read: {
                        url: "http://krustev:8080/olap/msmdpump.dll",
                        dataType: "text",
                        contentType: "text/xml",
                        type: "POST"
                    }
                },
                schema: {
                    type: "xmla"
                },
                change: function() {
                   renderPivot(this.data());
               },
               error: function(e) {
                   alert("error: " + e.errors[0]);
               }
            });

            //dataSource.execute({ columns: [ { name: "[Date].[Calendar]", expand: true }, { name: "[Product].[Category]", expand: true } ], rows: [{ name: "[Product].[Product Name]", expand: true }], filter: {}, values: ["[Measures].[Internet Order Lines Count]", "[Measures].[Internet Total Discount Amount]"] });
           // dataSource.execute({ columns: ["[Date].[Calendar]"], rows: ["[Product].[Product Name]"], filter: {}, values: ["[Measures].[Internet Order Lines Count]"] });

            dataSource.read();

            $("button").click(function() {
                dataSource.expand("[Date].[Calendar]");
            });

            function renderHeader(nodeName, tuples) {
                var html = "";

                for (var j = 0; j < tuples[0].members.length;j++) {
                    html += "<tr>";
                    html += "<th></th>";

                    for (var idx = 0; idx < tuples.length; idx++) {
                        var members = tuples[idx].members;

                        html += kendo.format("<{0} class='k-header'>{1}</{0}>", nodeName, members[j].caption);
                    }
                    html += "</tr>";
                }

                return html;
            }

            function renderRowHeader(nodeName, axis) {
                var html = "";

                for (var idx = 0; idx < axis.length; idx++) {
                    var members = axis[idx].members;

                    for (var j = 0; j < members.length; j++) {
                        html += kendo.format("<{0} class='k-header'>{1}</{0}>", nodeName, members[j].caption);
                    }
                }

                return html;
            }

            function renderPivot(data) {
                var html = '<thead class="k-grid-header">';

                var columns = dataSource.axes().columns.tuples;
                var rows = dataSource.axes().rows.tuples;


                if (!rows.length) {
                    rows.push({ members: [] });
                }

                html += renderHeader("th", columns);

                html += "</thead>";

                html +="<tbody>";

                var cellData = data;

                for (var axisIndex = 0; axisIndex < rows.length; axisIndex++) {
                    html += "<tr>";

                    html += renderRowHeader("td", [rows[axisIndex]]);

                    var startIndex = axisIndex * columns.length;

                    for (var j = 0; j < columns.length; j++) {
                        html += "<td>" + (cellData[startIndex + j] || {}).fmtValue + "</td>";
                    }

                    html += "</tr>";
                }

                html +="</tbody>";


                $("#container").append($(html));
            }
        </script>
    </body>
</html>

