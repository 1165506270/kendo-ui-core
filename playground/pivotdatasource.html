<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>pivot columns</title>
        <script src="../src/jquery.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.core.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.data.odata.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.data.xml.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.data.js" type="text/javascript" charset="utf-8"></script>
        <script src="../src/kendo.pivotgrid.js" type="text/javascript" charset="utf-8"></script>
        <link rel="stylesheet" href="../dist/styles/web/kendo.common.css"/>
        <link rel="stylesheet/less" type="text/css" href="../dist/styles/web/kendo.default.less"/>
        <script src="../demos/mvc/content/shared/js/less.js"></script>
    </head>
    <body>
        <!--button>Expand</button-->
        <div class="k-grid k-widget" style="overflow: scroll;height: 1000px">
            <table id="container"></table>
        </div>

        <script>
/*           var PivotDataSource = kendo.data.PivotDataSource.extend({
               _readData: function(data) {
                    debugger;
                    var originalData = this._data;
                    var cellData = this.reader.data(data);
                    var axes = this.reader.axes(data);

                    this._axes = axes;

                    //merge data with this._data;
                    return cellData;
                },
                execute: function(descriptors) {
                    this.read($.extend({ columns: [], rows: [], measures: [], filter: {}}, descriptors));
                },
                discover: function(descriptors) {
                }
            });

*/
            var dataSource = new kendo.data.PivotDataSource({
                type: "xmla",
                columns: [{ name: "[Geography].[City]", expand: true }, { name: "[Date].[Calendar]", expand: true }],
                rows: [ { name: "[Product].[Product Name]", expand: true }, { name: "[Product].[Category]", expand: true }],
                measures: ["[Measures].[Internet Order Lines Count]"],
                transport: {
                    connection: {
                        catalog: "Adventure Works Internet Sales Model",
                        cube: "Adventure Works Internet Sales Model"
                    },
                    read: {
                        url: "http://krustev:8080/olap/msmdpump.dll",
                        dataType: "text",
                        contentType: "text/xml",
                        type: "POST"
                    }
                },
                schema: {
                    type: "xmla"
                },
                change: function() {
                   renderPivot(this.data());
               },
               error: function(e) {
                   alert("error: " + kendo.stringify(e.errors[0]));
               }
            });

            //dataSource.execute({ columns: [ { name: "[Date].[Calendar]", expand: true }, { name: "[Product].[Category]", expand: true } ], rows: [{ name: "[Product].[Product Name]", expand: true }], filter: {}, values: ["[Measures].[Internet Order Lines Count]", "[Measures].[Internet Total Discount Amount]"] });
           // dataSource.execute({ columns: ["[Date].[Calendar]"], rows: ["[Product].[Product Name]"], filter: {}, values: ["[Measures].[Internet Order Lines Count]"] });

            dataSource.read();

            $("button").click(function() {
                dataSource.expand("[Date].[Calendar]");
            });

            function renderHeader(nodeName, tuples) {
                var html = "";

                for (var j = 0; j < dataSource.columns().length;j++) {
                    html += "<tr>";
                    html += new Array(dataSource.rows().length + 1).join("<th class='k-header'></th>");

                    for (var idx = 0; idx < tuples.length; idx++) {
                        var members = tuples[idx].members;

                        html += kendo.format("<{0} class='k-header'>{1}</{0}>", nodeName, members[j].caption);
                    }
                    html += "</tr>";
                }

                return html;
            }

            function renderRowHeader(nodeName, axis) {
                var html = "";

                for (var idx = 0; idx < axis.length; idx++) {
                    var members = axis[idx].members;

                    for (var j = 0; j < members.length; j++) {
                        html += kendo.format("<{0} class='k-header'>{1}</{0}>", nodeName, members[j].caption);
                    }
                }

                return html;
            }

            function renderPivot(data) {
                var html = '<thead class="k-grid-header">';

                var columns = dataSource.axes().columns.tuples;
                var rows = dataSource.axes().rows.tuples;


                if (!rows.length) {
                    rows.push({ members: [] });
                }

                html += renderHeader("th", columns);

                html += "</thead>";

                html +="<tbody>";

                var cellData = data;

                for (var axisIndex = 0; axisIndex < rows.length; axisIndex++) {
                    html += "<tr>";

                    html += renderRowHeader("td", [rows[axisIndex]]);

                    var startIndex = axisIndex * columns.length;

                    for (var j = 0; j < columns.length; j++) {
                        html += "<td>" + (cellData[startIndex + j] || {}).fmtValue + "</td>";
                    }

                    html += "</tr>";
                }

                html +="</tbody>";


                $("#container").append($(html));
            }
        </script>
    </body>
</html>

