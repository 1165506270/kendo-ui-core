<!DOCTYPE html>
<html>
    <head>
        <title>Bar Chart</title>
        <script src="../src/jquery.js"></script>
        <script src="../src/kendo.core.js"></script>
        <script src="../src/kendo.data.js"></script>
        <script src="../src/kendo.dataviz.core.js"></script>
        <script src="../src/kendo.dataviz.chart.js"></script>
        <script src="../src/kendo.dataviz.themes.js"></script>
        <script src="../src/kendo.dataviz.vml.js"></script>
        <script src="../src/kendo.dataviz.svg.js"></script>
        <script src="../src/kendo.userevents.js"></script>
        <script src="../src/kendo.draganddrop.js"></script>
        <script src="../src/kendo.slider.js"></script>
        <link href="../styles/web/kendo.common.css" rel="stylesheet" />
        <link href="http://mvc-kendobuild/staging/content/cdn/styles/kendo.default.min.css" rel="stylesheet" />
        <style>
            .k-label { display: none; }
        </style>
    </head>
    <body>
        <div id="chart" style="width: 900px; height: 400px; -webkit-transform: translateZ(0);"></div>
        <div id="rangeslider" style="width: 845px; margin-left: 50px;">
            <input />
            <input />
        </div>
        <script>
            var updateCount = 0;
            var navigatorDataSource;
            var salesData = [];

            $(function() {
                function generate() {
                    var date = new Date("2009/01/01");
                    var endDate = new Date("2014/01/30");

                    while (date < endDate) {
                        var open = Math.random() * 400;
                        var close = open + (Math.random() * 100 * (Math.random() > 0.5 ? 1 : -1));
                        var high = open + 100;
                        var low = open - 100;
                        salesData.push({
                            date: date,
                            open: Math.round(open),
                            high: Math.round(high),
                            low: Math.round(low),
                            close: Math.round(close),
                            sales: Math.round(date.getYear() * 100 + Math.random() * 1000)
                        });

                        date = kendo.dataviz.addDuration(date, 1, "days");
                    }

                    return salesData;
                }

                var data = generate();

                navigatorDataSource = new kendo.data.DataSource({
                    data: data
                });
                navigatorDataSource.read();

                $("#chart").kendoChart({
                    dataSource: {
                        data: data/*,
                        filter: [{
                            field: "date",
                            operator: "gte",
                            value: new Date("2012/07/01")
                            }, {
                            field: "date",
                            operator: "lt",
                            value: new Date("2012/09/01")
                        }]*/
                    },
                    panes: [{
                        name: "top"
                    }, {
                        name: "bottom",
                        height: 80
                    }],
                    valueAxes: [{
                        name: "topValueAxis"
                    }, {
                        name: "bottomValueAxis",
                        pane: "bottom",
                        labels: {
                            visible: false
                        }
                    }],
                    categoryAxes: [{
                        type: "date",
                        field: "date",
                        // TODO: Validate base unit value
                        baseUnit: "days",
                        labels: {
                            visible: false
                            // TODO: Should be automatic. Based on axis and label size?
                            // step: 5
                        },
                        majorGridLines: {
                            //TODO: Implement
                            //step: 7
                        },
                        min: new Date("2012/01/01"),
                        max: new Date("2012/03/01")
                    }, {
                        type: "date",
                        field: "date",
                        labels: {
                            // TODO: Should be automatic. Based on axis and label size?
                            skip: 1,
                            step: 5
                        },
                        // TODO: Different rules apply for the navigator axis.
                        // Instead of days it should default to "detail chart" base unit + 1
                        baseUnit: "months",
                        name: "bottomCategoryAxis",
                        pane: "bottom"
                    }],
                    series: [{
                        type: "candlestick",
                        openField: "open",
                        highField: "high",
                        lowField: "low",
                        closeField: "close",
                        // TODO: Axis range is not updated when axis name is not specified
                        axis: "topValueAxis",
                        markers: {
                            visible: false
                        },
                        width: 1
                    }, {
                        type: "line",
                        axis: "bottomValueAxis",
                        categoryAxis: "bottomCategoryAxis",
                        data: $.map(navigatorDataSource.view(), function(item) {
                            return item.sales;
                        }),
                        markers: {
                            visible: false
                        },
                        // TODO: Implement
                        dataSource: {
                            data: data
                        }
                    }],
                    legend: {
                        visible: false
                    },
                    tooltip: {
                        visible: true
                    },
                    transitions: false
                });

                function sliderChange(e) {
                    var chart = $("#chart").data("kendoChart");
                    var detailAxis = chart.options.categoryAxes[0];
                    detailAxis.min = kendo.dataviz.addDuration(
                        new Date("2009/01/01"),
                        e.values[0],
                        "months"
                    );

                    detailAxis.max = kendo.dataviz.addDuration(
                        new Date("2009/01/01"),
                        e.values[1],
                        "months"
                    );

                    var diff = e.values[1] - e.value[0];
                    if (diff > 30) {
                        detailAxis.baseUnit = "months";
                    } else if (diff > 5){
                        detailAxis.baseUnit = "weeks";
                    } else{
                        detailAxis.baseUnit = "days";
                    }

                    chart.refresh();
                    /*
                    dataSource.filter([{
                            field: "date",
                            operator: "gte",
                            value: kendo.dataviz.addDuration(new Date("2012/07/01"), e.value, "days")
                        }, {
                            field: "date",
                            operator: "lt",
                            value: kendo.dataviz.addDuration(new Date("2012/09/01"), e.value, "days")
                        }
                    ]);
                    */
                }
                $("#rangeslider").kendoRangeSlider({
                    change: sliderChange,
                    min: 0,
                    max: 60,
                    smallStep: 1,
                    largeStep: 10,
                    selectionStart: 36,
                    selectionEnd: 39,
                    tooltip: {
                        template: "#= formatTooltip(selectionStart, selectionEnd) #"
                    }
                });
            });

            function formatTooltip(from, to) {
                var min = kendo.dataviz.addDuration(
                    new Date("2009/01/01"),
                    from,
                    "months"
                );

                var max = kendo.dataviz.addDuration(
                    new Date("2009/01/01"),
                    to,
                    "months"
                );

                return kendo.toString(min, "d") + " " + kendo.toString(max, "d");
            }
        </script>
    </body>
</html>

