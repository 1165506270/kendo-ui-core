<!DOCTYPE html>
<html>
    <head>
        <title>code 128A tests</title>
        <script src="../../jquery-loader.js"></script>
        <script src="../..//qunit/qunit/qunit.js"></script>
        <script src="../../qunit/addons/close-enough/qunit-close-enough.js"></script>
        <script src="../../kendo-test-helpers.js"></script>
        <link href="../../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../../src/kendo.core.js"></script>
        <script src="../../../src/kendo.dataviz.core.js"></script>
        <script src="../../../src/kendo.dataviz.barcode.js"></script>
        <script src="constants.js"></script>
        <script src="utils.js"></script>

        <script type="text/javascript">
            var dataviz = kendo.dataviz,
                encodings = dataviz.encodings;

            (function() {
                var encoding,
                    characters = {
                        /* A */"65": [[BAR,1],[SPACE, 1],[BAR,1],[SPACE, 3],[BAR,2],[SPACE, 3]],
                        /* B */"66": [[BAR,1],[SPACE, 3],[BAR,1],[SPACE, 1],[BAR,2],[SPACE, 3]],
                        /* E */"69": [[BAR,1],[SPACE, 3],[BAR,2],[SPACE, 1],[BAR,1],[SPACE, 3]],
                        /* K */"75": [[BAR,1],[SPACE, 1],[BAR,2],[SPACE, 3],[BAR,3],[SPACE, 1]],
                        /* L */"76": [[BAR,1],[SPACE, 3],[BAR,2],[SPACE, 1],[BAR,3],[SPACE, 1]],
                        /* S */"83": [[BAR,2],[SPACE, 1],[BAR,3],[SPACE, 1],[BAR,1],[SPACE, 3]],
                        /* T */"84": [[BAR,2],[SPACE, 1],[BAR,3],[SPACE, 3],[BAR,1],[SPACE, 1]],
                        /* X */"88": [[BAR,3],[SPACE, 3],[BAR,1],[SPACE, 1],[BAR,2],[SPACE, 1]],
                        /* Z */"90": [[BAR,3],[SPACE, 1],[BAR,2],[SPACE, 3],[BAR,1],[SPACE, 1]],
                        /* < */"60": [[BAR,3],[SPACE, 2],[BAR,2],[SPACE, 1],[BAR,1],[SPACE, 2]],
                        /* = */"61": [[BAR,3],[SPACE, 2],[BAR,2],[SPACE, 2],[BAR,1],[SPACE, 1]],
                        /* @ */"64": [[BAR,2],[SPACE, 3],[BAR,2],[SPACE, 1],[BAR,2],[SPACE, 1]],
                        /* 0 */"48": [[BAR,1],[SPACE, 2],[BAR,3],[SPACE, 1],[BAR,2],[SPACE, 2]],
                        /* 3 */"51": [[BAR,2],[SPACE, 2],[BAR,1],[SPACE, 1],[BAR,3],[SPACE, 2]],
                        /* 7 */"55": [[BAR,3],[SPACE, 1],[BAR,2],[SPACE, 1],[BAR,3],[SPACE, 1]],
                        /* ^ */"94": [[BAR,4],[SPACE, 3],[BAR,1],[SPACE, 1],[BAR,1],[SPACE, 1]],
                        /* _ */"95": [[BAR,1],[SPACE, 1],[BAR,1],[SPACE, 2],[BAR,2],[SPACE, 4]],
                        /* ' */"39": [[BAR,1],[SPACE, 2],[BAR,2],[SPACE, 3],[BAR,1],[SPACE, 2]],
                        /* # */"35": [[BAR,1],[SPACE, 2],[BAR,1],[SPACE, 2],[BAR,2],[SPACE, 3]],
                        /* SPACE */"32": [[BAR,2],[SPACE, 1],[BAR,2],[SPACE, 2],[BAR,2],[SPACE, 2]],
                        /* NUL */"0": [[BAR,1],[SPACE, 1],[BAR,1],[SPACE, 4],[BAR,2],[SPACE, 2]],
                        /* LF */"10": [[BAR,1],[SPACE, 4],[BAR,2],[SPACE, 2],[BAR,1],[SPACE, 1]],
                        /* DC1 */"17": [[BAR,1],[SPACE, 2],[BAR,1],[SPACE, 1],[BAR,4],[SPACE, 2]],
                        /* DC4 */"20": [[BAR,1],[SPACE, 2],[BAR,4],[SPACE, 1],[BAR,1],[SPACE, 2]],
                        /* ESC */"27": [[BAR,4],[SPACE, 1],[BAR,2],[SPACE, 1],[BAR,2],[SPACE, 1]],
                            START: [[BAR,2],[SPACE, 1],[BAR,1],[SPACE, 4],[BAR,1],[SPACE, 2]],
                            STOP: [[BAR,2],[SPACE, 3],[BAR,3],[SPACE, 1],[BAR,1],[SPACE, 1],[BAR, 2]]
                    };

                function calculateCheckSum(value){
                    var sum = 103;
                    for(var i = 0; i< value.length; i++){
                        ascii = value.charCodeAt(i);
                        if(ascii < 32){
                            sum+= (i+1)*(ascii + 64);
                        }
                        else{
                            sum+= (i+1)*(ascii - 32);
                        }
                    }
                    return sum % 103;
                }

                function generateResult(value, checkValue, options){
                    var expectedResult = [];
                    if(options.quietZoneLength){
                        expectedResult.push([SPACE, options.quietZoneLength]);
                    }

                    expectedResult.pushArray(characters.START);

                    for( var i = 0; i < value.length; i++){
                        expectedResult.pushArray(characters[value.charCodeAt(i)]);
                    }

                    expectedResult.pushArray(characters[checkValue.charCodeAt(0)]);


                    expectedResult.pushArray(characters.STOP);

                    if(options.quietZoneLength){
                        expectedResult.push([SPACE, options.quietZoneLength]);
                    }

                    return expectedResult;
                }

                module("128A", {
                    setup: function() {
                        encoding = new encodings.code128a();
                    },
                    teardown: function(){
                        encoding = null;
                    }
                });

                test("test value TESTA", function() {
                    var value = "TESTA",
                        result = encoding.encode(value, 300, 100),
                        expectedResult = generateResult(value,"B",
                            {quietZoneLength: encoding.options.quietZoneLength });

                    ok(comparePatterns(result.pattern, expectedResult));
                });

                test("test value BEXZ<=0 ", function() {
                    var value = "BEXZ<=0",
                        result = encoding.encode(value, 300, 100),
                        expectedResult = generateResult(value, "'",
                            {quietZoneLength: encoding.options.quietZoneLength });

                    ok(comparePatterns(result.pattern, expectedResult));
                });

                test("test value ' (NUL)@(LF)(ESC)^KL' ", function() {
                    var value = " " + String.fromCharCode(0) + "@" + String.fromCharCode(10) + String.fromCharCode(27) + "^KL",
                        result = encoding.encode(value, 300, 100),
                        expectedResult = generateResult(value, "K",
                            {quietZoneLength: encoding.options.quietZoneLength });

                    ok(comparePatterns(result.pattern, expectedResult));
                });

                test("test value (_730(DC1)#') ", function() {
                    var value = "_730" + String.fromCharCode(17) + "#'",
                        result = encoding.encode(value, 300, 100),
                        expectedResult = generateResult(value, String.fromCharCode(20),
                            {quietZoneLength: encoding.options.quietZoneLength });

                    ok(comparePatterns(result.pattern, expectedResult));
                });


                test("test invalid character error", function() {
                    var thrownError = false;
                    try{
                        encoding.encode("AASaT*", 300, 100);
                    }
                    catch (ex){
                        thrownError = true;
                    }
                    ok(thrownError);
                });

                test("test base unit calculation", function() {
                    var width = 200,
                        height = 100,
                        value = "_730" + String.fromCharCode(17) + "#'",
                        quietZoneLength = encoding.options.quietZoneLength,
                        result,
                        resultWithoutQuietZone,
                        expectedResult = fixed(width / (112 + 2 * quietZoneLength), 2),
                        expectedResultWithoutQuietZone = 1.79;

                        encoding.options.addQuietZone = true;
                        result = encoding.encode(value, width, height).baseUnit;
                        equal(fixed(result, 2), expectedResult);

                        encoding.options.addQuietZone = false;
                        resultWithoutQuietZone = encoding.encode(value, width, height).baseUnit;
                        equal(fixed(resultWithoutQuietZone, 2), expectedResultWithoutQuietZone);
                });

            })();
        </script>

        <h1 id="qunit-header">encoding 128A</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <div id="container" style="width: 600px; height: 400px">
        </div>
    </body>
</html>
