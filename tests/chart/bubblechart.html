<!DOCTYPE html>
<html>
    <head>
        <title>kendo.chart</title>
        <script src="../jquery-loader.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit/addons/close-enough/qunit-close-enough.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.dataviz.core.js"></script>
        <script src="../../src/kendo.dataviz.chart.js"></script>
        <script src="../../src/kendo.dataviz.themes.js"></script>
        <script src="../../src/kendo.dataviz.svg.js"></script>
        <script src="../../src/kendo.dataviz.vml.js"></script>
        <script src="util.js"></script>

        <script type="text/javascript">
            var dataviz = kendo.dataviz,
                Box2D = dataviz.Box2D,
                chartBox = new Box2D(0, 0, 800, 600),
                plotArea,
                bubbleChart,
                firstPoint,
                root,
                view,
                TOLERANCE = 1;

            function setupBubbleChart(plotArea, options) {
                view = new ViewStub();

                bubbleChart = new dataviz.BubbleChart(plotArea, options);

                root = new dataviz.RootElement();
                root.append(bubbleChart);

                bubbleChart.reflow(chartBox);
                bubbleChart.getViewElements(view);

                firstPoint = bubbleChart.points[0];
            }

            (function() {
                var TOLERANCE = 1;
                var series = { data: [{
                        x: 1, y: 10, size: 100, category: "a",
                        color: "red"
                    }, {
                        x: 2, y: 2, size: 0, category: "b"
                    }, {
                        x: 3, y: 3, size: 20, category: "b"
                    }],
                    type: "bubble",
                    minSize: 10,
                    maxSize: 110
                };

                function PlotAreaStub() { }

                $.extend(PlotAreaStub.prototype, {
                    axisX: {
                        getSlot: function(categoryIndex) {
                            return new Box2D(0, 0, categoryIndex + 1, 0);
                        }
                    },
                    axisY: {
                        getSlot: function(value) {
                            return new Box2D(0, 1, 0, value);
                        },
                        options: {}
                    },
                    options: {}
                });

                // ------------------------------------------------------------
                module("Bubble Chart / Points", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupBubbleChart(plotArea, { series: [ series ] });
                    }
                });

                test("Bubbles with negative size are hidden", function() {
                    setupBubbleChart(plotArea, { series: [{
                            data: [{x: 1, y: 1, size: -100}],
                            negativeValues: { visible: false },
                            type: "bubble"
                        }]
                    });

                    equal(bubbleChart.points.length, 0);
                });

                test("Maximum bubble diameter is set to maxSize", function() {
                    close(firstPoint.options.markers.size, 110, TOLERANCE);
                });

                test("Minimum bubble diameter is set to minSize", function() {
                    close(bubbleChart.points[1].options.markers.size, 10, TOLERANCE);
                });

                test("Default maximum bubble diameter is proportional to box size", function() {
                    setupBubbleChart(plotArea, { series: [{
                            data: [{x: 1, y: 1, size: 100}],
                            type: "bubble"
                        }]
                    });

                    close(firstPoint.options.markers.size, 120, TOLERANCE);
                });

                test("Default minimum bubble diameter is proportional to box size", function() {
                    setupBubbleChart(plotArea, { series: [{
                            data: [{x: 1, y: 1, size: 10}, {x: 1, y: 1, size: 100}],
                            type: "bubble"
                        }]
                    });

                    close(firstPoint.options.markers.size, 40, TOLERANCE);
                });

                test("Default minimum bubble diameter is floored to 10", function() {
                    setupBubbleChart(plotArea, { series: [{
                            data: [{x: 1, y: 1, size: 10}, {x: 1, y: 1, size: 100}],
                            type: "bubble"
                        }]
                    });

                    bubbleChart.reflow(new Box2D());
                    close(firstPoint.options.markers.size, 10, TOLERANCE);
                });

                test("Bubble diameter is proportional to size value", function() {
                    close(bubbleChart.points[2].options.markers.size, 50, TOLERANCE);
                });

                test("zIndex is higher for smaller bubbles", function() {
                    ok(bubbleChart.points[1].options.markers.zIndex >
                       firstPoint.options.markers.zIndex);
                });

                test("Color is set for bubbles with negative size", function() {
                    setupBubbleChart(plotArea, { series: [{
                            data: [{x: 1, y: 1, size: -100}],
                            negativeValues: { visible: true, color: "red" },
                            type: "bubble"
                        }]
                    });

                    equal(firstPoint.color, "red");
                });

                test("Color is set in options", function() {
                    equal(firstPoint.options.color, "red");
                });

                test("format variable {0} returns x", function() {
                    equal(firstPoint.formatValue("{0}"), 1);
                });

                test("format variable {1} returns y", function() {
                    equal(firstPoint.formatValue("{1}"), 10);
                });

                test("format variable {2} returns size", function() {
                    equal(firstPoint.formatValue("{2}"), 100);
                });

                test("format variable {3} returns category", function() {
                    equal(firstPoint.formatValue("{3}"), "a");
                });

                // ------------------------------------------------------------
                module("Bubble Chart / Points / Rendering", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupBubbleChart(plotArea, { series: [ series ] });
                    }
                });

                test("highlightOverlay renders a circle", function() {
                    ok(firstPoint.highlightOverlay(view).c);
                });

                test("renders top-level group", function() {
                    equal(view.log.group.length, 1);
                });

                // ------------------------------------------------------------
                module("Bubble Chart / Points / Highlight", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupBubbleChart(plotArea, { series: [ series ] });
                    }
                });

                test("highlightOverlay renders a transparent circle", function() {
                    equal(firstPoint.highlightOverlay(view).options.fill, undefined);
                });

                test("highlightOverlay renders a circle with 1 border smaller diameter", function() {
                    firstPoint.options.highlight.border.width = 2;
                    var outline = firstPoint.highlightOverlay(view);

                    equal(outline.r, firstPoint.options.markers.size / 2 - 1);
                });

                test("highlightOverlay renders default border width", function() {
                    var outline = firstPoint.highlightOverlay(view);

                    equal(outline.options.strokeWidth, 1);
                });

                test("highlightOverlay renders custom border width", function() {
                    firstPoint.options.highlight.border.width = 2;
                    var outline = firstPoint.highlightOverlay(view);

                    equal(outline.options.strokeWidth, 2);
                });

                test("highlightOverlay renders default border color (computed)", function() {
                    firstPoint.options.markers.background = "#ffffff";
                    var outline = firstPoint.highlightOverlay(view);

                    equal(outline.options.stroke, "#cccccc");
                });

                test("highlightOverlay renders custom border color", function() {
                    firstPoint.options.highlight.border.color = "red";
                    var outline = firstPoint.highlightOverlay(view);

                    equal(outline.options.stroke, "red");
                });

                test("highlightOverlay renders default border opacity", function() {
                    var outline = firstPoint.highlightOverlay(view);

                    equal(outline.options.strokeOpacity, 1);
                });

                test("highlightOverlay renders custom border opacity", function() {
                    firstPoint.options.highlight.border.opacity = 0.5;
                    var outline = firstPoint.highlightOverlay(view);

                    equal(outline.options.strokeOpacity, 0.5);
                });
            })();

            (function() {
                var data = [{
                        xValue: 1,
                        yValue: 10,
                        sizeValue: 100,
                        pointColor: "red"
                    }, {
                        xValue: 2,
                        yValue: 20,
                        sizeValue: 200,
                        pointColor: "blue"
                    }],
                    points;

                function createBubbleChart(bubbleSeries) {
                    $("#container").kendoChart({
                        dataSource: {
                            data: data
                        },
                        series: [kendo.deepExtend({
                            type: "bubble"
                        }, bubbleSeries)]
                    });

                    var chart = $("#container").data("kendoChart");
                    points = chart._plotArea.charts[0].points;
                }

                // ------------------------------------------------------------
                module("Bubble Chart / Data Binding / Data Source", {
                    teardown: function() {
                        $("#container").empty();
                    }
                });

                test("binds to 3-element array", function() {
                    createBubbleChart({
                        data: [[1, 10, 100], [2, 20, 200]]
                    });

                    deepEqual(points[1].value, { x: 2, y: 20, size: 200 });
                });

                test("binds x, y and size field", function() {
                    createBubbleChart({
                        xField: "xValue",
                        yField: "yValue",
                        sizeField: "sizeValue"
                    });

                    deepEqual(points[1].value, { x: 2, y: 20, size: 200 });
                });

                test("binds color field", function() {
                    createBubbleChart({
                        xField: "xValue",
                        yField: "yValue",
                        sizeField: "sizeValue",
                        colorField: "pointColor"
                    });

                    deepEqual(points[1].color, "blue");
                });

                test("binds category field", function() {
                    createBubbleChart({
                        xField: "xValue",
                        yField: "yValue",
                        sizeField: "sizeValue",
                        categoryField: "pointColor"
                    });

                    deepEqual(points[1].category, "blue");
                });

                test("binds to object with x, y and size fields", function() {
                    createBubbleChart({
                        data: [{x: 1, y: 10, size: 100}, {x: 2, y: 20, size: 200}]
                    });

                    deepEqual(points[1].value, { x: 2, y: 20, size: 200 });
                });

                test("binds color to object field", function() {
                    createBubbleChart({
                        data: [{ x: 1, y: 10, size: 100, color: "red" }]
                    });

                    deepEqual(points[0].color, "red");
                });

                test("binds category to object field", function() {
                    createBubbleChart({
                        data: [{ x: 1, y: 10, size: 100, category: "UK" }]
                    });

                    deepEqual(points[0].category, "UK");
                });

            })();

            (function() {
                var data = [{
                        xValue: 1,
                        yValue: 10,
                        sizeValue: 100
                    }, {
                        xValue: 2,
                        yValue: 20,
                        sizeValue: 200
                    }],
                    points,
                    bubbleChart,
                    legend;

                function createBubbleChart(options) {
                    $("#container").kendoChart(
                        kendo.deepExtend({}, {
                            dataSource: {
                                data: data
                            },
                            series: [{
                                type: "bubble",
                                xField: "xValue",
                                yField: "yValue",
                                sizeField: "sizeValue",
                                name: "A",
                                test: "test"
                            }]
                        }, options)
                    );

                    var chart = $("#container").data("kendoChart");
                    points = chart._plotArea.charts[0].points;
                    bubbleChart = chart._plotArea.charts[0];
                    legend = chart._model.children[0];
                }

                // ------------------------------------------------------------
                module("Bubble Chart / Configuration", {
                    teardown: function() {
                        $("#container").empty();
                    }
                });

                test("tooltip options are applied to points", function() {
                    createBubbleChart({
                        tooltip: {
                            format: "a"
                        }
                    });

                    deepEqual(points[0].options.tooltip.format, "a");
                });

                test("sets legend item name from dataItem", function() {
                    createBubbleChart({
                        legend: {
                            labels: {
                                template: "#= text #-#= series.test #"
                            }
                        }
                    });

                    equal(legend.options.items[0].name, "A-test");
                });

            })();

        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <div id="container">
        </div>
    </body>
</html>
