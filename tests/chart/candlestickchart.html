<!DOCTYPE html>
<html>
    <head>
        <title>kendo.chart</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.dataviz.core.js"></script>
        <script src="../../src/kendo.dataviz.chart.js"></script>
        <script src="../../src/kendo.dataviz.themes.js"></script>
        <script src="../../src/kendo.dataviz.svg.js"></script>
        <script src="../../src/kendo.dataviz.vml.js"></script>
        <script src="util.js"></script>
        <script type="text/javascript">
            var dataviz = kendo.dataviz,
                Box2D = dataviz.Box2D,
                categoriesCount = dataviz.categoriesCount,
                chartBox = new Box2D(0, 0, 800, 600),
                candlestickChart,
                root,
                view,
                TOLERANCE = 1;

            function setupCandlestickChart(plotArea, options) {
                view = new ViewStub();

                candlestickChart = new dataviz.CandlestickChart(plotArea, options);

                root = new dataviz.RootElement();
                root.append(candlestickChart);

                candlestickChart.reflow();
                candlestickChart.getViewElements(view);
            }

            function stubPlotArea(getCategorySlot, getValueSlot, options) {
                return new function() {
                    this.categoryAxis = this.primaryCategoryAxis = {
                        getSlot: getCategorySlot,
                        options: {
                            axisCrossingValue: 0,
                            categories: options.categoryAxis.categories
                        }
                    };

                    this.valueAxis = {
                        getSlot: getValueSlot,
                        options: {
                            axisCrossingValue: 0
                        }
                    };

                    this.namedCategoryAxes = { };
                    this.namedValueAxes = {};

                    this.seriesCategoryAxis = function(series) {
                        return series.categoryAxis ?
                            this.namedCategoryAxes[series.categoryAxis] : this.primaryCategoryAxis;
                    };

                    this.options = options;
                };
            }

            (function() {
                var series = { data: [[2,4,1,3]], type: "candlestick" },
                    VALUE_AXIS_MAX = 4,
                    CATEGORY_AXIS_Y = 2;

                var plotArea = stubPlotArea(
                    function(categoryIndex) {
                        return new Box2D(categoryIndex, CATEGORY_AXIS_Y,
                                         categoryIndex + 1, CATEGORY_AXIS_Y);
                    },
                    function(value) {
                        var value = typeof value === "undefined" ? 0 : value,
                            valueY = VALUE_AXIS_MAX - value,
                            slotTop = Math.min(CATEGORY_AXIS_Y, valueY),
                            slotBottom = Math.max(CATEGORY_AXIS_Y, valueY);

                        return new Box2D(0, slotTop, 0, slotBottom);
                    }, {
                        categoryAxis: {
                            categories: ["A", "B"]
                        }
                    }
                );

                // ------------------------------------------------------------
                module("Candlestick Chart", {
                    setup: function() {
                        setupCandlestickChart(plotArea, { series: [ series ] });
                    }
                });

                test("creates points for candlestickChart data points", function() {
                    equal(candlestickChart.points.length, series.data.length);
                });

                test("reports minimum series value for default axis", function() {
                    same(candlestickChart.valueAxisRanges[undefined].min, series.data[0][2]);
                });

                test("reports maximum series value for default axis", function() {
                    same(candlestickChart.valueAxisRanges[undefined].max, series.data[0][1]);
                });

                test("reports number of categories", function() {
                    setupCandlestickChart(plotArea, { series: [ series ]});
                    equal(categoriesCount(candlestickChart.options.series), series.data.length);
                });

                test("sets point owner", function() {
                    ok(candlestickChart.points[0].owner === candlestickChart);
                });

                test("sets point series", function() {
                    ok(candlestickChart.points[0].series === series);
                });

                test("sets point series index", function() {
                    ok(candlestickChart.points[0].seriesIx === 0);
                });

                test("sets point category", function() {
                    equal(candlestickChart.points[0].category, "A");
                });

                test("sets point dataItem", function() {
                    equal(typeof candlestickChart.points[0].dataItem, "object");
                });

                // ------------------------------------------------------------
                module("Candlestick Chart / Rendering", {
                    setup: function() {
                        setupCandlestickChart(plotArea, {
                            series: [ $.extend({
                                line: {
                                    width: 4,
                                    color: "lineColor",
                                    opacity: 0.5,
                                    dashType: "dot"
                                },
                                color: "rectColor",
                                border: {
                                    color: "borderColor",
                                    width: 2,
                                    opacity: 0.2,
                                    dashType: "dot"
                                }
                            },
                            series)]
                        });
                    }
                });

                test("sets line width", function() {
                    equals(view.log.path[0].style.strokeWidth, 4);
                });

                test("sets line color", function() {
                    equals(view.log.path[0].style.stroke, "lineColor");
                });

                test("sets line opacity", function() {
                    equals(view.log.path[0].style.strokeOpacity, 0.5);
                });

                test("sets line dashType", function() {
                    equals(view.log.path[0].style.dashType, "dot");
                });

                test("sets rect border", function() {
                    equals(view.log.rect[0].style.strokeWidth, 2);
                    equals(view.log.rect[0].style.stroke, "borderColor");
                    equals(view.log.rect[0].style.strokeOpacity, 0.2);
                    equals(view.log.rect[0].style.dashType, "dot");
                });

                test("sets rect color(open < close)", function() {
                    equals(view.log.rect[0].style.fill, "rectColor");
                });

                test("sets rect base body color(open > close)", function() {
                    setupCandlestickChart(plotArea, {
                        series: [{
                            type: "candlestick",
                            data: [[3,4,1,2]],
                            baseColor: "baseColor"
                        }]
                    });

                    equals(view.log.rect[0].style.fill, "baseColor");
                });

                test("overlay rect has same model id as its segment", function() {
                    equals(view.log.rect[1].style.data.modelId, candlestickChart.points[0].options.modelId);
                });

                test("renders chart group", function() {
                    equals(view.log.group.length, 1);
                });

                test("sets group animation", function() {
                    equals(view.log.group[0].options.animation.type, "clip");
                });

            })();

            (function() {
                var candlestickChart,
                    MARGIN = PADDING = BORDER = 5,
                    candlestick;

                var plotArea = stubPlotArea(
                    function(categoryIndex) {
                        return new Box2D();
                    },
                    function(value) {
                        return new Box2D();
                    },
                    {
                        categoryAxis: { }
                    }
                );

                function createCandlestickChart(options) {
                    candlestickChart = new dataviz.CandlestickChart(plotArea, {
                        series: [$.extend({
                            data: [[1,4,2,3]],
                            border: {
                                opacity: 0.5,
                                dashType: "dot",
                            },
                            line: {
                                dashType: "dot",
                                color: "red",
                                opacity: 0.7,
                                width: 0.2
                            },
                            color: "#f00",
                            opacity: 0.2,
                            type: "candlestick"
                        }, options)]
                    });
                    candlestick = candlestickChart.points[0];
                }

                // ------------------------------------------------------------
                module("Candlestick Chart / Configuration", {
                    setup: function() {
                        createCandlestickChart();
                    }
                });

                test("applies series color to point", function() {
                    equal(candlestick.options.color, "#f00");
                });

                test("applies opacity to point", function() {
                    equal(candlestick.options.opacity, 0.2);
                });

                test("applies border color to point", function() {
                    createCandlestickChart({ border: { color: "point-border" } });
                    equal(candlestick.options.border.color, "point-border");
                });

                test("applies dashType", function() {
                    equal(candlestick.options.border.dashType, "dot");
                });

                test("applies line dashType", function() {
                    equal(candlestick.options.line.dashType, "dot");
                });

                test("applies line color", function() {
                    equal(candlestick.options.line.color, "red");
                });

                test("applies line width", function() {
                    equal(candlestick.options.line.width, 0.2);
                });

                test("applies line opacity", function() {
                    equal(candlestick.options.line.opacity, 0.7);
                });

            })();

            (function() {
                var Candlestick = dataviz.Candlestick,
                    point,
                    box,
                    label,
                    root,
                    VALUE = {
                        open: 2,
                        high: 4,
                        low: 1,
                        close: 3

                    },
                    TOOLTIP_OFFSET = 5,
                    CATEGORY = "A",
                    SERIES_NAME = "series";

                function createPoint(options) {
                    point = new Candlestick(VALUE,
                        $.extend(true, {
                            labels: { font: SANS12 }
                        }, options)
                    );

                    point.category = CATEGORY;
                    point.dataItem = { value: VALUE };
                    point.series = { name: SERIES_NAME };

                    point.owner = {
                        formatPointValue: function(point, tooltipFormat) {
                            return kendo.dataviz.autoFormat(tooltipFormat, point.value);
                        },
                        seriesValueAxis: function(series) {
                            return {
                                getSlot: function(a,b) {
                                    return new Box2D();
                                }
                            };
                        }
                    }

                    box = new Box2D(0, 0, 100, 100);
                    point.reflow(box);

                    root = new dataviz.RootElement();
                    root.append(point);
                }

                // ------------------------------------------------------------
                module("Candlestick", {
                    setup: function() {
                        createPoint();
                    }
                });

                test("is discoverable", function() {
                    ok(point.options.modelId);
                });

                test("sets point border width", function() {
                    createPoint({ border: { width: 4 } });
                    equals(point.options.border.width, 4);
                });

                test("sets point opacity", function() {
                    createPoint({ opacity: 0.5 });
                    same(point.options.opacity, 0.5);
                });

                test("sets point id", function() {
                    ok(point.options.id.length > 0);
                });

                test("point has same model id", function() {
                    view = new ViewStub();

                    point.getViewElements(view);
                    equals(view.log.rect[1].style.data.modelId, point.options.modelId);
                });

                test("tooltipAnchor is at top right of point", function() {
                    var anchor = point.tooltipAnchor(10, 10);
                    same([anchor.x, anchor.y],
                         [point.box.x2 + TOOLTIP_OFFSET, point.box.y1 + TOOLTIP_OFFSET], TOLERANCE)
                });

            })();

        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <div id="container" style="width: 600px; height: 400px">
        </div>
    </body>
</html>
