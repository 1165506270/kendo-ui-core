<!DOCTYPE html>
<html>
    <head>
        <title>UI5.Chart Tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.chart.js"></script>
        <script src="util.js"></script>
        <script type="text/javascript">

            var Chart = kendo.ui.Chart,
                EMPTY_DIV = "<div id='container' style='width: 0px; height: 0px; line-height: 0px;'></div>";

            (function() {
                var chart,
                    plotArea;

                function createChart(options) {
                    $("#container").kendoChart(options);

                    chart = $("#container").data("kendoChart");

                    plotArea = chart._model.children[1];
                }

                function createBarChart(options) {
                    createChart($.extend({
                        series: [{
                            type: "bar",
                            data: [1, 2]
                        }]
                    }, options));
                }

                function createScatterChart(options) {
                    createChart($.extend({
                        series: [{
                            type: "scatter",
                            data: [[1, 1]]
                        }]
                    }, options));
                }

                function destroyChart() {
                    $("#container").empty();
                    chart = null;
                }

                // ------------------------------------------------------------
                module("View", {
                    setup: function() {
                        createChart();
                    }
                });

                test("SVGView is created if browser supports SVG", function() {
                    Chart.prototype._supportsSVG = function() { return true; };
                    createChart();
                    ok(chart._view instanceof Chart.SVGView);
                });

                test("VMLView is created if browser does not support SVG", function() {
                    Chart.prototype._supportsSVG = function() { return false; };
                    createChart();
                    ok(chart._view instanceof Chart.VMLView);
                });

                test("sets dimensions on view element", 2, function() {
                    var view = chart._view;
                    equals(view.options.width, 600);
                    equals(view.options.height, 400);
                });

                // ------------------------------------------------------------
                module("Category Axis Configuration", {
                    teardown: destroyChart
                });

                test("categories are set", function() {
                    createChart({
                        categoryAxis: {
                            categories: ["Alpha", "Beta", "Charlie"]
                        }
                    });

                    same(plotArea.axisX.options.categories,
                         chart.options.categoryAxis.categories);
                });

                test("category axis is rendered horizontally by default", function() {
                    createChart();
                    ok(plotArea.axisX instanceof Chart.CategoryAxis);
                });

                test("categories are empty by default", function() {
                    createChart();

                    equal(plotArea.axisX.options.categories.length, 0);
                });

                // ------------------------------------------------------------
                module("Value Axis Configuration", {
                    teardown: destroyChart
                });

                test("default value axis type is Numeric", function() {
                    createChart();
                    equal(plotArea.axisY.options.type, "Numeric");
                });

                test("value axis is rendered vertically by default", function() {
                    createChart();
                    ok(plotArea.axisY instanceof Chart.NumericAxis);
                });

                // ------------------------------------------------------------
                module("X Axis Configuration", {
                    teardown: destroyChart
                });

                test("xAxis options are applied to X Axis", function() {
                    createChart({
                        xAxis: {
                            categories: ["Alpha", "Beta", "Charlie"]
                        }
                    });

                    same(plotArea.axisX.options.categories,
                         chart.options.xAxis.categories);
                });

                // ------------------------------------------------------------
                module("Y Axis Configuration", {
                    teardown: destroyChart
                });

                test("yAxis options are applied to Y Axis", function() {
                    createChart({
                        yAxis: {
                            min: 100
                        }
                    });

                    same(plotArea.axisY.options.min,
                         chart.options.yAxis.min);
                });

                // ------------------------------------------------------------
                module("Axis Configuration / Scatter Chart", {
                    teardown: destroyChart
                });

                test("xAxis settings are applied to X Axis", function() {
                    createScatterChart({ xAxis: { min: 100 } });
                    same(plotArea.axisX.options.min, 100);
                });

                test("xAxis orientation can't be set to vertical", function() {
                    createScatterChart({ xAxis: { orientation: "vertical" } });
                    same(plotArea.axisX.options.orientation, "horizontal");
                });

                test("yAxis settings are applied to Y Axis", function() {
                    createScatterChart({ yAxis: { min: 100 } });
                    same(plotArea.axisY.options.min, 100);
                });

                test("yAxis orientation can't be set to horizontal", function() {
                    createScatterChart({ yAxis: { orientation: "horizontal" } });
                    same(plotArea.axisY.options.orientation, "vertical");
                });

                // ------------------------------------------------------------
                module("Axis defaults", {
                    teardown: destroyChart
                });

                test("axisDefaults are applied to categoryAxis", function() {
                    createChart({
                        axisDefaults: {
                            flag: true
                        }
                    });

                    ok(chart.options.categoryAxis.flag === true);
                });

                test("axisDefaults are applied to valueAxis", function() {
                    createChart({
                        axisDefaults: {
                            flag: true
                        }
                    });

                    ok(chart.options.valueAxis.flag === true);
                });

                test("axisDefaults are applied to xAxis", function() {
                    createChart({
                        axisDefaults: {
                            flag: true
                        }
                    });

                    ok(chart.options.xAxis.flag === true);
                });

                test("axisDefaults are applied to yAxis", function() {
                    createChart({
                        axisDefaults: {
                            flag: true
                        }
                    });

                    ok(chart.options.yAxis.flag === true);
                });

                test("categoryAxis settings override axisDefaults settings", function() {
                    createChart({
                        axisDefaults: {
                            flag: false
                        },
                        categoryAxis: {
                            flag: true
                        }
                    });

                    ok(chart.options.categoryAxis.flag === true);
                });

                test("valueAxis settings override axisDefaults settings", function() {
                    createChart({
                        axisDefaults: {
                            flag: false
                        },
                        valueAxis: {
                            flag: true
                        }
                    });

                    ok(chart.options.valueAxis.flag === true);
                });

                test("xAxis settings override axisDefaults settings", function() {
                    createChart({
                        axisDefaults: {
                            flag: false
                        },
                        xAxis: {
                            flag: true
                        }
                    });

                    ok(chart.options.xAxis.flag === true);
                });

                test("yAxis settings override axisDefaults settings", function() {
                    createChart({
                        axisDefaults: {
                            flag: false
                        },
                        yAxis: {
                            flag: true
                        }
                    });

                    ok(chart.options.yAxis.flag === true);
                });

                test("axisDefaults override theme base", function() {
                    Chart.themes.test = {
                        categoryAxis: {
                            flag: true
                        }
                    };

                    createChart({
                        theme: "test",
                        axisDefaults: {
                            flag: false
                        }
                    });

                    ok(chart.options.categoryAxis.flag === false);
                });

                test("axisDefaults override theme with specific type", function() {
                    Chart.themes.test = {
                        axisDefaults: {
                            categoryAxis: {
                                flag: true
                            }
                        }
                    };

                    createChart({
                        theme: "test",
                        categoryAxis: {
                            flag: false
                        }
                    });

                    ok(chart.options.categoryAxis.flag === false);
                });

                // ------------------------------------------------------------
                module("Series defaults", {
                    teardown: destroyChart
                });

                test("default type is set to column", function() {
                    createChart({
                        series: [{ }]
                    });

                    equal(chart.options.series[0].type, "column");
                });

                test("type is set", function() {
                    createChart({
                        seriesDefaults: {
                            type: "line"
                        },
                        series: [{ }]
                    });

                    equal(chart.options.series[0].type, "line");
                });

                test("series colors are set", function() {
                    createChart({
                        seriesColors: ["#fff", "#f00"],
                        series: [{}, {}]
                    });

                    equal(chart.options.series[0].color, "#fff");
                    equal(chart.options.series[1].color, "#f00");
                });

                test("series colors are preserved", function() {
                    createChart({
                        seriesColors: ["#fff"],
                        series: [{ color: "#000" }]
                    });

                    equal(chart.options.series[0].color, "#000");
                });

                test("series colors are reused", function() {
                    createChart({
                        seriesColors: ["#f00"],
                        series: [{}, {}]
                    });

                    equal(chart.options.series[0].color, "#f00");
                    equal(chart.options.series[1].color, "#f00");
                });

                test("bar series defaults are applied", function() {
                    createChart({
                        seriesDefaults: {
                            bar: {
                                gap: 1
                            }
                        },
                        series: [{ type: "bar" }]
                    });

                    equal(chart.options.series[0].gap, 1);
                });

                test("bar series defaults are not applied to other series", function() {
                    createChart({
                        seriesDefaults: {
                            bar: {
                                gap: 1
                            }
                        },
                        series: [{ type: "line" }]
                    });

                    notEqual(chart.options.series[0].gap, 1);
                });

                test("bar series defaults are not copied in series", function() {
                    createChart({
                        seriesDefaults: {
                            bar: { }
                        },
                        series: [{ type: "bar" }]
                    });

                    ok(typeof(chart.options.series[0].bar) === "undefined");
                });

                test("column series defaults are applied", function() {
                    createChart({
                        seriesDefaults: {
                            column: {
                                gap: 1
                            }
                        },
                        series: [{ type: "column" }]
                    });

                    equal(chart.options.series[0].gap, 1);
                });

                test("column series defaults are applied to series with default type", function() {
                    createChart({
                        seriesDefaults: {
                            column: {
                                gap: 1
                            }
                        },
                        series: [{}]
                    });

                    equal(chart.options.series[0].gap, 1);
                });

                test("column series defaults are not applied to other series", function() {
                    createChart({
                        seriesDefaults: {
                            bar: {
                                gap: 1
                            }
                        },
                        series: [{ type: "line" }]
                    });

                    notEqual(chart.options.series[0].gap, 1);
                });

                test("column series defaults are not copied in series", function() {
                    createChart({
                        seriesDefaults: {
                            column: { }
                        },
                        series: [{ type: "column" }]
                    });

                    ok(typeof(chart.options.series[0].column) === "undefined");
                });

                test("line series defaults are applied", function() {
                    createChart({
                        seriesDefaults: {
                            line: {
                                width: 2
                            }
                        },
                        series: [{ type: "line" }]
                    });

                    equal(chart.options.series[0].width, 2);
                });

                test("line series defaults are not applied to other series", function() {
                    createChart({
                        seriesDefaults: {
                            line: {
                                width: 1
                            }
                        },
                        series: [{ type: "bar" }]
                    });

                    notEqual(chart.options.series[0].width, 1);
                });

                test("line series defaults are not copied in series", function() {
                    createChart({
                        seriesDefaults: {
                            line: { }
                        },
                        series: [{ type: "line" }]
                    });

                    ok(typeof(chart.options.series[0].line) === "undefined");
                });

                // ------------------------------------------------------------
                module("Title", {
                    teardown: destroyChart
                });

                test("text is set", function() {
                    createChart({
                        title: {
                            text: "My Title"
                        }
                    });

                    equal(chart._model.children[0].options.text, "My Title");
                });

                test("default font", function() {
                    createChart({
                        title: {
                            text: "My Title"
                        }
                    });

                    equal(chart._model.children[0].options.font,
                          "16px Arial,Helvetica,sans-serif");
                });

                test("font is set", function() {
                    createChart({
                        title: {
                            text: "My Title",
                            font: "10pt Comic Sans"
                        }
                    });

                    equal(chart._model.children[0].options.font,
                          "10pt Comic Sans");
                });

                test("not created if no text is set", function() {
                    createChart({
                        title: {
                            text: ""
                        }
                    });
                    ok(!(chart._model.children[0] instanceof Chart.Title));
                });

                test("not created if no visible is false", function() {
                    createChart({
                        title: {
                            text: "Title",
                            visible: false
                        }
                    });
                    ok(!(chart._model.children[0] instanceof Chart.Title));
                });

                // ------------------------------------------------------------
                module("Size", {
                    setup: function() {
                        $("#container").width("100px").height("100px").show();
                        createChart();
                    }
                });

                test("picks width from container", function() {
                    equal(chart._model.options.width, 100);
                });

                test("picks height from container", function() {
                    equal(chart._model.options.height, 100);
                });

                test("picks width from container on refresh", function() {
                    $("#container").width("200px");
                    chart.refresh();

                    equal(chart._model.options.width, 200);
                });

                test("picks height from container on refresh", function() {
                    $("#container").height("200px");
                    chart.refresh();

                    equal(chart._model.options.height, 200);
                });

                test("applies set width", function() {
                    createChart({ chartArea: { width: 200, height: 200 }});

                    equal(chart._model.options.width, 200);
                });

                test("applies set height", function() {
                    createChart({ chartArea: { width: 200, height: 200 }});

                    equal(chart._model.options.height, 200);
                });

                test("maintains set width after refresh", function() {
                    createChart({ chartArea: { width: 200, height: 200 }});
                    chart.refresh();

                    equal(chart._model.options.width, 200);
                });

                test("maintains set height after refresh", function() {
                    createChart({ chartArea: { width: 200, height: 200 }});
                    chart.refresh();

                    equal(chart._model.options.height, 200);
                });

                test("uses default width when none is available", function() {
                    $("#container").replaceWith(EMPTY_DIV);
                    createChart();

                    equal(chart._model.options.width, 600);
                });

                test("uses default height when none is available", function() {
                    $("#container").replaceWith(EMPTY_DIV);
                    createChart();

                    equal(chart._model.options.height, 400);
                });

                test("sets width on rootElement", function() {
                    createChart({ chartArea: { width: 200 } });

                    equal(chart._model.options.width, 200);
                });

                test("sets height on rootElement", function() {
                    createChart({ chartArea: { height: 200 } });

                    equal(chart._model.options.height, 200);
                });

                // ------------------------------------------------------------
                module("Themes", {
                    setup: function() {
                        Chart.themes.test = {
                            flag: true,
                            seriesColors: ["#f00", "#cf0"],
                            seriesDefaults: {
                                seriesDefaultsFlag: true,
                                scatter: {
                                    flag: false
                                }
                            }
                        };
                    },
                    teardown: destroyChart
                });

                test("applies theme", function() {
                    createChart({ theme: "test" });

                    ok(chart.options.flag);
                });

                test("applies default theme when not set by user", function() {
                    createChart();
                    equals(chart.options.theme, "hakama");
                });

                test("default theme can be disabled", function() {
                    createChart({ theme: "" });
                    equals(chart.options.theme, "");
                });

                test("overrides series colors", function() {
                    createChart({
                        theme: "test",
                        series: [{}, {}]
                    });

                    equal(chart.options.series[0].color, "#f00");
                    equal(chart.options.series[1].color, "#cf0");
                });

                test("seriesDefaults overrides theme series settings", function() {
                    createChart({
                        theme: "black",
                        seriesDefaults: {
                            overlay: {
                                gradient: "foo"
                            }
                        },
                        series: [{}, {}]
                    });

                    equal(chart.options.series[0].overlay.gradient, "foo");
                });

                test("applies theme seriesDefaults", function() {
                    createChart({
                        theme: "test",
                        series: [{}, {}]
                    });

                    ok(chart.options.series[0].seriesDefaultsFlag);
                });

                test("applies theme seriesDefaults with specific type", function() {
                    createChart({
                        theme: "test",
                        seriesDefaults: {
                            type: "scatter"
                        },
                        series: [{}, {}]
                    });

                    ok(chart.options.series[0].flag === false);
                });

                test("seriesDefaults overrides theme seriesDefaults", function() {
                    createChart({
                        theme: "test",
                        seriesDefaults: {
                            type: "scatter",
                            scatter: {
                                flag: true
                            }
                        },
                        series: [{}, {}]
                    });

                    ok(chart.options.series[0].flag);
                });

                // ------------------------------------------------------------
                module("Tooltip", {
                    teardown: destroyChart
                });

                test("created when visible", function() {
                    createChart({
                        tooltip: {
                            visible: true
                        }
                    });

                    ok(typeof chart._tooltip !== "undefined");
                });

                test("sets format", function() {
                    createChart({
                        tooltip: {
                            visible: true,
                            format: "{0}%"
                        }
                    });

                    equals(chart._tooltip.options.format, "{0}%");
                });

                test("sets font", function() {
                    createChart({ tooltip: {
                            visible: true,
                            font: "100px Verdana"
                        }
                    });

                    equals(chart._tooltip.options.font, "100px Verdana");
                });

                test("sets background", function() {
                    createChart({
                        tooltip: {
                            visible: true,
                            background: "red"
                        }
                    });

                    equals(chart._tooltip.options.background, "red");
                });

                // ------------------------------------------------------------
                var animations;
                function logAnimations(callback) {
                    animations = [];
                    stubMethod(Chart.ViewBase, "playAnimations",
                        function() {
                            var view = this;
                            animations = view.animations;
                            view.animations = [];
                        }, callback
                    );
                }

                module("Transitions", {
                    teardown: destroyChart
                });

                test("initial transitions are enabled by default", function() {
                    logAnimations(
                        function() {
                            createBarChart();
                            ok(animations.length > 0);
                        }
                    );
                });

                test("transitions can be disabled (transitions: false)", function() {
                    logAnimations(
                        function() {
                            createBarChart({
                                transitions: false
                            });

                            equals(animations.length, 0);
                        }
                    );
                });

                // ------------------------------------------------------------
                module("CSS Class");

                test("renders k-chart class", function() {
                    createChart({ theme: "test" });

                    ok($("#container").hasClass("k-chart"));
                });
            })();
        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <div id="container" style="width: 600px; height: 400px">
        </div>
    </body>
</html>
