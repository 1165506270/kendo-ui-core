<!DOCTYPE html>
<html>
    <head>
        <title>kendo.chart.funnel</title>
        <script src="../jquery-loader.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit/addons/close-enough/qunit-close-enough.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.dataviz.core.js"></script>
        <script src="../../src/kendo.dataviz.chart.js"></script>
        <script src="../../src/kendo.dataviz.chart.funnel.js"></script>
        <script src="../../src/kendo.dataviz.themes.js"></script>
        <script src="../../src/kendo.dataviz.svg.js"></script>
        <script src="../../src/kendo.dataviz.vml.js"></script>
        <script src="util.js"></script>
        <script type="text/javascript">
            var dataviz = kendo.dataviz,
                getElement = dataviz.getElement,
                Box2D = dataviz.Box2D,
                TOLERANCE = 1,
                box = new Box2D(0, 0, 800, 600),
                chart;

            function createChart(options) {
                var plotArea = {
                    options: {
                        seriesColors: ["red", "green", "blue"]
                    }
                };

                chart = new dataviz.FunnelChart(plotArea, options);
                chart.reflow(box);
            }

            // ------------------------------------------------------------
            module("segmentMethod none", {
                setup: function() {
                    createChart({
                        segmentHeight:"equal",
                        series: [{
                            data: [{
                                value: 1,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 3,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [707, 200], [93, 200]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [93, 200], [706, 200], [613, 400], [186, 400]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [186,400], [613, 400], [520, 600], [280, 600]
                ], TOLERANCE);
            });


            test("Creates segments for data points", function() {
                equal(chart.segments.length, chart.options.series[0].data.length);
            });

            module("segmentMethod height", {
                setup: function() {
                    createChart({
                        segmentMethod:"height",
                        series: [{
                            data: [{
                                value: 1,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 3,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [753, 100], [46, 100]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [46, 100], [753, 100], [660, 300], [140, 300]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [140,300], [660, 300], [520, 600], [280, 600]
                ], TOLERANCE);
            });

            module("max neckSize", {
                setup: function() {
                    createChart({
                        segmentMethod:"height",
                        neckSize: 1,
                        series: [{
                            data: [{
                                value: 1,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 3,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [800, 100], [0, 100]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [0, 100], [800, 100], [800, 300], [0, 300]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [0, 300], [800, 300], [800, 600], [0, 600]
                ], TOLERANCE);
            });

            module("min neckSize", {
                setup: function() {
                    createChart({
                        segmentMethod:"height",
                        neckSize: 0,
                        series: [{
                            data: [{
                                value: 1,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 3,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [733, 100], [66, 100]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [66, 100], [733, 100], [600, 300], [200, 300]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [200, 300], [600, 300], [400, 600], [400, 600]
                ], TOLERANCE);
            });

            module("Series setup", {
                setup: function() {
                    createChart({
                        series: [{
                            type: "funnel",
                            data: [{
                                value: 1,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 3,
                                category: "C"
                            }]
                        }]
                    });
                }
            })

            test("sets point owner", function() {
                ok(chart.segments[0].owner === chart);
            });

            test("sets point series", function() {
                equal(chart.segments[0].series.type, "funnel");
            });

            test("sets point category", function() {
                equal(chart.segments[0].category, "A");
            });

            test("sets point dataItem", function() {
                equal(typeof chart.segments[0].dataItem, "object");
            });

            module("segmentMethod height with spacing", {
                setup: function() {
                    createChart({
                        segmentMethod:"height",
                        segmentSpacing:30,
                        neckSize: 0,
                        series: [{
                            data: [{
                                value: 1,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 7,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [760, 54], [40, 54]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [40, 84], [760, 84], [680, 192], [120, 192]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [120, 222], [680, 222], [400, 600], [400, 600]
                ], TOLERANCE);
            });

            module("segmentMethod none with spacing", {
                setup: function() {
                    createChart({
                        segmentMethod:"height",
                        segmentSpacing:33,
                        neckSize: 0,
                        series: [{
                            segmentSpacing:33,
                            data: [{
                                value: 1,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 7,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [760, 53], [40, 53]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [40, 86], [760, 86], [680, 193], [120, 193]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [120, 226], [680, 226], [400, 600], [400, 600]
                ], TOLERANCE);
            });

            module("depend ot relation", {
                setup: function() {
                    createChart({
                        segmentMethod:"relation",
                        series: [{
                            data: [{
                                value: 7,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 7,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [514, 262], [285, 262]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [285, 262], [514, 262], [800, 337], [0, 337]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [0, 337], [800, 337], [800, 600], [0, 600]
                ], TOLERANCE);
            });

            module("depend ot relation with spacing", {
                setup: function() {
                    createChart({
                        segmentSpacing : 22,
                        segmentMethod:"relation",
                        series: [{
                            data: [{
                                value: 7,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 7,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [0, 0], [800, 0], [514, 243], [285, 243]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [285, 265], [514, 265], [800, 334], [0, 334]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [0, 356], [800, 356], [800, 600], [0, 600]
                ], TOLERANCE);
            });

            module("using label with template", {
                setup: function() {
                    createChart({
                        segmentSpacing : 22,
                        segmentMethod:"relation",
                        labels: {
                            align: function(context) { return context.index % 2 === 0 ? "left" : "right"; },
                            color:'red',
                            margin: 5,
                            template: "My Template #=value#"
                        },
                        series: [{
                            data: [{
                                value: 7,
                                category: "A",
                            }, {
                                value: 2,
                                category: "B"
                            }, {
                                value: 7,
                                category: "C"
                            }]
                        }]
                    });
                }
            });

            test("sets template options for the labels", function() {
                ok(chart.labels[0].options.template === "My Template #=value#");
            });

            test("sets margin options for the labels", function() {
                ok(chart.labels[0].options.margin === 5);
            });

            test("sets default options for the labels", function() {
                var padding = chart.labels[0].options.padding;
                ok(padding !== null && padding !== undefined);
                ok($.isEmptyObject(padding));
            });

            test("sets color for the labels", function() {
                var options = chart.labels[0].options;
                ok(options.color === 'red')
            });

            test("First label text position", function() {
                var textBox = chart.labels[0].children[0].box;
                close(textBox.x1,5,TOLERANCE);
                close(textBox.x2,84,TOLERANCE);
                close(textBox.y1,114,TOLERANCE);
                close(textBox.y2,129,TOLERANCE);
            });

            test("Second label text position", function() {
                var textBox = chart.labels[1].children[0].box;
                close(textBox.x1,716,TOLERANCE);
                close(textBox.x2,795,TOLERANCE);
                close(textBox.y1,292,TOLERANCE);
                close(textBox.y2,307,TOLERANCE);
            });

            test("Third label text position", function() {
                var textBox = chart.labels[2].children[0].box;
                close(textBox.x1,5,TOLERANCE);
                close(textBox.x2,84,TOLERANCE);
                close(textBox.y1,470,TOLERANCE);
                close(textBox.y2,485,TOLERANCE);
            });

            test("First label box position", function() {
                var textBox = chart.labels[0].box;
                close(textBox.x1,0,TOLERANCE);
                close(textBox.x2,89,TOLERANCE);
                close(textBox.y1,109,TOLERANCE);
                close(textBox.y2,134,TOLERANCE);
            });

            test("Second label bx position", function() {
                var textBox = chart.labels[1].box;
                close(textBox.x1,711,TOLERANCE);
                close(textBox.x2,800,TOLERANCE);
                close(textBox.y1,287,TOLERANCE);
                close(textBox.y2,312,TOLERANCE);
            });

            test("Third label box position", function() {
                var textBox = chart.labels[2].box;
                close(textBox.x1,0,TOLERANCE);
                close(textBox.x2,89,TOLERANCE);
                close(textBox.y1,465,TOLERANCE);
                close(textBox.y2,490,TOLERANCE);
            });

            test("First segment position", function() {
                arrayClose(mapPoints(chart.segments[0].points), [
                    [89, 0], [711, 0], [488, 243], [311, 243]
                ], TOLERANCE);
            });

            test("Second segment position", function() {
                arrayClose(mapPoints(chart.segments[1].points), [
                    [311, 265], [488, 265], [711, 334], [89, 334]
                ], TOLERANCE);
            });

            test("Third segment position", function() {
                arrayClose(mapPoints(chart.segments[2].points), [
                    [89, 356], [711, 356], [711, 600], [89, 600]
                ], TOLERANCE);
            });

            (function() {
                var segment,
                    segmentElement,
                    plotArea;

                function createFunnelChart(options) {
                    chart = $("#container").kendoChart($.extend({
                        series: [{
                            type: "funnel",
                            data: [{ value: 1, category: "A" }]
                        }]
                    }, options))
                    .data("kendoChart");

                    plotArea = chart._plotArea;
                    segment = plotArea.charts[0].segments[0];
                    segmentElement = $(getElement(segment.options.id));
                }

                function segmentClick(callback) {
                    createFunnelChart({
                        seriesClick: callback
                    });

                    segmentElement.click();
                }

                function segmentHover(callback) {
                    createFunnelChart({
                        seriesHover: callback
                    });

                    segmentElement.mouseover();
                }

                // ------------------------------------------------------------
                module("Funnel Chart / Events / seriesClick", {
                    teardown: destroyChart
                });

                test("fires when clicking segments", 1, function() {
                    segmentClick(function() { ok(true); });
                });

                test("fires on touchstart", 1, function() {
                    createFunnelChart({
                        seriesClick: function() {
                            ok(true);
                        }
                    });

                    segmentElement.trigger($.Event("touchstart", {
                        originalEvent: { }
                    }));
                });

                test("fires when clicking segment labels", 1, function() {
                    createFunnelChart({
                        seriesClick: function() { ok(true); }
                    });
                    var label = plotArea.charts[0].labels[0];
                    $(getElement(label.options.id)).click();
                });

                test("event arguments contain value", 1, function() {
                    segmentClick(function(e) { equal(e.value, 1); });
                });

                test("event arguments contain category", 1, function() {
                    segmentClick(function(e) { equal(e.category, "A"); });
                });

                test("event arguments contain series", 1, function() {
                    segmentClick(function(e) {
                        deepEqual(e.series, chart.options.series[0]);
                    });
                });

                test("event arguments contain jQuery element", 1, function() {
                    segmentClick(function(e) {
                        equal(e.element[0], getElement(segment.options.id));
                    });
                });

                // ------------------------------------------------------------
                module("Funnel Chart / Events / seriesHover", {
                    teardown: destroyChart
                });

                test("fires when hovering segments", 1, function() {
                    segmentHover(function() { ok(true); });
                });

                test("fires on touchstart", 1, function() {
                    createFunnelChart({
                        seriesHover: function() {
                            ok(true);
                        }
                    });

                    segmentElement.trigger($.Event("touchstart", {
                        originalEvent: { }
                    }));
                });

                test("fires when hovering segment labels", 1, function() {
                    createFunnelChart({
                        seriesHover: function() { ok(true); }
                    });
                    var label = plotArea.charts[0].labels[0];
                    $(getElement(label.options.id)).mouseover();
                });

                test("event arguments contain value", 1, function() {
                    segmentHover(function(e) { equal(e.value, 1); });
                });

                test("event arguments contain category", 1, function() {
                    segmentHover(function(e) { equal(e.category, "A"); });
                });

                test("event arguments contain series", 1, function() {
                    segmentHover(function(e) {
                        deepEqual(e.series, chart.options.series[0]);
                    });
                });

                test("event arguments contain jQuery element", 1, function() {
                    segmentHover(function(e) {
                        equal(e.element[0], getElement(segment.options.id));
                    });
                });

            })();

        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <div id="container" style="width: 600px; height: 400px">
        </div>
    </body>
</html>
