<!DOCTYPE html>
<html>
    <head>
        <title>kendo.chart</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.chart.js"></script>
        <script src="util.js"></script>
        <script type="text/javascript">
            var Chart = kendo.ui.Chart,
                Box2D = Chart.Box2D,
                categoriesCount = Chart.categoriesCount,
                chartBox = new Box2D(0, 0, 800, 600),
                plotArea,
                pieChart,
                TOLERANCE = 0.1,
                root,
                view;

            function setupPieChart(plotArea, options) {
                view = new ViewStub();

                pieChart = new Chart.PieChart(plotArea, options);

                root = new Chart.RootElement();
                root.append(pieChart);

                pieChart.reflow(chartBox);
                pieChart.getViewElements(view);
            }

            (function() {
                var values = { data: [1, 2] },
                    dataValues = {
                       data: [
                           {
                               value: 1,
                               name: "A"
                           }, {
                               value: 2,
                               name: "B"
                           }
                       ]
                    };

                function PlotAreaStub() { }

                $.extend(PlotAreaStub.prototype, {
                    options: {
                        categoryAxis: {
                            categories: ["A"]
                        }
                    }
                });

                // ------------------------------------------------------------
                module("Pie Chart / Array with values", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupPieChart(plotArea, { series: [ values ] });
                    }
                });

                test("creates segments for pie chart data points", function() {
                    equal(pieChart.segments.length, values.data.length);
                });

                test("reports number of categories", function() {
                    equal(categoriesCount(pieChart.options.series), values.data.length);
                });

                test("segments have set angle", function() {
                    $.each(pieChart.segments, function() {
                        ok(this.sector.angle);
                    });
                });

                test("segments have set startAngle", function() {
                    $.each(pieChart.segments, function() {
                        ok(this.sector.angle);
                    });
                });

                test("segments have set owner", function() {
                    ok(pieChart.segments[0].owner === pieChart);
                });

                test("sets segment category", function() {
                    equal(pieChart.segments[0].category, "");
                });

                test("sets segment series", function() {
                    ok(pieChart.segments[0].series === values);
                });

                test("sets segment series index", function() {
                    ok(pieChart.segments[0].seriesIx === 0);
                });

                test("sets segment dataItem", function() {
                    equal(typeof pieChart.segments[0].dataItem, "object");
                });

                // ------------------------------------------------------------
                module("Pie Chart / Array with items", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupPieChart(plotArea, { series: [ dataValues ] });
                    }
                });

                test("sets segment category", function() {
                    equal(pieChart.segments[0].category, "A");
                });

                test("segments have set owner", function() {
                    ok(pieChart.segments[0].owner === pieChart);
                });

                test("sets segment series", function() {
                    ok(pieChart.segments[0].series === dataValues);
                });

                test("sets segment series index", function() {
                    ok(pieChart.segments[0].seriesIx === 0);
                });

                test("sets segment dataItem", function() {
                    equal(typeof pieChart.segments[0].dataItem, "object");
                });

            })();


            (function() {
                var point,
                    box,
                    label,
                    root,
                    VALUE = 1,
                    CATEGORY = "A",
                    SERIES_NAME = "series";

                function createSegment(options) {
                    segment = new Chart.PieSegment(
                        VALUE,
                        new Chart.Sector(new Chart.Point2D(0,0), 100, 90, 100),
                        options
                    );

                    segment.dataItem = { value: VALUE };

                    box = new Box2D(0, 0, 100, 100);
                    segment.reflow(box);

                    root = new Chart.RootElement();
                    root.append(segment);
                }

                // ------------------------------------------------------------
                module("Pie Segment", {
                    setup: function() {
                        createSegment();
                    }
                });

                test("fills target box", function() {
                    sameBox(segment.box, box);
                });

                test("sets segment border color", function() {
                    createSegment({ border: { color: "red" } });
                    equals(segment.options.border.color, "red");
                });

                test("sets pie border width", function() {
                    createSegment({ border: { width: 4 } });
                    equals(segment.options.border.width, 4);
                });

                test("tooltipAnchor is set distance from segment", function() {
                    var anchor = segment.tooltipAnchor(10, 10);
                    same([Math.round(anchor.x), Math.round(anchor.y)], [81, -77], TOLERANCE);
                });

            })();

            (function() {
                var chart,
                    model,
                    title,
                    legend,
                    plotArea
                    MARGIN = 10;

                module("Pie Chart / Model", {
                    setup: function() {
                        $("#container").kendoChart({
                            title: {
                                text: "Chart Title"
                            },
                            series: [{
                                name: "Value",
                                type: "pie",
                                data: [
                                    {
                                        value: 100,
                                        name: "Value A"
                                    }, {
                                        value: 200,
                                        name: "Value B"
                                    }, {
                                        value: 300,
                                        name: "Value C"
                                    }
                                ]
                            }],
                            categoryAxis: {
                                categories: ["Alpha", "Beta", "Charlie"]
                            },
                            chartArea: {
                                margin: 0
                            }
                        });

                        chart = $("#container").data("kendoChart");
                        model = chart._model;
                        title = model.children[0];
                        legend = model.children[1];
                        plotArea = model.children[2];
                    },
                    teardown: function() {
                        $("#container").empty();
                    }
                });

                test("model is a RootElement", function() {
                    ok(model instanceof Chart.RootElement);
                });

                test("title is created", function() {
                    ok(title instanceof Chart.Title);
                });

                test("title text is set", function() {
                    equal(title.options.text, "Chart Title");
                });

                test("title box is positioned at top", function() {
                    equal(title.box.y1, 0);
                });

                test("legend is created", function() {
                    ok(legend instanceof Chart.Legend);
                });

                test("legend series are populated", function() {
                    equal(legend.options.items[0].name, "Value A");
                });

                test("legend is positioned at right", function() {
                    equal(legend.box.x1,
                        model.box.width() - legend.box.width() - MARGIN);
                });

                test("legend is positioned at vertical center", function() {
                    var titleHeight = title.box.height(),
                        vCenter = titleHeight +
                                  ((model.box.height() - titleHeight - legend.box.height()) / 2);
                    equal(legend.box.y1, vCenter);
                });

                test("plotArea is created", function() {
                    ok(plotArea instanceof Chart.PlotArea);
                });

            })();


            (function() {
                var PADDING = 5,
                    MARGIN = 5,
                    pieSegment;

                function PlotAreaStub() { }

                $.extend(PlotAreaStub.prototype, {
                    options: {
                        categoryAxis: {
                            categories: ["A"]
                        }
                    }
                });

                // ------------------------------------------------------------
                module("Pie Chart / Labels / Configuration", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupPieChart(plotArea, {
                            series: [ { data: [1, 2],
                                labels: {
                                    visible: false,
                                    color: "labels-color",
                                    background: "labels-background",
                                    border: {
                                        color: "labels-border-color",
                                        width: 2,
                                        dashType: "dot"
                                    },
                                    padding: PADDING,
                                    margin: MARGIN,
                                    distance: 20,
                                    font: "labels-font"
                                }
                            } ]
                        });
                        pieSegment = pieChart.segments[0];
                    }
                });

                test("applies visible to data labels", function() {
                    equal(pieSegment.options.labels.visible, false);
                });

                test("applies color to data labels", function() {
                    equal(pieSegment.options.labels.color, "labels-color");
                });

                test("applies background to data labels", function() {
                    equal(pieSegment.options.labels.background, "labels-background");
                });

                test("applies border color to data labels", function() {
                    equal(pieSegment.options.labels.border.color, "labels-border-color");
                });

                test("applies border width to data labels", function() {
                    equal(pieSegment.options.labels.border.width, 2);
                });

                test("applies padding to data labels", function() {
                    equal(pieSegment.options.labels.padding, PADDING);
                });

                test("applies margin to data labels", function() {
                    equal(pieSegment.options.labels.margin, MARGIN);
                });

                test("applies margin to data labels", function() {
                    equal(pieSegment.options.labels.border.dashType, "dot");
                });

                test("applies distance to data labels", function() {
                    equal(pieSegment.options.labels.distance, 20);
                });

                test("applies font to data labels", function() {
                    equal(pieSegment.options.labels.font, "labels-font");
                });

                // ------------------------------------------------------------
                module("Pie Chart / Labels / Connectors / Normal test case 1", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupPieChart(plotArea, {
                            series: [ {
                                data: [ 1, 2, 3, 4, 4, 3, 2, 1 ],
                                labels: {
                                    visible: true,
                                    distance: 20
                                }
                            } ],
                            padding: 30
                        });
                    }
                });

                test("start point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[0].x, this.points[0].y ]);
                    });

                    same(points, [ [ 445.21, 14.558 ], [ 569.87, 66.194 ],
                                   [ 685.442, 254.79 ], [ 569.87, 533.806 ],
                                   [ 230.13, 533.806 ], [ 114.558, 254.79 ],
                                   [ 230.13, 66.194 ], [ 354.79, 14.558 ] ]);
                });

                test("middle point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[1].x, this.points[1].y ]);
                    });

                    same(points, [ [ 446.645, 5.5 ], [ 574.733, 59.5 ],
                                   [ 689, 254.79 ], [ 583.452, 552.5 ],
                                   [ 216.548, 552.5 ], [ 111, 254.79 ],
                                   [ 225.267, 59.5 ], [ 353.355, 5.5 ] ]);
                });

                test("end point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[2].x, this.points[2].y ]);
                    });

                    same(points, [ [ 701, 5.5 ], [ 701, 59.5 ],
                                   [ 697, 258.5 ], [ 701, 552.5 ],
                                   [ 99, 552.5 ], [ 103, 258.5 ],
                                   [ 99, 59.5 ], [ 99, 5.5 ] ]);
                });

                test("middle point Y and end point Y should be equal", function() {
                    $.each(view.log.path, function() {
                        if (this.points.length > 3) {
                            equal(this.points[2].y, this.points[3].y);
                        } else {
                            equal(this.points[1].y, this.points[2].y);
                        }
                    });
                });

                // ------------------------------------------------------------
                module("Pie Chart / Labels / Connectors / Normal test case 2", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupPieChart(plotArea, {
                            series: [ {
                                data: [ 1, 2, 3, 4, 5, 6, 6, 5, 4, 3, 2, 1 ],
                                labels: {
                                    visible: true,
                                    distance: 20
                                }
                            } ],
                            padding: 100
                        });
                    }
                });

                test("start point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[0].x, this.points[0].y ]);
                    });

                    same(points, [ [ 418.981, 46.71 ], [ 474.868, 57.285 ],
                                   [ 558.366, 101.415 ], [ 636.442, 207.203 ],
                                   [ 642.715, 374.868 ], [ 510.206, 528.846 ],
                                   [ 289.794, 528.846 ], [ 157.285, 374.868 ],
                                   [ 163.558, 207.203 ], [ 241.634, 101.415 ],
                                   [ 325.132, 57.285 ], [ 381.019, 46.71 ] ]);
                });

                test("second point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[1].x, this.points[1].y ]);
                    });

                    same(points, [ [ 420.046, 32.5 ], [ 477.578, 48.5 ],
                                   [ 563.083, 95.5 ], [ 654, 207.203 ],
                                   [ 662, 385.5 ], [ 520.152, 549.5 ],
                                   [ 279.848, 549.5 ], [ 138, 385.5 ],
                                   [ 146, 207.203 ], [ 236.917, 95.5 ],
                                   [ 322.422, 48.5 ], [ 379.954, 32.5 ] ]);
                });

                test("end point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[2].x, this.points[2].y ]);
                    });

                    same(points, [ [ 666, 32.5 ], [ 666, 48.5 ],
                                   [ 666, 95.5 ], [ 662, 207.5 ],
                                   [ 666, 385.5 ], [ 666, 549.5 ],
                                   [ 134, 549.5 ], [ 134, 385.5 ],
                                   [ 138, 207.5 ], [ 134, 95.5 ],
                                   [ 134, 48.5 ], [ 134, 32.5 ] ]);
                });

                test("middle point Y and end point Y should be equal", function() {
                    $.each(view.log.path, function() {
                        if (this.points.length > 3) {
                            equal(this.points[2].y, this.points[3].y);
                        } else {
                            equal(this.points[1].y, this.points[2].y);
                        }
                    });
                });

                // ------------------------------------------------------------
                module("Pie Chart / Labels / Connectors / Stress test case 1", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupPieChart(plotArea, {
                            series: [ {
                                data: [ 40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 140 ],
                                labels: {
                                    visible: true,
                                    distance: 20
                                }
                            } ],
                            padding: 30
                        });
                    }
                });

                test("start point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[0].x, this.points[0].y ]);
                    });

                    same(points,[ [ 571.35, 67.277 ], [ 677.293, 218.579 ],
                                  [ 679.737, 227.418 ], [ 681.899, 236.33 ],
                                  [ 683.777, 245.306 ], [ 685.37, 254.338 ],
                                  [ 686.675, 263.415 ], [ 687.691, 272.529 ],
                                  [ 688.418, 281.67 ], [ 688.855, 290.831 ],
                                  [ 689, 300 ], [ 688.855, 309.169 ],
                                  [ 688.418, 318.33 ], [ 687.691, 327.471 ],
                                  [ 686.675, 336.585 ], [ 685.37, 345.662 ],
                                  [ 683.777, 354.694 ], [ 681.899, 363.67 ],
                                  [ 679.737, 372.582 ], [ 170.025, 475.021 ] ]);
                });

                test("second point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[1].x, this.points[1].y ]);
                    });

                    same(points, [ [ 575.604, 61.5 ], [ 697, 164.5 ],
                                   [ 697, 180.5 ], [ 697, 196.5 ],
                                   [ 697, 212.5 ], [ 697, 228.5 ],
                                   [ 697, 244.5 ], [ 697, 260.5 ],
                                   [ 697, 276.5 ], [ 689, 290.831 ],
                                   [ 697, 308.5 ], [ 697, 324.5 ],
                                   [ 697, 340.5 ], [ 697, 356.5 ],
                                   [ 697, 372.5 ], [ 697, 388.5 ],
                                   [ 697, 404.5 ], [ 697, 420.5 ],
                                   [ 697, 436.5 ], [ 148.372, 491.5 ] ]);
                });

                test("end point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[2].x, this.points[2].y ]);
                    });

                    same(points, [ [ 701, 61.5 ], [ 701, 164.5 ],
                                   [ 701, 180.5 ], [ 701, 196.5 ],
                                   [ 701, 212.5 ], [ 701, 228.5 ],
                                   [ 701, 244.5 ], [ 701, 260.5 ],
                                   [ 701, 276.5 ], [ 697, 292.5 ],
                                   [ 701, 308.5 ], [ 701, 324.5 ],
                                   [ 701, 340.5 ], [ 701, 356.5 ],
                                   [ 701, 372.5 ], [ 701, 388.5 ],
                                   [ 701, 404.5 ], [ 701, 420.5 ],
                                   [ 701, 436.5 ], [ 99, 491.5 ] ]);
                });

                test("middle point Y and end point Y should be equal", function() {
                    $.each(view.log.path, function() {
                        if (this.points.length > 3) {
                            equal(this.points[2].y, this.points[3].y);
                        } else {
                            equal(this.points[1].y, this.points[2].y);
                        }
                    });
                });

                // ------------------------------------------------------------
                module("Pie Chart / Labels / Connectors / Stress test case 2", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupPieChart(plotArea, {
                            series: [ {
                                data: [ 70, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 40, 40, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 20 ],
                                labels: {
                                    visible: true,
                                    distance: 20
                                }
                            } ],
                            padding: 100
                        });
                    }
                });

                test("start point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[0].x, this.points[0].y ]);
                    });

                    same(points,[ [ 631.359, 195.172 ], [ 588.202, 470.576 ],
                                  [ 582.52, 476.642 ], [ 576.642, 482.52 ],
                                  [ 570.576, 488.202 ], [ 564.327, 493.682 ],
                                  [ 557.902, 498.955 ], [ 551.308, 504.015 ],
                                  [ 544.551, 508.856 ], [ 537.64, 513.474 ],
                                  [ 530.582, 517.863 ], [ 366.846, 551.827 ],
                                  [ 148.173, 333.154 ], [ 182.137, 169.418 ],
                                  [ 186.526, 162.36 ], [ 191.144, 155.449 ],
                                  [ 195.985, 148.692 ], [ 201.045, 142.098 ],
                                  [ 206.318, 135.673 ], [ 211.798, 129.424 ],
                                  [ 217.48, 123.358 ], [ 223.358, 117.48 ],
                                  [ 229.424, 111.798 ], [ 235.673, 106.318 ],
                                  [ 242.098, 101.045 ], [ 318.354, 59.48 ] ]);
                });

                test("second point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[1].x, this.points[1].y ]);
                    });

                    same(points, [ [ 654, 195.172 ], [ 654, 470.576 ],
                                   [ 654, 476.642 ], [ 654, 482.52 ],
                                   [ 654, 488.202 ], [ 571.809, 502.5 ],
                                   [ 573.414, 518.5 ], [ 573.917, 534.5 ],
                                   [ 573.373, 550.5 ], [ 571.829, 566.5 ],
                                   [ 569.324, 582.5 ], [ 363.861, 574.5 ],
                                   [ 138, 342.5 ], [ 146, 169.418 ],
                                   [ 146, 162.36 ], [ 146, 155.449 ],
                                   [ 146, 148.692 ], [ 146, 142.098 ],
                                   [ 146, 135.673 ], [ 207.469, 125.5 ],
                                   [ 203.161, 109.5 ], [ 200.15, 93.5 ],
                                   [ 198.338, 77.5 ], [ 197.648, 61.5 ],
                                   [ 198.014, 45.5 ], [ 308.177, 29.5 ] ]);
                });

                test("end point", function() {
                    var points = [];
                    $.each(view.log.path, function() {
                        points.push([ this.points[2].x, this.points[2].y ]);
                    });

                    same(points, [ [ 662, 195.5 ], [ 662, 438.5 ],
                                   [ 662, 454.5 ], [ 662, 470.5 ],
                                   [ 662, 486.5 ], [ 666, 502.5 ],
                                   [ 666, 518.5 ], [ 666, 534.5 ],
                                   [ 666, 550.5 ], [ 666, 566.5 ],
                                   [ 666, 582.5 ], [ 134, 574.5 ],
                                   [ 134, 342.5 ], [ 138, 221.5 ],
                                   [ 138, 205.5 ], [ 138, 189.5 ],
                                   [ 138, 173.5 ], [ 138, 157.5 ],
                                   [ 138, 141.5 ], [ 134, 125.5 ],
                                   [ 134, 109.5 ], [ 134, 93.5 ],
                                   [ 134, 77.5 ], [ 134, 61.5 ],
                                   [ 134, 45.5 ], [ 134, 29.5 ] ]);
                });

                test("middle point Y and end point Y should be equal", function() {
                    $.each(view.log.path, function() {
                        if (this.points.length > 3) {
                            equal(this.points[2].y, this.points[3].y);
                        } else {
                            equal(this.points[1].y, this.points[2].y);
                        }
                    });
                });

            })();

        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <div id="container">
        </div>
    </body>
</html>
