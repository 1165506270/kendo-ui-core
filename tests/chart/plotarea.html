<!DOCTYPE html>
<html>
    <head>
        <title>UI5.Chart Tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.chart.js"></script>
        <script src="util.js"></script>
        <script type="text/javascript">

            var Chart = kendo.ui.Chart,
                Box2D = Chart.Box2D,
                chartBox = new Box2D(100, 100, 1000, 1000),
                view,
                TOLERANCE = 1,
                MARGIN = 10,
                GAP = 4,
                chartSeries;

                function moduleSetup() {
                    view = new ViewStub();
                }

            (function() {
                var plotArea,
                    categoryAxis,
                    namedValueAxes,
                    primaryValueAxis,
                    secondaryValueAxis,
                    barSeriesData = [{
                        name: "Value A",
                        type: "bar",
                        data: [100, 200, 300],
                        gap: GAP
                    }, {
                        name: "Value B",
                        type: "bar",
                        data: [10, 20, 30]
                    }],
                    columnSeriesData = [{
                        name: "Value A",
                        type: "column",
                        data: [100, 200, 300],
                        gap: GAP
                    }, {
                        name: "Value B",
                        type: "column",
                        data: [10, 20, 30]
                    }],
                    lineSeriesData = [{
                        name: "Value A",
                        type: "line",
                        data: [100, 200, 300]
                    }, {
                        name: "Value B",
                        type: "line",
                        data: [10, 20, 30]
                    },
                    verticalLineSeriesData = [{
                        name: "Value A",
                        type: "verticalLine",
                        data: [100, 200, 300]
                    }, {
                        name: "Value B",
                        type: "verticalLine",
                        data: [10, 20, 30]
                    }]],
                    areaSeriesData = [{
                        name: "Value A",
                        type: "area",
                        data: [100, 200, 300]
                    }, {
                        name: "Value B",
                        type: "area",
                        data: [10, 20, 30]
                    },
                    verticalAreaSeriesData = [{
                        name: "Value A",
                        type: "verticalArea",
                        data: [100, 200, 300]
                    }, {
                        name: "Value B",
                        type: "verticalArea",
                        data: [10, 20, 30]
                    }]];

                function createPlotArea(series, options) {
                    plotArea = new Chart.CategoricalPlotArea(series,
                        $.extend({
                        categoryAxis: {
                            categories: ["A", "B", "C"]
                        }
                    }, options));

                    categoryAxis = plotArea.categoryAxis;
                    namedValueAxes = plotArea.namedValueAxes;
                    primaryValueAxis = plotArea.namedValueAxes.primary;
                    secondaryValueAxis = plotArea.namedValueAxes.secondary;

                    chartSeries = plotArea.charts[0];
                }

                // ------------------------------------------------------------
                module("Categorical PlotArea / Axes", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(columnSeriesData);
                    }
                });

                test("appends primary value axis to children collection", function() {
                    ok($.inArray(primaryValueAxis, plotArea.children) >= 0);
                });

                test("appends category axis to children collection", function() {
                    ok($.inArray(categoryAxis, plotArea.children) >= 0);
                });

                test("aligns axes at default crossing values", function() {
                    var axisX = categoryAxis,
                        axisY = primaryValueAxis;

                    plotArea.reflow(chartBox);

                    var crossingSlotY = axisY.getSlot(axisY.options.axisCrossingValue),
                        crossingSlotX = axisX.getSlot(axisX.options.axisCrossingValue);
                    same([crossingSlotY.x1, crossingSlotY.y1], [crossingSlotX.x1, crossingSlotX.y1]);
                });

                test("aligns axises at non-default crossing values", function() {
                    var axisX = categoryAxis,
                        axisY = primaryValueAxis;

                    axisY.options.axisCrossingValue = 10;
                    axisX.options.axisCrossingValue = 1;
                    plotArea.reflow(chartBox);

                    var crossingSlotY = axisY.getSlot(axisY.options.axisCrossingValue),
                        crossingSlotX = axisX.getSlot(axisX.options.axisCrossingValue);
                    same([crossingSlotY.x1, crossingSlotY.y1], [crossingSlotX.x1, crossingSlotX.y1]);
                });

                test("axis limit is [0, 1] when no series are configured", 2, function() {
                    stubMethod(Chart.CategoricalPlotArea, "createAxes",
                        function() {
                            equal(this.valueAxisRangeTracker.query("primary").min, 0);
                            equal(this.valueAxisRangeTracker.query("primary").max, 1);
                        },
                        function() {
                            plotArea = new Chart.CategoricalPlotArea([]);
                        }
                    );
                });

                test("adds categories to match actual data", function() {
                    var plotArea = new Chart.CategoricalPlotArea(columnSeriesData, {
                        categoryAxis: {
                            categories: ["A", "B"]
                        }
                    });

                    equals(plotArea.categoryAxis.options.categories.length, 3);
                });

                test("accepts extra categories", function() {
                    var plotArea = new Chart.CategoricalPlotArea([{
                            type: "column",
                            data: [100]
                        }], {
                        categoryAxis: {
                            categories: ["A", "B"]
                        }
                    });

                    equals(plotArea.categoryAxis.options.categories.length, 2);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Multiple Axes", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(columnSeriesData, {
                            valueAxis: [{}, {
                                name: "secondary"
                            }]
                        });
                    }
                });

                test("added to children collection", function() {
                    ok($.inArray(secondaryValueAxis, plotArea.children) >= 0);
                });

                test("crosses category axis at default value", function() {
                    plotArea.reflow(chartBox);

                    var slotX = categoryAxis.getSlot(categoryAxis.options.axisCrossingValue),
                        slotY = primaryValueAxis.getSlot(primaryValueAxis.options.axisCrossingValue);

                    equals(slotX.y1, slotY.y1);
                });

                test("overlapping axes are stacked to the left", function() {
                    var margin = secondaryValueAxis.options.margin;

                    plotArea.reflow(chartBox);

                    same([secondaryValueAxis.box.x2, secondaryValueAxis.box.y1],
                         [primaryValueAxis.box.x1 - margin, primaryValueAxis.box.y1]
                    );
                });

                test("stacked axes on left are aligned", function() {
                    plotArea.reflow(chartBox);

                    same([secondaryValueAxis.lineBox().y1, secondaryValueAxis.lineBox().y2],
                         [primaryValueAxis.lineBox().y1, primaryValueAxis.lineBox().y2]
                    );
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Multiple Axes / Stacked right", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(columnSeriesData, {
                            categoryAxis: {
                                axisCrossingValue: 100
                            },
                            valueAxis: [{}, {
                                name: "secondary"
                            }]
                        });
                    }
                });

                test("overlapping axes are shifted to the right", function() {
                    var margin = secondaryValueAxis.options.margin;

                    plotArea.reflow(chartBox);

                    same([secondaryValueAxis.box.x1, secondaryValueAxis.box.y1],
                         [primaryValueAxis.box.x2 + margin, primaryValueAxis.box.y1]
                    );
                });

                test("stacked axes on right are aligned", function() {
                    plotArea.reflow(chartBox);

                    same([secondaryValueAxis.lineBox().y1, secondaryValueAxis.lineBox().y2],
                         [primaryValueAxis.lineBox().y1, primaryValueAxis.lineBox().y2]
                    );
                });

                test("plot area bounding box wraps axis", function() {
                    plotArea.reflow(chartBox);

                    var axisBox = secondaryValueAxis.box;
                    ok(axisBox.x1 >= plotArea.box.x1 && axisBox.y1 >= plotArea.box.x1);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Inverted / Multiple Axes / Stacked Top", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(barSeriesData, {
                            categoryAxis: {
                                axisCrossingValue: 0
                            },
                            valueAxis: [{}, {
                                name: "secondary"
                            }]
                        });
                    }
                });

                test("overlapping axes are shifted to the top", function() {
                    var margin = secondaryValueAxis.options.margin;

                    plotArea.reflow(chartBox);

                    equals(secondaryValueAxis.box.y2, primaryValueAxis.box.y1 - margin);
                });

                test("stacked axes on top are aligned", function() {
                    plotArea.reflow(chartBox);

                    same([secondaryValueAxis.lineBox().x1, secondaryValueAxis.lineBox().x2],
                         [primaryValueAxis.lineBox().x1, primaryValueAxis.lineBox().x2]
                    );
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Inverted / Multiple Axes / Stacked Bottom", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(barSeriesData, {
                            valueAxis: [{}, {
                                name: "secondary"
                            }]
                        });
                    }
                });

                test("overlapping axes are shifted to the bottom", function() {
                    var margin = secondaryValueAxis.options.margin;

                    plotArea.reflow(chartBox);

                    same(secondaryValueAxis.box.y1, primaryValueAxis.box.y2 + margin);
                });

                test("stacked axes on bottom are aligned", function() {
                    plotArea.reflow(chartBox);

                    same([secondaryValueAxis.lineBox().x1, secondaryValueAxis.lineBox().x2],
                         [primaryValueAxis.lineBox().x1, primaryValueAxis.lineBox().x2]
                    );
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Column series", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(columnSeriesData);
                    }
                });

                test("value axis is vertical", function() {
                    ok(primaryValueAxis.options.isVertical);
                });

                test("category axis is horizontal", function() {
                    ok(!categoryAxis.options.isVertical);
                });

                test("value axis crosses at first category", function() {
                    equal(primaryValueAxis.options.axisCrossingValue, 0);
                });

                test("category axis crossing value can be changed", function() {
                    plotArea = new Chart.CategoricalPlotArea(columnSeriesData, {
                        categoryAxis: {
                            categories: ["A", "B", "C"],
                            axisCrossingValue: 2
                        }
                    });
                    equal(plotArea.categoryAxis.options.axisCrossingValue, 2);
                });

                test("creates bar chart", function() {
                    ok(chartSeries instanceof Chart.BarChart);
                });

                test("stacks series", function() {
                    plotArea = new Chart.CategoricalPlotArea([{
                            type: "column",
                            data: [],
                            stack: true
                        }], {
                        categoryAxis: {
                            categories: ["A"]
                        }
                    });

                    console.log(plotArea);

                    ok(plotArea.charts[0].options.isStacked);
                });

                test("groups bar series into bar chart", function() {
                    equal(chartSeries.options.series.length, 2);
                });

                test("sets axis min/max to series limits", 2, function() {
                    stubMethod(Chart.CategoricalPlotArea, "createAxes",
                        function() {
                            equal(this.valueAxisRangeTracker.query("primary").min, 10);
                            equal(this.valueAxisRangeTracker.query("primary").max, 300);
                        },
                        function() {
                            createPlotArea(columnSeriesData);
                        }
                    );
                });

                test("applies gap from first series", function() {
                    equals(chartSeries.options.gap, GAP);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Line series", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(lineSeriesData);
                    }
                });

                test("value axis is vertical", function() {
                    ok(primaryValueAxis.options.isVertical);
                });

                test("category axis is horizontal", function() {
                    ok(!categoryAxis.options.isVertical);
                });

                test("creates line chart", function() {
                    ok(chartSeries instanceof Chart.LineChart);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Vertical line series", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(verticalLineSeriesData);
                    }
                });

                test("value axis is horizontal", function() {
                    ok(!primaryValueAxis.options.isVertical);
                });

                test("category axis is vertical", function() {
                    ok(categoryAxis.options.isVertical);
                });

                test("creates line chart", function() {
                    ok(chartSeries instanceof Chart.LineChart);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Area series", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(areaSeriesData);
                    }
                });

                test("value axis is vertical", function() {
                    ok(primaryValueAxis.options.isVertical);
                });

                test("category axis is horizontal", function() {
                    ok(!categoryAxis.options.isVertical);
                });

                test("creates area chart", function() {
                    ok(chartSeries instanceof Chart.AreaChart);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Verical area series", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(verticalAreaSeriesData);
                    }
                });

                test("value axis is horizontal", function() {
                    ok(!primaryValueAxis.options.isVertical);
                });

                test("category axis is vertical", function() {
                    ok(categoryAxis.options.isVertical);
                });

                test("creates area chart", function() {
                    ok(chartSeries instanceof Chart.AreaChart);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Bar series", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(barSeriesData);
                    }
                });

                test("value axis is horizontal", function() {
                    ok(!primaryValueAxis.options.isVertical);
                });

                test("category axis is vertical", function() {
                    ok(categoryAxis.options.isVertical);
                });

                test("value axis crosses at last category", function() {
                    equal(plotArea.categoryAxis.options.axisCrossingValue, 3);
                });

                test("value axis crossing can be changed", function() {
                    plotArea = new Chart.CategoricalPlotArea(barSeriesData, {
                        categoryAxis: {
                            categories: ["A", "B", "C"],
                            axisCrossingValue: 2
                        }
                    });
                    equal(plotArea.categoryAxis.options.axisCrossingValue, 2);
                });

                test("stacks series", function() {
                    plotArea = new Chart.CategoricalPlotArea([{
                            type: "bar",
                            data: [],
                            stack: true
                        }], {
                        categoryAxis: {
                            categories: ["A"]
                        }
                    });

                    ok(plotArea.charts[0].options.isStacked);
                });

                test("applies gap from first series", function() {
                    equals(chartSeries.options.gap, GAP);
                });

            })();

            (function() {
                var plotArea,
                    barSeriesData = [{
                        name: "Value A",
                        type: "bar",
                        data: [100]
                    }];

                function createPlotArea(categoryAxis, valueAxis, plotArea) {
                    plotArea = new Chart.CategoricalPlotArea(barSeriesData, {
                        categoryAxis: categoryAxis,
                        valueAxis: valueAxis,
                        plotArea: plotArea
                    });

                    stubMethod(Chart.NumericAxis, "getViewElements", function() { return []; },
                        function() {
                            stubMethod(Chart.CategoryAxis, "getViewElements", function() { return []; },
                                function() {
                                    plotArea.reflow(chartBox);
                                    plotArea.getViewElements(view);
                                }
                    )});
                }

                // ------------------------------------------------------------
                module("Categorical PlotArea / Major Gridlines", {
                    setup: function() {
                        moduleSetup();
                    }
                });

                test("renders gridlines", function() {
                    createPlotArea({
                        categories: ["A"],
                        majorGridLines: {
                            visible: true
                        }
                    });

                    equal(view.log.line.length, 7);
                });

                test("should not render gridlines for numeric axis", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(view.log.line.length, 1);
                });

                test("should not render gridlines for category axis", function() {
                    var categoryAxis = {
                            categories: ["A"]
                        };

                    createPlotArea(categoryAxis);

                    equal(view.log.line.length, 6);
                });

                test("should not render gridlines", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: false
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(view.log.line.length, 0);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Minor Gridlines", {
                    setup: function() {
                        moduleSetup();
                    }
                });

                test("renders gridlines", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(view.log.line.length, 32);
                });

                test("should not render gridlines for numeric axis", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(view.log.line.length, 2);
                });

                test("should not render gridlines for category axis", function() {
                    var categoryAxis = {
                            categories: ["A"]
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(view.log.line.length, 30);
                });

                test("should not render gridlines", function() {
                    var categoryAxis = {
                            categories: ["A"]
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(view.log.line.length, 0);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Major and Minor GridLines", {
                    setup: function() {
                        moduleSetup();
                    }
                });

                test("should not render minor and major gridline to a same point", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: true
                            },
                            minorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: true
                            },
                            minorGridLines: {
                                visible: true
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(view.log.line.length, 32);
                });

                // ------------------------------------------------------------
                module("Categorical PlotArea / Configuration", {
                    setup: function() {
                        moduleSetup();
                    }
                });

                test("applies margin", function() {
                    var plotArea = new Chart.CategoricalPlotArea([{
                            data: [100]
                        }], {
                        categoryAxis: {
                            categories: ["A", "B"],
                            labels: { font: SANS12 }
                        },
                        valueAxis: {
                            labels: { font: SANS12 }
                        },
                        plotArea: {
                            margin: MARGIN
                        }
                    });

                    plotArea.reflow(chartBox);

                    sameBox(plotArea.box, new Box2D(110, 110, 990, 990), TOLERANCE);
                });

                test("should not render plot area with borders", function() {
                    var categoryAxis = {
                            categories: ["A"]
                        },
                        valueAxis = { };

                    createPlotArea(categoryAxis, valueAxis, {
                        border: {
                            color: "red",
                            width: 2,
                            dashType: "dot"
                        }
                    });

                    var plotAreaRect = view.log.rect[2];
                    equal(plotAreaRect.style.dashType, "dot");
                    equal(plotAreaRect.style.stroke, "red");
                    equal(plotAreaRect.style.strokeWidth, 2);
                });

            })();

            (function() {
                var plotArea,
                    categoryAxis,
                    namedXAxes,
                    namedYAxes,
                    scatterSeriesData = [{
                        name: "Value A",
                        type: "scatter",
                        data: [[100, 100], [200, 200], [300, 300]]
                    }, {
                        name: "Value B",
                        type: "scatter",
                        data: [[10, 10], [20, 20], [30, 30]]
                    }];

                function createPlotArea(series, options) {
                    plotArea = new Chart.XYPlotArea(series, options);

                    namedXAxes = plotArea.namedXAxes;
                    namedYAxes = plotArea.namedYAxes;

                    chartSeries = plotArea.charts[0];
                }

                // ------------------------------------------------------------
                module("XY PlotArea / Axes", {
                    setup: function() {
                        moduleSetup();

                        createPlotArea(scatterSeriesData);
                    }
                });

                test("appends primary X axis to children collection", function() {
                    ok($.inArray(namedXAxes.primary, plotArea.children) >= 0);
                });

                test("appends primary Y axis to children collection", function() {
                    ok($.inArray(namedYAxes.primary, plotArea.children) >= 0);
                });

                test("aligns axes at default crossing values", function() {
                    var axisX = namedXAxes.primary,
                        axisY = namedYAxes.primary;

                    plotArea.reflow(chartBox);

                    var crossingSlotY = axisY.getSlot(axisY.options.axisCrossingValue),
                        crossingSlotX = axisX.getSlot(axisX.options.axisCrossingValue);
                    same([crossingSlotY.x1, crossingSlotY.y1], [crossingSlotX.x1, crossingSlotX.y1]);
                });

                test("aligns axises at non-default crossing values", function() {
                    var axisX = namedXAxes.primary,
                        axisY = namedYAxes.primary;

                    axisY.options.axisCrossingValue = 10;
                    axisX.options.axisCrossingValue = 1;

                    plotArea.reflow(chartBox);

                    var crossingSlotY = axisY.getSlot(axisY.options.axisCrossingValue),
                        crossingSlotX = axisX.getSlot(axisX.options.axisCrossingValue);
                    same([crossingSlotY.x1, crossingSlotY.y1], [crossingSlotX.x1, crossingSlotX.y1]);
                });

                test("X axis limit is [0, 1] when no series are configured", 2, function() {
                    stubMethod(Chart.XYPlotArea, "createAxes",
                        function() {
                            equal(this.xAxisRangeTracker.query("primary").min, 0);
                            equal(this.xAxisRangeTracker.query("primary").max, 1);
                        },
                        function() {
                            plotArea = new Chart.XYPlotArea([]);
                        }
                    );
                });

                test("Y axis limit is [0, 1] when no series are configured", 2, function() {
                    stubMethod(Chart.XYPlotArea, "createAxes",
                        function() {
                            equal(this.yAxisRangeTracker.query("primary").min, 0);
                            equal(this.yAxisRangeTracker.query("primary").max, 1);
                        },
                        function() {
                            plotArea = new Chart.XYPlotArea([]);
                        }
                    );
                });

            })();
        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

    </body>
</html>
