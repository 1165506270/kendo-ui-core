<!DOCTYPE html>
<html>
    <head>
        <title>UI5.Chart Tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <link href="../qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.chart.js"></script>
        <script src="util.js"></script>
        <script type="text/javascript">

            var Chart = kendo.ui.Chart,
                Box2D = Chart.Box2D,
                chartBox = new Box2D(100, 100, 1000, 1000),
                TOLERANCE = 1,
                MARGIN = 10,
                GAP = 4;

            (function() {
                var plotArea,
                    viewFactory,
                    axisY,
                    axisX,
                    barSeriesData = [{
                        name: "Value A",
                        type: "bar",
                        data: [100, 200, 300],
                        gap: GAP
                    }, {
                        name: "Value B",
                        type: "bar",
                        data: [10, 20, 30]
                    }],
                    columnSeriesData = [{
                        name: "Value A",
                        type: "column",
                        data: [100, 200, 300],
                        gap: GAP
                    }, {
                        name: "Value B",
                        type: "column",
                        data: [10, 20, 30]
                    }];

                function createPlotArea(series) {
                    plotArea = new Chart.PlotArea({
                        series: series,
                        categoryAxis: {
                            categories: ["A", "B", "C"]
                        }
                    });

                    axisY = plotArea.axisY;
                    axisX = plotArea.axisX;
                }

                // ------------------------------------------------------------
                module("PlotArea", {
                    setup: function() {
                        createPlotArea(columnSeriesData);
                    }
                });

                test("appends Y-Axis to children collection", function() {
                    ok($.inArray(axisY, plotArea.children));
                });

                test("appends X-Axis to children collection", function() {
                    ok($.inArray(axisX, plotArea.children));
                });

                test("aligns axises at default crossing values", function() {
                    plotArea.updateLayout(chartBox);

                    var crossingSlotY = axisY.getSlot(axisY.options.axisCrossingValue),
                        crossingSlotX = axisX.getSlot(axisX.options.axisCrossingValue);
                    same([crossingSlotY.x1, crossingSlotY.y1], [crossingSlotX.x1, crossingSlotX.y1]);
                });

                test("aligns axises at non-default crossing values", function() {
                    axisY.options.axisCrossingValue = 10;
                    axisX.options.axisCrossingValue = 1;
                    plotArea.updateLayout(chartBox);

                    var crossingSlotY = axisY.getSlot(axisY.options.axisCrossingValue),
                        crossingSlotX = axisX.getSlot(axisX.options.axisCrossingValue);
                    same([crossingSlotY.x1, crossingSlotY.y1], [crossingSlotX.x1, crossingSlotX.y1]);
                });

                test("axes are contained in plot area", function() {
                    plotArea.updateLayout(chartBox);
                    var axisBox = axisY.box.clone().wrap(axisX.box);
                    same([axisBox.x1, axisBox.y1, axisBox.x2, axisBox.y2],
                         [plotArea.box.x1, plotArea.box.y1, plotArea.box.x2, plotArea.box.y2],
                         TOLERANCE);
                });

                test("axis limit is [0, 1] when no series are configured", 2, function() {
                    stubMethod(Chart.PlotArea, "createAxes",
                        function(seriesMin, seriesMax) {
                            equal(seriesMin, 0);
                            equal(seriesMax, 1);
                        },
                        function() {
                            plotArea = new Chart.PlotArea();
                        }
                    );
                });

                test("adds categories to match actual data", function() {
                    var plotArea = new Chart.PlotArea({
                        series: columnSeriesData,
                        categoryAxis: {
                            categories: ["A", "B"]
                        }
                    });

                    equals(plotArea.axisX.options.categories.length, 3);
                });

                test("accepts extra categories", function() {
                    var plotArea = new Chart.PlotArea({
                        series: [{
                            type: "column",
                            data: [100]
                        }],
                        categoryAxis: {
                            categories: ["A", "B"]
                        }
                    });

                    equals(plotArea.axisX.options.categories.length, 2);
                });

                test("set margin 10", function() {
                    var plotArea = new Chart.PlotArea({
                        series: [{
                            data: [100]
                        }],
                        categoryAxis: {
                            categories: ["A", "B"]
                        },
                        plotArea: {
                            margin: MARGIN
                        }
                    });

                    plotArea.updateLayout(chartBox);

                    equals(plotArea.box.x1, chartBox.x1 + MARGIN);
                    equals(plotArea.box.x2, chartBox.x2 - MARGIN);
                    equals(plotArea.box.y1, chartBox.y1 + MARGIN);
                    equals(plotArea.box.y2, chartBox.y2 - MARGIN);
                });

                // ------------------------------------------------------------
                var barChart;
                module("PlotArea / Column series", {
                    setup: function() {
                        createPlotArea(columnSeriesData);
                        barChart = plotArea.charts[0];
                    }
                });

                test("creates numeric Y-Axis", function() {
                    ok(axisY instanceof Chart.NumericAxis);
                });

                test("creates category X-Axis", function() {
                    ok(axisX instanceof Chart.CategoryAxis);
                });

                test("Y-Axis orientation is vertical", function() {
                    equal(axisY.options.orientation, "vertical");
                });

                test("X-Axis orientation is horizontal", function() {
                    equal(axisX.options.orientation, "horizontal");
                });

                test("value axis crosses at first category", function() {
                    equal(axisY.options.axisCrossingValue, 0);
                });

                test("value axis crossing can be changed", function() {
                    plotArea = new Chart.PlotArea({
                        series: columnSeriesData,
                        categoryAxis: {
                            categories: ["A", "B", "C"],
                            axisCrossingValue: 2
                        }
                    });
                    equal(plotArea.axisX.options.axisCrossingValue, 2);
                });

                test("creates bar chart", function() {
                    ok(barChart instanceof Chart.BarChart);
                });

                test("stacks series", function() {
                    plotArea = new Chart.PlotArea({
                        series: [{
                            type: "column",
                            data: [],
                            stack: true
                        }],
                        categoryAxis: {
                            categories: ["A"]
                        }
                    });

                    ok(plotArea.charts[0].options.isStacked);
                });

                test("groups bar series into bar chart", function() {
                    equal(barChart.options.series.length, 2);
                });

                test("sets axis min/max to series limits", 2, function() {
                    stubMethod(Chart.PlotArea, "createAxes",
                        function(seriesMin, seriesMax) {
                            equal(seriesMin, 10);
                            equal(seriesMax, 300);
                        },
                        function() {
                            createPlotArea(columnSeriesData);
                        }
                    );
                });

                test("applies gap from first series", function() {
                    equals(barChart.options.gap, GAP);
                });

                // ------------------------------------------------------------
                module("PlotArea / Bar series", {
                    setup: function() {
                        createPlotArea(barSeriesData);
                    }
                });

                test("creates category Y-Axis", function() {
                    ok(axisY instanceof Chart.CategoryAxis);
                });

                test("creates numeric X-Axis", function() {
                    ok(axisX instanceof Chart.NumericAxis);
                });

                test("Y-Axis orientation is vertical", function() {
                    equal(axisY.options.orientation, "vertical");
                });

                test("X-Axis orientation is horizontal", function() {
                    equal(axisX.options.orientation, "horizontal");
                });

                test("value axis crosses at last category", function() {
                    equal(axisY.options.axisCrossingValue, 3);
                });

                test("value axis crossing can be changed", function() {
                    plotArea = new Chart.PlotArea({
                        series: barSeriesData,
                        categoryAxis: {
                            categories: ["A", "B", "C"],
                            axisCrossingValue: 2
                        }
                    });
                    equal(plotArea.axisY.options.axisCrossingValue, 2);
                });

                test("stacks series", function() {
                    plotArea = new Chart.PlotArea({
                        series: [{
                            type: "bar",
                            data: [],
                            stack: true
                        }],
                        categoryAxis: {
                            categories: ["A"]
                        }
                    });

                    ok(plotArea.charts[0].options.isStacked);
                });

                test("applies gap from first series", function() {
                    equals(barChart.options.gap, GAP);
                });

            })();

            (function() {
                var plotArea,
                    viewFactory,
                    axisY,
                    axisX,
                    barSeriesData = [{
                        name: "Value A",
                        type: "bar",
                        data: [100]
                    }];

                function createPlotArea(categoryAxis, valueAxis) {
                    plotArea = new Chart.PlotArea({
                        series: barSeriesData,
                        categoryAxis: categoryAxis,
                        valueAxis: valueAxis
                    });

                    axisY = plotArea.axisY;
                    axisX = plotArea.axisX;

                    stubMethod(Chart.NumericAxis, "getViewElements", function() { return []; },
                        function() {
                            stubMethod(Chart.CategoryAxis, "getViewElements", function() { return []; },
                                function() {
                                    plotArea.updateLayout(chartBox);
                                    plotArea.getViewElements(viewFactory);
                                }
                    )});
                }

                // ------------------------------------------------------------
                module("PlotArea / Major Gridlines", {
                    setup: function() {
                        viewFactory = new ViewFactoryStub();
                    }
                });

                test("renders gridlines", function() {
                    createPlotArea({
                        categories: ["A"],
                        majorGridLines: {
                            visible: true
                        }
                    });

                    equal(viewFactory.log.line.length, 7);
                });

                test("should not render gridlines for numeric axis", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(viewFactory.log.line.length, 1);
                });

                test("should not render gridlines for category axis", function() {
                    var categoryAxis = {
                            categories: ["A"]
                        };

                    createPlotArea(categoryAxis);

                    equal(viewFactory.log.line.length, 6);
                });

                test("should not render gridlines", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: false
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(viewFactory.log.line.length, 0);
                });

                // ------------------------------------------------------------
                module("PlotArea / Minor Gridlines", {
                    setup: function() {
                        viewFactory = new ViewFactoryStub();
                    }
                });

                test("renders gridlines", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(viewFactory.log.line.length, 32);
                });

                test("should not render gridlines for numeric axis", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(viewFactory.log.line.length, 2);
                });

                test("should not render gridlines for category axis", function() {
                    var categoryAxis = {
                            categories: ["A"]
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            },
                            minorGridLines: {
                                visible: true
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(viewFactory.log.line.length, 30);
                });

                test("should not render gridlines", function() {
                    var categoryAxis = {
                            categories: ["A"]
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: false
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(viewFactory.log.line.length, 0);
                });

                // ------------------------------------------------------------
                module("PlotArea / Major and Minor GridLines", {
                    setup: function() {
                        viewFactory = new ViewFactoryStub();
                    }
                });

                test("should not render minor and major gridline to a same point", function() {
                    var categoryAxis = {
                            categories: ["A"],
                            majorGridLines: {
                                visible: true
                            },
                            minorGridLines: {
                                visible: true
                            }
                        },
                        valueAxis = {
                            majorGridLines: {
                                visible: true
                            },
                            minorGridLines: {
                                visible: true
                            }
                        };

                    createPlotArea(categoryAxis, valueAxis);

                    equal(viewFactory.log.line.length, 32);
                });
            })();
        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

    </body>
</html>
