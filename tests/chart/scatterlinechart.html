<!DOCTYPE html>
<html>
    <head>
        <title>kendo.chart</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <link href="../qunit/qunit/qunit.css" type="text/css" rel="stylesheet"/>
    </head>
    <body>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.dataviz.core.js"></script>
        <script src="../../src/kendo.dataviz.chart.js"></script>
        <script src="../../src/kendo.dataviz.themes.js"></script>
        <script src="../../src/kendo.dataviz.svg.js"></script>
        <script src="../../src/kendo.dataviz.vml.js"></script>
        <script src="util.js"></script>
        <script type="text/javascript">
            var dataviz = kendo.dataviz,
                Box2D = dataviz.Box2D,
                chartBox = new Box2D(0, 0, 800, 600),
                scatterLineChart,
                root,
                view,
                pointCoordinates,
                TOLERANCE = 1;

            function setupScatterLineChart(plotArea, options) {
                view = new ViewStub();

                scatterLineChart = new dataviz.ScatterLineChart(plotArea, options);

                root = new dataviz.RootElement();
                root.append(scatterLineChart);

                scatterLineChart.reflow();
                scatterLineChart.getViewElements(view);
                if (view.log.path[0]) {
                    pointCoordinates = mapPoints(view.log.path[0].points);
                }
            }

            (function() {
                var series = { data: [[1, 1], [2, 2]], labels: {}, type: "scatterLine" },
                    sparseSeries = { data: [
                                        [1, 1], [2, 2], undefined, [2, 2], [null, 1], [1, null]
                                    ], labels: {}, type: "scatterLine", width: 0 },
                    VALUE_AXIS_MAX = 2,
                    CATEGORY_AXIS_Y = 2;

                function PlotAreaStub() { }

                $.extend(PlotAreaStub.prototype, {
                    axisX: {
                        getSlot: function(categoryIndex) {
                            return new Box2D(categoryIndex, CATEGORY_AXIS_Y,
                            categoryIndex + 1, CATEGORY_AXIS_Y);
                        }
                    },
                    axisY: {
                        getSlot: function(value) {
                            var value = typeof value === "undefined" ? 0 : value,
                                valueY = VALUE_AXIS_MAX - value,
                                slotTop = Math.min(CATEGORY_AXIS_Y, valueY),
                                slotBottom = Math.max(CATEGORY_AXIS_Y, valueY);

                            return new Box2D(0, slotTop, 0, slotBottom);
                        },
                        options: {}
                    },
                    namedXAxes: {},
                    namedYAxes: {}
                });

                // ------------------------------------------------------------
                module("Scatter Line Chart / Series", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupScatterLineChart(plotArea, { series: [ series ] });
                    }
                });

                test("Creates points for scatterLineChart data points", function() {
                    equal(scatterLineChart.points.length, series.data.length);
                });

                test("Reports minimum series value for primary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges[undefined].min, series.data[0][0]);
                });

                test("Reports minimum series value for primary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges[undefined].min, series.data[0][1]);
                });

                test("Reports maximum series value for primary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges[undefined].max, series.data[1][0]);
                });

                test("Reports maximum series value for primary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges[undefined].max, series.data[1][1]);
                });

                test("points have set width", function() {
                    $.each(scatterLineChart.points, function() {
                        equal(this.box.width(), 1);
                    });
                });

                test("points have set height according to value", function() {
                    var pointHeights = $.map(scatterLineChart.points, function(point) {
                        return point.box.height();
                    });

                    deepEqual(pointHeights, [1, 2]);
                });

                test("sets point owner", function() {
                    ok(scatterLineChart.points[0].owner === scatterLineChart);
                });

                test("sets point series", function() {
                    ok(scatterLineChart.points[0].series === series);
                });

                test("sets point series index", function() {
                    ok(scatterLineChart.points[0].seriesIx === 0);
                });

                test("sets point dataItem", function() {
                    equal(typeof scatterLineChart.points[0].dataItem, "object");
                });

                test("renders empty scatter line series", function() {
                    setupScatterLineChart(plotArea, { series: [ { data: [] } ] });
                });

                test("renders empty and non-empty scatter line series", function() {
                    setupScatterLineChart(plotArea, { series: [ { data: [] }, series ] });
                });

                // ------------------------------------------------------------
                module("Scatter Line Chart / Multiple Axes", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        plotArea.namedXAxes.secondary = plotArea.axisX;
                        plotArea.namedYAxes.secondary = plotArea.axisY;

                        setupScatterLineChart(plotArea, {
                            series: [
                                { type: "scatterLine", data: [[1, 10], [2, 20]] },
                                { type: "scatterLine", xAxis: "secondary", yAxis: "secondary", data: [[3, 30], [4, 40]] }
                            ]
                        });
                    }
                });

                test("Reports minimum value for primary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges[undefined].min, 1);
                });

                test("Reports minimum value for primary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges[undefined].min, 10);
                });

                test("Reports maximum value for primary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges[undefined].max, 2);
                });

                test("Reports maximum value for primary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges[undefined].max, 20);
                });

                test("Reports minimum value for secondary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges.secondary.min, 3);
                });

                test("Reports minimum value for secondary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges.secondary.min, 30);
                });

                test("Reports maximum value for secondary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges.secondary.max, 4);
                });

                test("Reports maximum value for secondary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges.secondary.max, 40);
                });

                test("Throws error when unable to locate X axis", function() {
                    raises(function() {
                            setupScatterLineChart(plotArea, {
                                series: [
                                    { data: [[1, 10], [2, 20]], xAxis: "b" }
                                ]
                            });
                        },
                        /Unable to locate X axis with name b/);
                });

                test("Throws error when unable to locate Y axis", function() {
                    raises(function() {
                            setupScatterLineChart(plotArea, {
                                series: [
                                    { data: [[1, 10], [2, 20]], yAxis: "b" }
                                ]
                            });
                        },
                        /Unable to locate Y axis with name b/);
                });

                // ------------------------------------------------------------
                module("Scatter Line Chart / Missing values", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupScatterLineChart(plotArea, {
                            series: [ sparseSeries ]
                        });
                    }
                });

                test("Reports minimum series value for primary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges[undefined].min, 1);
                });

                test("Reports minimum series value for primary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges[undefined].min, 1);
                });

                test("Reports maximum series value for primary X axis", function() {
                    deepEqual(scatterLineChart.xAxisRanges[undefined].max, 2);
                });

                test("Reports maximum series value for primary Y axis", function() {
                    deepEqual(scatterLineChart.yAxisRanges[undefined].max, 2);
                });

                test("omits null points by default", function() {
                    equal(scatterLineChart.points[2], null);
                });

                test("omits null points when interpolating", function() {
                    setupScatterLineChart(plotArea, {
                        series: [
                            $.extend({ missingValues: "interpolate" }, sparseSeries)
                        ]
                    });

                    equal(scatterLineChart.points[2], null);
                });

                test("point with missing X value is omitted", function() {
                    equal(scatterLineChart.points[5], null);
                });

                test("point with missing Y value is omitted", function() {
                    equal(scatterLineChart.points[6], null);
                });

                // ------------------------------------------------------------
                module("Scatter Line Chart / Rendering", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                        setupScatterLineChart(plotArea, {
                            series: [
                                    $.extend({
                                        width: 4,
                                        color: "#cf0",
                                        opacity: 0.5,
                                        dashType: "dot",
                                        type: "scatterLine"
                                    },
                                    series
                                )
                            ]
                        });
                    }
                });

                test("sets line width", function() {
                    equal(view.log.path[0].style.strokeWidth, 4);
                });

                test("sets line color", function() {
                    equal(view.log.path[0].style.stroke, "#cf0");
                });

                test("sets line opacity", function() {
                    equal(view.log.path[0].style.strokeOpacity, 0.5);
                });

                test("sets line dashType", function() {
                    equal(view.log.path[0].style.dashType, "dot");
                });

                test("line has same model id as its segment", function() {
                    equal(view.log.path[0].style.data.modelId, scatterLineChart._segments[0].options.modelId);
                });

                test("renders line chart group", function() {
                    equal(view.log.group.length, 1);
                });

                test("sets group animation", function() {
                    equal(view.log.group[0].options.animation.type, "clip");
                });

                // ------------------------------------------------------------
                module("Scatter Line Chart / Rendering / Missing Values", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                    }
                });

                test("line stops before missing value", function() {
                    setupScatterLineChart(plotArea, {
                        series: [
                            sparseSeries
                        ]
                    });

                    deepEqual(pointCoordinates, [
                        [ 1.5, 1 ], [ 2.5, 0 ]
                    ]);
                });

                test("no line is created for isolated points", function() {
                    setupScatterLineChart(plotArea, {
                        series: [
                            sparseSeries
                        ]
                    });

                    equal(view.log.path.length, 1);
                });

                test("line continues after missing value", function() {
                    setupScatterLineChart(plotArea, {
                        series: [{
                            data: [ null, [1, 1], [2, 2]],
                            labels: {}, type: "scatterLine", width: 0
                        }]
                    });

                    deepEqual(pointCoordinates, [
                        [ 1.5, 1 ], [ 2.5, 0 ]
                    ]);
                });

                test("line is drawn between existing points", function() {
                    setupScatterLineChart(plotArea, {
                        series: [
                            $.extend({ missingValues: "interpolate" }, sparseSeries)
                        ]
                    });

                    deepEqual(pointCoordinates, [
                        [ 1.5, 1 ], [ 2.5, 0 ], [ 2.5, 0 ]
                    ]);
                });

                // ------------------------------------------------------------
                module("Scatter Line Chart / Labels", {
                    setup: function() {
                        plotArea = new PlotAreaStub();
                    }
                });

                test("applies full label format", function() {
                    setupScatterLineChart(plotArea, {
                        series: [{
                            data: [[1, 10], [2, 20]],
                            labels: { visible: true, format: "{0:C} {1:C}" },
                            type: "scatterLine"
                        }]
                    });

                    equal(view.log.text[0].content, "$1.00 $10.00");
                });

            })();

            (function() {
                var scatterLineChart,
                    MARGIN = PADDING = BORDER = 5,
                    linePoint,
                    TEMPLATE = "template",
                    FORMAT = "format";

                function PlotAreaStub() { }

                $.extend(PlotAreaStub.prototype, {
                    axisX: {
                        getSlot: function(value) {
                            return new Box2D();
                        }
                    },
                    axisY: {
                        getSlot: function(categoryIndex) {
                            return new Box2D();
                        }
                    }
                });

                function createScatterLineChart(options) {
                    plotArea = new PlotAreaStub();
                    scatterLineChart = new dataviz.ScatterLineChart(plotArea, {
                        series: [$.extend({
                            data: [[0, 0], [1, 1]],
                            type: "scatterLine",
                            color: "#f00",
                            markers: {
                                visible: false,
                                size: 10,
                                type: "triangle",
                                border: {
                                    width: BORDER
                                }
                            },
                            labels: {
                                visible: false,
                                color: "labels-color",
                                background: "labels-background",
                                border: {
                                    color: "labels-border",
                                    width: BORDER
                                },
                                margin: MARGIN,
                                padding: PADDING,
                                template: TEMPLATE,
                                format: FORMAT
                            },
                            opacity: 0.5,
                            dashType: "dot"
                        }, options)]
                    });
                    scatterLinePoint = scatterLineChart.points[0];
                }

                // ------------------------------------------------------------
                module("Scatter Line Chart / Configuration", {
                    setup: function() {
                        createScatterLineChart();
                    }
                });

                test("applies visible to point markers", function() {
                    equal(scatterLinePoint.options.markers.visible, false);
                });

                test("applies series color to point markers border", function() {
                    equal(scatterLinePoint.options.markers.border.color, "#f00");
                });

                test("applies series opacity color to point markers", function() {
                    equal(scatterLinePoint.options.markers.opacity, 0.5);
                });

                test("applies size to point markers", function() {
                    equal(scatterLinePoint.options.markers.size, 10);
                });

                test("applies type to point markers", function() {
                    equal(scatterLinePoint.options.markers.type, "triangle");
                });

                test("applies border color to point markers", function() {
                    createScatterLineChart({ markers: { border: { color: "marker-border" } } });
                    equal(scatterLinePoint.options.markers.border.color, "marker-border");
                });

                test("applies border width to point markers.", function() {
                    equal(scatterLinePoint.options.markers.border.width, BORDER);
                });

                test("applies visible to point labels", function() {
                    equal(scatterLinePoint.options.labels.visible, false);
                });

                test("applies color to point labels", function() {
                    equal(scatterLinePoint.options.labels.color, "labels-color");
                });

                test("applies background to point labels", function() {
                    equal(scatterLinePoint.options.labels.background, "labels-background");
                });

                test("applies border color to point labels", function() {
                    equal(scatterLinePoint.options.labels.border.color, "labels-border");
                });

                test("applies border width to point labels", function() {
                    equal(scatterLinePoint.options.labels.border.width, BORDER);
                });

                test("applies padding to point labels", function() {
                    equal(scatterLinePoint.options.labels.padding, PADDING);
                });

                test("applies margin to point labels", function() {
                    equal(scatterLinePoint.options.labels.margin, MARGIN);
                });

                test("applies dashType to point labels", function() {
                    equal(scatterLinePoint.options.dashType, "dot");
                });

                test("applies template to point labels", function() {
                    equal(scatterLinePoint.options.labels.template, TEMPLATE);
                });

                test("applies format to point labels", function() {
                    equal(scatterLinePoint.options.labels.format, FORMAT);
                });

            })();

            (function() {
                var data = [{
                        xValue: 3,
                        yValue: 1
                    }, {
                        xValue: 2,
                        yValue: 2
                    }, {
                        xValue: 2,
                        yValue: 2
                    }],
                    points;

                // ------------------------------------------------------------
                module("Scatter Chart / Integration", {
                    setup: function() {
                        $("#container").kendoChart({
                            dataSource: {
                                data: data
                            },
                            series: [{
                                type: "scatter",
                                xField: "xValue",
                                yField: "yValue"
                            }]
                        });

                        var chart = $("#container").data("kendoChart");
                        points = chart._plotArea.charts[0].points;
                    },
                    teardown: function() {
                        $("#container").empty();
                    }
                });

                test("gets data from x and y field", function() {
                    equal(points.length, 3);
                });

            })();

        </script>

        <h1 id="qunit-header">kendo.chart</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <div id="container">
        </div>
    </body>
</html>
