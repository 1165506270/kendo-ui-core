<!DOCTYPE html>
<html>
    <head>
        <title>ComboBox Initialization</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.selectable.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.combobox.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">ComboBox Initialization</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var ComboBox = kendo.ui.ComboBox,
                input;

            module("kendo.ui.ComboBox initialization", {
                setup: function() {
                    input = $("<input />").appendTo(document.body);
                },
                teardown: function() {
                    var ul = $(document.body).children(":last");
                    if(!ul[0].id) {
                        ul.remove();
                    }

                    var parent = input.parent();
                    if (parent.is("div")) {
                        parent.remove();
                    } else {
                        input.remove();
                    }
                }
            });

           test("kendoComboBox attaches a combobox object to target", function() {
               input.kendoComboBox({ data: [] });

               ok(input.data("kendoComboBox") instanceof ComboBox);
           });

           test("kendoComboBox extends passed options", function() {
                input.kendoComboBox({test: 1});

                var options = input.data("kendoComboBox").options;
                notEqual(options.test, undefined);
                equal(options.test, 1);
           });

           test("wraps element if no wrapper div.k-widget and hide element", function() {
               input.wrap("<div class='test'/>");

               input.kendoComboBox();

               var wrapper = input.data("kendoComboBox").wrapper;

               ok(wrapper.is("div"));
               ok(wrapper.parent().is("div.test"));
               ok(wrapper.hasClass("k-widget k-combobox k-header"));
               ok(!input.is(":visible"));

               input.parent().remove();
           });

           test("create text input", function() {
               input.kendoComboBox();

               var text = input.data("kendoComboBox").input;

               ok(text.is("input"));
               ok(text.hasClass("k-input"));
           });

           test("text input should wrapped with div", function(){
               input.kendoComboBox();

               var comboWrapper = input.data("kendoComboBox").input.parent();

               ok(comboWrapper.is("div"));
               ok(comboWrapper.hasClass("k-dropdown-wrap k-state-default"));
           });

           test("include arrow after input.k-input", function(){
               input.kendoComboBox();

               var spanArrow = input.data("kendoComboBox").input.next(),
                   arrow = spanArrow.children().eq(0);

               ok(spanArrow.is("span"));
               ok(spanArrow.hasClass("k-select"));
               ok(arrow.is("span"));
               ok(arrow.hasClass("k-icon k-arrow-down"));
               equal(arrow.html(), "select");
           });

           test("text input should copy value of the hidden input on create", function() {
               var combo = input.val("item").kendoComboBox({
                    autoBind: false
               }).data("kendoComboBox");

               equal(combo.input.val(), input.val());
           });

           test("data source is when pass DataSource", function() {
               var dataSource = kendo.data.DataSource.create([{text: 1, value: 1}, {text:2, value:2}]),
               combobox = new ComboBox(input, {dataSource: dataSource});

                ok(combobox.dataSource);
                equal(combobox.dataSource, dataSource);
                equal(combobox.options.dataSource, dataSource);
           });

           test("data source is initialized from options when it is an array", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
                combobox = new ComboBox(input, data);

                ok(combobox.dataSource);
                combobox.dataSource.read();
                equal(combobox.dataSource.data().length, 2);
           });

           test("data source is initialized from options.dataSource when array is passed", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
                   combobox = new ComboBox(input, {
                        dataSource: data
                   });

                ok(combobox.dataSource);
                combobox.dataSource.read();
                equal(combobox.dataSource.data().length, 2);
           });

           test("data source is initialized from options.dataSource", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
                   combobox = new ComboBox(input, {
                       dataSource: {
                              data: data
                     }
                   });

               ok(combobox.dataSource);
               combobox.dataSource.read();
               equal(combobox.dataSource.data().length, 2);
           });

           test("data source is initialized from OPTION items + one custom OPTION", function() {
               var select = $("<select><option value=1>Chai</option><option value=1 selected='selected'>Chai</option></select>"),
                   combobox = new ComboBox(select),
                   data;

               data = combobox.dataSource.view();

               ok(combobox.dataSource);
               equal(data.length, 2);
               equal(data[0].text, "Chai");
               equal(data[0].value, "1");

           });

           test("selected index is get from select element", function() {
               var select = $("<select><option value=1>Chai</option><option value=1 selected='selected'>Chai</option></select>"),
                   combobox = new ComboBox(select);

               equal(combobox.options.index, 1);
           });

           test("set text if select and not autoBind", function() {
               var select = $("<select><option value=1>Chai</option><option value=1 selected='selected'>Chai</option></select>"),
               combobox = new ComboBox(select, {autoBind: false});

               equal(combobox.input.val(), "Chai");
           });

           test("retrived data from OPTIONS does not override options.dataSource", function() {
               var select = $("<select><option value=1>Chai</option><option value=2 selected='selected'>Beverages</option></select>"),
                   data = [{text: "Foo", value: "Foo"}],
                   combobox = new ComboBox(select, {
                       dataSource: {
                              data: data
                     }
                   });

               ok(combobox.dataSource);

               combobox.dataSource.read();
               data = combobox.dataSource.data();

               equal(data.length, 1);
               equal(data[0].text, "Foo");
               equal(data[0].value, "Foo");
           });

           test("combobox initializes an UL for its items", function() {
                 var combobox = new ComboBox(input, []);

                 ok(combobox.ul);
                 ok(combobox.ul.is("ul"));
                 equal(combobox.ul.css("overflow"), "auto");
           });

           test("combobox initializes a popup for its items", function() {
                 var combobox = new ComboBox(input, []);

                 ok(combobox.popup);
                 ok(combobox.popup instanceof kendo.ui.Popup);
                 ok(combobox.popup.options.anchor[0], combobox.input[0]);
                 ok(combobox.popup.element[0], combobox.ul[0]);
           });

           test("combobox shrink ul if the height of the items is more then options.height", function() {
               var data = [{text: "foo", value: 1},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2}];

                  var combobox = new ComboBox(input, data);
                  combobox.options.height = 100;

                  combobox.dataSource.read();

                  equal(combobox.list.css("height"), "100px");
           });

           test("combobox populates its list when the datasource changes", function() {
                  var combobox = new ComboBox(input, [{text: "foo", value: 1}, {text:2, value:2}]);

                  combobox.dataSource.read();

                  equal(combobox.ul.children("li").length, 2);
                  equal(combobox.ul.children("li").first().text(), "foo");
           });

           test("dataAccessors are get from data attributes", function() {
               var select = $('<select data-kendo-text-field="name" data-kendo-value-field="id"></select>');
               combobox = new ComboBox(select, {autoBind: false});

               equal(combobox.options.dataTextField, "name");
               equal(combobox.options.dataValueField, "id");
           });

           test("template should render item directly if datatextField is empty string", function(){
                var combobox = new ComboBox(input, { dataTextField : ""});

                equal(combobox.template("foo"), "<li class='k-item' unselectable='on'>foo</li>");
           });

           test("template should use defined datatextField", function(){
                var combobox = new ComboBox(input, {
                    dataTextField : "ProductName"
                });

                equal(combobox.template({ProductName: "foo"}), "<li class='k-item' unselectable='on'>foo</li>");
           });

           test("changing the template", function() {
               var combobox = new ComboBox(input, {
                   datatextField: "",
                   template: "#= data.toUpperCase() #"
               });

               equal(combobox.template("foo"), "<li class='k-item' unselectable='on'>FOO</li>");
               equal(combobox.options.template, "#= data.toUpperCase() #");
           });

           test("should populate text and value if items", function() {
               var combobox = new ComboBox(input, {
                   dataSource: [{text: "foo", value: 1}, {text:2, value:2}],
                   index: 0
               });

               equal(combobox.text(), "foo");
               equal(combobox.value(), "1");
           });

           test("disabled input rendered with wrapper.k-state-disabled", function() {
               input.attr("disabled", "disabled").kendoComboBox();

               var combobox = input.data("kendoComboBox");

               ok(combobox._inputWrapper.hasClass("k-state-disabled"));
               ok(combobox.input.prop("disabled"));
           });

           test("rebuild select options if data", function() {
               var select = $("<select><option value=1>foo1</option><option value=2>foo2</option><option value=3>foo3</option></select>"),
               combobox = new ComboBox(select, {
                   dataSource: [{text: "Foo", value: 0}, {text: 0, value:5}]
               });

               setTimeout(function() {
                   var children = select.children();

                   equal(children.length, 2);
                   equal(children.eq(0).text(), "Foo");
                   equal(children.eq(0).val(), "0");
                   equal(children.eq(1).text(), "0");
                   equal(children.eq(1).val(), "5");
                   start();
               }, 500);

               stop(1);
           });

           test("value with space should be added to option", function() {
               var select = $("<select><option value=1>foo1</option><option value=2>foo2</option><option value=3>foo3</option></select>"),
               combobox = new ComboBox(select, {
                   index: 0,
                   dataSource: [{text: "Foo", value: "Foo 1"}, {text: "Foo 2", value:"Foo 2"}]
               });

               setTimeout(function() {
                   equal(combobox.value(), "Foo 1");
                   start();
               }, 500);

               stop(1);
           });

           test("copy input styles to the visible input", function() {
               input.css("color", "red").kendoComboBox();

               var color = input.css("color");

               var combobox = input.data("kendoComboBox");

               equal(combobox.input.css("color"), color);
               ok(combobox.input.is(":visible"));

           });

           test("copy input className to the visible input", function() {
               input.addClass("test").kendoComboBox();

               var combobox = input.data("kendoComboBox");

               ok(combobox.input.hasClass("test"));
           });

           test("set height if items height is bigger than options.height", function() {
               var dataSource = new kendo.data.DataSource.create([{text: 1, value: 1}, {text:2, value:2}]);
               dataSource.read();

               combobox = new ComboBox(input, {
                   autoBind: false,
                   dataSource: dataSource,
                   template: "<div style='height:30px'>#= text # </div>",
                   height: 50
               });

               combobox.refresh();

               equal(combobox.list.height(), 50);
           });

            test("pointer over widget should add hover state", function() {
                var data = [{text: 1, value: 1}, {text:2, value:2}],
                    combobox = new ComboBox(input, {
                         dataSource: data
                    }),
                    wrap = combobox.wrapper.children(".k-dropdown-wrap");

                wrap.mouseenter();

                ok(wrap.hasClass("k-state-hover"));
            });

            test("leaving widget should remove hover state", function() {
                var data = [{text: 1, value: 1}, {text:2, value:2}],
                    combobox = new ComboBox(input, {
                         dataSource: data
                    }),
                    wrap = combobox.wrapper.children(".k-dropdown-wrap");

                wrap.mouseenter();
                wrap.mouseleave();

                ok(!wrap.hasClass("k-state-hover"));
            });

            asyncTest("form reset support", function() {
                input.attr("value", "123");

                var form = $("<form/>").appendTo(document).append(input),
                    combobox = new ComboBox(input, {
                         dataSource: [{text: 1, value: 1}, {text:2, value:2}]
                    });

                combobox.select(1);

                form[0].reset();

                setTimeout(function() {
                    equal(combobox.element.val(), "123");
                    equal(combobox.input.val(), "123");
                    start();
                }, 200);
            });

      </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
