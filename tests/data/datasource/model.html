<!DOCTYPE html>
<html>
    <head>
        <title>DataSource model handling</title>
        <script src="../../../src/jquery.js"></script>
        <script type="text/javascript" src="../../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../../qunit-runner.js"></script>
        <script src="../../../src/kendo.core.js"></script>
        <script src="../../../src/kendo.data.js"></script>
        <script src="../../../src/kendo.model.js"></script>
        <link rel="stylesheet" href="../../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">DataSource model handling</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>

            var dataSource;

            function setup(source) {
                data = source || [{ id:1, foo: "foo" },{ id: 2, foo: "foo" }];

                dataSource = new kendo.data.DataSource( {
                    data: data,
                    schema: {
                        model: {
                            id: "id"
                        }
                    }
                });

                dataSource.read();
            }


            module("DataSource", {
                setup: setup
            });

            test("get returns undefined if no model exist with the specified id", function() {
                equal(dataSource.get(3), undefined, "result is undefined");
            });

            test("get returns the model instance with the specified id", function() {
                var model = dataSource.get(1);
                ok(model);
                ok(model instanceof kendo.data.Model);
            });

            test("get returns the model instance with the specified id as string", function() {
                var model = dataSource.get(1);
                equal(model.id, 1);
            });

            test("add appends the specified values", function() {
                dataSource.add( { foo: "bar" } );

                equal(dataSource.data().length, 3);
                equal(dataSource.data()[2].foo, "bar");
            });

            test("add returns the new model istance", function() {
                var model = dataSource.add( { foo: "bar" } );

                ok(model instanceof kendo.data.Model);
                equal(model.foo, "bar");
            });

            test("add appends specified model instance", function() {
                var model = new kendo.data.Model({ foo: "bar" });

                equal(dataSource.add(model), model);
            });

            test("inserts specified values at specified position", function() {
                dataSource.insert(0, { foo: "bar" } );

                equal(dataSource.data().length, 3);
                equal(dataSource.data()[0].foo, "bar");
            });

            test("inserts the specified values at first position if index is not specified", function() {
                dataSource.insert({ foo: "bar" } );

                equal(dataSource.data()[0].foo, "bar");
            });

            test("insert returns the new model istance", function() {
                var model = dataSource.insert({ foo: "bar" });

                ok(model instanceof kendo.data.Model);
            });

            test("removes the specified model", function() {
                var model = dataSource.get(1);
                dataSource.remove(model);

                equal(dataSource.data().length, 1);
            });

            test("remove returns the removed model", function() {
                var model = dataSource.get(1);

                equal(dataSource.remove(model), model);
            });

            test("cancelChanges restores removed model", function() {
                dataSource.remove(dataSource.get(1));

                dataSource.cancelChanges();

                equal(dataSource.data().length, 2);

                equal(dataSource.data()[0].id, 1);
                ok(dataSource.data()[0] instanceof kendo.data.Model, "First item is a model");
            });

            test("cancelChanges restores removed model to its original state", function() {
                var model = dataSource.get(1);

                model.set("foo", "bar");

                dataSource.remove(model);

                dataSource.cancelChanges();

                equal(dataSource.get(1).foo, "foo");
            });

            test("cancelChanges removes inserted model", function() {
                dataSource.insert({ foo: "baz" });

                dataSource.cancelChanges();

                equal(dataSource.data().length, 2);
            });

            test("cancelChanges restores updated model to its original state", function() {
                var model = dataSource.get(1);
                model.set("foo", "baz");

                dataSource.cancelChanges();

                equal(dataSource.get(1).foo, "foo");
            });

            test("cancelChanges restores updated model to its original state only for povided model", function() {
                var model1 = dataSource.get(1),
                    model2 = dataSource.get(2);
                model1.set("foo", "baz");
                model2.set("foo", "bar");

                dataSource.cancelChanges(model1);

                equal(dataSource.get(1).foo, "foo");
                equal(dataSource.get(2).foo, "bar");
            });

            test("cancelChanges removes inserted model passed as parameter", function() {
                var model;

                dataSource.get(1).set("foo", "bar");
                model = dataSource.insert({ foo: "baz" });

                dataSource.cancelChanges(model);

                equal(dataSource.get(1).foo, "bar");
                equal(dataSource.data().length, 2);
            });

            test("cancelChanges does not revert it passed model is removed", function() {
                var model = dataSource.get(1);

                dataSource.get(2).set("foo", "bar");
                dataSource.remove(model);

                dataSource.cancelChanges(model);

                equal(dataSource.get(2).foo, "bar");
                equal(dataSource.data().length, 1);
            });

            test("indexOf returns the index of model", function() {
                var model = dataSource.get(1);

                equal(dataSource.indexOf(model), 0);
            });

            test("indexOf returns -1 if model does is not contained in the data source", function() {
                equal(dataSource.indexOf(new kendo.data.Model()), -1);
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
