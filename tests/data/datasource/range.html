<!DOCTYPE html>
<html>
    <script src="../../../src/jquery.js"></script>
    <script type="text/javascript" src="../../qunit.js"></script>
    <script type="text/javascript" src="../../qunit-runner.js"></script>
    <script src="../../../src/kendo.core.js"></script>
    <script src="../../../src/kendo.query.js"></script>
    <script src="../../../src/kendo.model.js"></script>
    <script src="../../../src/kendo.datasource.js"></script>
    <link rel="stylesheet" href="../../qunit.css" type="text/css" />

    <body>
        <h1 id="qunit-header">QUnit example</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var  data = [], DataSource = kendo.data.DataSource;

            function setup(source) {
                data = source || [{ id:1, bar: "foo" },{ id: 2, bar: "foo" }];

                var dataSource = new DataSource( {
                    data: data
                } );

                dataSource.read();
                return dataSource;
            }

            function remoteDataSource(callback) {
                callback = callback || $.noop;
                var total = 10000,
                    dataSource = new kendo.data.DataSource({
                        serverPaging: true,
                        transport: {
                            read: function(options) {
                                var take = options.data.take,
                                skip = options.data.skip;

                                var data = [];

                                for (var i = skip; i < Math.min(skip + take, total); i++) {
                                    data.push({ OrderID: i, ContactName: "Contact " + i, ShipAddress: "Ship Address " + i });
                                }
                                callback();
                                options.success(data);
                            }
                        },
                        pageSize: 16
                    });


                return dataSource;
            }
            test("inrange returns true if available", function() {
                var dataSource = setup();

                ok(dataSource.inRange(0,2));
            });

            test("prefetch gets data for given range", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);

                var ranges = dataSource._ranges;
                equal(ranges.length, 1);
                equal(ranges[0].start, 0);
                equal(ranges[0].end, 1);
                equal(ranges[0].data.length, 1);
                equal(ranges[0].data[0].OrderID, 0);
            });

            test("prefetch multiple calls for same range does not retrieve data multiple times", function() {
                var called = 0,
                    dataSource = remoteDataSource(function () {
                        called++;
                    });

                dataSource.prefetch(0, 1);
                dataSource.prefetch(0, 1);
                equal(dataSource._ranges.length, 1);
                equal(called, 1);
            });

            test("prefetch retrieves different ranges", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(1, 1);

                var ranges = dataSource._ranges;
                equal(ranges.length, 2);
            });

            test("inRange returns true if skip is within range", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(1, 1);
                ok(dataSource.inRange(0, 2));
            });

            test("inRange returns true if start is more than one", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(1, 1);
                ok(dataSource.inRange(1, 1));
            });

            test("inRange returns false if skip is in range but take is not", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(1, 1);
                ok(!dataSource.inRange(0, 3));
            });

            test("inRange returns false if skip and take are in range but prefetched data is missing", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(2, 1);
                ok(!dataSource.inRange(0, 3));
            });

            test("ranges are sorted by start", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(2, 1);
                dataSource.prefetch(0, 1);
                equal(dataSource._ranges[0].start, 0);
                equal(dataSource._ranges[1].start, 2);
            });

            test("prefetch end of range is correctly set when returned data is less than page size", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(10000 - 16, 18);
                equal(dataSource._ranges[0].start, 10000 - 16);
                equal(dataSource._ranges[0].end, 10000);
            });

            test("range if range exists transport is not called", function() {
                var called = 0,
                    dataSource = remoteDataSource(function () {
                        called++;
                    });

                dataSource.prefetch(0, 1);
                dataSource.range(0, 1);
                equal(called, 1);
            });

            test("range if range does not exist transport is called", function() {
                var called = 0,
                    dataSource = remoteDataSource(function () {
                        called++;
                    });

                dataSource.range(0, 1);
                equal(called, 1);
            });

            test("change is raised when range is prefetched", function() {
                var data,
                    dataSource = remoteDataSource();

                dataSource.bind("change", function() {
                    data = dataSource.view();
                });

                dataSource.prefetch(0, 1);
                dataSource.range(0, 1);

                equal(data.length, 1);
            });

            test("change is raised when range is not", function() {
                var called = false, dataSource = remoteDataSource();
                dataSource.bind("change", function() {
                    called = true;
                });

                dataSource.prefetch(0, 1);
                dataSource.range(0, 1);
                ok(called);
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
