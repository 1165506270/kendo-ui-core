<!DOCTYPE html>
<html>
    <script src="../../../src/jquery.js"></script>
    <script type="text/javascript" src="../../qunit.js"></script>
    <script type="text/javascript" src="../../qunit-runner.js"></script>
    <script src="../../../src/kendo.core.js"></script>
    <script src="../../../src/kendo.model.js"></script>
    <script src="../../../src/kendo.data.js"></script>
    <link rel="stylesheet" href="../../qunit.css" type="text/css" />

    <body>
        <h1 id="qunit-header">QUnit example</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var  data = [], DataSource = kendo.data.DataSource,
                timeout;

            module("kendo.ui.DataSource ranges", {
                setup: function() {
                    timeout = window.setTimeout;
                    window.setTimeout = function(callback) {
                        callback();
                    }
                },
                teardown: function() {
                    window.setTimeout = timeout;
                }
            });

            function setup(source) {
                data = source || [{ id:1, bar: "foo" },{ id: 2, bar: "foo" }];

                var dataSource = new DataSource( {
                    data: data
                } );

                dataSource.read();
                return dataSource;
            }

            function remoteDataSource(callback) {
                callback = callback || $.noop;
                var total = 10000,
                    dataSource = new kendo.data.DataSource({
                        serverPaging: true,
                        transport: {
                            read: function(options) {
                                var take = options.data.take,
                                skip = options.data.skip;

                                var data = [];

                                for (var i = skip; i < Math.min(skip + take, total); i++) {
                                    data.push({ OrderID: i, ContactName: "Contact " + i, ShipAddress: "Ship Address " + i });
                                }
                                callback();
                                options.success(data);
                            }
                        },
                        schema: {
                            total:  function () {
                                return total;
                            }
                        },
                        pageSize: 16
                    });

                dataSource._total = total;
                return dataSource;
            }
            test("inrange returns true if available", function() {
                var dataSource = setup();

                ok(dataSource.inRange(0,2));
            });

            test("prefetch gets data for given range", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);

                var ranges = dataSource._ranges;
                equal(ranges.length, 1);
                equal(ranges[0].start, 0);
                equal(ranges[0].end, 1);
                equal(ranges[0].data.length, 1);
                equal(ranges[0].data[0].OrderID, 0);
            });

            test("prefetch multiple calls for same range does not retrieve data multiple times", function() {
                var called = 0,
                    dataSource = remoteDataSource(function () {
                        called++;
                    });

                dataSource.prefetch(0, 1);
                dataSource.prefetch(0, 1);
                equal(dataSource._ranges.length, 1);
                equal(called, 1);
            });

            test("prefetch retrieves different ranges", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(1, 1);

                var ranges = dataSource._ranges;
                equal(ranges.length, 2);
            });

            test("inRange returns true if skip is within range", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(1, 1);
                ok(dataSource.inRange(0, 2));
            });

            test("inRange returns true if start is more than one", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(1, 1);
                ok(dataSource.inRange(1, 1));
            });

            test("inRange returns false if skip is in range but take is not", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(1, 1);
                ok(!dataSource.inRange(0, 3));
            });

            test("inRange returns false if skip and take are in range but prefetched data is missing", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 1);
                dataSource.prefetch(2, 1);
                ok(!dataSource.inRange(0, 3));
            });

            test("ranges are sorted by start", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(2, 1);
                dataSource.prefetch(0, 1);
                equal(dataSource._ranges[0].start, 0);
                equal(dataSource._ranges[1].start, 2);
            });

            test("prefetch end of range is correctly set when returned data is less than page size", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(10000 - 16, 18);
                equal(dataSource._ranges[0].start, 10000 - 16);
                equal(dataSource._ranges[0].end, 10000);
            });

            test("fetchPrevPage adds prev page to the ranges", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.page(4);
                dataSource.fetchPrevPage();
                equal(dataSource._ranges[0].start, 32);
                equal(dataSource._ranges[0].end, 48);
            });

            test("fetchPrevPage if current page is first", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.fetchPrevPage();
                dataSource.fetchPrevPage();
                equal(dataSource._ranges.length, 1);
                equal(dataSource._ranges[0].start, 0);
                equal(dataSource._ranges[0].end, 16);
            });

            test("fetchPrevPage adds prev page to the ranges even if skip is not on begining of the page (second half of the page)", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.range(40, 16);
                dataSource.fetchPrevPage();
                ok(dataSource._rangeExists(16, 32));
            });

            test("fetchNextPage adds prev page to the ranges even if skip is not on begining of the page (first half of the page)", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.range(34, 16);
                dataSource.fetchPrevPage();
                ok(dataSource._rangeExists(16, 32));
            });

            test("fetchNextPage when current page is last no more pages are fetch", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.page(10000/16);
                dataSource.fetchNextPage();
                dataSource.fetchNextPage();
                equal(dataSource._ranges.length, 1);
                equal(dataSource._ranges[0].start, 10000 - 16);
                equal(dataSource._ranges[0].end, 10000);
            });

            test("fetchNextPage adds next page to the ranges", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.page(2);
                dataSource.fetchNextPage();
                equal(dataSource._ranges[1].start, 32);
                equal(dataSource._ranges[1].end, 48);
            });

            test("fetchNextPage adds next page to the ranges even if skip is not on begining of the page (second half of the page)", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.range(20, 16);
                dataSource.fetchNextPage();
                ok(dataSource._rangeExists(32, 48));
            });

            test("fetchNextPage adds next page to the ranges even if skip is not on begining of the page (first half of the page)", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                dataSource.range(32, 16);
                dataSource.fetchNextPage();
                ok(dataSource._rangeExists(48, 64));
            });

            test("range if range exists transport is not called", function() {
                var called = 0,
                    dataSource = remoteDataSource(function () {
                        called++;
                    });

                dataSource.prefetch(0, 1);
                dataSource.range(0, 1);
                equal(called, 1);
            });

            test("range if range does not exist transport is called", function() {
                var called = 0,
                    dataSource = remoteDataSource(function () {
                        called++;
                    });

                dataSource.range(0, 1);
                equal(called, 1);
            });

            test("change is raised when range is prefetched", function() {
                var data,
                    dataSource = remoteDataSource();

                dataSource.bind("change", function() {
                    data = dataSource.view();
                });

                dataSource.prefetch(0, 1);
                dataSource.range(0, 1);

                equal(data.length, 1);
            });

            test("change is raised when range is not", function() {
                var called = false, dataSource = remoteDataSource();
                dataSource.bind("change", function() {
                    called = true;
                });

                dataSource.prefetch(0, 1);
                dataSource.range(0, 1);
                ok(called);
            });

            test("inRange return false if skip is below available range", function() {
                 var dataSource = remoteDataSource();

                dataSource.prefetch(20, 40);
                ok(!dataSource.inRange(0, 40));
            });

            test("range calls transport if skip is below available range", function() {
                var called = 0,
                    dataSource = remoteDataSource(function () {
                        called++;
                    });

                dataSource.prefetch(20, 40);
                dataSource.range(0, 1);
                equal(called, 2);
            });

            test("range fetches range accross multiple prefech ranges", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(20, 20);
                dataSource.prefetch(0, 20);
                dataSource.range(9, 20);

                equal(dataSource.view().length, 20);
                equal(dataSource.view()[0].OrderID, 9);
                equal(dataSource.view()[19].OrderID, 28);
            });

            test("range fetches range accross multiple overlapping prefech ranges", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 15);
                dataSource.prefetch(10, 20);
                dataSource.range(9, 10);

                equal(dataSource.view().length, 10);
                equal(dataSource.view()[0].OrderID, 9);
                equal(dataSource.view()[9].OrderID, 18);
            });

            test("range fetches range accross multiple overlapping prefech ranges 2", function() {
                var dataSource = remoteDataSource();

                dataSource.prefetch(0, 20);
                dataSource.prefetch(20, 20);
                dataSource.range(9, 20);

                equal(dataSource.view().length, 20);
                equal(dataSource.view()[0].OrderID, 9);
                equal(dataSource.view()[19].OrderID, 28);
            });

            test("range fetches range accross multiple overlapping not prefeched ranges transport is called two times", function() {
                var called = 0, dataSource = remoteDataSource(function () { called ++;});

                dataSource.range(9, 20);

                equal(called, 2);
                equal(dataSource.view().length, 20);
                equal(dataSource.view()[0].OrderID, 9);
                equal(dataSource.view()[19].OrderID, 28);
            });

            test("inRange returns false if not the entire range is available", function() {
                 var called = 0,
                    dataSource = remoteDataSource();

                dataSource.prefetch(0, 5);
                dataSource.prefetch(10, 5);
                ok(!dataSource.inRange(0, 10));
            });

            test("read adds result as range", function() {
                var dataSource = remoteDataSource();
                dataSource.read();
                equal(dataSource._ranges[0].start, 0);
                equal(dataSource._ranges[0].end, 16);
            });

            test("read clear previous ranges", function() {
                var dataSource = remoteDataSource();
                dataSource.prefetch(20, 20);
                dataSource.read();
                equal(dataSource._ranges.length, 1);
                equal(dataSource._ranges[0].start, 0);
                equal(dataSource._ranges[0].end, 16);
            });
            test("range page given number of items from index", function() {
                var dataSource = new DataSource({
                    pageSize: 3,
                    data: [{age: 1}, {age: 2},{age: 3}, {age: 4},{age: 5}, {age: 6},{age: 7}, {age: 8}]
                });
                dataSource.read();
                dataSource.range(2, 3);

                var result = dataSource.view();

                equal(result.length, 3);
                equal(result[0].age, 3);
                equal(result[1].age, 4);
                equal(result[2].age, 5);
            });

            test("range if index undefined set to zero", function() {
                var dataSource = new DataSource({
                    pageSize: 3,
                    data: [{age: 1}, {age: 2},{age: 3}, {age: 4},{age: 5}, {age: 6},{age: 7}, {age: 8}]
                });
                dataSource.read();
                dataSource.range(undefined, 3);

                var result = dataSource.view();

                equal(result.length, 3);
                equal(result[0].age, 1);
                equal(result[1].age, 2);
                equal(result[2].age, 3);
            });

            test("range if count is undefined return all data", function() {
                var dataSource = new DataSource({
                    data: [{age: 1}, {age: 2},{age: 3}, {age: 4},{age: 5}, {age: 6},{age: 7}, {age: 8}]
                });
                dataSource.read();
                dataSource.range(0, undefined);

                var result = dataSource.view();

                equal(result.length, 8);
            });

            test("range fetches range accross pages where last page is partial", function() {
                var dataSource = new DataSource({
                    pageSize: 3,
                    data: [{age: 1}, {age: 2},{age: 3}, {age: 4},{age: 5}]
                });
                dataSource.read();
                dataSource.range(3, 3);

                var result = dataSource.view();
                equal(result.length, 2);
            });
            test("range fetch range accross multiple pages where second page is already fetched", function() {
                var dataSource = remoteDataSource();
                dataSource.range(32, 16);
                dataSource.range(30, 16);
                dataSource.range(30, 16);
                dataSource.range(30, 16);
                dataSource.range(30, 16);

                var result = dataSource.view();
                equal(result.length, 16);
                equal(result[0].OrderID, 30);
                equal(result[15].OrderID, 45);
                equal(dataSource._ranges.length, 2);
            });

            test("prefetch multiple request to the last not full page does not add multiple ranges", function () {
                var dataSource = remoteDataSource();
                dataSource.prefetch(dataSource.total() - 4, 16);
                dataSource.prefetch(dataSource.total() - 4, 16);
                dataSource.prefetch(dataSource.total() - 4, 16);
                equal(dataSource._ranges.length, 1);
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
