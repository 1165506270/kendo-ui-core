<!DOCTYPE html>
<html>
    <head>
        <title>sync response</title>
        <script src="../../../src/jquery.js"></script>
        <script type="text/javascript" src="../../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../../qunit-runner.js"></script>
        <script type="text/javascript" src="../../jquery.mockjax.js"></script>
        <script src="../../../src/kendo.core.js"></script>
        <script src="../../../src/kendo.data.js"></script>
        <script src="../../../src/kendo.model.js"></script>
        <link rel="stylesheet" href="../../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">QUnit example</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Model = kendo.data.Model, DataSource = kendo.data.DataSource, dataSource;

            function setup(options) {
                dataSource = new DataSource($.extend({
                    data: [ { id: 1, foo: "foo" }, { id: 2, foo: "foo2" }  ],
                    schema: {
                        model: Model
                    }
                }, options));

                dataSource.read();
            }

            function stubTransport(method, data) {
                var obj = {};
                data = data !== undefined ? data : [ { id: 1, foo: "bar" } ];
                obj[method] = function(options) {
                    options.success($.isFunction(data) ? data() : data);
                }

                stub(dataSource.transport, obj);
            }

            module("datasource sync response", {
                setup: setup
            });

            test("sync updates the fields of created model from array server response", function() {
                stubTransport("create");

                var model = new Model();
                dataSource.add(model);
                dataSource.sync();

                equal(model.id, 1);
                equal(model.get("foo"), "bar");
            });

            test("sync updates the fields of updated model from array server response", function() {
                stubTransport("update");

                var model = dataSource.get(1);
                model.set({ foo: "bar" });
                dataSource.sync();

                equal(model.get("foo"), "bar");
            });

            test("sync updates data from server response", function() {
                stubTransport("update");

                var model = dataSource.get(1);
                model.set({ foo: "bar" });
                dataSource.sync();

                equal(dataSource.data()[0].foo, "bar");
            });

            test("sync updates the fields of created model from single object server response", function() {
                stubTransport("create", { id: 1, foo: "foo" } );

                var model = new Model();
                dataSource.add(model);
                dataSource.sync();

                equal(model.id, 1);
                equal(model.get("foo"), "foo");
            });

            test("sync updates the fields of updated model from single object server response", function() {
                stubTransport("update", { id: 1, foo: "bar" } );

                var model = dataSource.get(1);
                model.set( { foo: "bar" } );
                dataSource.sync();

                equal(model.id, 1);
                equal(model.get("foo"), "bar");
            });

            test("sync merges created model data with server response", function() {
                stubTransport("create", { id: 1 } );

                var model = new Model({ foo: "foo" });
                dataSource.add(model);
                dataSource.sync();

                equal(model.id, 1);
                equal(model.get("foo"), "foo");
            });

            test("sync merges updated model data with server response", function() {
                stubTransport("update", { id: 1 } );

                var model = dataSource.get(1);
                model.set( { foo: "bar" } );
                dataSource.sync();

                equal(model.id, 1);
                equal(model.get("foo"), "bar");
            });

            test("sync updates created model when response is empty", function() {
                stubTransport("create", null );

                var model = new Model({ foo: "foo" });
                dataSource.add(model);
                dataSource.sync();

                equal(model.get("foo"), "foo");
                equal(model.hasChanges(), false);
            });

            test("sync updates the state of updated model when response is empty", function() {
                stubTransport("update", null );

                var model = dataSource.get(1);
                model.set( { foo: "bar" } );
                dataSource.sync();

                equal(model.get("foo"), "bar");
                equal(model.hasChanges(), false);
            });

            test("sync updates all created models with server response", function() {
                var response = [{id:1, foo: "foo"} , {id:2, foo: "bar"}];

                stubTransport("create", function() { return [response.shift()]; });

                var model1 = new Model();
                dataSource.add(model1);

                var model2 = new Model();
                dataSource.add(model2);
                dataSource.sync();

                equal(model1.id, 1);
                equal(model1.get("foo"), "foo");
                equal(model2.id, 2);
                equal(model2.get("foo"), "bar");
            });

            test("sync updates all updated models with server response", function() {
                var response = [{id:1, foo: "bar"} , {id:2, foo: "baz"}];

                stubTransport("update", function() { return [response.shift()]; });

                var model1 = dataSource.get(1);

                model1.set( { foo: "bar" } );

                var model2 = dataSource.get(2);

                model2.set( { foo: "baz" } );

                dataSource.sync();

                equal(model1.get("foo"), "bar");
                equal(model2.get("foo"), "baz");
            });

            test("sync updates all created models with server response when batch is true and incomplete response", function() {
                setup({ batch: true });

                stubTransport("create", [{id:1, foo: "bar"} , {id:2, foo: "baz"}]);

                var model1 = new Model();
                dataSource.add(model1);

                var model2 = new Model();
                dataSource.add(model2);
                dataSource.sync();

                equal(model1.id, 1);
                equal(model1.get("foo"), "bar");
                equal(model2.isNew(), false);
                equal(model2.hasChanges(), false);
            });

        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
