<!DOCTYPE html>
<html>
    <head>
        <title>Query Tests</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <link rel="stylesheet" href="../qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">QUnit example</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Query = kendo.data.Query;

            test("take returns the specified number of records", function() {
                var q = new Query([1,2]);
                var result = q.take(1).toArray();
                equal(result.length, 1);
                equal(result[0], 1);
            });

            test("skip returns new array starting after the specified index", function () {
                var q = new Query([1,2]);
                var result = q.skip(1).toArray();

                equal(result.length, 1);
                equal(result[0], 2);
            });

            test("skip and take returns a page of records", function () {
                var q = new Query([1, 2, 3]);

                var result = q.skip(1).take(2).toArray();

                equal(result.length, 2);
                equal(result[0], 2);
                equal(result[1], 3);
            });

            test("range returns given number of items from specific index", function() {
                 var q = new Query([1, 2, 3, 4, 5, 6, 7, 8]);

                 var result = q.range(1, 4).toArray();
                 equal(result.length, 4);
                 equal(result[0], 2);
                 equal(result[1], 3);
                 equal(result[2], 4);
                 equal(result[3], 5);
            });

            test("orderBy sorts numbers in ascending order", function () {
                var data = [100, 10, 1];

                var result = new Query(data).orderBy(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], 1);
                equal(result[1], 10);
                equal(result[2], 100);
            });

            test("orderBy sorts strings in ascending order", function () {
                var data = ["foo", "bar", "baz"];

                var result = new Query(data).orderBy(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], "bar");
                equal(result[1], "baz");
                equal(result[2], "foo");
            });

            test("orderBy sorts dates in ascending order", function () {
                var data = [new Date(2011, 1, 1), new Date(2008, 1, 1), new Date(2009, 1, 1)];

                var result = new Query(data).orderBy(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0].getFullYear(), 2008);
                equal(result[1].getFullYear(), 2009);
                equal(result[2].getFullYear(), 2011);
            });

            test("orderBy uses selector when sorting", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).orderBy(function (item) {
                    return item.name;
                }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("orderBy does not modify original", function () {
                var data = [3, 2, 1];

                new Query(data).orderBy(function (item) {
                    return item.name;
                }).toArray();

                equal(data.length, 3);
                equal(data[0], 3);
                equal(data[1], 2);
                equal(data[2], 1);
            });

            test("orderby without parameters sorts array", function() {
                var data = new Query([3, 2, 1]).orderBy().toArray();

                equal(data.length, 3);
                equal(data[0], 1);
                equal(data[1], 2);
                equal(data[2], 3);

            });
            test("orderByDescending sorts numbers in descending order", function () {
                var data = [1, 100, 10];

                var result = new Query(data).orderByDescending(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], 100);
                equal(result[1], 10);
                equal(result[2], 1);
            });

            test("orderByDescending sorts strings in descending order", function () {
                var data = ["foo", "bar", "baz"];

                var result = new Query(data).orderByDescending(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], "foo");
                equal(result[1], "baz");
                equal(result[2], "bar");
            });

            test("orderByDescending sorts dates in descending order", function () {
                var data = [new Date(2011, 1, 1), new Date(2008, 1, 1), new Date(2009, 1, 1)];

                var result = new Query(data).orderByDescending(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0].getFullYear(), 2011);
                equal(result[1].getFullYear(), 2009);
                equal(result[2].getFullYear(), 2008);
            });

            test("orderByDescending uses selector when sorting", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).orderByDescending(function (item) {
                    return item.name;
                })
                .toArray();

                equal(result.length, 3);
                equal(result[0].name, "foo");
                equal(result[1].name, "foo");
                equal(result[2].name, "bar");
            });

            test("orderByDescending does not modify original", function () {
                var data = [1, 2, 3];

                new Query(data).orderByDescending(function (item) {
                    return item.name;
                });

                equal(data[0], 1);
                equal(data[1], 2);
                equal(data[2], 3);
            });

            test("sort using ascending descriptor", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort( { field: "name", dir: "asc" }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("sorting nested objects", function() {
                var  data = [{ foo: { age: 1 } }, { foo : { age: 2 } }]

                var result = new Query(data).sort({ field: "foo.age", dir: "desc" }).toArray();

                equal(result[0].foo.age, 2);
            });

            test("sort ignores direction case", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort( { field: "name", dir: "Asc" }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("sort using descending descriptor", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort( { field: "name", dir: "desc" }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "foo");
                equal(result[1].name, "foo");
                equal(result[2].name, "bar");
            });

            test("orderBy using custom comparer", function() {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).orderBy({
                    compare: function(a, b){
                        return a.name > b.name ? 1 : (a.name < b.name ? -1 : 0);
                    }
                }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });
            test("sort using multiple descriptors", function () {
                var data = [{ name: "foo", age: 42 }, { name: "bar", age: 36 }, { name: "foo", age: 15 }];

                var result = new Query(data).sort( [ { field: "name", dir: "desc" }, { field: "age", dir: "asc" } ]).toArray();

                equal(result.length, 3);
                equal(result[0].name, "foo");
                equal(result[0].age, 15);
                equal(result[1].name, "foo");
                equal(result[1].age, 42);
                equal(result[2].name, "bar");
                equal(result[2].age, 36);
            });
            test("sort using two strings as arguments", function() {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort("name", "asc").toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("filter filters on numbers", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "eq",
                    value: 1
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters with field as a function", function() {
                var data = [ 100, 10, 1 ];
                var fieldFunctionWasCalled = false;

                var result = new Query(data).filter( {
                    field: function(item) {
                        fieldFunctionWasCalled = true;
                        return item;
                    },
                    operator: "eq",
                    value: 1
                }).toArray();

                ok(fieldFunctionWasCalled);
                equal(result.length, 1);
                equal(result[0], 1);
            });

            test("filter filters with operator as a function", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];
                var operatorFunctionWasCalled = false;

                var result = new Query(data).filter( {
                    field: "field",
                    operator: function(selector, value) {
                        operatorFunctionWasCalled = true;
                        return function(item) {
                            return selector(item) === value;
                        };
                    },
                    value: 1
                }).toArray();

                ok(operatorFunctionWasCalled);
                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters on dates", function () {
                var data = [new Date(2011, 1, 1), new Date(2008, 1, 1), new Date(2009, 1, 1)];

                var result = new Query(data).filter( {
                    field: function(item) {
                        return item;
                    },
                    operator: "eq",
                    value: new Date(2011, 1, 1)
                }).toArray();

                equal(result.length, 1);
                equal(result[0].getFullYear(), 2011);
            });

            test("filter filters without passing operator defaults to eq", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    value: 1
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters if passing operator allias", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "==",
                    value: 1
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters with neq", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "neq",
                    value: 1
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 100);
                equal(result[1].field, 10);
            });

            test("filter filters with lt", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "lt",
                    value: 100
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 10);
                equal(result[1].field, 1);
            });

            test("filter filters with lte", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "lte",
                    value: 10
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 10);
                equal(result[1].field, 1);
            });

            test("filter filters with gt", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "gt",
                    value: 10
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 100);
            });

            test("filter filters with gte", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "gte",
                    value: 10
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 100);
                equal(result[1].field, 10);
            });

            test("filter filters with eq on string", function() {
                var data = [ {field: "a"} , {field: "b"} , {field: "c"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "eq",
                    value: "c"
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "c");
            });

            test("filter filters with startswith on string", function() {
                var data = [ {field: "abc"} , {field: "bcd"} , {field: "cde"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "startswith",
                    value: "c"
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "cde");
            });

            test("filter filters with endswith on string", function() {
                var data = [ {field: "abc"} , {field: "bcd"} , {field: "cde"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "endswith",
                    value: "c"
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "abc");
            });

            test("filter filters with contains on string", function() {
                var data = [ {field: "abc"} , {field: "bcd"} , {field: "cde"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "contains",
                    value: "b"
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, "abc");
                equal(result[1].field, "bcd");
            });

            test("filter filters with eq on string case sensitive", function() {
                var data = [ {field: "a"} , {field: "b"} , {field: "c"}, {field: "A"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "eq",
                    value: "A",
                    caseSensitive: true
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "A");
            });

            test("filter filters with contains on string case sensitive", function() {
                var data = [ {field: "abc"} , {field: "Bcd"}];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "contains",
                    value: "B",
                    caseSensitive: true
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "Bcd");
            });

            test("filter with multiple expressions", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( [{
                    field: "field",
                    operator: "gte",
                    value: 1
                },
                {
                    field: "field",
                    operator: "lt",
                    value: 100
                }]).toArray();

                equal(result.length, 2);
                equal(result[0].field, 10);
                equal(result[1].field, 1);
            });

            test("filter without specifying field fields array", function() {
                var data = [100, 10, 1];

                var result = new Query(data).filter( {
                    operator: "gte",
                    value: 10
                }).toArray();

                equal(result.length, 2);
                equal(result[0], 100);
                equal(result[1], 10);
            });
            test("groupby groups data by field", function() {
                var data = [ {field: 100} , {field: 100} , {field: 1} ];

                var result = new Query(data).groupBy( {
                    field: "field"
                }).toArray();
                equal(result.length, 2);
                equal(result[0].value, 1);
                equal(result[0].field, "field");
                equal(result[0].items.length, 1);
                equal(result[1].value, 100);
                equal(result[1].field, "field");
                equal(result[1].items.length, 2);
            });

            test("groupby returns ungroup collection if no descriptors are provided", function() {
                var data = [ {field: 100} , {field: 100} , {field: 1} ];

                var result = new Query(data).group( ).toArray();
                equal(result, data);
            });

            test("groupby groups data by field and direction", function() {
                var data = [ {field: 100} , {field: 100} , {field: 1} ];

                var result = new Query(data).group( [{
                    field: "field",
                    dir: "desc"
                }]).toArray();
                equal(result.length, 2);
                equal(result[1].value, 1);
                equal(result[1].field, "field");
                equal(result[1].items.length, 1);
                equal(result[0].value, 100);
                equal(result[0].field, "field");
                equal(result[0].items.length, 2);
            });

            test("groupby groups data by multiple fields", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ],
                    firstGroup,
                    secondGroup;

                var result = new Query(data).group( [{ field: "foo" }, { field: "bar" }]).toArray();

                equal(result.length, 2);
                firstGroup = result[0];
                secondGroup = result[1];

                equal(firstGroup.value, 1);
                equal(firstGroup.field, "foo");
                equal(firstGroup.items.length, 1);
                equal(firstGroup.items[0].value, "baz");
                equal(firstGroup.items[0].field, "bar");
                equal(firstGroup.items[0].items.length, 1);
                equal(secondGroup.value, 100);
                equal(secondGroup.field, "foo");
                equal(secondGroup.items.length, 2);
                equal(secondGroup.items[0].value, "bar");
                equal(secondGroup.items[0].field, "bar");
                equal(secondGroup.items[0].items.length, 1);
                equal(secondGroup.items[1].value, "baz");
                equal(secondGroup.items[1].field, "bar");
                equal(secondGroup.items[1].items.length, 1);
            });

            test("groupby groups data by multiple fields with 3 levels", function() {
                var data = [ {foo: 100, bar: "baz", baz: "baz"} , {foo: 100, bar: "bar", baz: "baz"} , {foo: 1, bar: "baz", baz: "baz"} ],
                    firstGroup,
                    secondGroup;

                var result = new Query(data).group( [{ field: "foo" }, { field: "bar" },{ field: "baz" }]).toArray();
                equal(result.length, 2);
                firstGroup = result[0];
                secondGroup = result[1];

                equal(firstGroup.value, 1);
                equal(firstGroup.field, "foo");
                equal(firstGroup.items.length, 1);
                equal(firstGroup.items[0].value, "baz");
                equal(firstGroup.items[0].field, "bar");
                equal(firstGroup.items[0].items.length, 1);

                equal(firstGroup.value, 1);
                equal(firstGroup.field, "foo");
                equal(firstGroup.items.length, 1);
                equal(firstGroup.items[0].items[0].value, "baz");
                equal(firstGroup.items[0].items[0].field, "baz");
                equal(firstGroup.items[0].items[0].items.length, 1);

                equal(secondGroup.value, 100);
                equal(secondGroup.field, "foo");
                equal(secondGroup.items.length, 2);

                equal(secondGroup.items[0].value, "bar");
                equal(secondGroup.items[0].field, "bar");
                equal(secondGroup.items[0].items.length, 1);
                equal(secondGroup.items[1].value, "baz");
                equal(secondGroup.items[1].field, "bar");
                equal(secondGroup.items[1].items.length, 1);

            });

            test("group aggregates are calculated if provided", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).group( [{ field: "foo", aggregates: [{ field: "foo", aggregate: "sum" }] }]).toArray();

                equal(result.length, 2);

                equal(result[0].aggregates["foo"].sum, 1);
                equal(result[1].aggregates["foo"].sum, 200);
            });

            test("group aggregates are calculated  for multiple fields if provided", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).group( [{ field: "foo", aggregates: [{ field: "foo", aggregate: "sum" }, { field: "bar", aggregate: "count" }] }]).toArray();

                equal(result.length, 2);

                equal(result[0].aggregates["foo"].sum, 1);
                equal(result[1].aggregates["foo"].sum, 200);
                equal(result[0].aggregates["bar"].count, 1);
                equal(result[1].aggregates["bar"].count, 2);
            });

            test("group aggregates are calculated for multiple group levels", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).group( [
                    { field: "foo", aggregates: [{ field: "foo", aggregate: "sum" }] },
                    { field: "bar", aggregates: [{ field: "foo", aggregate: "sum" }]}
                ]).toArray();

                equal(result.length, 2);

                equal(result[0].aggregates["foo"].sum, 1);
                equal(result[0].items[0].aggregates["foo"].sum, 1);
                equal(result[1].aggregates["foo"].sum, 200);
                equal(result[1].items[0].aggregates["foo"].sum, 100);
                equal(result[1].items[1].aggregates["foo"].sum, 100);
            });

            test("group aggregates with multiple group levels and paging original data is required", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).skip(1).take(1).group( [
                    { field: "foo", aggregates: [{ field: "foo", aggregate: "sum" }] },
                    { field: "bar", aggregates: [{ field: "foo", aggregate: "sum" }]}
                ], data).toArray();

                equal(result.length, 1);

                equal(result[0].aggregates["foo"].sum, 200);
                equal(result[0].items[0].aggregates["foo"].sum, 100);
            });

            test("aggregate calculates aggregates for a collection", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).aggregate( [{ field: "foo", aggregate: "sum" }, { field: "bar", aggregate: "count" }] );

                equal(result.foo.sum, 201);
                equal(result.bar.count, 3);
            });

            test("aggregate returns empty object if no descriptor are provided", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).aggregate();

                ok(result);
            });

            test("aggregate returns empty object if collection is empty", function() {
                var data = [ ];

                var result = new Query(data).aggregate([{ field: "foo", aggregate: "sum" }, { field: "bar", aggregate: "count" }]);

                ok(result);
            });

            test("aggregate max returns max value for a given field", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).aggregate( [{ field: "foo", aggregate: "max" }] );

                equal(result.foo.max, 100);
            });

            test("aggregate average for a given field", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).aggregate( [{ field: "foo", aggregate: "average" }] );

                equal(result.foo.average, 67);
            });

            test("aggregate function should be caseinsensitive", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).aggregate( [{ field: "foo", aggregate: "Min" }] );

                equal(result.foo.Min, 1);
            });

            test("aggregate min returns min value for a given field", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).aggregate( [{ field: "foo", aggregate: "min" }] );

                equal(result.foo.min, 1);
            });

            test("group parent group should have hasSubgroups set to true", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).group( [
                    { field: "foo" },
                    { field: "bar" }
                ], data).toArray();

                equal(result.length, 2);

                ok(result[0].hasSubgroups);
                ok(!result[0].items[0].hasSubgroups);
            });
            test("group group should have hasSubgroups set to false", function() {
                var data = [ {foo: 100, bar: "baz"} , {foo: 100, bar: "bar"} , {foo: 1, bar: "baz"} ];

                var result = new Query(data).group( [ { field: "foo" } ], data).toArray();

                equal(result.length, 2);

                ok(!result[0].hasSubgroups);
            });
            test("aggregate return empty object if data is undefined", function() {
                var result = new Query(undefined).aggregate([{ field: "foo", aggregate: "sum" }, { field: "bar", aggregate: "count" }]);

                ok(result);
            });

            test("group on empty array", function() {
                var data = [ ];

                var result = new Query(data).group( [ { field: "foo" } ], data).toArray();

                equal(result.length, 0);
            });
        </script>
    </body>
</html>
