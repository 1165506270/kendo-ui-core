<!DOCTYPE html>
<html>
    <head>
        <title>Query Tests</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.query.js"></script>
        <link rel="stylesheet" href="../qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">QUnit example</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Query = kendo.data.Query;

            test("take returns the specified number of records", function() {
                var q = new Query([1,2]);
                var result = q.take(1).toArray();
                equal(result.length, 1);
                equal(result[0], 1);
            });

            test("skip returns new array starting after the specified index", function () {
                var q = new Query([1,2]);
                var result = q.skip(1).toArray();

                equal(result.length, 1);
                equal(result[0], 2);
            });

            test("skip and take returns a page of records", function () {
                var q = new Query([1, 2, 3]);

                var result = q.skip(1).take(2).toArray();

                equal(result.length, 2);
                equal(result[0], 2);
                equal(result[1], 3);
            });

            test("orderBy sorts numbers in ascending order", function () {
                var data = [100, 10, 1];

                var result = new Query(data).orderBy(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], 1);
                equal(result[1], 10);
                equal(result[2], 100);
            });

            test("orderBy sorts strings in ascending order", function () {
                var data = ["foo", "bar", "baz"];

                var result = new Query(data).orderBy(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], "bar");
                equal(result[1], "baz");
                equal(result[2], "foo");
            });

            test("orderBy sorts dates in ascending order", function () {
                var data = [new Date(2011, 1, 1), new Date(2008, 1, 1), new Date(2009, 1, 1)];

                var result = new Query(data).orderBy(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0].getFullYear(), 2008);
                equal(result[1].getFullYear(), 2009);
                equal(result[2].getFullYear(), 2011);
            });

            test("orderBy uses selector when sorting", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).orderBy(function (item) {
                    return item.name;
                }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("orderBy does not modify original", function () {
                var data = [3, 2, 1];

                new Query(data).orderBy(function (item) {
                    return item.name;
                }).toArray();

                equal(data.length, 3);
                equal(data[0], 3);
                equal(data[1], 2);
                equal(data[2], 1);
            });

            test("orderby without parameters sorts array", function() {
                var data = new Query([3, 2, 1]).orderBy().toArray();

                equal(data.length, 3);
                equal(data[0], 1);
                equal(data[1], 2);
                equal(data[2], 3);

            });
            test("orderByDescending sorts numbers in descending order", function () {
                var data = [1, 100, 10];

                var result = new Query(data).orderByDescending(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], 100);
                equal(result[1], 10);
                equal(result[2], 1);
            });

            test("orderByDescending sorts strings in descending order", function () {
                var data = ["foo", "bar", "baz"];

                var result = new Query(data).orderByDescending(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0], "foo");
                equal(result[1], "baz");
                equal(result[2], "bar");
            });

            test("orderByDescending sorts dates in descending order", function () {
                var data = [new Date(2011, 1, 1), new Date(2008, 1, 1), new Date(2009, 1, 1)];

                var result = new Query(data).orderByDescending(function (item) {
                    return item;
                }).toArray();

                equal(result.length, 3);
                equal(result[0].getFullYear(), 2011);
                equal(result[1].getFullYear(), 2009);
                equal(result[2].getFullYear(), 2008);
            });

            test("orderByDescending uses selector when sorting", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).orderByDescending(function (item) {
                    return item.name;
                })
                .toArray();

                equal(result.length, 3);
                equal(result[0].name, "foo");
                equal(result[1].name, "foo");
                equal(result[2].name, "bar");
            });

            test("orderByDescending does not modify original", function () {
                var data = [1, 2, 3];

                new Query(data).orderByDescending(function (item) {
                    return item.name;
                });

                equal(data[0], 1);
                equal(data[1], 2);
                equal(data[2], 3);
            });

            test("sort using ascending descriptor", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort( { field: "name", dir: "asc" }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("sort ignores direction case", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort( { field: "name", dir: "Asc" }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("sort using descending descriptor", function () {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort( { field: "name", dir: "desc" }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "foo");
                equal(result[1].name, "foo");
                equal(result[2].name, "bar");
            });

            test("orderBy using custom comparer", function() {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).orderBy({
                    compare: function(a, b){
                        return a.name > b.name ? 1 : (a.name < b.name ? -1 : 0);
                    }
                }).toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });
            test("sort using multiple descriptors", function () {
                var data = [{ name: "foo", age: 42 }, { name: "bar", age: 36 }, { name: "foo", age: 15 }];

                var result = new Query(data).sort( [ { field: "name", dir: "desc" }, { field: "age", dir: "asc" } ]).toArray();

                equal(result.length, 3);
                equal(result[0].name, "foo");
                equal(result[0].age, 15);
                equal(result[1].name, "foo");
                equal(result[1].age, 42);
                equal(result[2].name, "bar");
                equal(result[2].age, 36);
            });
            test("sort using two strings as arguments", function() {
                var data = [{ name: "foo" }, { name: "bar" }, { name: "foo"}];

                var result = new Query(data).sort("name", "asc").toArray();

                equal(result.length, 3);
                equal(result[0].name, "bar");
                equal(result[1].name, "foo");
                equal(result[2].name, "foo");
            });

            test("filter filters on numbers", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "eq",
                    value: 1
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters with field as a function", function() {
                var data = [ 100, 10, 1 ];
                var fieldFunctionWasCalled = false;

                var result = new Query(data).filter( {
                    field: function(item) {
                        fieldFunctionWasCalled = true;
                        return item;
                    },
                    operator: "eq",
                    value: 1
                }).toArray();

                ok(fieldFunctionWasCalled);
                equal(result.length, 1);
                equal(result[0], 1);
            });

            test("filter filters with operator as a function", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];
                var operatorFunctionWasCalled = false;

                var result = new Query(data).filter( {
                    field: "field",
                    operator: function(selector, value) {
                        operatorFunctionWasCalled = true;
                        return function(item) {
                            return selector(item) === value;
                        };
                    },
                    value: 1
                }).toArray();

                ok(operatorFunctionWasCalled);
                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters on dates", function () {
                var data = [new Date(2011, 1, 1), new Date(2008, 1, 1), new Date(2009, 1, 1)];

                var result = new Query(data).filter( {
                    field: function(item) {
                        return item;
                    },
                    operator: "eq",
                    value: new Date(2011, 1, 1)
                }).toArray();

                equal(result.length, 1);
                equal(result[0].getFullYear(), 2011);
            });

            test("filter filters without passing operator defaults to eq", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    value: 1
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters if passing operator allias", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "==",
                    value: 1
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 1);
            });

            test("filter filters with neq", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "neq",
                    value: 1
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 100);
                equal(result[1].field, 10);
            });

            test("filter filters with lt", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "lt",
                    value: 100
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 10);
                equal(result[1].field, 1);
            });

            test("filter filters with lte", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "lte",
                    value: 10
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 10);
                equal(result[1].field, 1);
            });

            test("filter filters with gt", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "gt",
                    value: 10
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, 100);
            });

            test("filter filters with gte", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "gte",
                    value: 10
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, 100);
                equal(result[1].field, 10);
            });

            test("filter filters with eq on string", function() {
                var data = [ {field: "a"} , {field: "b"} , {field: "c"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "eq",
                    value: "c"
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "c");
            });

            test("filter filters with startswith on string", function() {
                var data = [ {field: "abc"} , {field: "bcd"} , {field: "cde"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "startswith",
                    value: "c"
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "cde");
            });

            test("filter filters with endswith on string", function() {
                var data = [ {field: "abc"} , {field: "bcd"} , {field: "cde"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "endswith",
                    value: "c"
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "abc");
            });

            test("filter filters with contains on string", function() {
                var data = [ {field: "abc"} , {field: "bcd"} , {field: "cde"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "contains",
                    value: "b"
                }).toArray();

                equal(result.length, 2);
                equal(result[0].field, "abc");
                equal(result[1].field, "bcd");
            });

            test("filter filters with eq on string case sensitive", function() {
                var data = [ {field: "a"} , {field: "b"} , {field: "c"}, {field: "A"} ];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "eq",
                    value: "A",
                    caseSensitive: true
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "A");
            });

            test("filter filters with contains on string case sensitive", function() {
                var data = [ {field: "abc"} , {field: "Bcd"}];

                var result = new Query(data).filter( {
                    field: "field",
                    operator: "contains",
                    value: "B",
                    caseSensitive: true
                }).toArray();

                equal(result.length, 1);
                equal(result[0].field, "Bcd");
            });

            test("filter with multiple expressions", function() {
                var data = [ {field: 100} , {field: 10} , {field: 1} ];

                var result = new Query(data).filter( [{
                    field: "field",
                    operator: "gte",
                    value: 1
                },
                {
                    field: "field",
                    operator: "lt",
                    value: 100
                }]).toArray();

                equal(result.length, 2);
                equal(result[0].field, 10);
                equal(result[1].field, 1);
            });

            test("filter without specifying field fields array", function() {
                var data = [100, 10, 1];

                var result = new Query(data).filter( {
                    operator: "gte",
                    value: 10
                }).toArray();

                equal(result.length, 2);
                equal(result[0], 100);
                equal(result[1], 10);
            });
        </script>
    </body>
</html>
