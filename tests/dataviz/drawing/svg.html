<!DOCTYPE html>
<html>
<head>
    <title>DataViz / Drawing / SVG</title>
    <script src="../../jquery-loader.js"></script>
    <script src="../../qunit/qunit/qunit.js"></script>
    <script src="../../kendo-test-helpers.js"></script>
    <link rel="stylesheet" href="../../qunit/qunit/qunit.css">
</head>
<body>
    <script src="../../../src/kendo.core.js"></script>
    <script src="../../../src/kendo.dataviz.core.js"></script>
    <script src="../../../src/dataviz/util.js"></script>
    <script src="../../../src/dataviz/geometry.js"></script>
    <script src="../../../src/dataviz/drawing/core.js"></script>
    <script src="../../../src/dataviz/drawing/shapes.js"></script>
    <script src="../../../src/dataviz/drawing/svg.js"></script>

    <script>
    var dataviz = kendo.dataviz,

        g = dataviz.geometry,
        Point = g.Point,

        d = dataviz.drawing,
        Group = d.Group,
        Path = d.Path,

        svg = d.svg,
        Node = svg.Node,
        GroupNode = svg.GroupNode,
        PathNode = svg.PathNode,
        Surface = svg.Surface;

    // ------------------------------------------------------------
    var container,
        surface;

    module("Surface", {
        setup: function() {
            container = $("#container")[0];
            surface = new Surface(container);
        }
    });

    test("sets initial options", function() {
        surface = new Surface(container, { foo: true });
        ok(surface.options.foo);
    });

    test("appends svg element to container", function() {
        equal($("#container svg").length, 1);
    });

    test("draw attaches element to root node", function() {
        var group = new Group();
        surface.draw(group);

        deepEqual(surface._root.childNodes[0].srcElement, group);
    });

    test("clear removes element from root node", function() {
        var group = new Group();
        surface.draw(group);
        surface.clear();

        equal(surface._root.childNodes.length, 0);
    });

    test("svg returns current markup", function() {
        surface.draw(new Group());

        var svg = surface.svg();
        ok(svg.indexOf("<?xml") === 0);
        ok(svg.indexOf("<g>") !== -1);
    });

    // ------------------------------------------------------------
    var node;

    module("Node", {
        setup: function() {
            node = new Node();
        }
    });

    test("load appends GroupNode", function() {
        node.append = function(child) {
            ok(child instanceof GroupNode);
        };

        node.load([new Group()]);
    });

    test("load appends PathNode", function() {
        node.append = function(child) {
            ok(child instanceof PathNode);
        };

        node.load([new Path()]);
    });

    test("load appends child nodes", function() {
        var parentGroup = new Group()
        var childGroup = new Group();
        parentGroup.append(childGroup);

        node.load([parentGroup]);

        ok(node.childNodes[0].childNodes[0] instanceof GroupNode);
    });

    test("attachTo renders children", 2, function() {
        var ChildNode = Node.extend({});

        var child = new ChildNode();
        node.append(child);

        var grandChild = new ChildNode();
        child.append(grandChild);

        ChildNode.fn.render = function() {
            ok(true);
            Node.fn.render.call(this);
        };

        node.attachTo(document.createElement("div"));
    });

    // ------------------------------------------------------------
    module("RootNode");

    test("attachTo directly sets element", function() {
        var rootNode = new svg.RootNode();
        var container = document.createElement("div");
        rootNode.attachTo(container);

        deepEqual(rootNode.element, container);
    });

    // ------------------------------------------------------------
    var groupNode;

    module("GroupNode", {
        setup: function() {
            groupNode = new GroupNode();
        }
    });

    test("attachTo sets element", function() {
        groupNode.attachTo(document.createElement("div"));

        ok(groupNode.element);
    });

    test("load attaches node", function() {
        groupNode.attachTo(document.createElement("div"));

        var group = new Group();
        groupNode.load([group]);

        ok(groupNode.childNodes[0].element);
    });

    test("renders group tag", function() {
        equal(groupNode.render(), "<g></g>");
    });

    // ------------------------------------------------------------
    var path,
        pathNode,
        container;

    module("PathNode", {
        setup: function() {
            container = document.createElement("div");

            path = new Path();
            pathNode = new PathNode(path);
            pathNode.attachTo(container);
        }
    });

    test("renders straight segments", function() {
        path.moveTo(0, 0).lineTo(10, 20);

        ok(pathNode.render().indexOf("d='M0 0 10 20'") !== -1);
    });

    test("does not render segments for empty path", function() {
        equal(pathNode.render().indexOf("d="), -1);
    });

    test("renders stroke", function() {
        path.options.set("stroke.color", "red");

        ok(pathNode.render().indexOf("stroke='red'") !== -1);
    });

    test("renders default stroke", function() {
        ok(pathNode.render().indexOf("stroke='black'") !== -1);
    });

    test("renders stroke width", function() {
        path.options.set("stroke.width", 2);

        ok(pathNode.render().indexOf("stroke-width='2'") !== -1);
    });

    test("renders default stroke width", function() {
        ok(pathNode.render().indexOf("stroke-width='1'") !== -1);
    });

    test("renders stroke opacity", function() {
        path.options.set("stroke.opacity", 0.5);

        ok(pathNode.render().indexOf("stroke-opacity='0.5'") !== -1);
    });

    test("does not render stroke opacity if not set", function() {
        equal(pathNode.render().indexOf("stroke-opacity="), -1);
    });

    test("renders stroke dashType", function() {
        path.options.set("stroke.dashType", "dot");

        ok(pathNode.render().indexOf("stroke-dasharray='1.5 3.5'") !== -1);
    });

    test("does not render stroke dashType if not set", function() {
        equal(pathNode.render().indexOf("stroke-dasharray="), -1);
    });

    test("renders stroke linecap", function() {
        path.options.set("stroke.lineCap", "butt");

        ok(pathNode.render().indexOf("stroke-linecap='butt'") !== -1);
    });

    test("renders default stroke linecap", function() {
        ok(pathNode.render().indexOf("stroke-linecap='square'") !== -1);
    });

    test("overrides stroke linecap when dashType is set", function() {
        path.options.set("stroke.dashType", "dot");
        path.options.set("stroke.lineCap", "foo");

        ok(pathNode.render().indexOf("stroke-linecap='butt'") !== -1);
    });

    test("renders stroke linecap when dashType is set to solid", function() {
        path.options.set("stroke.dashType", "solid");
        path.options.set("stroke.lineCap", "foo");

        ok(pathNode.render().indexOf("stroke-linecap='foo'") !== -1);
    });

    test("renders default stroke linecap", function() {
        path.options.set("stroke", {});

        ok(pathNode.render().indexOf("stroke-linecap='square'") !== -1);
    });

    test("renders fill", function() {
        path.options.set("fill", { color: "red", opacity: 0.5 });
        var svg = pathNode.render();

        ok(svg.indexOf("fill='red'") !== -1);
        ok(svg.indexOf("fill-opacity='0.5'") !== -1);
    });

    test("renders empty fill if not set", function() {
        ok(pathNode.render().indexOf("fill='none'") !== -1);
    });

    test("renders empty fill if set to transparent", function() {
        path.options.set("fill.color", "transparent");
        ok(pathNode.render().indexOf("fill='none'") !== -1);
    });

    test("renders cursor", function() {
        path.options.set("cursor", "hand");
        ok(pathNode.render().indexOf("cursor:hand;") !== -1);
    });

    test("does not render cursor if not set", function() {
        ok(pathNode.render().indexOf("cursor") === -1);
    });

    test("geometryChange sets path", function() {
        path.moveTo(0, 0);
        pathNode.attr = function(name, value) {
            equal(name, "d");
            ok(value);
        };

        path.lineTo(10, 10);
    });

    test("optionsChange sets fill", function() {
        pathNode.attr = function(name, value) {
            equal(name, "fill");
            equal(value, "red");
        };

        path.options.set("fill.color", "red");
    });
    </script>

    <h1 id="qunit-header"></h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>

    <div id="container"></div>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <ul id="log"></ul>
</body>
</html>
