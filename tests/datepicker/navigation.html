<!DOCTYPE html>
<html>
    <head>
        <title>DatePicker API</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.calendar.js"></script>
        <script src="../../src/kendo.datepicker.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">DatePicker API</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>

            var DateView = kendo.DateView,
                keys = kendo.keys;

            QUnit.config.testTimeout = 500;

            module("kendo.ui.DatePicker API", {
                setup: function() {
                    div = $("<div />").appendTo(document.body);
                },
                teardown: function() {
                    div.remove();
                }
            });

            test("click enter should raise change event if dateview is closed", function() {
                var input = $("<input />"),
                datepicker = input.kendoDatePicker().data("kendoDatePicker");

                datepicker.close();

                stub(datepicker, { _change: datepicker._change });

                input.focus().val("10/10/2000");
                datepicker._keydown({
                    currentTarget: document.createElement("input"),
                    keyCode: keys.ENTER,
                    preventDefault: $.noop
                });

                equal(datepicker.calls("_change"), 1);
            });

            test("navigate down should persist current viewedValue", function() {
                var value = new Date(2000, 10, 10, 22, 22, 22),
                    upEvent = { keyCode: keys.UP, ctrlKey: true, preventDefault: $.noop },
                    downEvent = { keyCode: keys.DOWN, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({
                        value: value,
                        min: new Date(1999, 10, 10),
                        max: new Date(2111, 10, 10),
                        startView: "month",
                        depth: "month"
                    });

                dv._initCalendar();
                dv.navigate(upEvent);
                dv.navigate(upEvent);

                dv.navigate(downEvent);
                dv.navigate(downEvent);

                equal(+dv._viewedValue, +value);
            });

            //MONTH View
            test("navigate should not move selection if value is bigger than max", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    date = new Date(2000, 11, 1),
                    dv = new DateView({startView: "month", value: date, max: date});

                dv.navigate(event);

                equal(+dv._viewedValue, +date);
                equal(dv.calendar._table.find(".k-state-focused").text(), date.getDate() + "");

            });

            test("navigate should not move selection if value is less than min", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    date = new Date(2000, 11, 1),
                    dv = new DateView({startView: "month", depth: "month", value: date, min: date});

                dv.navigate(event);

                equal(+dv._viewedValue, +date);
                equal(dv.calendar._table.find(".k-state-focused").text(), date.getDate() + "");

            });

            test("navigate should focus next day in month view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                focusedDate.setDate(focusedDate.getDate() + 1);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");

            });

            test("navigate should focus previous day in month view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                focusedDate.setDate(focusedDate.getDate() - 1);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");
            });

            test("navigate should focus day on previous row in month view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                focusedDate.setDate(focusedDate.getDate() - 7);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");
            });

            test("navigate should focus day on next row in month view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                focusedDate.setDate(focusedDate.getDate() + 7);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), focusedDate.getDate() + "");
            });

            //YEAR VIEW
            test("navigate should focus next month in year view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() + 1);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "Dec");

            });

            test("navigate should focus previous month in year view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() - 1);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "Oct");
            });

            test("navigate should focus month on previous row in year view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() - 4);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "Jul");
            });

            test("navigate should focus month on next row in year view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigateUp();

                focusedDate.setMonth(focusedDate.getMonth() + 4);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "Mar");
            });

            //DECADE VIEW
            test("navigate should focus next year in decade view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() + 1);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2001");

            });

            test("navigate should focus previous year in decade view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1999, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() - 1);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1999");
                ok(!dv.calendar._table.find(".k-state-focused").hasClass("k-other-month"));
            });

            test("navigate should focus year on previous row in decade view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({
                        depth: "month",
                        startView: "month",
                        value: new Date(2000, 10, 10),
                        min: new Date(1900, 10, 10),
                        max: new Date(2111, 10, 10)
                    }),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() - 4);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1996");
            });

            test("navigate should focus year on next row in decade view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "decade");

                focusedDate.setFullYear(focusedDate.getFullYear() + 4);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2004");
            });

            //CENTURY VIEW
            test("navigate should focus next decade in century view", function() {
                var event = { keyCode: keys.RIGHT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() + 10);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2010-2019");
            });

            test("navigate should focus previous decade in century view", function() {
                var event = { keyCode: keys.LEFT, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() - 10);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1990-1999");
            });

            test("navigate should focus decade on previous row in century view", function() {
                var event = { keyCode: keys.UP, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() - 40);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "1960-1969");
            });

            test("navigate should focus decade on next row in century view", function() {
                var event = { keyCode: keys.DOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    focusedDate = new Date(dv._viewedValue);

                dv._initCalendar();
                dv.calendar.navigate(null, "century");

                focusedDate.setFullYear(focusedDate.getFullYear() + 40);

                dv.navigate(event);

                equal(+dv._viewedValue, +focusedDate);
                equal(dv.calendar._table.find(".k-state-focused").text(), "2040-2049");
            });

            //Navigate through views
            test("navigate up", function() {
                var event = { keyCode: keys.UP, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                stub(dv.calendar, "navigateUp");

                dv._initCalendar();
                dv.navigate(event);

                equal(dv.calendar.calls("navigateUp"), 1);
            });

            test("navigate down selects date", function() {
                var event = { keyCode: keys.DOWN, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)}),
                    selectedDate = new Date(2000, 10, 15);

                dv._initCalendar();
                dv.calendar._focusCell(selectedDate);

                dv.navigate(event);

                equal(+dv.calendar.value(), +selectedDate);
            });

            test("navigate down", function() {
                var event = { keyCode: keys.DOWN, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({
                        value: new Date(2000, 10, 10),
                        startView: "month",
                        depth: "month",
                        min: new Date(1900, 10, 10),
                        max: new Date(2111, 10, 10)
                    });

                stub(dv.calendar, "navigateDown");
                dv._initCalendar();
                dv.calendar.navigateUp();
                dv.navigate(event);

                equal(dv.calendar.calls("navigateDown"), 1);
            });

            test("navigate left", function() {
                var event = { keyCode: keys.LEFT, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                stub(dv.calendar, "navigateToPast");

                dv._initCalendar();
                dv.navigate(event);

                equal(dv.calendar.calls("navigateToPast"), 1);
            });

            test("navigate right", function() {
                var event = { keyCode: keys.RIGHT, ctrlKey: true, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                stub(dv.calendar, "navigateToFuture");

                dv._initCalendar();
                dv.navigate(event);

                equal(dv.calendar.calls("navigateToFuture"), 1);
            });

            test("Home should focus first day of current month", function() {
                var event = { keyCode: keys.HOME, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv._initCalendar();
                dv.navigate(event);

                var value = dv.calendar.element.find(".k-state-focused").children(":first").data("value");

                equal(value, "11/1/2000");
            });

            test("End should focus last day of current month", function() {
                var event = { keyCode: keys.END, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv._initCalendar();
                dv.navigate(event);

                var value = dv.calendar.element.find(".k-state-focused").children(":first").data("value");

                equal(value, "11/30/2000");
            });

            test("PageUp should focus same day in previous month", function() {
                var event = { keyCode: keys.PAGEUP, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv._initCalendar();
                stub(dv.calendar, {navigateToPast: dv.calendar.navigateToPast});

                dv.navigate(event);

                equal(dv.calendar.calls("navigateToPast"), 1);
            });

            test("PageDown should focus same day in next month", function() {
                var event = { keyCode: keys.PAGEDOWN, preventDefault: $.noop },
                    dv = new DateView({value: new Date(2000, 10, 10), startView: "month", depth: "month", min: new Date(1900, 10, 10), max: new Date(2111, 10, 10)});

                dv._initCalendar();

                stub(dv.calendar, {navigateToFuture: dv.calendar.navigateToFuture});

                dv.navigate(event);

                equal(dv.calendar.calls("navigateToFuture"), 1);
            });

            test("Enter should close date if select date", function() {
                var event = { keyCode: keys.ENTER, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    startView: "month",
                    depth: "month"
                });

                dv.open();

                dv.navigate(event);

                ok(!dv.popup.visible());
            });

            test("Enter should focus viewedDate", function() {
                var event = { keyCode: keys.ENTER, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    min: new Date(1900, 10, 10),
                    max: new Date(2100, 10, 10),
                    startView: "month",
                    depth: "month"
                });

                dv._initCalendar();
                dv.open();

                dv.calendar.navigate(new Date(2000, 10, 10), "year");
                dv.navigate(event);

                ok(dv.popup.visible());
                equal(dv.calendar._table.find(".k-state-focused").length, 1);
            });

            test("Enter should navigate down", function() {
                var event = { keyCode: keys.ENTER, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    min: new Date(1900, 10, 10),
                    max: new Date(2100, 10, 10),
                    startView: "month",
                });

                stub(dv.calendar, "navigateDown");

                dv.open();
                dv.calendar.navigateUp();

                dv.navigate(event);

                equal(dv.calendar.calls("navigateDown"), 1);
            });

            test("Enter should select date", function() {
                var called, event = { keyCode: keys.ENTER, preventDefault: $.noop },
                dv = new DateView({value: new Date(2000, 10, 10), startView: "month"}),
                focused = new Date(2000, 10, 11);

                dv._initCalendar();

                dv.calendar._focusCell(focused);
                dv.navigate(event);

                equal(+dv.calendar.args("navigateDown")[0], +focused);
            });

            test("Esc should close dateView", function() {
                var event = { keyCode: keys.ESC, preventDefault: $.noop },
                dv = new DateView({
                    anchor: $("<input />"),
                    value: new Date(2000, 10, 10),
                    startView: "month"
                });

                dv.open();

                stub(dv.popup, "close");

                dv.navigate(event);

                equal(dv.popup.calls("close"), 1);
            });

            test("keydown triggered from datepicker should call navigate method", function() {
                var input = $("<input />"),
                    datepicker = input.kendoDatePicker().data("kendoDatePicker");

                stub(datepicker.dateView.calendar, "_focusCell");
                input.trigger({ type:"keydown", keyCode: 40});

                equal(datepicker.dateView.calendar.calls("_focusCell"), 1);
            });

            test("keydown triggered from datepicker should call navigate method", function() {
                var input = $("<input />"),
                    datepicker = input.kendoDatePicker().data("kendoDatePicker");

                stub(datepicker.dateView.calendar, "_focusCell");
                input.trigger({ type:"keydown", keyCode: 40});

                equal(datepicker.dateView.calendar.calls("_focusCell"), 1);
            });

            asyncTest("type invalide date does not clear input", function() {
                var input = $("<input />"),
                    datepicker = input.kendoDatePicker({value: new Date()}).data("kendoDatePicker"),
                    value = "invalid date";

                input.focus().val(value).blur();

                setTimeout(function() {
                    equal(input.val(), value);
                    equal(datepicker.value(), null);
                    start();
                }, 300);
            });

            test("click on selected date should close the dateView", function() {
                var dv = new DateView({
                    startView: "month",
                    anchor: $("<input />"),
                    clearBlurTimeout: $.noop,
                    close: function() {
                        ok(true);
                    }
                });

                dv.open();
                dv.value(new Date());

                dv.calendar
                  .element
                  .find(".k-state-selected")
                  .click();
            });

            test("Alt + Down should open the calendar", function() {
                var input = $("<input />"),
                    event = { type: "keydown", keyCode: keys.DOWN, altKey: true, preventDefault: $.noop },
                    datepicker = input.kendoDatePicker().data("kendoDatePicker");

                stub(datepicker.dateView, "open");

                input.trigger(event);

                equal(datepicker.dateView.calls("open"), 1);
            });

            test("Alt + UP should close the calendar", function() {
                var input = $("<input />"),
                    event = { type: "keydown", keyCode: keys.UP, altKey: true, preventDefault: $.noop },
                    datepicker = input.kendoDatePicker().data("kendoDatePicker");

                stub(datepicker.dateView, "close");

                input.trigger(event);

                equal(datepicker.dateView.calls("close"), 1);
            });

        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
