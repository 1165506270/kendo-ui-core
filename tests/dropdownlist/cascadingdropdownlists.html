<!DOCTYPE html>
<html>
    <head>
        <title>Cascading DropDownLists</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../jquery.mockjax.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.dropdownlist.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">DropDownList cascading</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            kendo.ns = "kendo-";
            var DropDownList = kendo.ui.DropDownList,
                parent, child;

            QUnit.config.testTimeout = 500;

            module("kendo.ui.DropDownLists Cascading DropDownLists", {
                setup: function() {
                    parent = $("<input id='parent' />").appendTo(document.body);
                    child = $("<input />").appendTo(document.body);
                },
                teardown: function() {
                    parent.data("kendoDropDownList").destroy();
                    child.data("kendoDropDownList").destroy();

                    parent.closest(".k-widget").remove();
                    child.closest(".k-widget").remove();
               }
            });

            test("Clear child ddl if no data after filtration", function() {
                parent.kendoDropDownList({
                    dataTextField: "parentID",
                    dataValueField: "parentID",
                    dataSource: [
                        { parentID: 1 },
                        { parentID: 2 }
                    ]
                });

                child.kendoDropDownList({
                    cascadeFrom: "parent", //id of the parent
                    dataTextField: "childID",
                    dataValueField: "id",
                    optionLabel: "Select",
                    dataSource:  [
                        { parentID: 1, childID: "1", id: 1 },
                        { parentID: 1, childID: "3", id: 2 }
                    ]
                });

                var parentCB = parent.data("kendoDropDownList"),
                    childCB = child.data("kendoDropDownList");

                //select first item
                parentCB.select(0);
                parentCB.trigger("change");

                //select first item
                childCB.select(0);
                parentCB.trigger("change");

                //select second item
                parentCB.select(1);
                parentCB.trigger("change");

                equal(childCB.value(), "");
                equal(childCB.text(), "Select");
            });

            test("Select optionLabel if no data", function() {
                parent.kendoDropDownList({
                    dataTextField: "parentID",
                    dataValueField: "parentID",
                    autoBind: false,
                    dataSource: [
                        { parentID: 1 },
                        { parentID: 2 },
                        { parentID: 3 }
                    ]
                });

                child.kendoDropDownList({
                    cascadeFrom: "parent", //id of the parent
                    dataTextField: "childID",
                    dataValueField: "id",
                    optionLabel: "Select",
                    autoBind: false,
                    dataSource:  [
                        { parentID: 1, childID: "1", id: 1 },
                        { parentID: 1, childID: "3", id: 2 }
                    ]
                });

                var parentCB = parent.data("kendoDropDownList"),
                    childCB = child.data("kendoDropDownList");


                //select first item
                parentCB.select(2);
                parentCB.trigger("change");

                equal(childCB.value(), "");
                equal(childCB.text(), "Select");
            });

            asyncTest("Cascading DDLs handles consecutive calls of value method", 2, function() {
                $.mockjaxSettings.responseTime = 0;
                $.mockjaxSettings.contentType = "text/html";
                $.mockjax({ url: "fake.json", responseText: [
                    {text: "item1", id: 1},
                    {text: "item2", id: 1},
                    {text: "item3", id: 2},
                    {text: "item4", id: 2}
                ] });

                var ddl = new DropDownList(parent, {
                    optionLabel: "Select",
                    dataValueField: "id",
                    dataTextField: "id",
                    dataSource: {
                        transport: {
                            read: { url: "fake.json", type: "json" }
                        }
                    },
                    autoBind: false
                });

                var ddl2 = new DropDownList(child, {
                    optionLabel: "Select",
                    dataValueField: "text",
                    dataTextField: "text",
                    dataSource: {
                        transport: {
                            read: { url: "fake.json", type: "json" }
                        }
                    },
                    cascadeFrom: "parent",
                    autoBind: false,
                    cascade: function() {
                        start();
                        $.mockjaxClear();

                        equal(ddl.value(), "2");
                        equal(ddl2.value(), "item4");
                    }
                });

                ddl.value("2");
                ddl2.value("item4");
            });

            asyncTest("DropDownList does not clear value if parent has value", function() {
                $.mockjaxSettings.responseTime = 0;
                $.mockjaxSettings.contentType = "text/html";
                $.mockjax({ url: "fake.json", responseText: [
                    {text: "item1", id: 1},
                    {text: "item2", id: 1},
                    {text: "item3", id: 2},
                    {text: "item4", id: 2}
                ] });

                var ddl = new DropDownList(parent, {
                    optionLabel: "Select",
                    dataValueField: "id",
                    dataTextField: "id",
                    dataSource: {
                        transport: {
                            read: { url: "fake.json", type: "json" }
                        }
                    },
                    autoBind: false
                });

                var ddl2 = new DropDownList(child.attr("id", "child"), {
                    optionLabel: "Select",
                    dataValueField: "text",
                    dataTextField: "text",
                    dataSource: {
                        transport: {
                            read: { url: "fake.json", type: "json" }
                        }
                    },
                    cascadeFrom: "parent",
                    autoBind: false
                });

                var ddl3 = new DropDownList($("<input />"), {
                    optionLabel: "Select",
                    dataValueField: "text",
                    dataTextField: "text",
                    dataSource: {
                        transport: {
                            read: { url: "fake.json", type: "json" }
                        }
                    },
                    cascadeFrom: "child",
                    autoBind: false,
                    cascade: function() {
                        start();
                        $.mockjaxClear();

                        equal(ddl.value(), "2");
                        equal(ddl2.value(), "item4");
                        equal(ddl3.value(), "item4");
                    }
                });

                ddl.value("2");
                ddl2.value("item4");
                ddl3.value("item4");
            });

            test("DropDownList clears value if parent has no value", function() {
                var ddl = new DropDownList(parent, {
                    optionLabel: "Select",
                    dataValueField: "id",
                    dataTextField: "text2",
                    dataSource: [
                        {text: "item1", id: "1", text2: "i"},
                        {text: "item3", id: "2", text2: "i"}
                    ],
                    autoBind: false
                });

                var ddl2 = new DropDownList(child.attr("id", "child"), {
                    optionLabel: "Select",
                    dataValueField: "text",
                    dataTextField: "text",
                    dataSource: [
                        {text: "item1", id: "1"},
                        {text: "item2", id: "1"},
                        {text: "item3", id: "2"},
                        {text: "item4", id: "2"}
                    ],
                    cascadeFrom: "parent",
                    autoBind: false
                });

                var ddl3 = new DropDownList($("<input />"), {
                    optionLabel: "Select",
                    dataValueField: "text",
                    dataTextField: "text",
                    dataSource: [
                        {text: "item1", id: "1"},
                        {text: "item2", id: "1"},
                        {text: "item3", id: "2"},
                        {text: "item4", id: "2"}
                    ],
                    cascadeFrom: "child",
                    autoBind: false
                });

                ddl.value("2");
                ddl2.value("item4");
                ddl3.value("item4");

                ddl.value("");

                equal(ddl2.value(), "Select");
            });

            test("DropDownList clears value if parent has no value and child has no data", function() {
                var ddl = new DropDownList(parent, {
                    optionLabel: "Select",
                    dataValueField: "id",
                    dataTextField: "text2",
                    dataSource: [
                        {text: "item1", id: "1", text2: "i"},
                        {text: "item2", id: "2", text2: "i"},
                        {text: "item3", id: "3", text2: "i"}
                    ],
                    autoBind: false
                });

                var ddl2 = new DropDownList(child.attr("id", "child"), {
                    optionLabel: "Select",
                    dataValueField: "text",
                    dataTextField: "text",
                    dataSource: [
                        {text: "item1", id: "1"},
                        {text: "item2", id: "1"},
                        {text: "item3", id: "2"},
                        {text: "item4", id: "2"}
                    ],
                    cascadeFrom: "parent",
                    autoBind: false
                });

                ddl.value("3");

                equal(ddl2.value(), "");
                equal(ddl2.dataItem(), null);
            });
      </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
