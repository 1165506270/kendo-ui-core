<!DOCTYPE html>
<html>
    <head>
        <title>DropDownList Initialization</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.selectable.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.dropdownlist.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">DropDownList Initialization</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var DropDownList = kendo.ui.DropDownList,
                input;

            module("kendo.ui.DropDownList initialization", {
                setup: function() {
                    input = $("<input />").appendTo(document.body);
                },
                teardown: function() {
                    var ul = $(document.body).children(":last");
                    if(!ul[0].id) {
                        ul.remove();
                    }

                    var parent = input.parent();
                    if (parent.is("div")) {
                        parent.remove();
                    } else {
                        input.remove();
                    }
                }
            });

           test("kendoDropDownList attaches a dropdownlist object to target", function() {
                 input.kendoDropDownList({ data: [] });

                 ok(input.data("kendoDropDownList") instanceof DropDownList);
           });

           test("kendoDropDownList extends passed options", function() {
                input.kendoDropDownList({test: 1});

                var options = input.data("kendoDropDownList").options;
                notEqual(options.test, undefined)
                equal(options.test, 1);
           });

           test("wraps element if no wrapper div and hide element", function() {
               input.wrap("<div class='test'/>");
               input.kendoDropDownList();

               var wrapper = input.data("kendoDropDownList").wrapper;

               ok(wrapper.parent().is("div.test"));
               ok(wrapper.is("div.k-widget"));
               ok(wrapper.hasClass("k-widget k-dropdown k-header"));
               ok(!input.is(":visible"));
           });

           test("set tabIndex to the wrapper", function() {
               input.kendoDropDownList();

               var wrapper = input.data("kendoDropDownList").wrapper;

               equal(wrapper.attr("tabIndex"), 0);
           });

           test("create text span", function() {
               input.kendoDropDownList();

               var span = input.data("kendoDropDownList").span;

               ok(span.is("span"));
               ok(span.hasClass("k-input"));
           });

           test("text span should wrapped with div", function(){
               input.kendoDropDownList();

               var dropDownWrapper = input.data("kendoDropDownList").span.parent();

               ok(dropDownWrapper.is("div"));
               ok(dropDownWrapper.hasClass("k-dropdown-wrap k-state-default"));
           });

           test("include arrow after span.k-input", function(){
               input.kendoDropDownList();

               var spanArrow = input.data("kendoDropDownList").span.next(),
                   arrow = spanArrow.children().eq(0);

               ok(spanArrow.is("span"));
               ok(spanArrow.hasClass("k-select"));
               ok(arrow.is("span"));
               ok(arrow.hasClass("k-icon k-arrow-down"));
               equal(arrow.html(), "select");
           });

           test("data source is when pass DataSource", function() {
               var dataSource = kendo.data.DataSource.create([{text: 1, value: 1}, {text:2, value:2}]),
               dropdownlist = new DropDownList(input, {dataSource: dataSource});

                ok(dropdownlist.dataSource);
                equal(dropdownlist.dataSource, dataSource);
                equal(dropdownlist.options.dataSource, dataSource);
           });

           test("data source is initialized from options when it is an array", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
                dropdownlist = new DropDownList(input, data);

                ok(dropdownlist.dataSource);
                dropdownlist.dataSource.read();
                equal(dropdownlist.dataSource.data().length, 2);
           });

           test("data source is initialized from options.dataSource when array is passed", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
                   dropdownlist = new DropDownList(input, {
                        dataSource: data
                   });

                ok(dropdownlist.dataSource);
                dropdownlist.dataSource.read();
                equal(dropdownlist.dataSource.data().length, 2);
           });

           test("data source is initialized from options.dataSource", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
                   dropdownlist = new DropDownList(input, {
                       dataSource: {
                              data: data
                     }
                   });

               ok(dropdownlist.dataSource);
               dropdownlist.dataSource.read();
               equal(dropdownlist.dataSource.data().length, 2);
           });

           test("data source is initialized from OPTION items", function() {
               var select = $("<select><option value=1>Chai</option><option value=1 selected='selected'>Chai</option></select>"),
                   dropdownlist = new DropDownList(select),
                   data;

               data = dropdownlist.dataSource.view();

               ok(dropdownlist.dataSource);
               equal(data.length, 2);
               equal(data[0].text, "Chai");
               equal(data[0].value, "1");

           });

           test("if no options, do not set index", function() {
               var select = $("<select/>"),
                   dropdownlist = new DropDownList(select, {index: 2});

               equal(dropdownlist.options.index, 2);
           });

           test("selected index is get from select element", function() {
               var select = $("<select><option value=1>Chai</option><option value=1 selected='selected'>Chai</option></select>"),
                   dropdownlist = new DropDownList(select);

               equal(dropdownlist.options.index, 1);
           });

           test("retrived data from OPTIONS does not override options.dataSource", function() {
               var select = $("<select><option value=1>Chai</option><option value=2 selected='selected'>Beverages</option></select>"),
                   data = [{text: "Foo", value: "Foo"}],
                   dropdownlist = new DropDownList(select, {
                       dataSource: {
                              data: data
                     }
                   });

               ok(dropdownlist.dataSource);

               dropdownlist.dataSource.read();
               data = dropdownlist.dataSource.data();

               equal(data.length, 1);
               equal(data[0].text, "Foo");
               equal(data[0].value, "Foo");
           });

           test("dropdownlist initializes an UL for its items", function() {
                 input.attr("id", "dropdownlist");
                 var dropdownlist = new DropDownList(input, []);

                 ok(dropdownlist.ul);
                 ok(dropdownlist.ul.is("ul"));
                 ok(dropdownlist.list.attr("id"), input.attr("id") + "-list");
                 equal(dropdownlist.ul.css("overflow"), "auto");
           });

           test("dropdownlist initializes a popup for its items", function() {
                 var dropdownlist = new DropDownList(input, []);

                 ok(dropdownlist.popup);
                 ok(dropdownlist.popup instanceof kendo.ui.Popup);
                 equal(dropdownlist.popup.options.anchor[0], dropdownlist.wrapper[0]);
                 equal(dropdownlist.popup.element[0], dropdownlist.list[0]);
           });

           test("dropdownlist shrink ul if the height of the items is more then options.height", function() {
               var data = [{text: "foo", value: 1},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2},
                           {text:2, value:2}];

                  var dropdownlist = new DropDownList(input, data);
                  dropdownlist.options.height = 100;

                  dropdownlist.dataSource.read();

                  equal(dropdownlist.list.css("height"), "100px");
           });

           test("dropdownlist populates its list when the datasource changes", function() {
                  var dropdownlist = new DropDownList(input, [{text: "foo", value: 1}, {text:2, value:2}]);

                  dropdownlist.dataSource.read();

                  equal(dropdownlist.ul.children("li").length, 2);
                  equal(dropdownlist.ul.children("li").first().text(), "foo");
           });

           test("dataAccessors are get from data attributes", function() {
               var select = $('<select data-text-field="name" data-value-field="id"></select>');
               dropdownlist = new DropDownList(select);

               equal(dropdownlist.options.dataTextField, "name");
               equal(dropdownlist.options.dataValueField, "id");
           });

           test("template should render item directly if datatextField is empty string", function(){
                var dropdownlist = new DropDownList(input, { dataTextField : ""});

                equal(dropdownlist.template("foo"), "<li class='k-item' unselectable='on'>foo</li>");
           });

           test("template should use defined datatextField", function(){
                var dropdownlist = new DropDownList(input, {
                    dataTextField : "ProductName"
                });

                equal(dropdownlist.template({ProductName: "foo"}), "<li class='k-item' unselectable='on'>foo</li>");
           });

           test("changing the template", function() {
               var dropdownlist = new DropDownList(input, {
                   datatextField: "",
                   template: "#= data.toUpperCase() #"
               });

               equal(dropdownlist.template("foo"), "<li class='k-item' unselectable='on'>FOO</li>");
               equal(dropdownlist.options.template, "#= data.toUpperCase() #");
           });

           test("should populate text and value if items", function() {
                 var dropdownlist = new DropDownList(input, [{text: "foo", value: 1}, {text:2, value:2}]);
                 equal(dropdownlist.text(), "foo");
                 equal(dropdownlist.value(), "1");
                 });

           test("disabled input rendered with wrapper.k-state-disabled", function() {
               input.attr("disabled", "disabled").kendoDropDownList();

               var wrapper = input.data("kendoDropDownList").wrapper;

               ok(wrapper.hasClass("k-state-disabled"));
           });

            test("pointer over widget should add hover state", function() {
                var data = [{text: 1, value: 1}, {text:2, value:2}],
                    dropdownlist = new DropDownList(input, {
                         dataSource: data
                    });

                var wrap = dropdownlist.wrapper.children(".k-dropdown-wrap");
                wrap.mouseenter();

                ok(wrap.hasClass("k-state-hover"));
            });

            test("leaving widget should remove hover state", function() {
                var data = [{text: 1, value: 1}, {text:2, value:2}],
                    dropdownlist = new DropDownList(input, {
                         dataSource: data
                    });

                var wrap = dropdownlist.wrapper.children(".k-dropdown-wrap");
                wrap.mouseenter();
                wrap.mouseleave();

                ok(!wrap.hasClass("k-state-hover"));
            });

           test("pointer over li should add hover state", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
                   dropdownlist = new DropDownList(input, {
                        dataSource: data
                   });

                   var li = dropdownlist.ul.show().children().eq(0);
                   li.mouseenter();

               ok(li.hasClass("k-state-hover"));
           });

           test("leave li should remove hover state", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
               dropdownlist = new DropDownList(input, {
                   dataSource: data
               });

               var li = dropdownlist.ul.show().children().eq(0);
               li.mouseenter();
               li.mouseleave();

               ok(!li.hasClass("k-state-hover"));
           });

           test("add k-list class to the UL", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
               dropdownlist = new DropDownList(input, {
                   dataSource: data
               });

               ok(dropdownlist.ul.hasClass("k-list"));
           });

           test("resize UL depending on the element width", function() {
               input.width(200);
               var data = [{text: 1, value: 1}, {text:2, value:2}],
               dropdownlist = new DropDownList(input, {
                   dataSource: data
               });

               equal(dropdownlist.list.width(), 200);
           });

           test("set height if items height is bigger than options.height", function() {
               var dataSource = new kendo.data.DataSource.create([{text: 1, value: 1}, {text:2, value:2}]);
               dataSource.read();

               dropdownlist = new DropDownList(input, {
                   autoBind: false,
                   dataSource: dataSource,
                   template: "<div style='height:30px'><%= text %> </div>",
                   height: 50
               });

               dropdownlist.refresh();

               equal(dropdownlist.list.height(), 50);
           });

           test("optionLabel should create empty item", function() {
               var data = [{text: 1, value: 1}, {text:2, value:2}],
               dropdownlist = new DropDownList(input, {
                   dataSource: data,
                   optionLabel: "Select..."
               });

               equal(dropdownlist._data()[0].text, "Select...");
               equal(dropdownlist._data()[0].value, "");
           });

           test("should not set id to the popup if the input does not have", function() {
               input.removeAttr("id");
               dropdownlist = new DropDownList(input);
               ok(!dropdownlist.list.attr("id"));
           });

      </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
