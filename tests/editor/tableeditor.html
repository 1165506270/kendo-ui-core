<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>kendo.ui.Editor Tests</title>

        <script src="../jquery-loader.js"></script>
        <script src="test-scripts.js"></script>

        <style> html { font-size: 12px; } </style>
    </head>
    <body>

        <div><textarea cols="20" rows="4" id="Editor1" name="Editor1"></textarea></div>

        <script>

            $("#Editor1").kendoEditor();

            var TableEditor = kendo.ui.editor.TableEditor;

            function createTable(rows, cols) {
                return $(
                    "<table><tbody>" +
                        new Array(rows + 1).join(
                            "<tr>" +
                                new Array(cols + 1).join("<td>foo</td>") +
                            "</tr>"
                        ) +
                    "</tbody></table>"
                );
            }

            module("Editor / TableEditor", {
                setup: function() {
                    editor = getEditor();
                }
            });

            var table, tableEditor;

            test("initializing adds select rows to table", function() {
                table = createTable(1, 1);

                tableEditor = new TableEditor(table[0]);

                equal(table.find("tr").length, 2);
                var cells = table.find("td");
                equal(cells.length, 4);
                ok(cells.eq(1).hasClass("k-selection-cell"));
                ok(cells.eq(2).hasClass("k-selection-cell"));
            });

            test("initializing adds select rows with proper cell countto table", function() {
                table = createTable(2, 3);

                tableEditor = new TableEditor(table[0]);

                var cells = table.find("td");
                equal(cells.length, 12);
            });

            test("after init, top-left cell has k-select-all class", function() {
                table = createTable(3, 3);

                tableEditor = new TableEditor(table[0]);

                var topLeftCell = $(table[0].rows[0].cells[0]);
                ok(topLeftCell.hasClass("k-select-all"));
                ok(!topLeftCell.hasClass("k-selection-cell"));
            });

            test("destroying removes selection and selection rows from table", function() {
                table = createTable(2, 3);

                tableEditor = new TableEditor(table[0]);

                tableEditor.selectRow(1);

                tableEditor.destroy();

                equal(table.find("tr").length, 2);
                equal(table.find("td").length, 6);
                equal(table.find(".k-selection-cell").length, 0);
                equal(table.find(".k-selected").length, 0);
            });

            test("selectRow adds selected class to cells in row", function() {
                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                tableEditor.selectRow(1);

                var rows = table.find("tr");

                equal(rows.eq(0).find("td.k-selected").length, 0);
                equal(rows.eq(1).find("td.k-selected").length, 2);
                equal(rows.eq(2).find("td.k-selected").length, 0);
            });

            test("selectColumn adds selected class to cells in column", function() {
                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                tableEditor.selectColumn(1);

                var rows = table.find("tr");

                equal(rows.eq(0).find("td.k-selected").length, 0);
                equal(rows.eq(1).find("td.k-selected").index(), 1);
                equal(rows.eq(2).find("td.k-selected").index(), 1);
            });

            test("clearSelection clears previous row selection", function() {
                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                tableEditor.selectRow(1);
                tableEditor.clearSelection();

                equal(table.find("td.k-selected").length, 0);
            });

            test("clearSelection clears previous column selection", function() {
                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                tableEditor.selectColumn(2);
                tableEditor.clearSelection();

                equal(table.find("td.k-selected").length, 0);
            });

            test("clicking row selection cells calls selectRow with proper index", function() {
                var index;

                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                withMock(tableEditor, "selectRow", function(i) { index = i; }, function() {
                    table.find("td.k-selection-cell:last").click();

                    equal(index, 2);
                });
            });

            test("clicking column selection cells calls selectColumn with proper index", function() {
                var index;

                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                withMock(tableEditor, "selectColumn", function(i) { index = i; }, function() {
                    table.find("tr:first td.k-selection-cell").eq(0).click();

                    equal(index, 1);
                });
            });

            test("clicking column selection cells removes previous selection", function() {
                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                var selectionCells = table.find("tr:first td.k-selection-cell");

                selectionCells.eq(0).click();
                selectionCells.eq(1).click();

                equal(table.find("td.k-selected").length, 2);
            });

            test("shift-clicking column selection cells adds column to selection", function() {
                table = createTable(2, 2);

                tableEditor = new TableEditor(table[0]);

                var selectionCells = table.find("tr:first td.k-selection-cell");

                selectionCells.eq(0).click();
                selectionCells.eq(1).trigger({
                    shiftKey: true,
                    type: "click"
                });

                equal(table.find("td.k-selected").length, 4);
            });

            test("focusing a table within the editor initializes a TableEditor on it", function() {
                var range = createRangeFromText(editor, "<table><tr><td>|foo|</td></tr></table>");

                editor.selectRange(range);
                editor.trigger("select");

                equal($("table", editor.document).find("td.k-selection-cell").length, 2);
            });

            test("blurring a table within the editor destroys its TableEditor", function() {
                var range = createRangeFromText(editor, "<table><tr><td>|foo|</td></tr></table><p>bar</p>");

                editor.selectRange(range);
                editor.trigger("select");

                range.setStart(editor.body.lastChild.firstChild, 1);
                range.collapse(true);
                editor.selectRange(range);
                editor.trigger("select");

                equal($("table", editor.document).find("td.k-selection-cell").length, 0);
            });

            test("selecting table twice does not initialize second TableEditor", function() {
                var range = createRangeFromText(editor, "<table><tr><td>|foo|</td></tr></table>");

                editor.selectRange(range);
                editor.trigger("select");
                editor.trigger("select");

                equal($("table", editor.document).find("td.k-selection-cell").length, 2);
            });

            test("tables in the editor have the k-table class", function() {
                editor.value("<table><tr><td>foo</td></tr></table>");

                equal($("table.k-table", editor.document).length, 1);
            });

        </script>

        <h1 id="qunit-header">kendo.ui.Editor Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

    </body>
</html>
