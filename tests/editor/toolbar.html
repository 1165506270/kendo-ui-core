<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>kendo.ui.Editor Tests</title>

        <script src="../jquery-loader.js"></script>
        <script src="test-scripts.js"></script>

        <style> html { font-size: 12px; } </style>
    </head>
    <body>

        <div><textarea cols="20" rows="4" id="Editor1" name="Editor1"></textarea></div>

        <script>

            var editor = $("#Editor1").kendoEditor({
                tools: [
                    "bold",
                    "italic",
                    "underline",
                    "strikethrough",
                    "fontName",
                    "fontSize",
                    "foreColor",
                    "backColor",
                    "justifyLeft",
                    "justifyCenter",
                    "justifyRight",
                    "justifyFull",
                    "insertUnorderedList",
                    "insertOrderedList",
                    "indent",
                    "outdent",
                    "formatBlock",
                    "createLink",
                    "unlink",
                    "insertImage",
                    "createTable"
                ]
            }).data("kendoEditor");

            var inline;

            var componentType = kendo.support.browser.msie || kendo.support.touch ? 'kendoDropDownList' : 'kendoComboBox';

            var Editor = kendo.ui.Editor;

            module("Toolbar", {
                teardown: function() {
                    editor.trigger("select");
                }
            });

            function value($ui) {
                if (kendo.support.browser.msie) {
                    return $.trim($ui.parent().find("span.k-input").text());
                } else {
                    return $ui.val();
                }
            }

            test('initially fontName should have "inherit" value', function () {
                editor.value("foo");

                var component = $('select.k-fontSize').data(componentType);

                equal(component.value(), 'inherit');
            });

            test('exec with node parameter calls exec', function() {
                var execArgs = [];

                withMock(editor, "exec", function() { execArgs = arguments; }, function() {
                    $('.k-bold', editor.wrapper).click();

                    equal(execArgs.length, 1);
                    equal(execArgs[0], 'bold');
                });
            });

            test("popup buttons do not call exec", function() {
                var called;

                withMock(editor, "exec", function() { called = true; }, function() {
                    $("[data-popup]", editor.wrapper).click();

                    ok(!called);
                });
            });

            test('handle carret selection', function() {
                editor.value('<strong>foo</strong>')
                var range = editor.createRange();
                range.setStart(editor.body.firstChild.firstChild, 1);
                range.setEnd(editor.body.firstChild.firstChild, 1);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok($('.k-bold', editor.wrapper).hasClass('k-state-selected'));
            });

            test('handle word selection', function() {
                editor.value('<strong>foo</strong>')
                var range = editor.createRange();
                range.selectNodeContents(editor.body.firstChild);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok($('.k-bold', editor.wrapper).hasClass('k-state-selected'));
            });

            test('handle mixed selection', function() {
                editor.value('<ul><li>foo</li></ul><ul><li>bar</li></ul>')
                var range = editor.createRange();
                range.setStart(editor.body.firstChild.firstChild.firstChild, 1);
                range.setEnd(editor.body.firstChild.firstChild.firstChild, 1);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok(!$('k-insertUnorderedList', editor.wrapper).hasClass('k-state-selected'));
            });

            test('handle image selection', function() {
                editor.value('<img style="float:right" src="foo" />');
                var range = editor.createRange();
                range.selectNode(editor.body.firstChild);

                editor.getSelection().removeAllRanges();
                editor.getSelection().addRange(range);

                editor.trigger('select');

                ok($('.k-justifyRight', editor.wrapper).hasClass('k-state-selected'));
            });

            if (!kendo.support.browser.msie) {
                // select box does not show custom values

                test('font size combobox on mixed content', function() {
                    editor.selectRange(createRangeFromText(editor, '|foo<span style="font-size:8px;">bar|</span>'));

                    editor.trigger('select');

                    equal(value($('.k-fontSize', editor.wrapper)), '');
                });

                test('font size combobox on custom font size', function() {
                    editor.selectRange(createRangeFromText(editor, '<span style="font-size:8px;">f|o|o</span>'));

                    editor.trigger('select');

                    equal(value($('.k-fontSize', editor.wrapper)), '8px');
                });
            }

            test('inherited font size', function() {
                editor.selectRange(createRangeFromText(editor, '<span>f|o|o</span>'));

                editor.trigger('select');

                equal(value($('.k-fontSize', editor.wrapper)), editor.options.messages.fontSizeInherit);
            });

            test('font size combobox on relative font size', function() {
                editor.selectRange(createRangeFromText(editor, '<span style="font-size:x-small;">f|o|o</span>'));

                editor.trigger('select');

                equal(value($('.k-fontSize', editor.wrapper)), '2 (10pt)');
            });

            var toolbar;
            var dom;
            var editorElement = $("<div />");
            var editorNS = kendo.ui.editor;

            module("Tool configuration & rendering", {
                setup: function() {
                    dom = $("<ul class='k-editor-toolbar' />").appendTo("body");
                    toolbar = new editorNS.Toolbar(dom[0]);
                },

                teardown: function() {
                    toolbar.destroy();
                    dom.remove();
                }
            });

            function mockEditorTools(array, options) {
                return {
                    element: editorElement,
                    options: $.extend({
                        tools: array,
                        messages: {
                            bold: "Bold",
                            italic: "Italic",
                            underline: "Underline",
                            strikethrough: "Strikethrough",
                            superscript: "Superscript",
                            subscript: "Subscript",
                            justifyCenter: "Center text",
                            justifyLeft: "Align text left",
                            justifyRight: "Align text right",
                            justifyFull: "Justify"
                        }
                    }, options),
                    bind: $.noop,
                    exec: $.noop
                };
            }

            test("expands tool configuration for default tool", function() {
                toolbar.bindTo(mockEditorTools([ "bold" ]));

                ok($.isPlainObject(toolbar.tools.bold));
                equal(toolbar.tools.bold.options.name, "bold");
                equal(dom.find(".k-bold").length, 1);
            });

            test("expands tool configuration for custom tool", function() {
                toolbar.bindTo(mockEditorTools([ { name: "foo" } ]));

                ok($.isPlainObject(toolbar.tools.foo));
                equal(toolbar.tools.foo.options.name, "foo");
                equal(toolbar.tools.foo.options.type, "button");
                equal(dom.find(".k-foo").length, 1);
            });

            test("expands native tools", function() {
                toolbar.bindTo(mockEditorTools([]));

                ok(toolbar.tools.undo);
                ok(toolbar.tools.redo);
                ok(toolbar.tools.insertParagraph);
                ok(toolbar.tools.insertLineBreak);
            });

            test("clicking on tool executes editor command", function() {
                var editorMock = mockEditorTools([ "bold" ]);
                var args;

                editorMock.exec = function() { args = arguments; };

                toolbar.bindTo(editorMock);

                dom.find(".k-bold").trigger("click");

                ok(args);
                equal(args[0], "bold");
            });

            test("expands configured tools", function() {
                toolbar.bindTo(mockEditorTools([ {
                    name: "formatting",
                    items: [ { text: "foo", tag: "h1" } ]
                } ]));

                var formatting = dom.find("select.k-formatting");

                ok(formatting.length);

                var dataSource = formatting.data("kendoSelectBox").dataSource;
                equal(dataSource.data().length, 1);
                equal(dataSource.data()[0].text, "foo");
            });

            test("toolById returns tool", function() {
                toolbar.bindTo(mockEditorTools([ { name: "foo" }, { name: "bar" } ]));

                var tool = toolbar.toolById("bar");

                ok(tool);
                equal(tool.options.name, "bar");
            });

            test("snippets tool is not shown if it has no items", function() {
                toolbar.bindTo(mockEditorTools([]));

                equal(dom.find("li").length, 0);
            });

            test("unlink tool applies custom title", function() {
                toolbar.bindTo(mockEditorTools([ "unlink" ], { messages: { unlink: "foo" } }));

                equal(dom.find(".k-unlink").attr("title"), "foo");
            });

            test("clicking disabled links should not navigate", function() {
                toolbar.bindTo(mockEditorTools([ "unlink" ]));

                var isDefaultPrevented = false;
                var navigationListener = function(e) {
                    isDefaultPrevented = e.isDefaultPrevented();
                };

                dom.bind("click", navigationListener);

                dom.find(".k-tool-icon.k-state-disabled:first").trigger("click");

                dom.unbind("click", navigationListener);

                ok(isDefaultPrevented);
            });

            test("first and last buttons in groups get k-group-start/end classes", function() {
                toolbar.bindTo(mockEditorTools([
                    "bold", "italic", "underline",
                    "insertImage", "createLink"
                ]));

                equal(dom.find("li.k-tool-group").length, 2);
                equal(dom.find(".k-group-start").length, 2);
                equal(dom.find(".k-group-end").length, 2);
                ok(dom.find(".k-bold").hasClass("k-group-start"));
                ok(dom.find(".k-insertImage").hasClass("k-group-start"));
                ok(dom.find(".k-underline").hasClass("k-group-end"));
                ok(dom.find(".k-createLink").hasClass("k-group-end"));
            });

            test("hidden buttons do not end groups", function() {
                toolbar.bindTo(mockEditorTools([
                    "createLink", "unlink"
                ]));

                dom.find(".k-unlink").addClass(".k-state-disabled");
                toolbar._updateContext();

                equal(dom.find(".k-createLink.k-group-end").length, 1);
            });

            test("break tool renders row breaking element", function() {
                toolbar.bindTo(mockEditorTools([
                    "bold", "italic", "underline", "break",
                    "createLink", "unlink"
                ]));

                equal(dom.find(".k-row-break").length, 1);
            });

            test("custom tools are moved into new groups", function() {
                toolbar.bindTo(mockEditorTools([
                    "formatting",
                    { name: "custom", template: "<b class='foo' />" },
                    "fontName"
                ]));

                equal(dom.find(".k-tool-group").length, 3);
            });

            test("custom tools are moved into separate groups", function() {
                toolbar.bindTo(mockEditorTools([
                    { name: "custom1", template: "<b class='foo' />" },
                    { name: "custom2", template: "<b class='bar' />" }
                ]));

                equal(dom.find(".k-tool-group").length, 2);
            });

            test("custom tools exec function is bound to tool click", 2, function() {
                toolbar.bindTo(mockEditorTools([
                    { name: "custom1", exec: function() {
                        ok(true);
                        equal(this, editorElement[0]);
                    } }
                ]));

                dom.find(".k-tool-icon").trigger("click");
            });

        </script>

        <h1 id="qunit-header">kendo.ui.Editor Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

    </body>
</html>
