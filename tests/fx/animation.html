<!DOCTYPE html>
<html>
    <head>
        <title>FX animation tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.fx.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">FX animation tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <script>
            var animate = kendo.animate,
                transitions = kendo.support.transitions,
                matrix3dRegExp = /matrix3?d?\s*\(.*,\s*([\d\w\.\-]+),\s*([\d\w\.\-]+),\s*([\d\w\.\-]+)/,
                translateXRegExp = /translatex?$/i,
                TRANSFORM = kendo.support.transitions.css + "transform",
                span;

            function animationProperty (element, property) {
                if (transitions) {
                    var transform = element.css(TRANSFORM),
                        match = transform.match(new RegExp(property + "\\s*\\(([\\d\\w\\.]+)")),
                        computed = 0;

                    if (match)
                        computed = parseInt(match[1], 10);
                    else {
                        match = transform.match(matrix3dRegExp) || [0, 0, 0];

                        if (translateXRegExp.test(property)) {
                            computed = parseInt(match[2], 10);
                        } else if (property.toLowerCase() == "translatey") {
                            computed = parseInt(match[3], 10);
                        } else if (property.toLowerCase() == "scale") {
                            computed = parseFloat(match[1]);
                        }
                    }

                    return computed;
                } else
                    return element.css(property);
            }

            module("animate", {
                setup: function() {
                    span = $("<span>foo</span>").appendTo(document.body);
                },
                teardown: function() {
                    span.remove();
                }
            });

            asyncTest("animate waits all effects to finish", function() {
                var fooFinished = false, barFinished = false;

                kendo.fx.foo = {
                    setup: function(element, options) {
                        fooFinished = true;
                        options.complete();
                    }
                };

                kendo.fx.bar = {
                    setup: function(element, options) {
                        barFinished = true;
                        options.complete();
                    }
                };

                animate(span, "foo bar", function() {
                    ok(fooFinished);
                    ok(barFinished);
                    start();
                });
            });

            asyncTest("animations play in sequence", function() {
                var firstAnimationFinished = false;

                kendo.fx.foo = {
                    setup: function(element, options) {
                        options.complete();
                    }
                };

                animate(span, "foo", function() {
                    firstAnimationFinished = true;
                });

                animate(span, "foo", function() {
                    ok(firstAnimationFinished);
                    start();
                });
            });

            test("reverse method of the effect is called if reverse = true", function() {
                var reverseWasCalled = false;

                kendo.fx.foo = {
                    setup: function(element, options) {
                        reverseWasCalled = options.reverse;
                        options.complete();
                    }
                };

                animate(span, "foo", true);
                ok(reverseWasCalled);
            });

            test("passing options to animate", function() {
                var reverseWasCalled = false, callbackWasCalled = false;

                kendo.fx.foo = {
                    setup: function(element, options) {
                        reverseWasCalled = options.reverse;
                        options.complete();
                    }
                };

                animate(span, {
                    reverse: true,
                    complete: function() {
                        callbackWasCalled = true;
                    },
                    effects: {
                        foo: {}
                    }
                });
                ok(reverseWasCalled);
                ok(callbackWasCalled);
            });

            test("passing options to animate effects as string", function() {
                var reverseWasCalled = false, callbackWasCalled = false;

                kendo.fx.foo = {
                    setup: function(element, options) {
                        reverseWasCalled = options.reverse;
                        options.complete();
                    }
                };

                animate(span, {
                    reverse: true,
                    complete: function() {
                        callbackWasCalled = true;
                    },
                    effects: "foo"
                });
                ok(reverseWasCalled);
                ok(callbackWasCalled);
            });

            test("make sure keep, css, setup, teardown and restore are called in sequence", function() {
                var cssWasKept = false, cssWasSet = false, setupWasCalled = false, teardownWasCalled = false, cssWasRestored = false;
                span.css("overflow", "visible");

                kendo.fx.foo = {
                    keep: [ "overflow" ],
                    restore: [ "overflow" ],
                    css: {
                        overflow: function (element) {
                            if (element.data("overflow") == "visible")
                                cssWasKept = true;

                            return "hidden";
                        }
                    },
                    setup: function(element, options) {
                        if (element[0].style.overflow == "hidden") // element.css() fails to detect overflow is hidden in Opera?!?
                            cssWasSet = true;

                        setupWasCalled = true;
                        options.complete();
                    },
                    teardown: function(element, options) {
                        if (element.css("overflow") == "visible")
                            cssWasRestored = true;

                        teardownWasCalled = true;
                    }
                };

                animate(span, "foo");
                ok(cssWasKept);
                ok(cssWasSet);
                ok(setupWasCalled);
                ok(cssWasRestored);
                ok(teardownWasCalled);
            });

            asyncTest("callback is fired asynchronously after animate", function() {
                var called = false;

                kendo.fx.moo = {
                    setup: function(element, options) {
                        return { translateX: "10px" };
                    }
                };

                span.kendoAnimate({
                    effects: "moo",
                    duration: 100,
                    init: function () {
                        oldTime = +new Date();
                    },
                    complete: function() {
                        setTimeout( function () {
                            called = true;
                            ok(true);
                            start();
                        }, 50);
                    }
                });

                ok(!called);
            });

            asyncTest("animating height from 0 to 100 results in 100px high element", function() {
                var height = -1;

                kendo.fx.foo = {
                    css: { height: 0, display: "block" },
                    setup: function(element, options) {
                        return { height: 100 };
                    }
                };

                span.kendoAnimate({
                    effects: "foo",
                    duration: 20,
                    init: function () {
                        height = span.height();
                    },
                    complete: function(element) {
                        setTimeout( function () {
                            ok(height == 0);
                            ok(span.height() == 100);
                            start();
                        }, 50);
                    }
                });
            });

            asyncTest("fadeIn animates the opacity from 0 to 1", function() {
                span.css({ position: "absolute", display: "block" });

                var opacity = 5;

                span.kendoAnimate({
                    effects: "fadeIn",
                    duration: 10,
                    init: function () {
                        opacity = span.css("opacity");
                    },
                    complete: function () {
                        setTimeout( function () {
                            ok(opacity == 0);
                            ok(span.css("opacity") == 1);
                            start();
                        }, 50);
                    }
                });
            });

            asyncTest("fadeOut animates the opacity from 1 to 0", function() {
                span.css({ position: "absolute", display: "block" });

                var opacity = 5;

                kendo.fx.fade.restore = [];

                span.kendoAnimate({
                    effects: "fadeOut",
                    duration: 10,
                    init: function () {
                        opacity = span.css("opacity");
                    },
                    complete: function () {
                        setTimeout( function () {
                            ok(opacity == 1);
                            ok(span.css("opacity") == 0);
                            start();
                        }, 50);
                    }
                });
            });

            if (!$.browser.msie) // TODO: Write the IE part of this test.
                asyncTest("zoomIn animates the scale from 0.01 to 1", function() {
                    span.css({ position: "absolute", display: "block" });

                    var scale = 5;

                    span.kendoAnimate({
                        effects: "zoomIn",
                        duration: 10,
                        init: function () {
                            scale = animationProperty(span, "scale");
                        },
                        complete: function () {
                            setTimeout( function () {
                                ok(scale == 0.01);
                                ok(animationProperty(span, "scale") == 1);
                                start();
                            }, 50);
                        }
                    });
                });

            asyncTest("slide:right moves the element right with its width", function() {
                span.css({ position: "absolute", display: "block", left: 10, width: 20 });
                var position = span.offset().left;

                span.kendoAnimate("slide:right", 20, function () {
                    setTimeout( function () {
                        ok((transitions ? animationProperty(span, "translateX") : span.offset().left - position) == span.width());
                        start();
                    }, 50);
                });
            });

            asyncTest("slide:down moves the element down with its height", function() {
                span.css({ position: "absolute", display: "block", top: 10, height: 20 });
                var position = span.offset().top;

                span.kendoAnimate("slide:down", 20, function () {
                    setTimeout( function () {
                        ok((transitions ? animationProperty(span, "translateY") : span.offset().top - position) == span.height());
                        start();
                    }, 50);
                });
            });

            asyncTest("slideIn:right moves the element right from - its width to 0", function() {
                span.css({ position: "absolute", display: "block", left: 10 });

                var position = 1;
                if (transitions)
                    span.css(TRANSFORM, "translateX(10px)");

                span.kendoAnimate({
                    effects: "slideIn:right",
                    duration: 20,
                    init: function () {
                        position = (transitions ? animationProperty(span, "translateX") : span.offset().left);
                    },
                    complete: function () {
                        setTimeout( function () {
                            ok(position == -span.width());
                            ok((transitions ? animationProperty(span, "translateX") : span.offset().left) == 0);
                            start();
                        }, 50);
                    }
                });
            });

            asyncTest("slideIn:down moves the element down from - its height to 0", function() {
                span.css({ position: "absolute", display: "block", top: 10 });

                var position = 1;
                if (transitions)
                    span.css(TRANSFORM, "translateY(10px)");

                span.kendoAnimate({
                    effects: "slideIn:down",
                    duration: 20,
                    init: function () {
                        position = (transitions ? animationProperty(span, "translateY") : span.offset().top);
                    },
                    complete: function () {
                        setTimeout( function () {
                            ok(position == -span.height());
                            ok((transitions ? animationProperty(span, "translateY") : span.offset().top) == 0);
                            start();
                        }, 50);
                    }
                });
            });

            asyncTest("expand:vertical expands the element from 0 to its height", function() {
                span.css({ position: "absolute", display: "block", height: 100 });
                var initialHeight = 100;

                span.kendoAnimate({
                    effects: "expand:vertical",
                    duration: 20,
                    init: function () {
                        initialHeight = span.height();
                    },
                    complete: function () {
                        setTimeout( function () {
                            ok(initialHeight == 0);
                            ok(span.height() == 100);
                            start();
                        }, 50);
                    }
                });
            });

            asyncTest("expand:horizontal expands the element from 0 to its width", function() {
                span.css({ position: "absolute", display: "block", width: 100, height: 100 });
                var initialWidth = 100;

                span.kendoAnimate({
                    effects: "expand:horizontal",
                    duration: 20,
                    init: function () {
                        initialWidth = span.width();
                    },
                    complete: function () {
                        setTimeout( function () {
                            ok(initialWidth == 0);
                            ok(span.width() == 100);
                            start();
                        }, 50);
                    }
                });
            });

            module("animationFrame Animation", {});

            asyncTest("executes callbacks", 1, function() {
                var animation = kendo.fx.Animation.extend({
                    counter: 0,
                    tick: function() {
                        this.counter ++;
                    },

                    onEnd: function() {
                        start();
                        equal(this.counter, 3);
                    },

                    done: function() {
                        return this.counter === 3;
                    }
                });

                new animation().start();
            });

            asyncTest("is cancellable", 1, function() {
                var animation = kendo.fx.Animation.extend({
                    counter: 0,
                    tick: function() {
                        this.counter ++;
                        if (this.counter === 2) {
                            this.cancel();
                        }
                    },

                    onCancel: function() {
                        start();
                        equal(this.counter, 2);
                    },

                    onEnd: function() {
                        ok(false);
                    },

                    done: function() {
                        return this.counter === 3;
                    }
                });

                new animation().start();
            });
       </script>
    </body>
</html>
