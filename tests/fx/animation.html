<!DOCTYPE html>
<html>
    <head>
        <title>FX animation tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.fx.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">FX animation tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <script>
            var animate = kendo.animate,
                transforms = kendo.support.transforms,
                matrix3dRegExp = /matrix3?d?\s*\(.*,\s*([\d\.\-]+)\w*?,\s*([\d\.\-]+)\w*?,\s*([\d\.\-]+)\w*?,\s*([\d\.\-]+)\w*?/i,
                translateXRegExp = /translatex?$/i,
                TRANSFORM = kendo.support.transforms.css + "transform",
                span;

            QUnit.config.reorder = false;

            function animationProperty(element, property) {
                if (transforms) {
                    var transform = element.css(TRANSFORM);
                    if (transform == "none") {
                        return property == "scale" ? 1 : 0;
                    }

                    var match = transform.match(new RegExp(property + "\\s*\\(([\\d\\w\\.]+)")),
                        computed = 0;

                    if (match) {
                        computed = parseInt(match[1], 10);
                    } else {
                        match = transform.match(matrix3dRegExp) || [0, 0, 0, 0, 0];
                        property = property.toLowerCase();

                        if (translateXRegExp.test(property)) {
                            computed = parseFloat(match[3] / match[2]);
                        } else if (property == "translatey") {
                            computed = parseFloat(match[4] / match[2]);
                        } else if (property == "scale") {
                            computed = parseFloat(match[2]);
                        } else if (property == "rotate") {
                            computed = parseFloat(Math.atan2(match[2], match[1]));
                        }
                    }

                    return computed;
                } else {
                    return element.css(property);
                }
            }

            module("animate", {
                setup: function() {
                    span = $("<span style='position: absolute; top: 0; left: 0; visibility: hidden;'>foo</span>").appendTo(document.body);
                },
                teardown: function() {
                    span.remove();
                }
            });

            asyncTest("animate waits all effects to finish", function() {
                var fooFinished = false, barFinished = false;

                kendo.fx.createEffect("foo", {
                    endState: function() {
                        fooFinished = true;
                        this.options.complete();
                    }
                });

                kendo.fx.createEffect("bar", {
                    endState: function() {
                        barFinished = true;
                        this.options.complete();
                    }
                });

                animate(span, "foo bar", function() {
                    ok(fooFinished);
                    ok(barFinished);
                    start();
                });
            });

            asyncTest("animations play in sequence", function() {
                var firstAnimationFinished = false;

                kendo.fx.createEffect("foo", {
                    endState: function() {
                        this.options.complete();
                    }
                });

                animate(span, "foo", function() {
                    firstAnimationFinished = true;
                });

                animate(span, "foo", function() {
                    ok(firstAnimationFinished);
                    start();
                });
            });

            test("reverse method of the effect is called if reverse = true", function() {
                var reverseWasCalled = false;

                kendo.fx.createEffect("foo", {
                    endState: function() {
                        reverseWasCalled = this.options.reverse;
                        this.options.complete();
                    }
                });

                animate(span, "foo", true);
                ok(reverseWasCalled);
            });

            test("passing options to animate", function() {
                var reverseWasCalled = false, callbackWasCalled = false;

                kendo.fx.createEffect("foo", {
                    endState: function() {
                        reverseWasCalled = this.options.reverse;
                        this.options.complete();
                    }
                });

                animate(span, {
                    reverse: true,
                    complete: function() {
                        callbackWasCalled = true;
                    },
                    effects: {
                        foo: {}
                    }
                });
                ok(reverseWasCalled);
                ok(callbackWasCalled);
            });

            test("passing options to animate effects as string", function() {
                var reverseWasCalled = false, callbackWasCalled = false;

                kendo.fx.createEffect("foo", {
                    endState: function() {
                        reverseWasCalled = this.options.reverse;
                        this.options.complete();
                    }
                });

                animate(span, {
                    reverse: true,
                    complete: function() {
                        callbackWasCalled = true;
                    },
                    effects: "foo"
                });
                ok(reverseWasCalled);
                ok(callbackWasCalled);
            });

            test("make sure css, setup, teardown and restore are called in sequence", function() {
                var cssWasKept = false, cssWasSet = false, setupWasCalled = false, teardownWasCalled = false, cssWasRestored = false;
                span.css("overflow", "visible");

                kendo.fx.createEffect("foo", {
                    restore: [ "overflow" ],

                    startState: function() {
                        if (this.element.data("overflow") == "visible")
                            cssWasKept = true;

                        return { overflow: "hidden" };
                    },

                    endState: function() {
                        if (this.element[0].style.overflow == "hidden") // element.css() fails to detect overflow is hidden in Opera?!?
                            cssWasSet = true;

                        setupWasCalled = true;
                        this.options.complete();
                    },
                    teardown: function() {
                        if (this.element.css("overflow") == "visible")
                            cssWasRestored = true;

                        teardownWasCalled = true;
                    }
                });

                animate(span, "foo");
                ok(cssWasKept);
                ok(cssWasSet);
                ok(setupWasCalled);
                ok(cssWasRestored);
                ok(teardownWasCalled);
            });

            asyncTest("callback is fired asynchronously after animate", function() {
                var called = false;

                kendo.fx.createEffect("moo", {
                    endState: function() {
                        return { translateX: "10px" };
                    }
                });

                span.kendoAnimate({
                    effects: "moo",
                    duration: 100,
                    init: function () {
                        oldTime = +new Date();
                    },
                    complete: function() {
                        called = true;
                        ok(true);
                        start();
                    }
                });

                ok(!called);
            });

            if (!kendo.support.browser.mozilla) {
                asyncTest("animating height from 0 to 100 results in 100px high element", function() {
                    var height = -1;

                    kendo.fx.createEffect("foo", {
                        startState: function() {
                            return { height: 0, display: "block" };
                        },
                        endState: function() {
                            return { height: 100 };
                        }
                    });

                    span.kendoAnimate({
                        effects: "foo",
                        duration: 20,
                        init: function () {
                            height = span.height();
                        },
                        complete: function(element) {
                            ok(height == 0);
                            ok(span.height() == 100);
                            start();
                        }
                    });
                });

                asyncTest("fadeIn animates the opacity from 0 to 1", function() {
                    span.css({ position: "absolute", display: "block" });

                    var opacity = 5;

                    span.kendoAnimate({
                        effects: "fadeIn",
                        duration: 10,
                        init: function () {
                            opacity = span.css("opacity");
                        },
                        complete: function () {
                            ok(opacity == 0);
                            ok(span.css("opacity") == 1);
                            start();
                        }
                    });
                });

                asyncTest("fadeOut animates the opacity from 1 to 0", function() {
                    span.css({ position: "absolute", display: "block" });

                    var opacity = 5;

                    kendo.fx.Effects.fade.prototype.restore = [];

                    span.kendoAnimate({
                        effects: "fadeOut",
                        duration: 10,
                        complete: function () {
                            equal(span.css("opacity"), 0);
                            start();
                        }
                    });
                });

                if (!kendo.support.browser.msie) // TODO: Write the IE part of this test.
                    asyncTest("zoomIn animates the scale from 0.01 to 1", function() {
                        span.css({ position: "absolute", display: "block" });

                        var scale = 5;

                        span.kendoAnimate({
                            effects: "zoomIn",
                            duration: 10,
                            init: function () {
                                scale = animationProperty(span, "scale");
                            },
                            complete: function () {
                                ok(scale == 0.01);
                                ok(animationProperty(span, "scale") == 1);
                                start();
                            }
                        });
                    });

                asyncTest("slide:right moves the element right with its width", function() {
                    span.css({ left: 10, width: 20 });
                    var position = span.offset().left;

                    span.kendoAnimate("slide:right", 20, function () {
                        ok((transforms ? animationProperty(span, "translatex") : span.offset().left - position) == span.width());
                        start();
                    });
                });

                asyncTest("slide:down moves the element down with its height", function() {
                    span.css({ top: 10, height: 20 });
                    var position = span.offset().top;

                    span.kendoAnimate("slide:down", 20, function () {
                        ok((transforms ? animationProperty(span, "translatey") : span.offset().top - position) == span.height());
                        start();
                    });
                });

                asyncTest("slideIn:right moves the element right from - its width to 0", function() {
                    span.css({ position: "absolute", display: "block", left: 10 });

                    var position = 1;
                    if (transforms)
                        span.css(TRANSFORM, "translateX(10px)");

                    span.kendoAnimate({
                        effects: "slideIn:right",
                        duration: 20,
                        init: function () {
                            position = (transforms ? animationProperty(span, "translateX") : span.offset().left);
                        },
                        complete: function () {
                            ok(position == -span.width());
                            ok((transforms ? animationProperty(span, "translateX") : span.offset().left) == 0);
                            start();
                        }
                    });
                });

                asyncTest("slideIn:down moves the element down from - its height to 0", function() {
                    span.css({ position: "absolute", display: "block", top: 10 });

                    var position = 1;
                    if (transforms)
                        span.css(TRANSFORM, "translateY(10px)");

                    span.kendoAnimate({
                        effects: "slideIn:down",
                        duration: 20,
                        init: function () {
                            position = (transforms ? animationProperty(span, "translateY") : span.offset().top);
                        },
                        complete: function () {
                            ok(position == -span.height());
                            ok((transforms ? animationProperty(span, "translateY") : span.offset().top) == 0);
                            start();
                        }
                    });
                });

                asyncTest("expand:vertical expands the element from 0 to its height", function() {
                    span.css({ position: "absolute", display: "block", height: 100 });
                    var initialHeight = 100;

                    span.kendoAnimate({
                        effects: "expand:vertical",
                        duration: 20,
                        init: function () {
                            initialHeight = span.height();
                        },
                        complete: function () {
                            ok(initialHeight == 0);
                            ok(span.height() == 100);
                            start();
                        }
                    });
                });

                asyncTest("expand:horizontal expands the element from 0 to its width", function() {
                    span.css({ position: "absolute", display: "block", width: 100, height: 100 });
                    var initialWidth = 100;

                    span.kendoAnimate({
                        effects: "expand:horizontal",
                        duration: 20,
                        init: function () {
                            initialWidth = span.width();
                        },
                        complete: function () {
                            ok(initialWidth == 0);
                            ok(span.width() == 100);
                            start();
                        }
                    });
                });
            }

            module("animationFrame Animation", {});

            asyncTest("executes callbacks", 1, function() {
                var animation = kendo.fx.Animation.extend({
                    counter: 0,
                    tick: function() {
                        this.counter ++;
                    },

                    onEnd: function() {
                        start();
                        equal(this.counter, 3);
                    },

                    done: function() {
                        return this.counter === 3;
                    }
                });

                new animation().start();
            });

            asyncTest("is cancellable", 1, function() {
                var animation = kendo.fx.Animation.extend({
                    counter: 0,
                    tick: function() {
                        this.counter ++;
                        if (this.counter === 2) {
                            this.cancel();
                        }
                    },

                    onCancel: function() {
                        start();
                        equal(this.counter, 2);
                    },

                    onEnd: function() {
                        ok(false);
                    },

                    done: function() {
                        return this.counter === 3;
                    }
                });

                new animation().start();
            });
       </script>
    </body>
</html>
