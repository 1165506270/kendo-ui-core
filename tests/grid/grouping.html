<!DOCTYPE html>
<html>
    <head>
        <title>Grid grouping</title>
        <script src="../../src/jquery.min.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.groupable.js"></script>
        <script src="../../src/kendo.grid.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">Grid grouping</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Grid = kendo.ui.Grid,
                DataSource = kendo.data.DataSource;

            function table() {
                return document.body.appendChild(document.createElement("table"));
            }

             module("kendo.ui.Grid grouping", {
                setup: function() {
                },
                teardown: function() {
                    $("div.k-grid").remove();
                }
            });

            test("groupable instanciate kendo.ui.Groupable", function() {
                var grid = new Grid(table(), { dataSource:[], groupable: true });
                ok(grid.groupable);
            });

            test("groupable creates .k-grouping-header", function() {
                var grid = new Grid(table(), { dataSource:[], groupable: true }),
                    gridElement = grid.wrapper;

                var groupingHeader = gridElement.find("div.k-grouping-header");
                equal(groupingHeader.length, 1);
            });

            test("grouping row is created for every group", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo"}, {foo: "bar"}], groupable: true
                });
                grid.dataSource.group({field: "foo"});

                var groupingRows = grid.tbody.find("tr.k-grouping-row");
                equal(groupingRows.length, 2);
            });

            test("first level grouping row colspans is columns + number of groups", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo"}, {foo: "bar"}], groupable: true
                });
                grid.dataSource.group({field: "foo"});

                var groupingRowCell = grid.tbody.find("tr.k-grouping-row>td:first");
                equal(groupingRowCell.attr("colspan"), 2);
            });

            test("first level grouping row colspans is columns + number of groups and detailView if declared", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo"}, {foo: "bar"}],
                    groupable: true,
                    detailTemplate: "ddd"
                });
                grid.dataSource.group({field: "foo"});

                var groupingRowCell = grid.tbody.find("tr.k-grouping-row>td:first");
                equal(groupingRowCell.attr("colspan"), 3);
            });

            test("nesting groups created grouping row for every group", function() {

                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}], groupable: true
                });
                grid.dataSource.group([{field: "foo"}, {field: "bar"}]);

                var groupingRows = grid.tbody.find("tr.k-grouping-row");
                var groupingCells = groupingRows.find("td");
                equal(groupingRows.length, 4);
                equal(groupingCells.eq(0).attr("colspan"), 4);
                ok(groupingCells.eq(1).is(".k-group-cell"));
                equal(groupingCells.eq(2).attr("colspan"), 3);
            });

            test("nested groups creates group cells for nested grouping rows", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}], groupable: true
                });
                grid.dataSource.group([{field: "foo"}, {field: "bar"}]);

                var nestedGroupingRow = grid.tbody.find("tr.k-grouping-row").eq(1);
                ok(nestedGroupingRow.find("td:first").is(".k-group-cell"));
            });

            test("group cells are created for every data row", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}], groupable: true
                });
                grid.dataSource.group([{field: "foo"}]);

                var dataRows = grid.tbody.find("tr:not(.k-grouping-row)").eq(0);
                ok(dataRows.find("td:first").is(".k-group-cell"));
            });

            test("grouping scrollable grid creates header group cells", function() {
                 var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}],
                    groupable: true,
                    scrollable: true
                }),
                header = grid.thead;

                grid.dataSource.group([{field: "foo"},{field: "bar"}]);

                var headerCells = header.find("th");
                equal(headerCells.length, 4);
                ok(headerCells.is(".k-group-cell"));
            });

            test("grouping non-scrollable grid creates header group cells", function() {
                 var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}],
                    groupable: true,
                    scrollable: false
                }),
                header = grid.thead;

                grid.dataSource.group([{field: "foo"},{field: "bar"}]);

                var headerCells = header.find("th");
                equal(headerCells.length, 4);
                ok(headerCells.is(".k-group-cell"));
            });

            test("ungroup remove header group cells", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}], groupable: true
                }),
                header = grid.thead;
                grid.dataSource.group([{field: "foo"}, {field: "bar"}]);
                grid.dataSource.group([{field: "foo"}]);

                var headerCells = header.find("th");
                equal(headerCells.length, 3);
            });

            test("ungroup all remove all header group cells", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}], groupable: true
                }),
                header = grid.thead;
                grid.dataSource.group([{field: "foo"}, {field: "bar"}]);
                grid.dataSource.group([]);

                var headerCells = header.find("th");
                equal(headerCells.length, 2);
            });

            test("collapseGroup hides all grop data rows", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}],
                    groupable: true
                });

                grid.dataSource.group([{field: "foo"}]);
                grid.collapseGroup(grid.tbody.find("tr.k-grouping-row:first"));

                var dataRows = grid.tbody.children(":not(.k-grouping-row)");
                equal(dataRows.length, 2);
                ok(dataRows.eq(0).is(":hidden"));
                ok(dataRows.eq(1).is(":visible"));
            });

            test("collapseGroup change button class to k-expand", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}],
                    groupable: true
                }),
                groupingRow;

                grid.dataSource.group([{field: "foo"}]);
                groupingRow = grid.tbody.find("tr.k-grouping-row:first");
                grid.collapseGroup(groupingRow);

                ok(groupingRow.find(".k-icon").hasClass("k-expand"));
            });

            test("expandGroup change button class to k-collapse", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}],
                    groupable: true
                }),
                groupingRow;

                grid.dataSource.group([{field: "foo"}]);
                groupingRow = grid.tbody.find("tr.k-grouping-row:first");
                grid.collapseGroup(groupingRow);
                grid.expandGroup(groupingRow);

                ok(groupingRow.find(".k-icon").hasClass("k-collapse"));
            });

            test("expandGroup shows all grop data rows", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "fooz", bar: "baz"}],
                    groupable: true
                }),
                groupingRow;

                grid.dataSource.group([{field: "foo"}]);
                groupingRow = grid.tbody.find("tr.k-grouping-row:first");
                grid.collapseGroup(groupingRow);
                grid.expandGroup(groupingRow);

                var dataRows = grid.tbody.children(":not(.k-grouping-row)");
                equal(dataRows.length, 2);
                ok(dataRows.eq(0).is(":visible"));
                ok(dataRows.eq(1).is(":visible"));
            });

            test("expand parent group does not expand collapsed sub groups", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "foo", bar: "baz"}],
                    groupable: true
                }),
                tbody,
                masterGroup,
                subGroup;

                grid.dataSource.group([{field: "foo"}, {field: "bar"}]);
                tbody = grid.tbody;
                masterGroup = tbody.find(".k-grouping-row:first");
                subGroup = tbody.find(".k-grouping-row").eq(1);

                grid.collapseGroup(subGroup);
                grid.collapseGroup(masterGroup);
                grid.expandGroup(masterGroup);

                equal(tbody.find("tr:visible").length, 4);
                ok(subGroup.find(".k-icon").hasClass("k-expand"));
            });

            test("grouping non-groupable grid updates html", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "foo", bar: "baz"}],
                    groupable: false
                });

                grid.dataSource.group([{field: "foo"}, {field: "bar"}]);

                equal(grid.thead.find("th").length, 4);
                equal(grid.wrapper.find(".k-group-cell").length, 8);
            });

            test("ungrouping non-groupable grid updates html", function() {
                var grid = new Grid(table(), {
                    dataSource:[{foo: "foo", bar: "bar"}, {foo: "foo", bar: "baz"}],
                    groupable: false
                });

                grid.dataSource.group([{field: "foo"}, {field: "bar"}]);
                grid.dataSource.group([]);

                equal(grid.thead.find("th").length, 2);
                equal(grid.wrapper.find(".k-group-cell").length, 0);
            });

            test("columns are retrieved from grouped dataSource", function() {
                var dataSource = new DataSource({
                    data: [{foo: "foo", bar: "bar"}, {foo: "foo1", bar: "baz"}],
                    group: [{field: "foo"}, {field: "bar"}]
                }),
                grid = new Grid($("div"), { dataSource: dataSource });

                var columns = grid.columns;
                equal(columns.length, 2);
                equal(columns[0].field, "foo");
                equal(columns[1].field, "bar");
            })

            test("col elemens are generated for every group cell", function() {
                var dataSource = new DataSource({
                    data: [{foo: "foo", bar: "bar"}, {foo: "foo1", bar: "baz"}],
                    group: [{field: "foo"}, {field: "bar"}]
                }),
                grid = new Grid(table(), { dataSource: dataSource, scrollable: false });

                var cols = grid.table.find("col");
                ok(cols.eq(0).hasClass("k-group-col"));
                ok(cols.eq(1).hasClass("k-group-col"));
            });

            test("colspan of group cell when grouping is disabled initial grouped grid with auto columns", function() {
                var dataSource = new DataSource({
                    data: [{foo: "foo", bar: "bar"}, {foo: "foo1", bar: "baz"}],
                    group: [{field: "foo"}]
                }),
                grid = new Grid(table(), { dataSource: dataSource });

                equal(grid.tbody.find("tr>td:first").attr("colspan"), 3);
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
