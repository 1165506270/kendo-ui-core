<!DOCTYPE html>
<html>
    <head>
        <title>Grid Initialization</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.pageable.js"></script>
        <script src="../../src/kendo.grid.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">Grid Initialization</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Grid = kendo.ui.Grid,
                table,
                DataSource = kendo.data.DataSource;

            module("grid initialziation", {
                setup: function() {
                    table = document.createElement("table");
                    document.body.appendChild(table);
                },
                teardown: function() {
                    $(table).closest(".k-grid").remove();
                }
            });

            test("kendoGrid attaches a grid object to target", function() {
                var table = $("<table />").kendoGrid({ dataSource: [] });

                ok(table.data("kendoGrid") instanceof Grid);
            });

            test("Grid constructor calls the read method of its datasource", function() {
                var dataSource = new DataSource({ dataSource: [] });
                var readWasCalled = false;

                dataSource.read = function() {
                    readWasCalled = true;
                };

                new Grid(table, { dataSource: dataSource } );

                ok(readWasCalled);
            });

            test("column initialization - field", function() {
                var grid = new Grid(table, { dataSource: [], columns: [{ field: "foo" }, { field: "bar" }] });

                equal(grid.columns.length, 2);
                equal(grid.columns[0].field, "foo");
                equal(grid.columns[1].field, "bar");
            });

            test("column initialization - template", function() {
                var grid = new Grid(table, { dataSource: [], columns: [{ field: "foo", template: "bar" }] });

                equal(grid.columns[0].field, "foo");
                equal(grid.columns[0].template, "bar");
            });

            test("column initialization - treating strings as fields", function() {
                var grid = new Grid(table, { dataSource: [], columns: ["foo", { field: "bar" }] });

                equal(grid.columns.length, 2);
                equal(grid.columns[0].field, "foo");
                equal(grid.columns[1].field, "bar");
            });

            test("header data attributes - data-field", function() {
                var grid = new Grid($('<table><th data-field="foo"></th><th data-field="bar"></th></table>')[0], { dataSource: [] });

                equal(grid.columns.length, 2);
                equal(grid.columns[0].field, "foo");
                equal(grid.columns[1].field, "bar");
            });

            test("header data attributes - data-template", function() {
                var grid = new Grid($('<table><th data-field="foo" data-template="bar"></th></table>')[0], { dataSource: [] });

                equal(grid.columns[0].field, "foo");
                equal(grid.columns[0].template, "bar");
            });

            test("tbody is created if not present", function() {
                var grid = new Grid(table, { dataSource: [], columns: [{ field: "foo", template: "item.foo" }] });
                equal(grid.tbody.length, 1);
            });

            test("array passed as options is treated as data", function() {
                var data = ["foo"];
                var grid = new Grid(table, data);
                ok(grid.dataSource.data()[0] === data[0]);
            });

            test("div wrapper is created around the table", function() {
                var grid = new Grid(table, []);

                ok(grid.wrapper.is("div.k-grid.k-widget"));
            });

            test("wrapper field is initialized", function() {
                var grid = new Grid(table, []);

                ok(grid.wrapper.is("div.k-grid.k-widget"));
            });

            test("datasource is populated from table if not specified", function() {
                var grid = new Grid($('<table><tr><td /><td/></tr></table>'), {columns: [ { field:"foo" }] });

                equal(grid.dataSource.data().length, 1);
            });

            test("header text is used as a field if data-field attribute is not set", function() {
                var grid = new Grid($('<table><th>Foo</th></table>'));

                equal(grid.columns[0].field, "Foo");
            });

            test("data-field takes precedence over the header text", function() {
                var grid = new Grid($('<table><th data-field="foo">Foo</th></table>'));

                equal(grid.columns[0].field, "foo");
            });

            test("everything which is not alpha numeric is stripped from header text when used as a field", function() {
                var grid = new Grid($('<table><th>  $@Foo1   Bar   </th></table>'));

                equal(grid.columns[0].field, "Foo1Bar");
            });

            test("initializing a grid from a div", function() {
                var div = $("<div />"), grid = new Grid(div, {scrollable: false, dataSource: [] });

                ok(grid.element[0] === div[0]);
                ok(div.children().first().is("table"));
                ok(grid.table[0] === div.children().first()[0]);
            });

            test("initializing a scrollable grid from a div", function() {
                var div = $("<div />"), grid = new Grid(div, { dataSource: [] });

                ok(grid.element[0] === div[0]);
                equal(grid.table[0], div.find(".k-grid-content").children().first()[0]);
            });

            test("autogenerating columns", function() {
                var grid = new Grid(table, [ { foo: "foo", bar: "bar" } ]);

                equal(grid.columns.length, 2);
            });

            test("autogenerating columns - inferring the field", function() {
                var grid = new Grid(table, [ { foo: "foo", bar: "bar" } ]);

                equal(grid.columns[0].field, "foo");
                equal(grid.columns[1].field, "bar");
            });

            test("autogenerating columns - generating the templates", function() {
                var grid = new Grid(table, [ { foo: "foo", bar: "bar" } ]);

                equal(grid.tbody.find(">tr>td:first").text(), "foo");
                equal(grid.tbody.find(">tr>td:last").text(), "bar");
            });

            test("autogenerating columns - generating the th", function() {
                var grid = new Grid(table, { scrollable: false, dataSource: [ { foo: "foo", bar: "bar" } ] });

                equal(grid.table.find("tr>th:first").text(), "foo");
                equal(grid.table.find("tr>th:last").text(), "bar");
            });

            test("autogenerating columns - generating the th in scrollable grid", function() {
                var grid = new Grid(table, { scrollable: true, dataSource: [ { foo: "foo", bar: "bar" } ] });

                equal(grid.thead.find("tr>th:first").text(), "foo");
                equal(grid.thead.find("tr>th:last").text(), "bar");
            });

            test("generating the th from column metadata", function() {
                var grid = new Grid(table, { columns: [ { field: "foo" } ] });

                equal(grid.thead.find("tr>th:first").text(), "foo");
            });

            test("thead initialization", function() {
                var grid = new Grid(table, { columns: [ { field: "foo" } ] });

                equal(grid.thead.length, 1);
            });

            test("thead initialization when there is existing thead", function() {
                var grid = new Grid($("<table><thead/></table>"), { columns: [ { field: "foo" } ] });

                equal(grid.wrapper.find("thead").length, 1);
                equal(grid.thead.find("th").length, 1);
            });

            test("thead initialization when there is existing thead > tr", function() {
                var grid = new Grid($("<table><thead><tr/></thead></table>"), { columns: [ { field: "foo" } ] });

                equal(grid.wrapper.find("thead").length, 1);
                equal(grid.thead.find("tr").length, 1);
                equal(grid.thead.find("th").length, 1);
            });

            test("thead initialization when there is existing thead > tr > th", function() {
                var grid = new Grid($("<table><thead><tr><th>bar</th></tr></thead></table>"), { columns: [ { field: "foo" } ] });

                equal(grid.wrapper.find("thead").length, 1);
                equal(grid.thead.find("tr").length, 1);
                equal(grid.thead.find("th").length, 1);
                equal(grid.thead.find("th").text(), "bar");
            });
            test("thead initialization when there is no thead but th exists", function() {
                var grid = new Grid($("<table><tr><th>bar</th></tr></table>"), { });

                equal(grid.wrapper.find("thead").length, 1);
                equal(grid.wrapper.find("tr").length, 1);
                equal(grid.thead.find("th").length, 1);
                equal(grid.thead.find("th").text(), "bar");
            });
            test("autoBind false does not populate grid", function() {
                var grid = new Grid(table, { autoBind: false, dataSource: [ { foo: "foo", bar: "bar" } ]});

                ok(grid.element.find("tbody > tr").length == 0);
            });

            test("th css class is set", function() {
                var grid = new Grid($("<table><thead><tr><th /></tr></thead></table>"));

                equal(grid.thead.find(".k-header").length, grid.thead.find("th").length);
            });

            test("zero cellspacing is set", function() {
                var grid = new Grid($("<table><thead><tr><th /></tr></thead></table>"));

                equal(grid.table.attr("cellspacing"), "0");
            });

            test("scrollable grid has a div for the header", function() {
                var grid = new Grid($("<table><thead><tr><th /></tr></thead></table>"), { scrollable: true });

                equal(grid.wrapper.children().filter("div.k-grid-header").length, 1);
            });

            test("scrollable grid has a table with thead in the header", function() {
                var grid = new Grid($("<table><thead><tr><th /></tr></thead></table>"), { scrollable: true });

                equal(grid.wrapper.children().filter("div").find("table > thead").length, 1);
            });

            test("scrollable grid has only one header when columns are autogenerated", function() {
                var grid = new Grid($("<table />"), { scrollable: true, dataSource: [{foo:"bar"}] });

                equal(grid.wrapper.children().filter("div.k-grid-header").find("table > thead").length, 1);
            });

            test("scrollable grid header has right padding the same as the scrollbar width", function() {
                var grid = new Grid($("<table />"), { scrollable: true, dataSource: [{foo:"bar"}] });

                equal(grid.wrapper.children().filter("div.k-grid-header").css("padding-right"), kendo.support.scrollbar() + "px");
            });

            test("scrollable grid has header wrap", function() {
                var grid = new Grid($("<table />"), { scrollable: true, dataSource: [{foo:"bar"}] });

                equal(grid.wrapper.children().filter("div.k-grid-header").find("> div.k-grid-header-wrap").length, 1);
            });

            test("scrollable grid table is nested in a div", function() {
                var grid = new Grid($("<table />"), { scrollable: true, dataSource: [{foo:"bar"}] });

                ok(grid.table.parent().is("div.k-grid-content"));
            });

            test("scrollable area is sized", function() {
                var grid = new Grid(table, { height: 100, pageable: true, scrollable: true, dataSource: [{foo:"bar"}] });

                equal(grid.wrapper.find(".k-grid-content").height(), 100
                    - grid.wrapper.find(".k-grid-header").outerHeight()
                    - grid.wrapper.find(".k-grid-pager").outerHeight());
            });

            test("grid height is applied to the wrapper element", function() {
                var grid = new Grid(table, { height: 100, dataSource: [{foo:"bar"}] });

                equal(grid.wrapper.height(), 100);
            });

            test("non-scrollable grid thead has k-grid-header class", function() {
                var grid = new Grid(table, { dataSource: [{foo:"bar"}], scrollable: false });

                ok(grid.thead.hasClass("k-grid-header"));
            });

            test("col elements are created for every column in non-scrollable grid", function() {
                var grid = new Grid(table, {
                    dataSource: [],
                    columns: [{field: "foo" }, {field: "bar"}],
                    scrollable: false
                });
                var headerTable = grid.thead.parent();

                ok(headerTable.find("colgroup").length);
                equal(headerTable.find("col").length, 2);
            });

            test("col elements are created for every column in scrollable grid", function() {
                var grid = new Grid(table, {
                    dataSource: [],
                    columns: [{field: "foo" }, {field: "bar"}],
                    scrollable: true
                });

                var colgroups = grid.wrapper.find("colgroup");

                equal(colgroups.length, 2);
                equal(colgroups.eq(0).find("col").length, 2);
                equal(colgroups.eq(1).find("col").length, 2);
            });

            test("column width is applied on col element", function() {
                var width = "200px",
                    grid = new Grid(table, {
                        dataSource: [],
                        columns: [{field: "foo", width: width }],
                        scrollable: true
                    });

                var cols = grid.wrapper.find("col");
                equal(cols.length, 2);
                equal(cols.eq(0).css("width"), width);
                equal(cols.eq(1).css("width"), width);
            });

            test("column width is parsed from DOM col element when grid created from table element", function() {
                var element = $('<table><colgroup><col style="width:200px"/><col /><th data-field="foo"></th><th data-field="bar"></th><th data-field="baz"></th></colgroup></table>'),
                    grid = new Grid(element, {
                        dataSource: [],
                        scrollable: false
                    });

                var cols = grid.wrapper.find("col");
                equal(cols.length, 3);
                equal(cols.eq(0).css("width"), "200px");
                equal(cols.eq(1).css("width"), "0px");
                equal(cols.eq(2).css("width"), "0px");
            });

            test("dataBound event is raised if bound to array", function() {
                var called = false,
                    grid = new Grid(table, {
                        dataSource: [ {foo:"foo", bar:"bar"} ],
                        dataBound: function() { called = true; }
                    });
                ok(called);
            });

            test("initialization from rendered table should disable encoding", function() {
                table.innerHTML = "<thead><tr><th data-field='col1'>col1</th></tr></thead><tbody><tr><td>&nbsp;</td></tr></tbody>";
                var grid = new Grid(table, {scrollable: false});
                
                equal(grid.columns[0].encoded, false);
            });
       </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
