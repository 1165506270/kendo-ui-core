<!DOCTYPE html>
<html>
    <head>
        <title>Grid Virtual Scrolling</title>
        <script src="../../src/jquery.js"></script>
        <script type="text/javascript" src="../qunit.js"></script>
        <script type="text/javascript" src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.grid.js"></script>
        <link rel="stylesheet" href="../qunit.css" type="text/css" />
        <link rel="stylesheet" href="../../styles/kendo.common.css" type="text/css" />
        <style>
            .t-scrollbar
            {
                overflow: scroll;
                position: absolute;
            }

            .t-scrollbar-vertical
            {
                overflow-x:hidden;
                top: 0;
                right: 0;
                height: 100%;
                width: 17px; /* scrollbar width */
            }
            .t-virtual-scrollable-wrap
            {
                overflow: hidden;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <h1 id="qunit-header">Grid Virtual Scrolling</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Grid = kendo.ui.Grid,
                DataSource = kendo.data.DataSource,
                VirtualScrollable = kendo.ui.VirtualScrollable,
                dataSource,
                timeout,
                container;

            function setup(element, data) {
                dataSource = DataSource.create( { data: data || [ { foo: 2, bar: 2 }, { foo: 1, bar: 1 } ] } );
                return  new VirtualScrollable(element || container, {
                    dataSource: dataSource,
                    itemHeight: function() {
                        return 32;
                    }
                });
            }

            module("kendo.ui.VirtualScrollable", {
                setup: function() {
                    timeout = window.setTimeout;
                    window.setTimeout = function(callback) {
                        callback();
                    }
                    container = $('<div style="height:300px;position:relative; overflow-x: hidden; overflow-y: hidden;"><table></table></div>').appendTo($(document.body));
                },
                teardown: function() {
                    container.remove();
                    window.setTimeout = timeout;
                }
            });

            test("wraps the element in scrollable area", function() {
                setup();

                var wrap = container.children().first();
                equal(container.children().length, 2);
                ok(wrap.hasClass("t-virtual-scrollable-wrap"));
                equal(wrap.children()[0].nodeName.toLowerCase(), "table");
            });

            test("auto width is applied to the container element", function() {
                setup();
                equal(container[0].style.width, "auto");
                equal(container.css("overflow"), "hidden");
                equal(container.css("paddingRight"), kendo.support.scrollbar() + 1 + "px");
            });

            test("scrollbars are added to the container", function() {
                setup();
                var scrollBar = container.children().last();
                equal(container.children().length, 2);
                ok(scrollBar.hasClass("t-scrollbar t-scrollbar-vertical"));
                ok(scrollBar.width(), kendo.support.scrollbar());
            });

            test("refresh inserts elements into the scrollbar element to for correct scroll height", function() {
                var scroller = setup();
                container.find("table").html(new Array(30).join('<tr><td style="height:30px">foo</td></tr>'));
                dataSource._total = 300;
                scroller.refresh();
                equal(container.find(".t-scrollbar-vertical").children().length, 1);
            });

            test("scroll is called when scrollbar is scrolled", function() {
                var called = false,
                    MyVirtualScrollable = VirtualScrollable.extend( {
                        _scroll: function() {
                            called = true;
                        }
                    }),
                    scroller = new MyVirtualScrollable(container, {
                        dataSource: dataSource
                    });

                container.find(".t-scrollbar-vertical").scroll();

                ok(called);
            });

            test("scroll calls fetch", function() {
                dataSource = DataSource.create( { data: [ { foo: 2, bar: 2 }, { foo: 1, bar: 1 } ] } );
                var called = false,
                    MyVirtualScrollable = VirtualScrollable.extend( {
                        _fetch: function() {
                            called = true;
                        }
                    }),
                    scroller = new MyVirtualScrollable(container, {
                        dataSource: dataSource
                    });

                container.find("table").html(new Array(30).join('<tr><td style="height:30px">foo</td></tr>'));
                dataSource._total = 300;
                scroller.refresh();
                container.find(".t-scrollbar-vertical").scroll();

                ok(called)
            });

            test("scroll content is scrolled if items are rendered", function() {
                var scroller = setup(),
                    content = container.find("table").html(new Array(300).join('<tr><td style="height:30px">foo</td></tr>'));

                dataSource._total = 300;
                scroller.refresh();
                container.find(".t-scrollbar-vertical").scrollTop(70).scroll();
                equal(content.parent().scrollTop(), 70);
            });

            test("fetch shows loading mask if items are not present", function() {
                 var MyDataSource = DataSource.extend({
                        inRange: function() {
                            return false;
                    }}),
                    scroller = new VirtualScrollable(container, {
                        dataSource: new MyDataSource({
                            pageSize: 2,
                            page: 2,
                            data: [ 1,2,3,4,5,6,7,8,9,10 ]
                        })
                    });
                kendo.ui.progress = function() {
                    ok(true);
                    start();
                }
                firstRowIndex = 1,
                lastRowIndex = 2;
                scroller._fetch(firstRowIndex, lastRowIndex);
                stop(300);
            });

            test("fetch does not show loading mask if items are present", function() {
                var MyDataSource = DataSource.extend({
                    inRange: function() {
                        return true;
                    }
                }),
                scroller = new VirtualScrollable(container, {
                    dataSource: new MyDataSource({ data: [ { foo: 2, bar: 2 }, { foo: 1, bar: 1 } ] })
                });

                scroller._fetch(0, 15);
                equal(container.find("div.t-overlay").length, 0);
            });

            test("mask is hidden on refresh", function() {
                var scroller = setup();

                kendo.ui.progress(container, true);
                scroller.refresh();
                equal(container.find("div.t-overlay").length, 0);
            });

            test("fetch if lastRow is at the end of the available page fetches next page", function() {
                var skip, take,
                MyDataSource = DataSource.extend({
                    range: function() {
                        skip = arguments[0];
                        take = arguments[1];
                    }
                }), scroller = new VirtualScrollable(container, {
                    dataSource: new MyDataSource({
                        pageSize: 2,
                        page: 0,
                        data: [ { foo: 2, bar: 2 }, { foo: 1, bar: 1 }, { foo: 3, bar: 3 } ]
                    })
                }),
                firstRowIndex = 1,
                lastRowIndex = 2;
                var fetching = scroller._fetch(firstRowIndex, lastRowIndex);
                ok(fetching);
                equal(skip, 1);
                equal(take, 2);
            });

            test("fetch if lastRow is at the end of the available page fetches next page with no prefetch", function() {
                var MyDataSource = DataSource.extend({
                    inRange: function() {
                        return false;
                    },
                    range: function(skip, take) {
                        equal(skip, 1);
                        equal(take, 2);
                    }
                }), scroller = new VirtualScrollable(container, {
                    dataSource: new MyDataSource({
                        pageSize: 2,
                        page: 1,
                        data: [ { foo: 2, bar: 2 }, { foo: 1, bar: 1 }, { foo: 3, bar: 3 } ]
                    })
                }),
                firstRowIndex = 1,
                lastRowIndex = 2;
                var fetching = scroller._fetch(firstRowIndex, lastRowIndex);
                ok(fetching);
            });

            test("fetch if firstRow is at the begining of the available page fetches prev page", function() {
                var skip, take,
                    MyDataSource = DataSource.extend({
                    range: function() {
                        skip = arguments[0];
                        take = arguments[1];
                    }
                }), scroller = new VirtualScrollable(container, {
                    dataSource: new MyDataSource({
                        pageSize: 2,
                        page: 2,
                        data: [ 1,2,3,4,5,6,7,8,9,10 ]
                    })
                }),
                firstRowIndex = 1,
                lastRowIndex = 2;
                var fetching = scroller._fetch(firstRowIndex, lastRowIndex);
                ok(fetching);
                equal(skip, 0);
                equal(take, 2);
            });

            test("fetch if firstRow is at the begining of the available page fetches prev page without prefech", function() {
                var MyDataSource = DataSource.extend({
                    inRange: function() {
                        return false;
                    },
                    range: function(skip,take) {
                        equal(skip, 0);
                        equal(take, 2);
                    }
                }), scroller = new VirtualScrollable(container, {
                    dataSource: new MyDataSource({
                        pageSize: 2,
                        page: 2,
                        data: [ 1,2,3,4,5,6,7,8,9,10 ]
                    })
                }),
                firstRowIndex = 1,
                lastRowIndex = 2;
                var fetching = scroller._fetch(firstRowIndex, lastRowIndex);
                ok(fetching);
            });

            test("fetch no new page is requested if first and last rows are in range", function() {
                var called = false,
                    MyDataSource = DataSource.extend({
                    range: function() {
                        called = true;
                    }
                }), scroller = new VirtualScrollable(container, {
                    dataSource: new MyDataSource({
                        pageSize: 2,
                        page: 1,
                        data: [ { foo: 2, bar: 2 }, { foo: 1, bar: 1 }, { foo: 3, bar: 3 } ]
                    })
                });
                firstRowIndex = 1,
                lastRowIndex = 1;
                var fetching = scroller._fetch(firstRowIndex, lastRowIndex);
                ok(!fetching);
                ok(!called);
            });

            test("scroll passes firstRowIndex and lastRowIndex", function() {
                var firstRowIndex, lastRowIndex,
                    content = container.height(60).find("table").html(new Array(2).join('<tr><td style="height:30px">foo</td></tr>')),
                    MyVirtualScrollable = VirtualScrollable.extend( {
                        _fetch: function() {
                            firstRowIndex = arguments[0];
                            lastRowIndex = arguments[1];
                        }
                    }),
                    scroller = new MyVirtualScrollable(container, {
                        itemHeight: function() {
                            return 35;
                        },
                        dataSource: new DataSource({
                            pageSize: 2,
                            page: 1,
                            data: [ { foo: 2, bar: 2 }, { foo: 1, bar: 1 }, { foo: 3, bar: 3 } ]
                        })
                    });

                scroller.refresh();
                scroller._scroll({ currentTarget: { scrollTop: 40 } });
                equal(firstRowIndex, 1);
                equal(lastRowIndex, 2);
            });

            test("fetch prefetch the next page if lastRowIndex is after middle of the page", function() {
                var skip, take
                    MyDataSource = DataSource.extend({
                        prefetch: function() {
                            skip = arguments[0];
                            take = arguments[1];
                        },
                        _total: 10000
                    }),
                    scroller = new VirtualScrollable(container, {
                            itemHeight: function() {
                            return 35;
                        },
                        dataSource: new MyDataSource({
                            pageSize: 4,
                            page: 1,
                            data: [ 1,2,3,4,5,6,7,8,9,10 ]
                        })
                    });
                firstRowIndex = 0,
                lastRowIndex = 3;
                scroller._fetch(firstRowIndex, lastRowIndex);
                equal(skip, 4);
                equal(take, 4);
            });
/*
            test("fetch prefetch the prev page if firstRow is before middle of the page", function() {
                var skip, take
                    MyDataSource = DataSource.extend({
                        prefetch: function() {
                            skip = arguments[0];
                            take = arguments[1];
                        }
                    }), scroller = new VirtualScrollable(container, {
                        dataSource: new MyDataSource({
                            pageSize: 4,
                            page: 2,
                            data: [ 1,2,3,4,5,6,7,8,9,10 ]
                        })
                    });
                firstRowIndex = 4,
                lastRowIndex = 7;
                scroller._fetch(firstRowIndex, lastRowIndex, true);
                equal(skip, 0);
                equal(take, 4);
            });
*/
            test("content is scrolled to the second record of the new page when the next page is fetched", function() {
                var firstRowIndex, lastRowIndex,
                    content = container.height(60).find("table").html(new Array(10).join('<tr><td style="height:30px">foo</td></tr>')),
                    scroller = new VirtualScrollable(container, {
                        itemHeight: function() {
                            return 35;
                        },
                        dataSource: new DataSource({
                            pageSize: 2,
                            page: 1,
                            data: [ 1,2,3,4,5,6,7,8,9,10 ]
                        })
                    });

                scroller.refresh();
                scroller._scroll({ currentTarget: { scrollTop: 70 } });
                equal(content.parent().scrollTop(), 35);
            });

            test("content is scrolled to the last record of the new page when the prev page is fetched", function() {
                var firstRowIndex, lastRowIndex,
                    idxToLoad = 7,
                    itemHeight = 35,
                    visibleHeight = 60,
                    content = container.height(visibleHeight).find("table").html(new Array(10).join('<tr><td style="height:30px">foo</td></tr>')),
                    scroller = new VirtualScrollable(container, {
                        itemHeight: function() {
                            return itemHeight;
                        },
                        dataSource: new DataSource({
                            pageSize: 4,
                            page: 3,
                            data: [ 1,2,3,4,5,6,7,8,9,10 ]
                        })
                    });

                scroller.refresh();
                scroller._scroll({ currentTarget: { scrollTop: 35 * idxToLoad } });
                equal(content.parent().scrollTop(), (idxToLoad - 4) * 35);
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
