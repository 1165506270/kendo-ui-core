<!DOCTYPE html>
<html>
    <head>
        <script src="jquery-loader.js"></script>
        <link rel="stylesheet" href="qunit/qunit/qunit.css" media="screen" />
        <link rel="stylesheet" href="qunit/addons/composite/qunit-composite.css" media="screen" />
        <script src="qunit/qunit/qunit.js"></script>
        <script src="qunit/addons/composite/qunit-composite.js"></script>
        <script src="tests-list.js"></script>
        <script>

            var filter = location.search,
                grepCallback = function(test) {
                    return test.indexOf(filter) === 0;
                }

            if (filter) {
                filter = filter.replace("?", "").replace(/&?jquery=[^&#]*/, "");
                tests = $.grep(tests, grepCallback);
                if (!tests.length) {
                    QUnit.test("no tests found", function() {
                        QUnit.pushFailure("No tests found!");
                    });
                }
            }

            QUnit.testSuites(tests);

            var client = top.client;

            if (client) {
                QUnit.begin(function() {
                    var suite;

                    QUnit.testStart(function(data) {
                        suite = data.name.replace('.html', '').replace('/', ' ');
                    });

                    QUnit.addEvent(QUnit.iframe, "load", function() {
                        var win = QUnit.iframe.contentWindow,
                            startDate;

                        if (!win.$) {
                            client.publish("/log", { message: "iFrame has no jQuery, skipping", location: win.location.href });
                            return;
                        }
                        var knownFails = win.$();


                        win.QUnit.testStart(function (state) {
                            startDate = +new Date();
                        });

                        win.QUnit.testDone(function(state) {
                            var newFails = win.$('li.fail li.fail').not(knownFails);

                            $.extend(state, {
                                failures: $.map(newFails.contents(), function(err) { return $(err).text() }),
                                name: (state.module || "") + " " + state.name,
                                suite: suite,
                                duration: ((+new Date()) - startDate) / 1000,
                                timestamp: $.now(),
                                agent: navigator.userAgent
                            });

                            client.publish("/testDone", state);

                            knownFails = knownFails.add(newFails);
                        });
                    });

                    QUnit.done(function(state) {
                        client.publish("/done", $.extend(state, { agent: navigator.userAgent }));
                    });
                });
            }

        </script>
    </head>
    <body>
        <div id="qunit"></div>
        <div id="qunit-fixture"></div>
    </body>
</html>
