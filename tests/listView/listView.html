<!DOCTYPE html>
<html>
    <head>
        <title>kendo.ui.ListView Tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.selectable.js"></script>
        <script src="../../src/kendo.listView.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.ui.ListView Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <script>
            var DataSource = kendo.data.DataSource,
                dataSource;

            $.fn.press = function(key, ctrl, shift) {
                return this.trigger( { type: "keydown", keyCode: key, ctrlKey: ctrl, shiftKey: shift } );
            }

            function setup(options) {
                options = $.extend({
                    template: "<li></li>",
                    navigatable: true,
                    dataSource: dataSource = new DataSource({ data: [1,2,3,4,5] })
                }, options);
                return $("<ul/>").kendoListView(options);
            }

            test("kendoListView attaches listView to element", function() {
                var ul = setup();

                ok(ul.data("kendoListView") instanceof kendo.ui.ListView);
            });

            test("k-widget and k-listview classes are applied on element", function() {
                var ul = setup();

                ok(ul.hasClass("k-widget"));
                ok(ul.hasClass("k-listview"));
            });

            test("renders item for dataSource items", function() {
                var ul = setup();

                equal(ul.find("li").length, 5);
            });

            test("dataBound event should be raised when bound", function() {
                var called = false,
                    ul = setup({
                        dataBound: function() {
                            called = true;
                        }
                    });
                ok(called);
            });

            test("autoBind false does not populate listView", function() {
                var ul = setup({autoBind: false});
                equal(ul.find("li").length, 0);
            });

            test("altTemplate defaults to template if is not set", function() {
                var listView = setup({ template: "<li>1</li>" }).data("kendoListView");

                equal(listView.template({}), "<li>1</li>");
                equal(listView.altTemplate({}), "<li>1</li>");
            });

            test("altTemplate defined", function() {
                var listView = setup({ template: "<li>1</li>", altTemplate: "<li>2</li>" }).data("kendoListView");

                equal(listView.template({}), "<li>1</li>");
                equal(listView.altTemplate({}), "<li>2</li>");
            });

            test("altTemplate is rendered", function() {
                var ul = setup({ template: "<li>1</li>", altTemplate: "<li>2</li>" });

                equal(ul.children().eq(0).html(), "1");
                equal(ul.children().eq(1).html(), "2");
            });

            test("selectable false does not instantiate Selectable object", function() {
                var ul = setup({ selectable: false });
                ok(!ul.data("kendoListView").selectable);
            });

            test("selectable true instantiate Selectable object", function() {
                var ul = setup({ selectable: true });
                ok(ul.data("kendoListView").selectable);
            });

            test("selectable true instantiate Selectable object", function() {
                var listView = setup({ selectable: true }).data("kendoListView");

                ok(listView.selectable);
                ok(!listView.selectable.options.multiple);
            });

            test("selectable multiple set multiple mode of the selectable", function() {
                var listView = setup({ selectable: "multiple" }).data("kendoListView");

                ok(listView.selectable.options.multiple);
            });

            test("focusing grid element focus first item ", function() {
                var listView = setup();
                listView.focus();
                ok(listView.find("li").first().is(".k-state-focused"));
            });

            test("down arrow moves focus on the next row same cell", function() {
                var listView = setup();
                listView.focus().press(kendo.keys.DOWN);
                ok(listView.find("li:eq(1)").hasClass("k-state-focused"));
            });

            test("right arrow moves focus on the next cell on the same row", function() {
                var listView = setup();
                listView.focus().press(kendo.keys.RIGHT);
                ok(listView.find("li:eq(0)").hasClass("k-state-focused"));
            });

            test("left arrow moves focus on the prev cell on the same row", function() {
                var listView = setup();
                listView.focus().press(kendo.keys.RIGHT).press(kendo.keys.LEFT);
                ok(listView.find("li:eq(0)").hasClass("k-state-focused"));
            });

            test("up arrow moves focus on the prev row same cell", function() {
                var listView = setup();
                listView.focus().press(kendo.keys.DOWN).press(kendo.keys.UP);
                ok(listView.find("li:eq(0)").hasClass("k-state-focused"));
            });

            test("space key select the focused item", function() {
                var listView = setup({ selectable: true });

                listView.focus().press(kendo.keys.DOWN).press(kendo.keys.SPACEBAR);

                ok(listView.find("li:eq(1)").hasClass("k-state-selected"));
            });

            test("ctrl + space key when multiple selectoin is enabled persist the selected items", function() {
                var listView = setup({ selectable: "multiple" });

                listView.focus().press(kendo.keys.DOWN).press(kendo.keys.SPACEBAR);
                listView.press(kendo.keys.DOWN).press(kendo.keys.SPACEBAR, true);

                equal(listView.find(".k-state-selected").length, 2);
                ok(listView.find("li:eq(1)").hasClass("k-state-selected"));
                ok(listView.find("li:eq(2)").hasClass("k-state-selected"));
            });

            test("space key on already selected item when multiple selectoin is enabled unselects the item", function() {
                var listView = setup({ selectable: "multiple" });

                listView.focus().press(kendo.keys.DOWN).press(kendo.keys.SPACEBAR).press(kendo.keys.SPACEBAR, true);

                ok(!listView.find("li:eq(1)").hasClass("k-state-selected"));
            });

            test("select without arguments returns selected items", function() {
                var ul = setup({ selectable: true }),
                    selected;

                ul.find("li:first").addClass("k-state-selected");

                selected = ul.data("kendoListView").select();
                equal(selected.length, 1);
            });

            test("select with arguments mark the arguments as selected", function() {
                var ul = setup({
                        selectable: true
                    }),
                    item = ul.find("li:eq(0)");

                ul.data("kendoListView").select(item);

                ok(item.hasClass("k-state-selected"));
            });

            test("select clears previously selected items if single select", function() {
                var ul = setup({
                        selectable: true
                    }),
                    items = ul.children();
                items.eq(0).addClass("k-state-selected");
                ul.data("kendoListView").select(items.eq(1));

                ok(!items.eq(0).hasClass("k-state-selected"));
                ok(items.eq(1).hasClass("k-state-selected"));
            });

            test("select persist previously selected items if multi select", function() {
                var ul = setup({
                        selectable: "multiple"
                    }),
                    items = ul.children();
                items.eq(0).addClass("k-state-selected");
                ul.data("kendoListView").select(items.eq(1));

                ok(items.eq(0).hasClass("k-state-selected"));
                ok(items.eq(1).hasClass("k-state-selected"));
            });

            test("select with array of items as argument select first if single select", function() {
                var ul = setup({
                        selectable: true
                    }),
                    items = ul.children();

                ul.data("kendoListView").select(items);

                ok(items.eq(0).hasClass("k-state-selected"));
                ok(!items.eq(1).hasClass("k-state-selected"));
                ok(!items.eq(2).hasClass("k-state-selected"));
            });

            test("clearSelection clears selected items", function() {
                var listView = setup({
                        selectable: true
                    }).data("kendoListView"),
                    item = listView.element.find("li:eq(1)").addClass("k-state-selected");

                listView.clearSelection();

                ok(!item.hasClass("k-state-selected"));
            });

            test("clearSelection triggers change event", function() {
                var triggered = false,
                    listView = setup({
                        selectable: true,
                        change: function() {
                            triggered = true;
                        }
                    }).data("kendoListView"),
                    item = listView.element.find("li:eq(1)").addClass("k-state-selected");

                listView.clearSelection();

                ok(triggered);
            });

        </script>
    </body>
</html>
