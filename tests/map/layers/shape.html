<!DOCTYPE html>
<html>
<head>
    <title>Shape layer</title>
    <script src="../../jquery-loader.js"></script>
    <script src="../../qunit/qunit/qunit.js"></script>
    <script src="../../qunit/addons/close-enough/qunit-close-enough.js"></script>
    <script src="../../kendo-test-helpers.js"></script>
    <link href="../../qunit/qunit/qunit.css" rel="stylesheet"/>
</head>
<body>
    <script src="../../../src/kendo.core.js"></script>
    <script src="../../../src/kendo.data.js"></script>
    <script src="../../../src/kendo.fx.js"></script>
    <script src="../../../src/kendo.userevents.js"></script>
    <script src="../../../src/kendo.draganddrop.js"></script>
    <script src="../../../src/kendo.dataviz.core.js"></script>
    <script src="../../../src/dataviz/util.js"></script>
    <script src="../../../src/dataviz/geometry.js"></script>
    <script src="../../../src/dataviz/drawing/core.js"></script>
    <script src="../../../src/dataviz/drawing/shapes.js"></script>
    <script src="../../../src/dataviz/drawing/svg.js"></script>
    <script src="../../../src/dataviz/drawing/canvas.js"></script>
    <script src="../../../src/map/location.js"></script>
    <script src="../../../src/map/crs.js"></script>
    <script src="../../../src/map/layers/shape.js"></script>
    <script src="../../../src/map/layers/marker.js"></script>
    <script src="helpers.js"></script>
    <script>
        var dataviz = kendo.dataviz,
            g = dataviz.geometry,
            d = dataviz.drawing,

            map = dataviz.map,
            ShapeLayer = map.layers.ShapeLayer,
            Location = map.Location;

        (function() {
            var map;
            var layer;
            var pointData = [{
                "type": "Point",
                "coordinates": [-105.01621, 39.57422]
            }];

            // ------------------------------------------------------------
            module("Shape Layer / Markers", {
                setup: function() {
                    map = new MapMock();
                    map.markers = { add: $.noop };
                    layer = new ShapeLayer(map);
                }
            });

            test("adds marker when parsing points", function() {
                map.markers = {
                    add: function() { ok(true); }
                };

                layer._load(pointData);
            });

            test("sets marker location", function() {
                map.markers = {
                    add: function(marker) {
                        deepEqual(marker.options.location, [39.57422, -105.01621]);
                    }
                };

                layer._load(pointData);
            });

            test("sets marker dataItem", function() {
                map.markers = {
                    add: function(marker) {
                        deepEqual(marker.dataItem, pointData[0]);
                    }
                };

                layer._load(pointData);
            });

            test("does not add marker when markerCreated is cancelled", 0, function() {
                map.markers = {
                    add: function() { ok(false); }
                };
                map.bind("markerCreated", function(e) { e.preventDefault(); });

                layer._load(pointData);
            });

            test("adds circle when markerCreated is cancelled", function() {
                map.bind("markerCreated", function(e) { e.preventDefault(); });

                layer.surface.draw = function(shape) {
                    ok(shape instanceof d.Circle);
                };

                layer._load(pointData);
            });

            test("does not add circle when markerCreated and shapeCreated are cancelled", 0, function() {
                map.bind("markerCreated", function(e) { e.preventDefault(); });
                map.bind("shapeCreated", function(e) { e.preventDefault(); });

                layer.surface.draw = function(shape) {
                    ok(false);
                };

                layer._load(pointData);
            });

            test("triggers markerCreated on map", function() {
                map.bind("markerCreated", function() { ok(true); });

                layer._load(pointData);
            });

            test("does not trigger shapeCreated on map", 0, function() {
                map.bind("shapeCreated", function() { ok(false); });

                layer._load(pointData);
            });

            test("triggers shapeCreated on map if markerCreated is cancelled", function() {
                map.bind("markerCreated", function(e) { e.preventDefault(); });
                map.bind("shapeCreated", function() { ok(true); });

                layer._load(pointData);
            });
        })();
    </script>

    <h1 id="qunit-header">kendo.chart</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <ul id="log"></ul>

</body>
</html>
