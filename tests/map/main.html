<!DOCTYPE html>
<html>
<head>
    <title>Helpers</title>
    <script src="../jquery-loader.js"></script>
    <script src="../qunit/qunit/qunit.js"></script>
    <script src="../qunit/addons/close-enough/qunit-close-enough.js"></script>
    <script src="../kendo-test-helpers.js"></script>
    <link href="../qunit/qunit/qunit.css" rel="stylesheet"/>
</head>
<body>
    <script src="../../src/kendo.core.js"></script>
    <script src="../../src/kendo.fx.js"></script>
    <script src="../../src/kendo.userevents.js"></script>
    <script src="../../src/kendo.draganddrop.js"></script>
    <script src="../../src/kendo.mobile.scroller.js"></script>
    <script src="../../src/kendo.dataviz.core.js"></script>
    <script src="../../src/dataviz/util.js"></script>
    <script src="../../src/dataviz/geometry.js"></script>
    <script src="../../src/dataviz/drawing/core.js"></script>
    <script src="../../src/dataviz/drawing/shapes.js"></script>
    <script src="../../src/map/location.js"></script>
    <script src="../../src/map/crs.js"></script>
    <script src="../../src/map/compass.js"></script>
    <script src="../../src/map/layers/marker.js"></script>
    <script src="../../src/map/main.js"></script>
    <script>
        var dataviz = kendo.dataviz,
            Point = dataviz.Point2D,

            m = dataviz.map,
            Extent = m.Extent,
            Location = m.Location;

        var map;
        function createMap(options) {
            var element = $("<div style='width: 512px; height: 512px;'></div>").appendTo($("#qunit-fixture"));
            map = new kendo.dataviz.ui.Map(element, options);
            return map;
        }

        function destroyMap() {
            map.destroy();
            map.element.remove();
        }

        (function() {
            // ------------------------------------------------------------
            module("Map / Extent", {
                setup: createMap,
                teardown: destroyMap
            });

            test("se corner wraps around by default", function() {
                createMap({ zoom: 0 });
                map.element.css("width", "2000px");
                ok(map.extent().se.round().lng > 180);
            });

            test("se corner does not wrap around", function() {
                createMap({ zoom: 1, wraparound: false });
                map.element.css("width", "2000px");
                equal(map.extent().se.round().lng, 180);
            });

            test("se is clipped visible area", function() {
                createMap({ zoom: 3 });
                map.element.css("width", "1024px");
                equal(map.extent().se.round().lng, 135);
            });
        })();

        (function() {
            // ------------------------------------------------------------
            module("Map / Location <-> Layer", {
                setup: function() {
                    createMap({ zoom: 1 });
                },
                teardown: destroyMap
            });

            test("locationToLayer maps location to layer coordinates", function() {
                var point = map.locationToLayer(new Location(90, 240));
                ok(point.round().equals(new Point(597, 0)));
            });

            test("locationToLayer maps location to layer coordinates at specified zoom", function() {
                var point = map.locationToLayer(new Location(0, 0), 3);
                ok(point.round().equals(new Point(1024, 1024)));
            });

            test("locationToLayer clamps coordinates when wraparound is false", function() {
                createMap({ zoom: 1, wraparound: false });
                var point = map.locationToLayer(new Location(90, 240));
                ok(point.round().equals(new Point(512, 0)));
            });

            test("layerToLocation maps layer coordinates to location", function() {
                var loc = map.layerToLocation(new Point(597, 0));
                ok(loc.round().equals(new Location(85, 240)));
            });

            test("layerToLocation maps layer coordinates to location at specified zoom", function() {
                var loc = map.layerToLocation(new Point(1024, 1024), 3);
                ok(loc.round().equals(new Location(0, 0)));
            });

            test("layerToLocation maps layer coordinates to location when wraparound is false", function() {
                createMap({ zoom: 1, wraparound: false });
                var loc = map.layerToLocation(new Point(512, 0));
                ok(loc.round().equals(new Location(85, 180)));
            });
        })();

        (function() {
            // ------------------------------------------------------------
            module("Map / Scroller", {
                setup: createMap,
                teardown: destroyMap
            });

            test("x virtualSize is 20x scale when wraparound is true", function() {
                var scale = map.scale();
                var x = map.scroller.dimensions.x;
                equal(x._virtualMin, -20 * scale);
                equal(x._virtualMax, 20 * scale);
            });

            test("x virtualSize is scale when wraparound is false", function() {
                createMap({ wraparound: false });
                var scale = map.scale();
                var x = map.scroller.dimensions.x;
                equal(x._virtualMax - x._virtualMin, 2048);
            });

            test("y virtualSize equals scale", function() {
                var scale = map.scale();
                var y = map.scroller.dimensions.y;
                equal(y._virtualMax - y._virtualMin, scale);
            });
        })();

        (function() {
            // ------------------------------------------------------------
            module("Map / Compass", {
                setup: createMap,
                teardown: destroyMap
            });

            test("compass is created by default", function() {
                ok(map.compass);
            });

            test("compass is not created on mobile devices", function() {
                var mobileOS = kendo.support.mobileOS;

                kendo.support.mobileOS = true;
                createMap();
                ok(!map.compass);
                kendo.support.mobileOS = mobileOS;
            });

            test("compass is not created if disabled", function() {
                createMap({ controls: { navigator: false } });
                ok(!map.compass);
            });

            test("compass options are passed", function() {
                createMap({ controls: { navigator: { foo: true } } });
                ok(map.compass.options.foo);
            });

            test("panning triggers pan and panEnd", 2, function() {
                map.bind("pan", function() {
                    map.bind("panEnd", function() {
                        ok(true);
                    });

                    ok(true);
                });
                map.compass.trigger("pan", { x: 100, y: 0 });
            });

            test("panning moves origin", function() {
                map.bind("panEnd", function() {
                    ok(new Location(53, -27).equals(map.origin().round()));
                });
                map.compass.trigger("pan", { x: 100, y: 100 });
            });

            test("panning is limited to world extent (west)", function() {
                createMap({ wraparound: false });
                map.bind("panEnd", function() {
                    equal(map.scroller.scrollLeft, -768);
                });
                map.compass.trigger("pan", { x: -10000, y: 0 });
            });

            test("panning is limited to world extent (east)", function() {
                createMap({ wraparound: false });
                map.bind("panEnd", function() {
                    equal(map.scroller.scrollLeft, 768);
                });
                map.compass.trigger("pan", { x: 10000, y: 0 });
            });

            test("panning is limited to world extent (north)", function() {
                createMap({ wraparound: false });
                map.bind("panEnd", function() {
                    equal(map.scroller.scrollTop, 768);
                });
                map.compass.trigger("pan", { x: 0, y: -10000 });
            });

            test("panning is limited to world extent (south)", function() {
                createMap({ wraparound: false });
                map.bind("panEnd", function() {
                    equal(map.scroller.scrollTop, -768);
                });
                map.compass.trigger("pan", { x: 0, y: 10000 });
            });

            test("panning wraps around world (west)", function() {
                map.bind("panEnd", function() {
                    equal(map.scroller.scrollLeft, -10000);
                });
                map.compass.trigger("pan", { x: -10000, y: 0 });
            });

            test("panning wraps around (east)", function() {
                map.bind("panEnd", function() {
                    equal(map.scroller.scrollLeft, 10000);
                });
                map.compass.trigger("pan", { x: 10000, y: 0 });
            });

            test("center resets center", function() {
                map.bind("reset", function() { ok(true); });
                map.compass.trigger("center");
            });
        })();

    </script>

    <h1 id="qunit-header">kendo.chart</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <ul id="log"></ul>

</body>
</html>
