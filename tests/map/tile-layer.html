<!DOCTYPE html>
<html>
<head>
    <title>Shape layer</title>
    <script src="../jquery-loader.js"></script>
    <script src="../qunit/qunit/qunit.js"></script>
    <script src="../qunit/addons/close-enough/qunit-close-enough.js"></script>
    <script src="../kendo-test-helpers.js"></script>
    <link href="../qunit/qunit/qunit.css" rel="stylesheet"/>
</head>
<body>
    <script src="../../src/kendo.core.js"></script>
    <script src="../../src/kendo.dataviz.core.js"></script>
    <script src="../../src/dataviz/util.js"></script>
    <script src="../../src/dataviz/geometry.js"></script>
    <script src="../../src/map/location.js"></script>
    <script src="../../src/map/crs.js"></script>
    <script src="../../src/map/layers/tile.js"></script>
    <script src="../../src/map/main.js"></script>
    <script>
        var dataviz = kendo.dataviz,
            map = dataviz.map,

            TilePool = map.layers.TilePool,
            ImageTile = map.layers.ImageTile,
            Location = map.Location,

            Point = dataviz.geometry.Point;

        (function() {

            var tile,
                element;

            function createTile(options) {
                var element = $("<div class='k-layer' style='width: 800px; height: 800px;'></div>")
                                .appendTo(document.body);

                tile = new TileView(element, {});
            }

            // ------------------------------------------------------------
            module("Tile view", {
                setup: function() {
                    createTile();
                },
                teardown: function() {
                    $(".k-layer").remove();
                }
            });

        })();


        (function() {

            var tile,
                pool;

            function addItemsToPool(count) {
                count = count || 15;
                for (var i = 0; i < count; i++) {
                    pool.get({ x: 5, y: 5 },{
                        index: new Point(i, i),
                        point: new Point(i, i),
                        offset: new Point(i, i)
                    });
                }
            }

            // ------------------------------------------------------------
            module("Tile layer / Pool", {
                setup: function() {
                    pool = new TilePool();
                }
            });

            test("should not have more then 10 items", function() {
                pool.options.maxSize = 10;
                addItemsToPool();
                ok(pool._items.length === 10);
            });

            test("empty should remove the items", function() {
                addItemsToPool();
                pool.empty();
                ok(pool._items.length === 0);
            });

            test("should reuse the items", function() {
                pool.options.maxSize = 10;
                addItemsToPool(11);
                ok(pool._items[0].index.x === 10);
                ok(pool._items[0].index.y === 10);
            });

            test("_tileId should return correct id", function() {
                var id = pool._tileId({
                    index: {
                        x: 0,
                        y: 0
                    },
                    zoom: 0
                })
                ok(id === "x:0y:0zoom:0");
            });

        })();

        function createImageTile(options) {
            // value or initial value
            options = options || {};
            options.index = options.index || { x: 0, y: 0 };
            options.offset = options.offset || { x: 0, y: 0 };
            options.point = options.point || { x: 0, y: 0 };

            return new ImageTile({
                url: options.url || "",
                index: new Point(options.index.x, options.index.y),
                offset: new Point(options.offset.x, options.offset.y),
                point: new Point(options.point.x, options.point.y),
                zoom: options.zoom || 1
            });
        }

        (function() {
            var tile;

            // ------------------------------------------------------------
            module("Tile layer / ImageTile");

            test("should render url", function() {
                tile = createImageTile({
                    url: "url"
                });

                ok(tile.element.attr("src") === "url");
            });

            test("should render offset", function() {
                tile = createImageTile({
                    offset: {
                        x: 20,
                        y: 10
                    }
                });

                ok(parseInt(tile.element.css("top")) == 10);
                ok(parseInt(tile.element.css("left")) == 20);
            });

            test("should have id", function() {
                tile = createImageTile({
                    index: {
                        x: 1,
                        y: 1
                    },
                    zoom: 1
                });

                ok(tile.id === "x:1y:1zoom:1");
            });

            test("initial visible should be false", function() {
                tile = createImageTile();

                ok(!tile.visible);
            });

            test("destroy should remove the element", function() {
                tile = createImageTile();
                tile.destroy();

                ok(!tile.element);
            });

            // ------------------------------------------------------------
            module("Tile layer / ImageTile/ Update", {
                setup: function() {
                    tile = createImageTile();
                }
            });

            test("should render url", function() {
                tile.load({
                    url: "url",
                    index: {
                        x: 1,
                        y: 1
                    },
                    offset: {
                        x: 20,
                        y: 10
                    }
                });

                ok(tile.element.attr("src") === "url");
            });

            test("should render offset", function() {
                tile.load({
                    index: {
                        x: 1,
                        y: 1
                    },
                    offset: {
                        x: 20,
                        y: 10
                    }
                });

                ok(parseInt(tile.element.css("top")) == 10);
                ok(parseInt(tile.element.css("left")) == 20);
            });

            test("should have id", function() {
                tile.load({
                    index: {
                        x: 1,
                        y: 1
                    },
                    offset: {
                        x: 1,
                        y: 1
                    },
                    zoom: 1
                });

                ok(tile.id === "x:1y:1zoom:1");
            });

            test("should set visible to true", function() {
                tile.load({
                    index: {
                        x: 1,
                        y: 1
                    },
                    offset: {
                        x: 1,
                        y: 1
                    }
                });

                ok(tile.visible === true);
            });

        })();

    </script>

    <h1 id="qunit-header">kendo.map</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <ul id="log"></ul>

</body>
</html>
