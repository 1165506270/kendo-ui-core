<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>kendo.ui.MobileListView DataBinding Tests</title>
        <link rel="stylesheet/less" href="../../../styles/mobile/kendo.mobile.all.less" type="text/css" />
        <script src="../../../demos/mvc/content/shared/js/less.js"></script>
        <script src="../../../src/jquery.js"></script>
        <script src="../../qunit/qunit/qunit.js"></script>
        <script src="../../jquery.mockjax.js"></script>
        <script src="../../../src/kendo.core.js"></script>
        <script src="../../../src/kendo.fx.js"></script>
        <script src="../../../src/kendo.userevents.js"></script>
        <script src="../../../src/kendo.draganddrop.js"></script>
        <script src="../../../src/kendo.data.js"></script>
        <script src="../../../src/kendo.router.js"></script>
        <script src="../../../src/kendo.model.js"></script>
        <script src="../../../src/kendo.mobile.listview.js"></script>
        <script src="../../../src/kendo.mobile.scroller.js"></script>
        <script src="../../../src/kendo.mobile.view.js"></script>
        <script src="../../../src/kendo.mobile.loader.js"></script>
        <script src="../../../src/kendo.mobile.pane.js"></script>
        <script src="../../../src/kendo.mobile.application.js"></script>
        <link rel="stylesheet" href="../../qunit/qunit/qunit.css" />
        <style>
            #qunit-fixture {
                height: 100px;
            }
        </style>

    </head>
    <body>
        <h1 id="qunit-header">kendo.mobile.ui.ListView DataBinding Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <script>
            QUnit.config.reorder = false;
            var ListView = kendo.mobile.ui.ListView;

            module("mobile listview", {
                setup: function() {

                },
                teardown: function() {

                }
            });

            test("binds to flat datasource", function() {
                var dom = $("<ul/>");

                new ListView(dom, {
                    dataSource: [1, 2]
                });

                equal(dom.children().length, 2);
            });

            test("binds to datasource referenced by data attribute", function() {
                var dom = $('<ul data-role="listview" data-source="foo" />');

                window.foo =  [1, 2];

                kendo.mobile.init(dom);

                equal(dom.children().length, 2);
            });


            test("default template expects string as data item", function() {
                var dom = $("<ul/>");

                new ListView(dom, {
                    dataSource: [1, 2]
                });

                equal(dom.children().first().text(), "1");
            });

            test("uses custom template", function() {
                var dom = $("<ul/>");

                new ListView(dom, {
                    dataSource: [ { text: "foo" } ],
                    template: "#= text #"
                });

                equal(dom.children().first().text(), "foo");
            });

            test("does not rebind when item in the datasource changes", function() {
                var dom = $("<ul/>");

                var listView = new ListView(dom, {
                    dataSource: [ { text: "foo" }, { text: "bar" } ],
                    template: "#= text #"
                });

                var last = dom.find("li:last")[0];

                listView.dataSource.data()[0].set("text", "baz");

                equal(last, dom.find("li:last")[0]);
            });

            test("refreshes the corresponding list item when item in the datasource changes", function() {
                var dom = $("<ul/>");

                var listView = new ListView(dom, {
                    dataSource: [ { text: "foo" }, { text: "bar" } ],
                    template: "#= text #"
                });

                listView.dataSource.data()[0].set("text", "baz");

                equal(dom.find("li:first").text(), "baz");
            });

            test("default template escapes html entities", function() {
                var dom = $("<ul/>");

                new ListView(dom, {
                    dataSource: ["<i>"]
                });

                equal(dom.children().first().html(), "&lt;i&gt;");
            });

            test("custom template as function", function() {
                var dom = $("<ul/>");

                new ListView(dom, {
                    dataSource: [ { text: "foo" }],
                    template: function(data) {
                        return data.text;
                    }
                });

                equal(dom.children().first().html(), "foo");
            });

            test("calls mobile.init on refresh", function() {
                var dom = $("<ul/>"),
                    originInit = kendo.mobile.init;

                stub(kendo.mobile, {
                    init: originInit
                });

                var listView = new ListView(dom, {
                    dataSource: [ { text: "foo" }, { text: "bar" } ],
                    template: "#= text #"
                });

                equal(kendo.mobile.calls("init"), 1);

                kendo.mobile.init = originInit;
            });

            test("ListView does not init elements twice", function() {
                var dom = $("<ul/>"),
                    originInit = kendo.initWidget;

                var listView = new ListView(dom, {
                    dataSource: [ { text: "foo" }, { text: "bar" } ],
                    appendOnRefresh: true,
                    template: "#= text #"
                });

                stub(kendo, {
                    initWidget: originInit
                });

                listView.dataSource.data([ { text: "baz" } ]);

                equal(kendo.calls("initWidget"), 1);

                kendo.initWidget = originInit;
            });

            var dom, dataSource, listView, subList, data;

            module("grouped datasource", {
                setup: function() {
                    data = [{foo: "Foo", bar: "Bar"}, {foo: "Foo", bar: "Baz"}];
                    dom = $("<ul/>");


                    dataSource = new kendo.data.DataSource({data: data, group: {field: "foo"}});
                    listView = new ListView(dom, {dataSource: dataSource, template: "${bar}", headerTemplate: "<i>${value}</i>"});
                    subList = dom.find("li>ul");
                },

                teardown: function() { }
            });

            test("detects grouped datasource", function() {
                equal(listView.options.type, "group");
            });

            test("styles root element correctly", function() {
                ok(!dom.is(".km-list"));
            });

            test("uses group values for headers", function() {
                equal(dom.find("li").contents().eq(0).text(), "Foo");
            });

            test("creates sublists", function() {
                equal(subList.length, 1, "sublist is created");
                ok(subList.is(".km-list"), "sublist class is applied");
            });

            test("populates sublists with items", function() {
                equal(subList.find("li").length, 2);
                equal(subList.find("li").eq(0).text(), "Bar");
                equal(subList.find("li").eq(1).text(), "Baz");
            });

            test("renders data-uid attribute for sublist items", function() {
                equal(subList.find("li").data("uid"), listView.dataSource.view()[0].items[0].uid);
            });

            test("accepts custom header template", function() {
                ok(dom.find("li > div > div").eq(0).children(0).is("i"), "item has custom header");
            });

            test("accepts function as a custom header template", function() {
                dom = $("<ul/>");
                listView = new ListView(dom, {dataSource: dataSource, template: "${bar}", headerTemplate: function(data) { return "<i>" + data + "</i>" }});
                ok(dom.find("li > div > div").eq(0).children(0).is("i"), "item has custom header");
            });

            test("data-uid attribute is rendered for each row when model is defined", function() {
                dom = $("<ul/>");
                listView = new ListView(dom, {
                    dataSource: {data: [{foo: "bar"}]}
                });

                equal(dom.find("li").data("uid"), listView.dataSource.view()[0].uid);
            });

            test("databound item passes the dataitem in the event when clicked", function() {
                expect(1);
                var model = {foo: "bar"},
                    link,
                        dataSource = { data: [model]};

                dom = $("<ul/>");

                listView = new ListView(dom, {dataSource: dataSource});

                listView.bind("click", function(e) {
                    equal(e.dataItem.foo, model.foo, "event passes the model as data item");
                });

                link = dom.find("li");

                link.trigger(kendo.support.mousedown);
                link.trigger("mouseup");
            });

            test("resetting dataSource detaches the previouse events", function() {
                dom = $("<ul/>");

                listView = new ListView(dom, {dataSource: dataSource});

                var dataSource = listView.dataSource;

                listView._dataSource();

                listView.bind("dataBound", function() {
                    ok(false, "Change event is not detached");
                });

                dataSource.read();

                notStrictEqual(listView.dataSource, dataSource);
            });

            test("resetting DataSource rebinds the widget", function() {
                dom = $("<ul/>");

                listView = new ListView(dom, {dataSource: dataSource});

                listView.setDataSource(new kendo.data.DataSource({
                    data:[{text: 1, value: 1}, {text:2, value:2}]
                }));

                equal(dom.find("li").length, 2);
            });

            test("clearing groups does not throw error", function() {
                dom = $("<ul/>");

                listView = new ListView(dom, {dataSource: dataSource});

                listView.dataSource.query({});

                ok(true);
            });

            var application;

            module("pull to refresh", {
                setup: function() {
                    location.hash = '';
                    $.mockjaxSettings.responseTime = 0;
                    $.mockjaxSettings.contentType = "text/html";
                },

                teardown: function() {
                    $.mockjaxClear();
                    kendo.history.stop();
                }
            });

            function setup(html, options) {
                $("#qunit-fixture").html(html);
                application = new kendo.mobile.Application($("#qunit-fixture"), options);
            }

            asyncTest("refreshes on pull if configured", 2, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });
                var ds = kendo.data.DataSource.create({ transport: { read: { url: "foo.json", dataType: "json" } } });
                var listview;

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        pullToRefresh: true
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar", "baz"] });

                function secondAssert() {
                    start();
                    equal(listview.children().length, 3);
                }

                function firstAssert() {
                    equal(listview.children().length, 2);
                    ds.unbind("change", firstAssert);
                    ds.bind("change", secondAssert);

                    application.scroller().trigger("pull");
                }

                ds.bind("change", firstAssert);
            });

            asyncTest("Pull to refresh always send page number 1", 1, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });

                var listview;
                var ds = kendo.data.DataSource.create({
                    transport: {
                        read: { url: "foo.json", dataType: "json" },
                        parameterMap: function(options) {
                            //first time DS does not send page number
                            if (options.page !== undefined) {
                                equal(options.page, 1);
                            }
                        }
                    },
                    serverPaging: true
                });

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        pullToRefresh: true
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
                var scroller = application.scroller();

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar", "baz"] });

                function firstAssert() {
                    $.mockjaxClear();
                    scroller.trigger("pull");
                    start();
                }

                ds.bind("change", firstAssert);
            });

            test("Pull to refresh calls pull to refresh callback", 1, function(){
                var listview;
                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: [],
                        pullToRefresh: true,
                        pullParameters: function() {
                            ok(true);
                        }
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
                application.scroller().trigger("pull");
            });

            asyncTest("Pull to refresh passes first item to the callback", 2, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });

                var listview, calls = 1;
                var ds = kendo.data.DataSource.create({
                    transport: {
                        read: { url: "foo.json", dataType: "json" },
                        parameterMap: function(options) {
                            //first time DS does not send page number
                            if (options.page !== undefined) {
                                equal(options.page, 1);
                            }
                        }
                    },
                    serverPaging: true
                });

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        pullToRefresh: true,
                        pullParameters: function(item) {
                            if (calls === 1) {
                                equal(item, "foo");
                                calls ++;
                            } else {
                                equal(item, "foo1");
                                $.mockjaxClear();
                                start();
                            }
                        }
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
                var scroller = application.scroller();

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["foo1"] });

                function secondAssert() {
                    scroller.trigger("pull");
                }

                function firstAssert() {
                    ds.unbind("change", firstAssert);
                    ds.bind("change", secondAssert);

                    scroller.trigger("pull");
                }

                ds.bind("change", firstAssert);
            });

            module("press to load more", {
                setup: function() {
                    location.hash = '';
                    $.mockjaxSettings.responseTime = 0;
                    $.mockjaxSettings.contentType = "text/html";
                },

                teardown: function() {
                    $.mockjaxClear();
                    kendo.history.stop();
                }
            });

            function setup(html, options) {
                $("#qunit-fixture").html(html);
                application = new kendo.mobile.Application($("#qunit-fixture"), options);
            }

            asyncTest("refreshes on press to load more", 3, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });
                var ds = kendo.data.DataSource.create({
                    transport: {
                        read: { url: "foo.json", dataType: "json" }
                    },
                    serverPaging: true,
                    pageSize: 1
                });
                var listview;

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        loadMore: true
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["baz"] });

                function secondAssert() {
                    start();
                    equal(listview.children().length, 3);
                    equal(listview.children(":last").text(), "baz");
                }

                function firstAssert() {
                    equal(listview.children().length, 2);
                    ds.unbind("change", firstAssert);
                    ds.bind("change", secondAssert);

                    listview.parent().find(".km-load").trigger("mouseup");
                }

                ds.bind("change", firstAssert);
            });

            asyncTest("ListView calls loadMoreParameters", 2, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });
                var ds = kendo.data.DataSource.create({
                    transport: {
                        read: { url: "foo.json", dataType: "json" }
                    },
                    serverPaging: true,
                    pageSize: 1
                });
                var listview;

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        loadMore: true,
                        loadMoreParameters: function(first, last) {
                            $.mockjaxClear();
                            start();

                            equal(first, "foo");
                            equal(last, "bar");
                        }
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["baz"] });

                function firstAssert() {
                    ds.unbind("change", firstAssert);

                    listview.parent().find(".km-load").trigger("mouseup");
                }

                ds.bind("change", firstAssert);
            });

            test("ListView hides the load button on click", 4, function() {
                var dom = $("<ul/>").appendTo("#qunit-fixture");

                new ListView(dom, {
                    dataSource: [1, 2],
                    loadMore: true
                });

                var button = dom.parent().find(".km-load"),
                    icon = dom.parent().find(".km-icon");

                ok(button.is(":visible"));
                ok(!icon.is(":visible"));

                button.trigger("mouseup");

                ok(!button.is(":visible"));
                equal(icon.css("display"), "block");

            });

            asyncTest("ListView shows load button on dataSource change", 2, function() {
                var dom = $("<ul/>").appendTo("#qunit-fixture");

                var listView = new ListView(dom, {
                    dataSource: {
                        data: [1, 2],
                        pageSize: 1
                    },
                    loadMore: true
                });

                var button = dom.parent().find(".km-load"),
                    icon = dom.parent().find(".km-icon");

                listView.bind("dataBound", function() {
                    start();

                    ok(button.is(":visible"));
                    ok(!icon.is(":visible"));
                });

                button.trigger("mouseup");
            });

            module("endless scrolling", {
                setup: function() {
                    location.hash = '';
                    $.mockjaxSettings.responseTime = 0;
                    $.mockjaxSettings.contentType = "text/html";
                },

                teardown: function() {
                    $.mockjaxClear();
                    kendo.history.stop();
                }
            });

            function setup(html, options) {
                $("#qunit-fixture").html(html);
                application = new kendo.mobile.Application($("#qunit-fixture"), options);
            }

            asyncTest("ListView appends on scroll", 2, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });
                var ds = kendo.data.DataSource.create({ pageSize: 1, transport: { read: { url: "foo.json", dataType: "json" } } });
                var listview;

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        endlessScroll: true
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
                var scroller = application.scroller();

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar", "baz"] });

                function secondAssert() {
                    start();
                    equal(listview.children().length, 2);
                }

                function firstAssert() {
                    equal(listview.children().length, 1);
                    ds.unbind("change", firstAssert);
                    ds.bind("change", secondAssert);

                    scroller.trigger("scroll", {
                        scrollTop: scroller.scrollHeight() - scroller.element.height()
                    });
                }

                scroller.trigger("resize");

                ds.bind("change", firstAssert);

            });

            asyncTest("Endless scrolling increment the page number", 1, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });

                var ds = kendo.data.DataSource.create({
                    pageSize: 1,
                    transport: { read: { url: "foo.json", dataType: "json" } }
                });

                var listview;

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        endlessScroll: true
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
                var scroller = application.scroller();

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar", "baz"] });

                function secondAssert() {
                    start();
                    equal(listview.data("kendoMobileListView").dataSource.page(), 2);
                }

                function firstAssert() {
                    ds.unbind("change", firstAssert);
                    ds.bind("change", secondAssert);

                    scroller.trigger("scroll", {
                        scrollTop: scroller.scrollHeight() - scroller.element.height()
                    });
                }

                scroller.trigger("resize");

                ds.bind("change", firstAssert);
            });

            asyncTest("ListView caches original first item and the last item", 4, function(){
                $.mockjax({ url: "foo.json", responseText: ["foo", "bar"] });

                var ds = kendo.data.DataSource.create({
                    pageSize: 2,
                    serverPaging: true,
                    schema: { total: function() { return 6; } },
                    transport: { read: { url: "foo.json", dataType: "json" } }
                });

                var listview, calls = 1;

                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: ds,
                        endlessScroll: true,
                        endlessScrollParameters: function (first, last) {
                            if (calls === 1) {
                                equal(first, "foo");
                                equal(last, "bar");
                                calls ++;
                            } else {
                                console.log("starting");
                                start();
                                equal(first, "foo");
                                equal(last, "bar1");
                            }
                        }
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
                var scroller = application.scroller();

                $.mockjaxClear();
                $.mockjax({ url: "foo.json", responseText: ["foo1", "bar1"] });

                function scrollToNextPage() {
                    scroller.trigger("scroll", {
                        scrollTop: scroller.scrollHeight() - scroller.element.height()
                    });
                }

                ds.one("change", function() {
                    ds.one("change", scrollToNextPage);

                    scrollToNextPage();
                });

                scroller.trigger("resize");
            });

            test("Endless scroll calls endless callback", 1, function(){
                var listview;
                window.initListView = function(e) {
                    listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: {
                            data: ["item1", "item2"],
                            pageSize: 1
                        },
                        endlessScroll: true,
                        endlessScrollParameters: function() {
                            ok(true);
                        }
                    });
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
                var scroller = application.scroller();

                scroller.trigger("resize");

                scroller.trigger("scroll", {
                    scrollTop: scroller.scrollHeight() - scroller.element.height()
                });
            });

            test("stopEndlessScrolling method stops endlessScrolling functionality", 2, function() {
                window.initListView = function(e) {
                    var listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: [],
                        endlessScroll: true
                    });

                    listview.data("kendoMobileListView").stopEndlessScrolling();

                    var scroller = listview.data("kendoMobileListView")._scroller();

                    equal(scroller._events["resize"][0], undefined);
                    ok(scroller._events["scroll"].length < 2);
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');
            });

            test("stopLoadMore method disables loadMore functionality", function() {
                var lv = $("<div/>").kendoMobileListView({
                    dataSource: [],
                    loadMore: true
                }).data("kendoMobileListView");

                lv.stopLoadMore();

                equal(lv._loadButton.data("events"), undefined);
            });

            test("stopLoadMore method raises event", 1, function() {
                var lv = $("<div/>").kendoMobileListView({
                    dataSource: [],
                    loadMore: true,
                    lastPageReached: function() {
                        ok(true);
                    }
                }).data("kendoMobileListView");

                lv.stopLoadMore();
            });

            test("stopEndlessScrolling method raises event", 1, function() {
                window.initListView = function(e) {
                    var listview = e.view.element.find("#listview");
                    listview.kendoMobileListView({
                        dataSource: [],
                        endlessScroll: true,
                        lastPageReached: function() {
                            ok(true);
                        }
                    });

                    listview.data("kendoMobileListView").stopEndlessScrolling();
                }

                setup('<div data-role="view" data-init="initListView"><div id="listview" style="height:300px"></div></div>');

            });

        </script>
    </body>
</html>
