<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>kendo.ui.MobileScrollView.Tests</title>
        <script src="../../jquery-loader.js"></script>
        <script src="../../qunit/qunit/qunit.js"></script>
        <script src="../../kendo-test-helpers.js"></script>
        <script src="../../../src/kendo.core.js"></script>
        <script src="../../../src/kendo.fx.js"></script>
        <script src="../../../src/kendo.data.js"></script>
        <script src="../../../src/kendo.userevents.js"></script>
        <script src="../../../src/kendo.draganddrop.js"></script>
        <script src="../../../src/kendo.router.js"></script>
        <script src="../../../src/kendo.mobile.scroller.js"></script>
        <script src="../../../src/kendo.mobile.loader.js"></script>
        <script src="../../../src/kendo.mobile.view.js"></script>
        <script src="../../../src/kendo.mobile.pane.js"></script>
        <script src="../../../src/kendo.mobile.application.js"></script>
        <script src="../../../src/kendo.mobile.scrollview.js"></script>
        <link rel="stylesheet" href="../../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.mobile.ui.ScrollView Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <style>
            [data-role=page] {
                display: inline-block;
            }
        </style>

        <script>
            var ElasticPane = kendo.mobile.ui.ScrollViewElasticPane;

            var Transition = kendo.effects.Transition,
                floor = Math.floor,
                round = Math.round,
                ceil = Math.ceil,
                LEFT_SWIPE = -1,
                NUDGE = 0,
                RIGHT_SWIPE = 1;

            var ScrollViewContent = kendo.Class.extend({
                init: function (element, pane) {
                    var that = this;

                    that.element = element;
                    that.pane = pane;
                    that._getPages();
                    this.page = 0;
                    this.pageSize = 1;
                },

                scrollTo: function(page, instant) {
                    this.page = page;
                    this.pane.transitionTo(- page * this.pane.size(), Transition.easeOutExpo, instant);
                },

                dragged: function(swipeType, bounce) {
                    var that = this,
                        pane = that.pane,
                        width = pane.size() * that.pageSize,
                        approx = round,
                        ease = bounce ? Transition.easeOutBack : Transition.easeOutExpo,
                        snap,
                        nextPage;

                    if (swipeType === LEFT_SWIPE) {
                        approx = ceil;
                    } else if (swipeType === RIGHT_SWIPE) {
                        approx = floor;
                    }

                    nextPage = approx(pane.offset() / width);

                    snap = Math.max(that.minSnap, Math.min(-nextPage * width, that.maxSnap));

                    pane.transitionTo(snap, ease);
                },

                updatePage: function() {
                    var pane = this.pane,
                        page = Math.round(pane.offset() / pane.size());

                    if (page != this.page) {
                        this.page = page;
                        return true;
                    }

                    return false;
                },

                _getPages: function () {
                    this.pageElements = this.element.find("[data-role=page]");
                    this._paged = this.pageElements.length > 0;
                },

                resizeTo: function(width) {
                    var pane = this.pane;

                    this.pageElements.width(width);

                    // re-read pane dimension after the pageElements have been resized.
                    pane.updateDimension();

                    if (!this._paged) {
                        this.page = Math.floor(pane.offset() / width);
                    }

                    this.scrollTo(this.page, true);

                    this.pageCount = Math.ceil(pane.total() / width);
                    this.minSnap = - (this.pageCount - 1) * width;
                    this.maxSnap = 0;
                }
            });

            var element,
                content,
                container;

            module("ScrollView Content", { setup: function () {

            }});

            test("calculates pageCount correctly", 1, function() {
                element = $("<div style='width: 500px;' />").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");

                content = new ScrollViewContent(element, new ElasticPane(element));

                content.resizeTo(200);
                equal(content.pageCount, 3);
            });

            test("resizes container and data-role=page elements as expected", 2, function() {
                element = $("<div style='position: absolute;'><div data-role=page></div><div data-role=page></div></div>").appendTo("#qunit-fixture").wrap("<div/>");

                content = new ScrollViewContent(element, new ElasticPane(element));

                content.resizeTo(200);
                equal(content.element.width(), 400);
                equal(content.element.find("[data-role=page]").eq(0).width(), 200);
            });

            test("scrolls to provided page, offseting the pane to the correct value", 3, function() {
                element = $("<div style='width: 500px;' />").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");

                var pane = new ElasticPane(element);
                content = new ScrollViewContent(element, pane);

                equal(content.page, 0);

                content.scrollTo(1, true);

                equal(content.page, 1);
                equal(pane.offset(), 200);
            });

            test("re-calculates current page on pane resize", 2, function() {
                element = $("<div style='width: 500px;' />").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");

                var pane = new ElasticPane(element);
                content = new ScrollViewContent(element, pane);

                equal(content.page, 0);
                content.scrollTo(1, true);

                content.resizeTo(100);
                equal(content.page, 2);
            });

            test("retains current page on pane resize if data-role page elements are present", 2, function() {
                element = $("<div style='position: absolute;'><div data-role=page></div><div data-role=page></div></div>").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");

                var pane = new ElasticPane(element);
                content = new ScrollViewContent(element, pane);

                equal(content.page, 0);
                content.scrollTo(1, true);

                content.resizeTo(100);
                equal(content.page, 1);
            });

            test("scrolls to the current page on resize", 1, function() {
                element = $("<div style='position: absolute;'><div data-role=page></div><div data-role=page></div></div>").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");

                var pane = new ElasticPane(element);
                content = new ScrollViewContent(element, pane);
                content.page = 1;
                content.resizeTo(200);

                equal(pane.offset(), 200);
            });

            test("re-adjusts offset on resize if pages present", 1, function() {
                element = $("<div style='position: absolute;'><div data-role=page></div><div data-role=page></div></div>").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");

                var pane = new ElasticPane(element);
                content = new ScrollViewContent(element, pane);
                content.page = 1;
                content.resizeTo(200);

                element.parent().width(100);
                pane.refresh();
                content.resizeTo(100);

                equal(pane.offset(), 100);
            });

            var pane, content;

            module("ScrollView Content dragging", {
                setup: function () {
                    element = $("<div style='position: absolute;'><div data-role=page></div><div data-role=page></div></div>").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");
                    pane = new ElasticPane(element);
                    content = new ScrollViewContent(element, pane);
                    content.resizeTo(200);
                }
            });

            asyncTest("small drag snaps the content back to the current page", 2, function() {
                pane.moveTo(50);
                content.dragged(NUDGE);
                setTimeout(function() {
                    start();
                    equal(content.page, 0);
                    equal(pane.offset(), 0);
                }, 50);
            });

            asyncTest("swift drag moves the content to the next page", 2, function() {
                pane.moveTo(50);
                content.dragged(LEFT_SWIPE);
                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 1);
                    equal(pane.offset(), 200);
                }, 50);
            });

            asyncTest("swift right drag moves the content to the previous page", 2, function() {
                content.scrollTo(1, true);
                pane.moveTo(150);
                content.dragged(RIGHT_SWIPE);

                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 0);
                    equal(pane.offset(), 0);
                }, 50);
            });

            asyncTest("long drag snaps the content to the next page", 2, function() {
                pane.moveTo(150);
                content.dragged(NUDGE);
                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 1);
                    equal(pane.offset(), 200);
                }, 50);
            });

            asyncTest("drag left side of the boundaries snaps the content to the next page", 2, function() {
                pane.moveTo(-150);
                content.dragged(NUDGE);
                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 0);
                    equal(pane.offset(), 0);
                }, 50);
            });

            asyncTest("drag right side of the boundaries snaps the content to the next page", 2, function() {
                pane.moveTo(300);
                content.dragged(NUDGE);

                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 1);
                    equal(pane.offset(), 200);
                }, 50);
            });
        </script>
    </body>
</html>

