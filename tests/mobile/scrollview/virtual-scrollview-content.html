<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>kendo.ui.MobileScrollView.Tests</title>
        <script src="../../jquery-loader.js"></script>
        <script src="../../qunit/qunit/qunit.js"></script>
        <script src="../../kendo-test-helpers.js"></script>
        <script src="../../../src/kendo.core.js"></script>
        <script src="../../../src/kendo.fx.js"></script>
        <script src="../../../src/kendo.data.js"></script>
        <script src="../../../src/kendo.userevents.js"></script>
        <script src="../../../src/kendo.draganddrop.js"></script>
        <script src="../../../src/kendo.router.js"></script>
        <script src="../../../src/kendo.mobile.scroller.js"></script>
        <script src="../../../src/kendo.mobile.loader.js"></script>
        <script src="../../../src/kendo.mobile.view.js"></script>
        <script src="../../../src/kendo.mobile.pane.js"></script>
        <script src="../../../src/kendo.mobile.application.js"></script>
        <script src="../../../src/kendo.mobile.scrollview.js"></script>
        <link rel="stylesheet" href="../../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.mobile.ui.VirtualScrollViewContent Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <script>
            QUnit.config.reorder = false;

            var ElasticPane = kendo.mobile.ui.ScrollViewElasticPane,
                Page = kendo.mobile.ui.VirtualPage,
                BatchBuffer = kendo.mobile.ui.BatchBuffer,
                Buffer = kendo.data.Buffer,
                VIRTUAL_PAGE_COUNT = 3,
                LEFT_PAGE = -1,
                CETER_PAGE = 0,
                RIGHT_PAGE = 1,
                LEFT_SWIPE = -1,
                NUDGE = 0,
                RIGHT_SWIPE = 1;

            var VirtualScrollViewContent = kendo.Class.extend({
                init: function(element, pane, options) {
                    var that = this;

                    that.element = element;
                    that.pane = pane;
                    that.options = options;
                    that.template = kendo.template(options.template || ""),
                    that.emptyTemplate = kendo.template(options.emptyTemplate || ""),
                    that.page = 0;
                    that.pages = [];
                    that._initPages();
                    that.resizeTo(that.element.width());
                    that._dataSource();
                    that._buffer();

                    if(that.options.autoBind) {
                        that.dataSource.fetch();
                    }
                },

                _dataSource: function() {
                    var options = this.options;

                    this.dataSource = kendo.data.DataSource.create(options.dataSource);
                },

                _buffer: function() {
                    var batchSize = this.options.batchSize;

                    if(batchSize > 1) {
                        this.buffer = new BatchBuffer(this.dataSource, batchSize);
                    } else {
                        this.buffer = new Buffer(this.dataSource, batchSize * 3);
                    }

                    this._resizeProxy = $.proxy(this, "_onResize");
                    this._resetProxy = $.proxy(this, "_onReset");
                    this._endReachedProxy = $.proxy(this, "_onEndReached");

                    this.buffer.bind({
                        "resize": this._resetProxy,
                        "reset": this._resetProxy,
                        "endreached": this._endReachedProxy
                    });
                },

                _initPages: function() {
                    var pages = this.pages,
                        element = this.element,
                        page;

                    for (var i = 0; i < VIRTUAL_PAGE_COUNT; i++) {
                        page = new Page(element);
                        pages.push(page);
                    }
                },

                resizeTo: function(width) {
                    var pages = this.pages,
                        pane = this.pane;

                    for (var i = 0; i < pages.length; i++) {
                        pages[i].setWidth(width);
                    }

                    pane.updateDimension();

                    pages[0].position(LEFT_PAGE);
                    pages[1].position(CETER_PAGE);
                    pages[2].position(RIGHT_PAGE);

                    this.width = width;
                },

                scrollTo: function(page, instant) {
                    var buffer = this.buffer,
                        pages = this.pages,
                        dataItem;

                    buffer.syncDataSource();
                    dataItem = buffer.at(page);

                    if(!dataItem) {
                        return;
                    }

                    for (var i = 0; i < pages.length; i++) {
                        pages[i].position(i-1);
                        this.setPageContent(pages[i], page + (i-1));
                    }

                    this.page = page;
                },

                paneMoved: function(swipeType, bounce, callback) {
                    var that = this,
                        pane = that.pane,
                        width = pane.size(),
                        ease = bounce ? kendo.effects.Transition.easeOutBack : kendo.effects.Transition. easeOutExpo,
                        isEndReached = that.page + 2 > that.buffer.total;

                    if(swipeType === RIGHT_SWIPE) {
                        if(that.page === 0) {
                            that._cancelMove(ease);
                        } else {
                            that._moveBackward();
                        }
                        return;
                    } else if(swipeType === LEFT_SWIPE && !isEndReached) {
                        that._moveForward();
                        return;
                    }

                    if(swipeType === NUDGE) {
                        that._cancelMove(ease);
                    }

                },

                updatePage: function() {
                    var pages = this.pages;

                    if(this.pane.movable.x === 0) {
                        return;
                    }

                    if(this.pane.movable.x < 0) {
                        pages.push(this.pages.shift());//forward
                        this.page++;
                        this.setPageContent(pages[2], this.page + 1);
                    } else {
                        pages.unshift(this.pages.pop()); //back
                        this.page--;
                        this.setPageContent(pages[0], this.page - 1);
                    }

                    pages[0].position(LEFT_PAGE);
                    pages[1].position(CETER_PAGE);
                    pages[2].position(RIGHT_PAGE);

                    this._resetMovable();
                },

                _resetMovable: function() {
                    this.pane.moveTo(0);
                },

                _moveForward: function(instant) {
                    this.pane.transitionTo(-this.width, kendo.effects.Transition.easeOutExpo, instant);
                },

                _moveBackward: function(instant) {
                    this.pane.transitionTo(this.width, kendo.effects.Transition.easeOutExpo, instant);
                },

                _cancelMove: function(ease) {
                    this.pane.transitionTo(0, ease, false);
                },

                _resetPages: function() {
                    var pages = this.pages;

                    for (var i = 0; i < pages.length; i++) {
                        this.setPageContent(pages[i], i-1);
                    }

                    pages[0].position(LEFT_PAGE);
                    pages[1].position(CETER_PAGE);
                    pages[2].position(RIGHT_PAGE);

                    this.page = 0;
                },

                _onResize: function() {
                    
                },

                _onReset: function() {
                    
                },

                _onEndReached: function() {
                    
                },

                setPageContent: function(page, index) {
                    var buffer = this.buffer,
                        template = this.template,
                        emptyTemplate = this.emptyTemplate,
                        view;

                    if(index >= 0) {
                        view = buffer.at(index);
                    }

                    if(view) {
                        page.content(template(view));
                    } else {
                        page.content(emptyTemplate({}));
                    }

                    kendo.mobile.init(page.element);
                }
            });

            var content,
                element,
                pane;

            module("VirtualScrollView content", { 
                setup: function() {

                    var dataSourceConfig = {
                        transport: {
                            read: function(options) {

                                var results = [], data = options.data;
                                for (var i = data.skip; i < data.skip + data.take; i ++) {
                                    results.push({ foo: i });
                                }

                                options.success(results);
                            }
                        },
                        pageSize: 36,
                        serverPaging: true,
                        schema: {
                            total: function() { return 100000; }
                        }
                    };

                    var options = {
                        dataSource: dataSourceConfig,
                        autoBind: true,
                        template: "<div class='foo'>#: foo #</div>",
                        emptyTemplate: "<div>empty</div>"
                    };

                    element = $("<div style='width: 400px;' />").appendTo("#qunit-fixture").wrap("<div style='width: 400px;' />");
                    content = new VirtualScrollViewContent(element, new ElasticPane(element), options);
                }
            });

            test("initializes pages correctly", 2, function() {
                equal(content.pages.length, 3);
                equal(content.element.find("div.virtual-page").length, 3);
            });

            test("positions pages correctly after refresh", 3, function() {
                var pages = content.pages;

                equal(pages[0].element.get(0).style["-webkit-transform"], "translate3d(-400px, 0, 0)");
                equal(pages[1].element.get(0).style["-webkit-transform"], "translate3d(0px, 0, 0)");
                equal(pages[2].element.get(0).style["-webkit-transform"], "translate3d(400px, 0, 0)");
            });

            test("re-calculates the pages width on pane resize", 2, function() {
                element = $("<div style='width: 500px;' />").appendTo("#qunit-fixture").wrap("<div style='width: 200px;' />");
                pane = new ElasticPane(element);
                content = new VirtualScrollViewContent(element, pane, {});

                equal(content.pages[0].element.width(), 500);

                content.resizeTo(300);
                equal(content.pages[0].element.width(), 300);
            });

            test("creates buffer correctly", 2, function() {
                var content = new VirtualScrollViewContent(element, new ElasticPane(element), {});
                ok(content.buffer instanceof kendo.data.Buffer);

                content = new VirtualScrollViewContent(element, new ElasticPane(element), { batchSize: 6 });
                ok(content.buffer instanceof BatchBuffer);
            });

            test("sets the content correctly", 5, function() {
                var page = content.pages[0];
                equal(page.element.find(">div").length, 0);

                content.setPageContent(page, 0);
                equal(page.element.children().length, 1);
                equal(page.element.find(">div").text(), "0");

                content.setPageContent(page, 3);
                equal(page.element.children().length, 1);
                equal(page.element.find(">div").text(), "3");
            });

            test("sets the empty content correctly when data is not available in the buffer", 1, function() {
                var page = content.pages[0];

                content.setPageContent(page, -1); //test for non existing content
                equal(page.element.find(">div").text(), "empty");
            })

            test("scrolls to the provided page", 12, function() {
                content.scrollTo(6);

                equal(content.page, 6);
                equal(content.pages[0].element.text(), "5");
                equal(content.pages[1].element.text(), "6");
                equal(content.pages[2].element.text(), "7");

                content.scrollTo(10);

                equal(content.page, 10);
                equal(content.pages[0].element.text(), "9");
                equal(content.pages[1].element.text(), "10");
                equal(content.pages[2].element.text(), "11");

                content.scrollTo(0);

                equal(content.page, 0);
                equal(content.pages[0].element.text(), "empty");
                equal(content.pages[1].element.text(), "0");
                equal(content.pages[2].element.text(), "1");
            });

            test("pages are reset correctly", 5, function() {
                content.scrollTo(5);
                equal(content.pages[1].element.text(), "5");

                content._resetPages();
                equal(content.pages[0].element.text(), "empty");
                equal(content.pages[1].element.text(), "0");
                equal(content.pages[2].element.text(), "1");
                equal(content.page, 0);
            })

            var content,
                pane;

            module("VirtualScrollView Content dragging", {
                setup: function() {
                    var element = $("<div style='width: 400px;' />").appendTo("#qunit-fixture").wrap("<div style='width: 400px;' />");

                    var dataSourceConfig = {
                        transport: {
                            read: function(options) {

                                var results = [], data = options.data;
                                for (var i = data.skip; i < data.skip + data.take; i ++) {
                                    results.push({ foo: i });
                                }

                                options.success(results);
                            }
                        },
                        pageSize: 36,
                        serverPaging: true,
                        schema: {
                            total: function() { return 100000; }
                        }
                    };

                    var options = {
                        dataSource: dataSourceConfig,
                        autoBind: true,
                        template: "<div class='foo'>#: foo #</div>",
                        emptyTemplate: "<div>empty</div>"
                    };

                    pane = new ElasticPane(element);
                    content = new VirtualScrollViewContent(element, pane, options);
                    content.resizeTo(400);
                }
            });

           asyncTest("small drag snaps the content back to the current page", 2, function() {
                pane.moveTo(50);
                content.paneMoved(NUDGE);
                setTimeout(function() {
                    start();
                    equal(content.page, 0);
                    equal(pane.offset(), 0);
                }, 50);
            });

            asyncTest("swift swipe to right snaps the content back to the current page when ScrollView is at the first page", 2, function() {
                pane.moveTo(50);
                content.paneMoved(RIGHT_SWIPE);
                setTimeout(function() {
                    start();
                    equal(content.page, 0);
                    equal(pane.offset(), 0);
                }, 50);
            });

            asyncTest("swift swipe to right snaps the content back to the previous page when ScrollView is not at the first page", 2, function() {
                content.scrollTo(7);
                pane.moveTo(50);
                content.paneMoved(RIGHT_SWIPE);
                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 6);
                    equal(pane.offset(), 0);
                }, 50);
            });

            asyncTest("swift swipe to left snaps the content to the next page if buffer end is NOT reached", 2, function() {
                pane.moveTo(-50);
                content.paneMoved(LEFT_SWIPE);
                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 1);
                    equal(pane.offset(), 0);
                }, 50);
            });

            asyncTest("swift swipe to left snaps the content back to the current page if buffer end is reached", 2, function() {
                pane.moveTo(-50);
                content.paneMoved(LEFT_SWIPE);
                setTimeout(function() {
                    start();
                    content.updatePage();
                    equal(content.page, 1);
                    equal(pane.offset(), 0);
                }, 50);
            });

        </script>
    </body>
</html>
