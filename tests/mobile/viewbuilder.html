<!DOCTYPE dom>
<html>
    <head>
        <title>kendo.mobile.ViewBuilder Tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <script src="../../src/kendo.fx.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.history.js"></script>
        <script src="../../src/kendo.mobile.scroller.js"></script>
        <script src="../../src/kendo.mobile.view.js"></script>
        <script src="../../src/kendo.mobile.splitview.js"></script>
        <script src="../../src/kendo.mobile.pane.js"></script>
        <script src="../../src/kendo.mobile.loader.js"></script>
        <script src="../../src/kendo.mobile.application.js"></script>
        <script src="../jquery.mockjax.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.mobile.ViewBuilder Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <script>
            var viewBuilder,
                root = $("#qunit-fixture");

            function hidden(selector) {
                ok(!root.find(selector).is(":visible"));
            }

            function visible(selector) {
                ok(root.find(selector).is(":visible"));
            }

            function view(selector) {
                ok(root.find(selector).data("kendoView"));
            }

            ////////////////////////////////////////////////////////////////////
            module("view builder view showing", {
                setup: function() {
                    root.html('<div data-role="view" id="foo">Foo</div><div data-role="view" id="bar">Bar</div>').show();
                    viewBuilder = new kendo.mobile.ViewBuilder({
                        container: root
                    });
                },
                teardown: function() {
                    $.mockjaxClear();
                }
            });

            test("hides child views", 2, function() {
                hidden("#foo");
                hidden("#bar");
            });

            asyncTest("Shows remote view", 2, function() {
                $.mockjax({
                    url: "page2.html",
                    responseText: '<body><div data-role="view" id="page2">Page 2</div></body>'
                });

                viewBuilder.bind("viewShow", function(e) {
                    start();
                    equal(root.has("#page2").length, 1, "Remote view is inserted in the application DOM element");
                    equal(e.view.element[0], root.find("#page2")[0]);
                });

                viewBuilder.showView("page2.html");
            });

            asyncTest("Reuses remote view once loaded", 1, function() {
                $.mockjax({
                    url: "page2.html",
                    responseText: '<body><div data-role="view" id="page2">Page 2</div></body>'
                });

                var view,
                    callback3 = function(e) {
                        start();
                        equal(view, e.view);
                    },
                    callback2 = function(e) {
                        viewBuilder.one("viewShow", callback3);
                        viewBuilder.showView("page2.html");
                    },
                    callback1 = function(e) {
                        view = e.view;
                        viewBuilder.one("viewShow", callback2);
                        viewBuilder.showView("#foo");
                    };

                viewBuilder.one("viewShow", callback1);
                viewBuilder.showView("page2.html");
            });

            asyncTest("Loads multiple remote views", 2, function() {
                $.mockjax({
                    url: "page2.html",
                    responseText: '<body><div data-role="view" id="page2">Page 2</div></body><div data-role="view" id="page3">Page 3</div></body>'
                });

                viewBuilder.bind("viewShow", function(e) {
                    start();
                    equal(root.has("#page3").length, 1, "Secondary remote view is inserted in the application DOM element");
                    equal(e.view.element[0], root.find("#page2")[0]);
                });

                viewBuilder.showView("page2.html");
            });

            asyncTest("Deals with various newline characters when loading remote view", 2, function() {
                $.mockjax({
                    url: "page2.html",
                    responseText: '<html><head></head><body><div id="page2" data-role="view">View\n\u000a\u000a\u000d\u2028\u2029</div></body>\r\n</html>'
                });

                viewBuilder.bind("viewShow", function(e) {
                    start();
                    equal(root.has("#page2").length, 1, "Remote view is inserted in the application DOM element");
                    equal(e.view.element[0], root.find("#page2")[0]);
                });

                viewBuilder.showView("page2.html");
            });

            asyncTest("remote asset loading injects scripts, styles and layouts", 3, function() {

                $.mockjax({
                    url: "page2.html",
                    responseText: '<body><div data-role="view" id="page2">Page 2</div></body><style ' +
                        'id="remoteStyle"></style><script id="remoteScript">window.scriptInjected = true;</scr' +
                        'ipt><div data-role="layout" data-id="remoteLayout" /></body>'
                });

                viewBuilder.bind("viewShow", function(e) {
                    start();
                    equal(root.find("#remoteStyle").length, 1, "Style is injected");
                    ok(viewBuilder.layouts["remoteLayout"], "Layout is injected");
                    ok(window.scriptInjected,  "Script is injected");
                });

                viewBuilder.showView("page2.html");
            });

            test("shows default view if no url passed", 2, function() {
                viewBuilder.bind("viewShow", function() {
                    visible("#foo");
                    hidden("#bar");
                });

                viewBuilder.showView("");
            });

            test("shows given view", 2, function() {
                viewBuilder.bind("viewShow", function() {
                    visible("#foo");
                    hidden("#bar");
                });

                viewBuilder.showView("#foo");
            });

            test("parses url params and provides them to the view", 1, function() {
                viewBuilder.bind("viewShow", function(e) {
                    equal(e.view.params["foo"], "bar");
                });

                viewBuilder.showView("#foo?foo=bar");
            });

            asyncTest("hides given view", 4, function() {
                viewBuilder.bind("viewShow", function() {
                    visible("#foo");
                    hidden("#bar");
                    viewBuilder.unbind("viewShow");

                    viewBuilder.bind("viewShow", function() {
                        start();
                        visible("#bar");
                        hidden("#foo");
                    });

                    viewBuilder.showView("#bar");
                });

                viewBuilder.showView("#foo");
            });

            ////////////////////////////////////////////////////////////////////
            module("view builder layout management", {
                setup: function() {
                    root.html('<div data-role="view" data-layout="bar" id="foo">Foo</div>' +
                    '<div data-role="layout" data-id="bar"><div data-role="header" id="layoutHeader">Foo</div>' +
                    '<div data-role="footer" id="layoutFooter">Foo</div></div>').show();

                    viewBuilder = new kendo.mobile.ViewBuilder({ container: root });
                },

                teardown: function() {
                    $.mockjaxClear();
                }
            });

            test("applies layout to view", 1, function() {
                viewBuilder.bind("viewShow", function(e) {
                    equal(e.view.layout, viewBuilder.layouts["bar"]);
                });

                viewBuilder.showView("");
            });

            ////////////////////////////////////////////////////////////////////
            module("view builder default layout", {
                setup: function() {
                    root.html('<div data-role="view" id="foo">Foo</div>' +
                    '<div data-role="layout" data-id="bar"><div data-role="header" id="layoutHeader">Foo</div>' +
                    '<div data-role="footer" id="layoutFooter">Foo</div></div>').show();

                    viewBuilder = new kendo.mobile.ViewBuilder({ container: root, layout: "bar" });
                },

                teardown: function() {
                    $.mockjaxClear();
                }
            });

            test("applies layout to view", 1, function() {
                viewBuilder.bind("viewShow", function(e) {
                    equal(e.view.layout, viewBuilder.layouts["bar"]);
                });

                viewBuilder.showView("");
            });

            test("Uses platform specific layouts", 1, function() {
                kendo.mobile.application = {os: "ios"};

                root.html('<div data-role="view" id="page1">Page 1</div> \
                <div data-role="layout" data-platform="ios" data-id="foo"><div data-role="footer">footer</div></div> \
                <div data-role="layout" data-platform="android" data-id="foo"><div data-role="footer">footer</div></div> \
                ').show();

                viewBuilder = new kendo.mobile.ViewBuilder({ container: root });

                equal(viewBuilder.layouts["foo"].element.data("platform"), "ios");
            });
        </script>
    </body>
</html>
