<!DOCTYPE html>
<html>
    <head>
        <title>kendo.bind tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.bind Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
        <script>
            QUnit.config.testTimeout = 100;

            test("text binding", function() {
                var dom = $('<span data-bind="text:foo"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.text(), "foo");
            });

            test("html binding", function() {
                var dom = $('<span data-bind="html:foo"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.html(), "foo");
            });

            test("value binding", function() {
                var dom = $('<input data-bind="value:foo"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.val(), "foo");
            });

            test("title binding", function() {
                var dom = $('<span data-bind="attr: {title:foo}"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.attr("title"), "foo");
            });

            test("alt binding", function() {
                var dom = $('<img data-bind="attr:{alt:foo}"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.attr("alt"), "foo");
            });

            test("src binding", function() {
                var dom = $('<img data-bind="attr: { src:foo }"/>');

                kendo.bind(dom, { foo: "http://www.example.com" });
                equal(dom.attr("src"), "http://www.example.com");
            });

            test("href binding", function() {
                var dom = $('<a data-bind="attr: { href:foo}"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.attr("href"), "foo");
            });

            test("binding immediate children", function() {
                var dom = $('<span><img data-bind="attr: {alt:foo}"/></span>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.find("img").attr("alt"), "foo");
            });

            test("binding arbitrary children", function() {
                var dom = $('<span><span><img data-bind=" attr : { alt : foo } "/></span></span>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.find("img").attr("alt"), "foo");
            });

            test("binding multiple attributes", function() {
                var dom = $('<a data-bind="attr: { href:foo, title: foo }"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.attr("href"), "foo");
                equal(dom.attr("title"), "foo");
            });

            test("binding custom attributes", function() {
                var dom = $('<a data-bind="attr: { custom: foo }"/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.attr("custom"), "foo");
            });

            test("binding multiple attr declarations", function() {
                var dom = $('<a data-bind="attr: { href: foo }, attr: { title: foo } "/>');

                kendo.bind(dom, { foo: "foo" });
                equal(dom.attr("href"), "foo");
                equal(dom.attr("title"), "foo");
            });

            asyncTest("click binding", function() {
                expect(1);

                var dom = $('<span data-bind="click:foo"/>');

                kendo.bind(dom, {
                    foo: function() {
                        start();
                        ok(true, "click is raised");
                    }
                });

                dom.trigger("click");
            });

            asyncTest("change binding", function() {
                expect(1);

                var dom = $('<input data-bind="event: { change:foo }"/>');

                kendo.bind(dom, {
                    foo: function() {
                        start();
                        ok(true, "change is raised");
                    }
                });

                dom.trigger("change");
            });

            asyncTest("the context of the event handler is the viewmodel", function() {
                expect(1);

                var dom = $('<span data-bind="click:foo"/>');
                var viewModel = kendo.observable( {
                    foo: function() {
                        start();
                        strictEqual(this, viewModel);
                    }
                });

                kendo.bind(dom, viewModel);

                dom.trigger("click");
            });

            test("select binding", function() {
                var dom = $('<select data-bind="source:foo"/>');

                kendo.bind(dom, {
                    foo: [1, 2]
                });

                equal(dom.find("option").length, 2);
                equal(dom.find("option").first().text(), "1");
                equal(dom.find("option").last().text(), "2");
            });

            test("select binding with template", function() {
                var dom = $('<select data-template="select-template" data-bind="source:foo"/>');

                kendo.bind(dom, {
                    foo: [ {
                        id: 1,
                        name: "foo"
                    }]
                });

                equal(dom.find("option").text(), "foo");
                equal(dom.find("option").val(), "1");
            });

            test("pushing items to array creates new option elements without destroying the existing ones", function() {
                var dom = $('<select data-bind="source:foo"/>');

                var viewModel = kendo.observable( {
                    foo: [1, 2]
                });

                kendo.bind(dom, viewModel);

                var option = dom.find("option")[0];

                viewModel.foo.push(3, 4);

                equal(dom.find("option").length, viewModel.foo.length);
                equal(dom.find("option").eq(2).text(), "3");
                equal(dom.find("option").eq(3).text(), "4");
                equal(dom.find("option")[0], option);
            });

            test("pushing items to array initializes child bindings", function() {
                var dom = $('<ul data-bind="source:foo" data-template="ul-template"/>');

                var viewModel = kendo.observable( {
                    foo: [1, 2]
                });

                kendo.bind(dom, viewModel);

                viewModel.foo.push(3, 4);

                equal(dom.find("li:last").text(), "4");
            });

            test("splicing items from array removes option elements without destroying the existing ones", function() {
                var dom = $('<select data-bind="source:foo"/>');

                var viewModel = kendo.observable( {
                    foo: [1, 2, 3, 4]
                });

                kendo.bind(dom, viewModel);

                var firstOption = dom.find("option")[0];
                var lastOption = dom.find("option")[3];

                viewModel.foo.splice(1, 2);

                equal(dom.find("option").length, viewModel.foo.length);
                equal(dom.find("option")[0], firstOption);
                equal(dom.find("option")[1], lastOption);
            });

            test("bind array to table appends table rows to the table body", function() {
                var dom = $('<table data-bind="source:foo"><thead><tr><th></th></tr></thead></table>');

                var viewModel = kendo.observable( {
                    foo: [1, 2]
                });

                kendo.bind(dom, viewModel);
                equal(dom.find("tbody > tr").length, viewModel.foo.length);
            });

            test("bind array to table keeps thead", function() {
                var dom = $('<table data-bind="source:foo"><thead><tr><th></th></tr></thead></table>');

                var viewModel = kendo.observable( {
                    foo: [1, 2]
                });

                kendo.bind(dom, viewModel);
                equal(dom.find("thead > tr").length, 1);
            });

            test("bind array to unordered list creats list item elements", function() {
                var dom = $('<ul data-bind="source:foo"/>');

                var viewModel = kendo.observable( {
                    foo: [1, 2]
                });

                kendo.bind(dom, viewModel);
                equal(dom.find("li").length, viewModel.foo.length);
            });

            test("bind array to ordered list creats list item elements", function() {
                var dom = $('<ol data-bind="source:foo"/>');

                var viewModel = kendo.observable( {
                    foo: [1, 2]
                });

                kendo.bind(dom, viewModel);
                equal(dom.find("li").length, viewModel.foo.length);
            });

            test("binding child elements of template to data item", function() {
                var dom = $('<div><ol data-template="ol-template" data-bind="source:foo"/></div>');

                var viewModel = kendo.observable( {
                    foo: [{ name: "foo"}]
                });

                kendo.bind(dom, viewModel);
                equal(dom.find("li").text(), viewModel.foo[0].name);
            });

            test("binding child elements of template to data item of primitive type", function() {
                var dom = $('<ul data-template="ul-template" data-bind="source:foo"/>');

                var viewModel = kendo.observable( {
                    foo: [1]
                });

                kendo.bind(dom, viewModel);
                equal(dom.find("li").text(), viewModel.foo[0]);
            });

            test("template binding without source", function() {
                var dom = $('<div data-template="div-template" data-bind="source:this"/>');

                kendo.bind(dom, { foo: "foo" });

                equal($.trim(dom.text()), "Hello, foofoo");
            });

            test("binding to nested field", function() {
                var dom = $('<div data-bind="text:foo.bar"/>');

                kendo.bind(dom, { foo: { bar: "baz" } });

                equal(dom.text(), "baz");
            });

            test("binding to array item", function() {
                var dom = $('<div data-bind="text:foo[0]"/>');

                kendo.bind(dom, { foo: ["baz"] });

                equal(dom.text(), "baz");
            });

            test("binding the style attribute", function() {
                var dom = $('<div data-bind="style: { display:foo, textDecoration: bar }" />');

                kendo.bind(dom, { foo: "none", bar: "underline" });

                equal(dom.css("display"), "none");
                equal(dom.css("text-decoration"), "underline");
            });

            test("binding select value to object", function() {
                var dom = $('<select data-value-field="name" data-bind="source:items, value:selectedItem"/>');

                var viewModel = kendo.observable({
                    items: [  { name: "foo" }, { name: "bar" } ],
                    selectedItem: {}
                });

                viewModel.set("selectedItem", viewModel.items[1]);

                kendo.bind(dom, viewModel);
                ok(dom.find("option").last().is(":selected"));
            });

            test("binding select value to primitive value", function() {
                var dom = $('<select data-bind="source:items, value:selectedItem"/>');

                var viewModel = kendo.observable({
                    items: ["foo", "bar"],
                    selectedItem: "bar"
                });

                kendo.bind(dom, viewModel);
                ok(dom.find("option").last().is(":selected"));
            });
            test("binding multi select value to multiple objects", function() {
                var dom = $('<select multiple="multiple" data-value-field="name" data-bind="source:items, value:selectedItem"/>');

                var viewModel = kendo.observable({
                    items: [  { name: "foo" }, { name: "bar" }, { name: "baz" } ],
                    selectedItem: []
                });

                viewModel.selectedItem.push(viewModel.items[1]);
                viewModel.selectedItem.push(viewModel.items[2]);

                kendo.bind(dom, viewModel);
                ok(dom.find("option").eq(1).is(":selected"));
                ok(dom.find("option").eq(2).is(":selected"));
            });

            test("checked binding binds radiobutton by value", function() {
                var dom = $('<input type="radio" value="foo" data-bind="checked:selectedItem"/>');

                var viewModel = kendo.observable({
                    selectedItem: ""
                });

                viewModel.set("selectedItem", "foo");

                kendo.bind(dom, viewModel);
                ok(dom.is(":checked"));
            });

            test("checked binding binds checkbox to boolean", function() {
                var dom = $('<input type="checkbox" data-bind="checked:selectedItem"/>');

                var viewModel = kendo.observable({
                    selectedItem: false
                });

                viewModel.set("selectedItem", true);

                kendo.bind(dom, viewModel);
                ok(dom.is(":checked"));
            });

            test("checked binding binds checkbox by value to array", function() {
                var dom = $('<input type="checkbox" value="foo" data-bind="checked:selectedItems"/>');

                var viewModel = kendo.observable({
                    selectedItems: []
                });

                viewModel.selectedItems.push("foo");

                kendo.bind(dom, viewModel);
                ok(dom.is(":checked"));
            });

            test("checked binding checkbox is not checked if value does not exists", function() {
                var dom = $('<input type="checkbox" value="foo" data-bind="checked:selectedItems"/>');

                var viewModel = kendo.observable({
                    selectedItems: []
                });

                kendo.bind(dom, viewModel);
                ok(!dom.is(":checked"));
            });

            test("visible binding shows the element", function() {
                var dom = $('<span data-bind="visible:show" style="display:none"/>');

                var viewModel = kendo.observable({
                    show: true
                });

                kendo.bind(dom, viewModel);
                ok(dom.css("display") != "none", "Display is not 'none'");
            });

            test("visible binding hides the element", function() {
                var dom = $('<span data-bind="visible:show"/>');

                var viewModel = kendo.observable({
                    show: true
                });

                kendo.bind(dom, viewModel);

                viewModel.set("show", false);

                equal(dom.css("display"), "none");
            });

            test("enable binding enables the element", function() {
                var dom = $('<input data-bind="enabled:enable" disabled="disabled"/>');

                var viewModel = kendo.observable({
                    enable: true
                });

                kendo.bind(dom, viewModel);
                ok(!dom.is(":disabled"));
            });

            test("enable binding disables the element if value is false", function() {
                var dom = $('<input data-bind="enabled:enable"/>');

                var viewModel = kendo.observable({
                    enable: false
                });

                kendo.bind(dom, viewModel);
                ok(dom.is(":disabled"));
            });

            test("enable binding disables the element if value is changed to false", function() {
                var dom = $('<input data-bind="enabled:enable"/>');

                var viewModel = kendo.observable({
                    enable: true
                });

                kendo.bind(dom, viewModel);
                viewModel.set("enable", false);
                ok(dom.is(":disabled"));
            });

            test("enable binding enables the select element", function() {
                var dom = $('<select data-bind="enabled:enable" disabled="disabled"/>');

                var viewModel = kendo.observable({
                    enable: true
                });

                kendo.bind(dom, viewModel);
                ok(!dom.is(":disabled"));
            });

            test("disable binding disables the element", function() {
                var dom = $('<input data-bind="disabled:disabled"/>');

                var viewModel = kendo.observable({
                    disabled: true
                });

                kendo.bind(dom, viewModel);
                ok(dom.is(":disabled"));
            });

            test("disable binding enables the element if value is false", function() {
                var dom = $('<input data-bind="disabled:disabled" disabled="disabled"/>');

                var viewModel = kendo.observable({
                    disabled: false
                });

                kendo.bind(dom, viewModel);
                ok(!dom.is(":disabled"));
            });

            test("disable binding disables the element if value is changed to true", function() {
                var dom = $('<input data-bind="disabled:disabled"/>');

                var viewModel = kendo.observable({
                    disabled: false
                });

                kendo.bind(dom, viewModel);
                viewModel.set("disabled", true);
                ok(dom.is(":disabled"));
            });

            test("disable binding disables the select element", function() {
                var dom = $('<select data-bind="disabled:disabled"/>');

                var viewModel = kendo.observable({
                    disabled: true
                });

                kendo.bind(dom, viewModel);
                ok(dom.is(":disabled"));
            });


            test("binding to getter", function() {
                var dom = $('<div data-template="get-template" data-bind="source:this"/>');

                var viewModel = {
                    foo: "foo"
                };

                kendo.bind(dom, viewModel);
                equal($.trim(dom.text()), "foo")
            });

            test("binding to function", function() {
                var dom = $('<div data-bind="text:foo"/>');

                var viewModel = {
                    bar: "bar",
                    foo: function() {
                        return this.get("bar");
                    }
                };

                kendo.bind(dom, viewModel);
                equal($.trim(dom.text()), "bar")
            });

            test("binding target is assign to the element", function() {
                var dom = $('<div data-bind="text:foo"/>');

                var viewModel = {
                    bar: "bar"
                };

                kendo.bind(dom, viewModel);
                ok(dom.data("kendoBindingTarget"));
            });

            test("binding are removed if element is rebind", 1, function() {
                var dom = $('<div data-bind="text:foo"/>');

                var viewModel = kendo.observable({
                    foo: "bar"
                });

                kendo.bind(dom, viewModel);

                var destroy = stub(dom.data("kendoBindingTarget"), "destroy");

                kendo.bind(dom, viewModel);

                equal(destroy.calls("destroy"), 1);
            });

        </script>

        <script id="select-template" type="text/x-kendo-template">
            <option value="${id}">${name}</option>
        </script>

        <script id="get-template" type="text/x-kendo-template">
            #= get("foo") #
        </script>

        <script id="ol-template" type="text/x-kendo-template">
            <li data-bind="text:name"></li>
        </script>
        <script id="ul-template" type="text/x-kendo-template">
            <li data-bind="text:this"></li>
        </script>
        <script id="div-template" type="text/x-kendo-template">
            Hello, ${foo}<span data-bind="text:foo"></span>
        </script>
    </body>
</html>
