<!DOCTYPE html>
<html>
    <head>
        <title>kendo.bind change tracking tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.bind change tracking tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
        <script>

            module("mvvm observing", {
                setup: function() {
                },
                teardown: function() {
                }
            });

            test("changing a view model field reflects UI", function() {
                var viewModel = kendo.observable( {
                    foo: "foo"
                });

                var dom = $('<span data-bind="text:foo"/>');
                kendo.bind(dom, viewModel);
                viewModel.set("foo", "bar");
                equal(dom.text(), "bar");
            });

            test("changing a view model field from a view model function bound to UI reflects UI", function() {
                var viewModel = kendo.observable( {
                    foo: "foo",
                    bar: function() {
                        this.set("foo", "baz");
                    }
                });

                var dom = $('<div><span data-bind="text:foo"/><button data-bind="click:bar"></button></div>');

                kendo.bind(dom, viewModel);

                equal(dom.find("span").text(), "foo");

                dom.find("button").trigger("click");

                equal(dom.find("span").text(), "baz");
            });

            test("removing item from view model array reflects UI", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "boo" // needed to test closure value assignment
                });

                var dom = $('<select data-bind="source:foo"/>');

                kendo.bind(dom, viewModel);

                viewModel.foo.splice(1, 1);

                equal(dom.find("option").length, 2);
                equal(dom.find("option").first().text(), "foo");
                equal(dom.find("option").last().text(), "baz");
            });

            test("removing item from array removes table rows", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "boo" // needed to test closure value assignment
                });

                var dom = $('<table data-bind="source:foo"/>');

                kendo.bind(dom, viewModel);

                viewModel.foo.splice(1, 1);

                equal(dom.find("tr").length, 2);
                equal(dom.find("tr").first().text(), "foo");
                equal(dom.find("tr").last().text(), "baz");
            });

            test("change event notifies value listeners", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "bar"
                });

                var dom = $('<div><select data-bind="source:foo,value:bar"/><span data-bind="text:bar"/></div>');

                kendo.bind(dom, viewModel);

                dom.find("option:first").attr("selected", "selected");
                dom.find("select").trigger("change");
                equal(dom.find("span").text(), "foo");
            });

            test("select of multi select updates the viewModel", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    selectedItems: []
                });

                var dom = $('<select data-bind="source:foo,value:selectedItems" multiple="multiple"/>');

                kendo.bind(dom, viewModel);

                dom.find("option:first").attr("selected", "selected");
                dom.find("option:last").attr("selected", "selected");
                dom.trigger("change");

                equal(viewModel.selectedItems[0], "foo");
                equal(viewModel.selectedItems[1], "baz");
            });

            test("tracking changes of the parent object", function() {
                var dom = $('<div data-bind="text: current.name"/>');

                var viewModel = kendo.observable({
                    current: null,
                    items: [ { name: "foo" }, { name: "bar" }]
                });

                viewModel.current = viewModel.items[0];

                kendo.bind(dom, viewModel);

                viewModel.set("current", viewModel.items[1]);

                equal(dom.text(), "bar");
            });

            test("tracking changes of array item members", function() {
                var dom = $('<div data-bind="text: items[0].name"/>');

                var viewModel = kendo.observable({
                    items: [ { name: "foo" } ]
                });


                kendo.bind(dom, viewModel);

                viewModel.items[0].set("name", "bar");

                equal(dom.text(), "bar");
            });

            test("tracking changes the array item", function() {
                var dom = $('<div data-bind="text: items[0].name"/>');

                var viewModel = kendo.observable({
                    items: [ { name: "foo" } ]
                });

                kendo.bind(dom, viewModel);

                viewModel.items.splice(0, 0, { name: "bar" });

                equal(dom.text(), "bar");
            });

            test("select of multi select bound to complex objects", function() {
                var viewModel = kendo.observable( {
                    foo: [{name:"foo"}, {name:"bar"}],
                    selectedItems: []
                });

                var dom = $('<select data-value-field="name" data-bind="source:foo,value:selectedItems" multiple="multiple"/>');

                kendo.bind(dom, viewModel);

                dom.find("option:first").attr("selected", "selected");
                dom.find("option:last").attr("selected", "selected");
                dom.trigger("change");

                equal(viewModel.selectedItems[0], viewModel.foo[0]);
                equal(viewModel.selectedItems[1], viewModel.foo[1]);
            });

            test("select tracks complex value", function() {
                var viewModel = kendo.observable( {
                    foo: [ { text: "foo" }, { text: "bar" } ],
                    selectedItem: null
                });

                viewModel.selectedItem = viewModel.foo[0];

                var dom = $('<select data-value-field="text" data-bind="source:foo,value:selectedItem"/>');

                kendo.bind(dom, viewModel);

                dom.find("option:last").attr("selected", "selected");

                dom.trigger("change");

                strictEqual(viewModel.selectedItem, viewModel.foo[1]);
            });

            test("select bound to complex object updates simple value", function() {
                var viewModel = kendo.observable( {
                    foo: [ { text: "foo" }, { text: "bar" } ],
                    selectedItem: "foo"
                });

                var dom = $('<select data-value-field="text" data-bind="source:foo,value:selectedItem"/>');

                kendo.bind(dom, viewModel);

                dom.find("option:last").attr("selected", "selected");

                dom.trigger("change");

                strictEqual(viewModel.selectedItem, "bar");
            });

            test("multi select has same item count after change", function() {
                var viewModel = kendo.observable( {
                    items: ["foo", "bar", "baz"],
                    selectedItems: []
                });

                var dom = $('<select data-bind="source:items,value:selectedItems" multiple="multiple" />');

                kendo.bind(dom, viewModel);

                dom.find("option:first").attr("selected", "selected");
                dom.trigger("change");
                dom.find("option:last").attr("selected", "selected");
                dom.trigger("change");

                equal(dom.find("option").length, 3);
            });

            test("changing the value updates the view model", function() {
                var dom = $('<input data-bind="value:foo" />');

                var viewmodel = kendo.observable( { foo: "foo" });

                kendo.bind(dom, viewmodel);

                dom.val("bar");
                dom.trigger("change");

                equal(viewmodel.foo, "bar");
            });

            test("changing radiobutton value updates the view model", function() {
                var dom = $('<input type="radio" value="bar"  data-bind="checked:foo"/>');

                var viewmodel = kendo.observable( { foo: "" });

                kendo.bind(dom, viewmodel);

                dom.attr("checked", true);
                dom.trigger("change");

                equal(viewmodel.foo, "bar");
            });

            test("changing checkbox value updates the view model", function() {
                var dom = $('<input type="checkbox" data-bind="checked:foo"/>');

                var viewmodel = kendo.observable( { foo: false });

                kendo.bind(dom, viewmodel);

                dom.attr("checked", true);
                dom.trigger("change");

                equal(viewmodel.foo, true);
            });

            test("checking checkbox adds the value to the view model", function() {
                var dom = $('<input type="checkbox" value="bar" data-bind="checked:foo"/>');

                var viewmodel = kendo.observable( { foo: [] });

                kendo.bind(dom, viewmodel);

                dom.attr("checked", true);
                dom.trigger("change");

                equal(viewmodel.foo[0], "bar");
            });

            test("unchecking checkbox removes the value from the view model", function() {
                var dom = $('<input type="checkbox" value="bar" data-bind="checked:foo"/>');

                var viewmodel = kendo.observable( { foo: ["bar"] });

                kendo.bind(dom, viewmodel);

                dom.attr("checked", false);
                dom.trigger("change");

                ok(!viewmodel.foo.length);
            });

            test("value binding calls set once during select change", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "bar"
                });

                var calls = 0;

                var dom = $('<select data-bind="source:foo,value:bar"/>');

                kendo.bind(dom, viewModel);

                viewModel.set("bar", "foo");

                viewModel.set = function() {
                    calls++;
                    kendo.data.ObservableObject.fn.set.apply(this, arguments);
                };

                dom.find("select").val("bar");
                dom.trigger("change");

                equal(calls, 1);
            });

            test("tracking changes of observable items in array", function() {
                var viewModel = kendo.observable( {
                    foo: [{ name: "foo" }]
                });

                var dom = $('<ul data-template="array-template" data-bind="source:foo"/>');

                kendo.bind(dom, viewModel);

                viewModel.foo[0].set("name", "bar");

                equal(dom.find("li").text(), "bar");
            });

            test("tracking changes of fields bound to style", function() {
                var viewModel = kendo.observable( {
                    foo: "1px",
                    bar: "10px"
                });

                var dom = $('<span data-bind="style: { left: foo, top: bar }"/>');

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "2px");
                viewModel.set("bar", "20px");

                equal(dom.css("left"), "2px");
                equal(dom.css("top"), "20px")
            });

            test("tracking changes of complex fields", function() {
                var dom = $('<div data-bind="attr: { title:bar }, text:foo.bar"/>');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    },
                    bar: "boo"
                });

                kendo.bind(dom, viewModel);

                viewModel.foo.set("bar", "baz");

                equal(dom.text(), "baz");
                //check that parent field is not changed
                equal(dom.attr("title"), "boo");
            });

            test("tracking changes in templates", function() {
                var dom = $('<div data-template="simple-field-template" data-bind="source: this" />');

                var viewModel = kendo.observable({ foo: "foo" });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "bar");

                equal($.trim(dom.text()), "bar");
            });

            test("change event is fired once", 1, function() {
                var dom = $('<div data-template="simple-field-template" data-bind="source: this" />');

                var viewModel = kendo.observable({ foo: "foo" });

                kendo.bind(dom, viewModel);

                viewModel.bind("change", function() {
                    ok(true);
                });

                viewModel.set("foo", "bar");
            });

            test("dependencies are reavaluated", function() {
                var dom = $('<div data-template="if-else-template" data-bind="source: this" />');

                var viewModel = kendo.observable({ foo: "foo", bar: "bar" });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "baz");

                viewModel.set("bar", "boo");

                equal($.trim(dom.text()), "boo");
            });

            test("does not attach more than one change handler when monitoring for dependency changes", function() {
                var dom = $('<div data-template="counting-template" data-bind="source:this" />');

                var viewModel = kendo.observable({ foo: "foo" });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "baz");

                templateEvaluationCounter = 0;

                viewModel.set("foo", "boo");

                equal(templateEvaluationCounter, 1);
            });

            test("tracking changes when direct access and set are used", function() {
                var dom = $('<div data-template="nested-field-template" data-bind="source:this"/>');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.foo.set("bar", "baz");

                equal($.trim(dom.text()), "baz");
            });

            test("tracking changes when single set is used", function() {
                var dom = $('<div data-template="nested-field-template" data-bind="source:this" />');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.set("foo.bar", "boo");

                equal($.trim(dom.text()), "boo");
            });

            test("tracking changes when direct access and set are used (multiple get template)", function() {
                var dom = $('<div data-template="nested-field-template-multiple-gets" data-bind="source:this" />');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.foo.set("bar", "baz");

                equal($.trim(dom.text()), "baz");
            });

            test("tracking changes when single set is used (multiple get template)", function() {
                var dom = $('<div data-bind="source:this" data-template="nested-field-template-multiple-gets" />');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.set("foo.bar", "boo");

                equal($.trim(dom.text()), "boo");
            });

            test("tracking changes in dependent fields", function() {
                var dom = $('<div data-bind="text:computed" />');

                var viewModel = kendo.observable({
                    foo: "foo",
                    bar: "bar",
                    computed: function() {
                        return this.get("foo") + this.get("bar");
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "boo");

                equal($.trim(dom.text()), "boobar");
            });

            test("checked binding removing the item unchecks the checkbox", function() {
                var dom = $('<input type="checkbox" value="foo" data-bind="checked:selectedItems"/>');

                var viewModel = kendo.observable({
                    selectedItems: ["foo"]
                });

                kendo.bind(dom, viewModel);

                viewModel.selectedItems.splice(0,1);

                ok(!dom.is(":checked"));
            });

            test("model is not updated after target is destoryed", function() {
                var dom = $('<input data-bind="value:foo" />');

                var viewmodel = kendo.observable( { foo: "foo" });

                kendo.bind(dom, viewmodel);

                kendo.unbind(dom);

                dom.val("bar");
                dom.trigger("change");

                equal(viewmodel.foo, "foo");
            });

            test("UI element is not updated after unbind", function() {
                var dom = $('<input data-bind="value:foo" />');

                var viewmodel = kendo.observable( { foo: "foo" });

                kendo.bind(dom, viewmodel);

                kendo.unbind(dom);

                viewmodel.set("foo", "bar");

                equal(dom.val(), "foo");
            });
        </script>

        <script id="array-template" type="text/x-kendo-template">
            <li data-bind="text:name"></li>
        </script>

        <script id="simple-field-template" type="text/x-kendo-template">
            #= get("foo") #
        </script>

        <script id="nested-field-template" type="text/x-kendo-template">
            #= get("foo.bar") #
        </script>

        <script id="nested-field-template-multiple-gets" type="text/x-kendo-template">
            #= get("foo").get("bar") #
        </script>

        <script>
            var templateEvaluationCounter = 0;
        </script>

        <script id="counting-template" type="text/x-kendo-template">
            # templateEvaluationCounter ++; #
            #= get("foo") #
        </script>

        <script id="if-else-template" type="text/x-kendo-template">
            # if (get("foo") == "foo") { #
                #: get("foo") #
            # } else { #
                #: get("bar") #
            # } #
        </script>
    </head>
</html>
