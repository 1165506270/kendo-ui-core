<!DOCTYPE html>
<html>
    <head>
        <title>kendo.bind observer tests</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.bind observer Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
        <script>
            var valueBinding;

            module("mvvm observing", {
                setup: function() {
                    valueBinding = kendo.bindings.select.value.prototype.bind;
                },
                teardown: function() {
                    kendo.bindings.select.value.prototype.bind = valueBinding;
                }
            });

            test("changing a view model field reflects UI", function() {
                var viewModel = kendo.observable( {
                    foo: "foo"
                });

                var dom = $('<span data-text="foo"/>');
                kendo.bind(dom, viewModel);
                viewModel.set("foo", "bar");
                equal(dom.text(), "bar");
            });

            test("changing a view model field from a view model function bound to UI reflects UI", function() {
                var viewModel = kendo.observable( {
                    foo: "foo",
                    bar: function() {
                        this.set("foo", "baz");
                    }
                });

                var dom = $('<div><span data-text="foo"/><button data-click="bar"></button></div>');

                kendo.bind(dom, viewModel);

                dom.find("button").trigger("click");

                equal(dom.find("span").text(), "baz");
            });

            test("removing item from view model array reflects UI", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "boo" // needed to test closure value assignment
                });

                var dom = $('<select data-source="foo"/>');

                kendo.bind(dom, viewModel);

                viewModel.foo.splice(1, 1);

                equal(dom.find("option").length, 2);
                equal(dom.find("option").first().text(), "foo");
                equal(dom.find("option").last().text(), "baz");
            });

            test("change event notifies value listeners", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "bar"
                });

                var dom = $('<div><select data-source="foo" data-value="bar"/><span data-text="bar"/></div>');

                kendo.bind(dom, viewModel);

                dom.find("option:first").attr("selected", "selected");
                dom.find("select").trigger("change");
                equal(dom.find("span").text(), "foo");
            });

            test("changing the value updates the view model", function() {
                var dom = $('<input data-value="foo" />');

                var viewModel = kendo.observable( { foo: "foo" });

                kendo.bind(dom, viewModel);

                dom.val("bar");
                dom.trigger("change");

                equal(viewModel.foo, "bar");
            });

            test("change event does not update the value again", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "bar"
                });

                var calls = 0;

                kendo.bindings.select.value.prototype.bind = function() {
                    calls++;
                    return valueBinding.apply(this, arguments);
                };

                var dom = $('<select data-source="foo" data-value="bar"/>');

                kendo.bind(dom, viewModel);

                dom.find("select").val("foo");
                dom.trigger("change");

                equal(calls, 1);
            });

            test("value binding calls set once during select change", function() {
                var viewModel = kendo.observable( {
                    foo: ["foo", "bar", "baz"],
                    bar: "bar"
                });

                var calls = 0;

                var dom = $('<select data-source="foo" data-value="bar"/>');

                kendo.bind(dom, viewModel);

                viewModel.set("bar", "foo");

                viewModel.set = function() {
                    calls++;
                    kendo.data.ObservableObject.fn.set.apply(this, arguments);
                };

                dom.find("select").val("bar");
                dom.trigger("change");

                equal(calls, 1);
            });

            test("tracking changes of observable items in array", function() {
                var viewModel = kendo.observable( {
                    foo: [{ name: "foo" }]
                });

                var dom = $('<ul data-source="foo" data-template="array-template"/>');

                kendo.bind(dom, viewModel);

                viewModel.foo[0].set("name", "bar");

                equal(dom.find("li").text(), "bar");
            });

            test("tracking changes of fields bound to style", function() {
                var viewModel = kendo.observable( {
                    foo: "none",
                    bar: "underline"
                });

                var dom = $('<div data-style="display:${foo};text-decoration:${bar}"/>');

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "inline");
                viewModel.set("bar", "overline");

                equal(dom.css("display"), "inline");
                equal(dom.css("text-decoration"), "overline");
            });

            test("tracking changes of complex fields", function() {
                var dom = $('<div data-title="bar" data-text="foo.bar"/>');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    },
                    bar: "boo"
                });

                kendo.bind(dom, viewModel);

                viewModel.foo.set("bar", "baz");

                equal(dom.text(), "baz");
                //check that parent field is not changed
                equal(dom.attr("title"), "boo");
            });

            test("tracking changes of parent complex fields", function() {
                var dom = $('<div data-title="bar" data-text="foo.bar"/>');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", { bar: "baz" });

                equal(dom.text(), "baz");
            });

            test("tracking changes in templates", function() {
                var dom = $('<div data-template="simple-field-template" />');

                var viewModel = kendo.observable({ foo: "foo" });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "bar");

                equal($.trim(dom.text()), "bar");
            });

            test("dependencies are reavaluated", function() {
                var dom = $('<div data-template="if-else-template" />');

                var viewModel = kendo.observable({ foo: "foo", bar: "bar" });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "baz");

                viewModel.set("bar", "boo");

                equal($.trim(dom.text()), "boo");
            });

            test("does not attach more than one change handler when monitoring for dependency changes", function() {
                var dom = $('<div data-template="counting-template" />');

                var viewModel = kendo.observable({ foo: "foo" });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "baz");

                templateEvaluationCounter = 0;

                viewModel.set("foo", "boo");

                equal(templateEvaluationCounter, 1);
            });

            test("tracking changes when direct access and set are used", function() {
                var dom = $('<div data-template="nested-field-template" />');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.foo.set("bar", "baz");

                equal($.trim(dom.text()), "baz");
            });

            test("tracking changes when single set is used", function() {
                var dom = $('<div data-template="nested-field-template" />');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.set("foo.bar", "boo");

                equal($.trim(dom.text()), "boo");
            });

            test("tracking changes when direct access and set are used (multiple get template)", function() {
                var dom = $('<div data-template="nested-field-template-multiple-gets" />');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.foo.set("bar", "baz");

                equal($.trim(dom.text()), "baz");
            });

            test("tracking changes when single set is used (multiple get template)", function() {
                var dom = $('<div data-template="nested-field-template-multiple-gets" />');

                var viewModel = kendo.observable({
                    foo: {
                        bar: "bar"
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.set("foo.bar", "boo");

                equal($.trim(dom.text()), "boo");
            });

            test("tracking changes in dependent fields", function() {
                var dom = $('<div data-text="computed" />');

                var viewModel = kendo.observable({
                    foo: "foo",
                    bar: "bar",
                    computed: function() {
                        return this.get("foo") + this.get("bar");
                    }
                });

                kendo.bind(dom, viewModel);

                viewModel.set("foo", "boo");

                equal($.trim(dom.text()), "boobar");
            });
        </script>

        <script id="array-template" type="text/x-kendo-template">
            <li data-text="name"></li>
        </script>

        <script id="simple-field-template" type="text/x-kendo-template">
            #= get("foo") #
        </script>

        <script id="nested-field-template" type="text/x-kendo-template">
            #= get("foo.bar") #
        </script>

        <script id="nested-field-template-multiple-gets" type="text/x-kendo-template">
            #= get("foo").get("bar") #
        </script>

        <script>
            var templateEvaluationCounter = 0;
        </script>

        <script id="counting-template" type="text/x-kendo-template">
            # templateEvaluationCounter ++; #
            #= get("foo") #
        </script>

        <script id="if-else-template" type="text/x-kendo-template">
            # if (get("foo") == "foo") { #
                #: get("foo") #
            # } else { #
                #: get("bar") #
            # } #
        </script>
    </head>
</html>
