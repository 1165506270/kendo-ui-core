<!doctype html>
<html>
<head>
    <title>kendo.ui.panelbar Tests</title>

    <script src="../../src/jquery.js"></script>
    <script src="../jquery.mockjax.js"></script>
    <script src="../qunit/qunit/qunit.js"></script>
    <script src="../kendo-test-helpers.js"></script>
    <script src="../../src/kendo.core.js"></script>
    <script src="../../src/kendo.panelbar.js"></script>

    <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    <link type="text/css" href="../../styles/web/kendo.common.less" rel="stylesheet/less"/>
    <script type="text/javascript" src="../../demos/mvc/content/shared/js/less.js"></script>

    <style> html { font-size: 12px; } </style>
</head>
<body>

<script type="text/x-kendo-template" id="panelbarHTML">
    <ul class="k-widget k-panelbar k-reset" id="PanelBar1" style="width: 300px; float: left; visibility: hidden; position: absolute;">
        <li><a>Pure ASP.NET MVC components</a>
            <div></div>
        </li>
        <li><a>Completely Open Source</a>
            <div></div>
        </li>
        <li><a>Exceptional Performance</a>
            <div></div>
        </li>
        <li><a>Based on jQuery</a>
            <div></div>
        </li>
        <li>Wide Cross-browser support
            <div></div>
        </li>
        <li>Wide Cross-browser support
            <div></div>
        </li>
    </ul>
</script>

<script type="text/x-kendo-template" id="activePanelbarHTML">
    <ul class="k-widget k-panelbar k-reset" id="PanelBar1" style="width: 300px; float: left; visibility: hidden; position: absolute;">
        <li><a>Pure ASP.NET MVC components</a>
            <div></div>
        </li>
        <li><a>Completely Open Source</a>
            <div></div>
        </li>
        <li><a>Exceptional Performance</a>
            <div></div>
        </li>
        <li><a>Based on jQuery</a>
            <div></div>
        </li>
        <li class="k-state-active">Wide Cross-browser support
            <div></div>
        </li>
    </ul>
</script>

    <script>
        QUnit.config.reorder = false;

        var panelbar;

        $.mockjax({
            url: "error.html",
            response: function() {
                this.responseText = 'foo<script type="text/javascript">exit;<' + '/script>';
            }
        });

        function createPanelBar() {
            $(document.body).append($("#panelbarHTML").html());
            panelbar = $("#PanelBar1").kendoPanelBar({
                animation: false,
                contentUrls: [
                    "AjaxView1.html",
                    "AjaxView2.html",
                    "AjaxView1.html",
                    "AjaxView2.html",
                    "AjaxView1.html",
                    "error.html"
                ]
            }).data("kendoPanelBar");
        }

        function destroyPanelBar() {
            panelbar.destroy();
            panelbar = null;
            $("#PanelBar1").remove();
        }
        
        function getRootItem(index) {
            return panelbar.element.find(".k-header").parent().eq(index).children(".k-link");
        }

        module("AjaxLoading", {
            setup: function() {
                window.con = window.console;
            },
            teardown: function() {
                window.console = window.con;
                destroyPanelBar();
            }
        });

        test("PanelBar renders anchor instead of span if contentUrl", function() {
            createPanelBar();

            var children = $("#PanelBar1").find("li:last").children();

            equal(children.filter("a").length, 1);
            equal(children.filter("span").length, 0)
        });

        asyncTest("clicking collapsed content items should expand them", 1, function() {
            createPanelBar();

            var item = getRootItem(0);

            panelbar.bind("contentLoad", function() {
                start();
                equal($(arguments[0].contentElement).css("display"), "block");
                panelbar.unbind("contentLoad");
            });

            item.trigger("click");
        });

        test("clicking expanded content items should collapse them", function() {
            createPanelBar();

            var item = getRootItem(0);

            item.trigger("click");

            equal(item.parent().find(".k-content").css("display"), "none");
        });

        asyncTest("clicking collapsed content items should toggle arrow", 1, function() {
            createPanelBar();

            var item = getRootItem(1);

            panelbar.bind("contentLoad", function() {
                start();
                ok($(arguments[0].item).find(".k-icon").hasClass("k-i-arrow-n"));
                panelbar.unbind("contentLoad");
            });

            item.trigger("click");
        });

        test("clicking expanded content items should toggle arrow", 1, function() {
            createPanelBar();

            var item = getRootItem(1);

            item.trigger("click");

            ok(item.find(".k-icon").hasClass("k-i-arrow-s"));
        });

        asyncTest("clicking should make item active", 1, function() {
            createPanelBar();

            var item = getRootItem(2);

            panelbar.bind("contentLoad", function() {
                start();
                ok(item.parent().hasClass("k-state-active"));
                panelbar.unbind("contentLoad");
            });

            item.click();
        });

        asyncTest("initially expanded items fetch their AJAX content", 1, function() {
            $(document.body).append($("#activePanelbarHTML").html());
            panelbar = $("#PanelBar1").kendoPanelBar({
                animation: false,
                contentUrls: [
                    "AjaxView1.html",
                    "AjaxView2.html",
                    "AjaxView1.html",
                    "AjaxView2.html",
                    "AjaxView1.html"
                ]
            }).data("kendoPanelBar");

            var item = getRootItem(4);

            panelbar.bind("contentLoad", function() {
                start();
                equal(item.parent().find(".k-content").css("display"), "block");
                panelbar.unbind("contentLoad");
            });
        });

        asyncTest("ajax content with error fires error handler and writes the error message to the console", 2, function () {
            createPanelBar();

            var item = getRootItem(5);

            panelbar.bind("error", function (e) {
                ok(true);
                start();
            });

            window.console = {
                log: function (msg) {
                    ok(msg);
                }
            };

            item.click();
        });

    </script>

    <h1 id="qunit-header">kendo.ui.PanelBar Tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
    <ul id="log"></ul>
</body>
</html>
