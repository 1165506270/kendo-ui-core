<!DOCTYPE html>
<html>
    <head>
        <title>Scheduler editing</title>
        <script src="../jquery-loader.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.validator.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <script src="../../src/kendo.editable.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.dropdownlist.js"></script>
        <script src="../../src/kendo.tooltip.js"></script>
        <script src="../../src/kendo.calendar.js"></script>
        <script src="../../src/kendo.datepicker.js"></script>
        <script src="../../src/kendo.window.js"></script>
        <script src="../../src/kendo.numerictextbox.js"></script>
        <script src="../../src/kendo.scheduler.view.js"></script>
        <script src="../../src/kendo.scheduler.dayview.js"></script>
        <script src="../../src/kendo.scheduler.recurrence.js"></script>
        <script src="../../src/kendo.scheduler.js"></script>
        <script src="../../src/kendo.timezones.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">Scheduler editing</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Scheduler = kendo.ui.Scheduler,
                timezone = kendo.timezone,
                container;

            QUnit.config.reorder = false;

            function getDate(date) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
            }

            module("editing", {
                setup: function() {
                    container = $("<div>");
                    container.appendTo(document.body);
                },
                teardown: function() {
                    container.kendoScheduler("destroy").empty().remove();
                    $(".k-window").remove();
                }
            });

            function setup(options) {
                return new Scheduler(container,
                    $.extend({
                        dataSource: {
                            data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event" } ]
                        }
                    }, options)
                );
            }

            test("adding model updates the view", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    render = stub(scheduler.view(), "render");

                dataSource.add({});

                equal(render.calls("render"), 1);
            });

            test("clicking view slot calls addEvent method", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    addEvent = stub(scheduler, "addEvent");

                var cell = scheduler.view().content.find("td").first();
                cell.trigger({ type: "dblclick", pageX: cell.offset().left, pageY: cell.offset().top });

                equal(addEvent.calls("addEvent"), 1);
                ok(addEvent.args("addEvent")[0].start);
                ok(addEvent.args("addEvent")[0].end);
            });

            test("addEvent calls dataSource add method", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    add = stub(dataSource, "add");

                scheduler.addEvent();

                equal(add.calls("add"), 1);
            });

            test("addEvent with type allday creates allday event", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource;

                scheduler.addEvent({ isAllDay: true, start: new Date(2013, 1, 13, 0, 0, 0), end: new Date(2013, 1, 13, 0, 0, 0) });

                equal(dataSource.at(0).isAllDay, true);
            });

            test("dblclicking on event calls editEvent", function() {
                var scheduler = setup({
                        dataSource: {
                            data: [ { start: new Date(), end: new Date(), title: "my event" } ]
                        }
                    }),
                    dataSource = scheduler.dataSource,
                    editEvent = stub(scheduler, "editEvent");

                scheduler.view().content.find(".k-event").first().dblclick();

                equal(editEvent.calls("editEvent"), 1);
            });

            test("dblclicking on allday event calls editEvent", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    editEvent = stub(scheduler, "editEvent");

                scheduler.view().datesHeader.find(".k-event").first().dblclick();

                equal(editEvent.calls("editEvent"), 1);
            });

            test("editEvent creates window instance", function() {
                var scheduler = setup();

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                ok(scheduler._editContainer.data("kendoWindow"));
            });

            test("default settings are applied to the window", function() {
                var scheduler = setup();
                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var wnd = scheduler._editContainer.data("kendoWindow");

                ok(wnd.options.modal);
                ok(!wnd.options.resizable);
                ok(wnd.options.draggable);
                equal(wnd.options.title, "Event");
            });

            test("custom settings are applied to the window", function() {
                var scheduler = setup({ editable: { window: { title: "foo" } } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var wnd = scheduler._editContainer.data("kendoWindow");

                equal(wnd.options.title, "foo");
            });

            test("correct model is passed to the editable instance", function() {
                var scheduler = setup({ editable: { window: { title: "foo" } } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer;
                equal(container.data("kendoEditable").options.model, scheduler.dataSource.at(0));
            });

            test("custom template is used if specified", function() {
                var scheduler = setup({ editable: { template:"<div>#=title#</div>" } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                equal(container.find("div:first").text(), "my event");
            });

            test("custom template as function", function() {
                var scheduler = setup({ editable: { template: kendo.template("foo") } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                equal(container.text(), "fooSaveCancel");
            });

            test("edit event is raised when entering edit mode", 2, function() {
                var scheduler = setup({
                    edit: function(e) {
                        ok(e.container[0], scheduler._editContainer.children(".k-edit-form-container"));
                        equal(e.event, scheduler.dataSource.at(0));
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));
            });

            test("the popup window is not shown if the edit event is prevented", 1, function() {
                var scheduler = setup({
                    edit: function(e) {
                        e.preventDefault();
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));
                equal($(".k-edit-form-container:visible").length, 0);
            });

            test("the new event is removed if the edit event is prevented", 1, function() {
                var scheduler = setup({
                    edit: function(e) {
                        e.preventDefault();
                    }
                });

                scheduler.addEvent({ start: new Date(), end: new Date() });
                equal(scheduler.dataSource.data().length, 1);
            });

            test("update and cancel buttons are added if template is set", function() {
                var scheduler = setup({ editable: { template:"<div>#=title#</div>" } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");

                equal(container.find("a.k-scheduler-update").length, 1);
                equal(container.find("a.k-scheduler-cancel").length, 1);
            });

            test("Update and cancel button custom text", function() {
                var scheduler = setup({
                    messages: {
                        save: "myUpdate",
                        cancel: "myCancel"
                    },
                    editable: { template:"<div>#=title#</div>" },
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                equal(container.find("a.k-scheduler-update").text(), "myUpdate");
                equal(container.find("a.k-scheduler-cancel").text(), "myCancel");
            });

            test("clicking update buttons calls update event", function() {
                var scheduler = setup(),
                    saveEvent = stub(scheduler, "saveEvent");

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                scheduler._editContainer.find("a.k-scheduler-update").click();

                ok(saveEvent.calls("saveEvent"));
            });

            test("clicking cancel buttons calls cancel event", function() {
                var scheduler = setup(),
                    cancelEvent = stub(scheduler, "cancelEvent");

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                scheduler._editContainer.find("a.k-scheduler-cancel").click();

                ok(cancelEvent.calls("cancelEvent"));
            });

            test("clicking close button of the window calls cancelEvent", function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid"),
                    cancelEvent = stub(scheduler, "cancelEvent");

                scheduler.editEvent(eventElement);

                var wnd = scheduler._editContainer.data("kendoWindow");
                wnd.wrapper.find(".k-i-close").click();

                equal(cancelEvent.calls("cancelEvent"), 2);
            });

            test("editEvent call cancelEvent", function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid"),
                    cancelEvent = stub(scheduler, "cancelEvent");

                scheduler.editEvent(eventElement);

                equal(cancelEvent.calls("cancelEvent"), 1);
            });

            test("cancelEvent closes the popup", 2, function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                var wnd = scheduler._editContainer.data("kendoWindow");

                wnd.bind("close", function() {
                    ok(true, "Window is not been closed");
                });

                scheduler.cancelEvent();
                ok(!scheduler._editContainer);
            });

            test("cancel event is raised when cancel button is clicked", 2, function() {
                var scheduler = setup({
                        cancel: function(e) {
                            equal(e.event, this.dataSource.at(0));
                            ok(e.container.length);
                        }
                    }),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                $(".k-scheduler-cancel").click();
            });

            test("preventing the cancel event leaves the window open when cancel button is clicked", function() {
                var scheduler = setup({
                    cancel: function(e) {
                        e.preventDefault();
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                $(".k-scheduler-cancel").click();

                equal($(".k-scheduler-cancel:visible").length, 1);
            });

            test("cancel event is raised when window is closed", 2, function() {
                var scheduler = setup({
                    cancel: function(e) {
                        equal(e.event, this.dataSource.at(0));
                        ok(e.container.length);
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                $(scheduler._editContainer.parent().find(".k-i-close")).click();
            });

            test("preventing the cancel event leaves the window open when close button is clicked", function() {
                var scheduler = setup({
                    cancel: function(e) {
                        e.preventDefault();
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);
                scheduler._editContainer.parent().find(".k-i-close").click();

                equal($(".k-scheduler-cancel:visible").length, 1);
            });

            test("saveEvent calls validate", function() {
                 var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                var validate = stub(scheduler._editContainer.data("kendoValidator"), "validate");

                scheduler.saveEvent();

                ok(validate.calls("validate"));
            });

            test("saveEvent item does not leave edit mode if validation fails", function() {
                var scheduler = setup({
                    editable: {
                        template: "<input/>"
                    },
                    dataSource: {
                            data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event" } ],
                            schema: {
                                model: {
                                    fields: {
                                        title: { validation: { custom: function() { return false; } } }
                                    }
                                }
                    }}}),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                scheduler.saveEvent();

                ok(scheduler._editContainer.find(".k-scheduler-update").length);
            });

            test("saveEvent calls DataSource sync", function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                var sync = stub(scheduler.dataSource, "sync");

                scheduler.saveEvent();

                ok(sync.calls("sync"));
            });

            test("sync is not call if save event is canceled", function() {
                var scheduler = setup({
                    save: function(e) {
                        e.preventDefault();
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                scheduler.saveEvent();

                ok(scheduler._editContainer);
            });

            test("addEvent opens the edit form", function() {
                var scheduler = setup();

                scheduler.addEvent({ start: new Date(), end: new Date() });

                ok(scheduler._editContainer);
            });

            test("all fields are wrapped", function() {
                var scheduler = setup();

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div").not(".k-edit-buttons").not(".k-recur-view");

                equal(elements.length, 15);
                ok(elements.eq(0).hasClass("k-edit-label"));
                equal(elements.eq(0).find("label").attr("for"), "title");
                equal(elements.eq(1).data("container-for"), "title");
                ok(elements.eq(1).hasClass("k-edit-field"));
            });

            test("non editable field value is shown", function() {
                var scheduler = setup({
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event" } ],
                        schema: { model: { fields: { title: { editable:false } } } }
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div").not(".k-edit-buttons").not(".k-recur-view");

                equal(elements.length, 13);
                ok(elements.eq(0).hasClass("k-edit-label"));
                equal(elements.eq(0).find("label").attr("for"), "title");
                equal(elements.eq(1).text(), "my event");
                ok(elements.eq(1).hasClass("k-edit-field"));
            });

            test("render description editor if exists", function() {
                var scheduler = setup({
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event", description: "foo" } ]
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div");

                ok(elements.filter("[data-container-for=description]").length);
            });

            test("recurrence editor is not rendered if recurrenceId property exists", function() {
                var scheduler = setup({
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event", recurrenceId: 1 } ]
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div");

                ok(!elements.filter("[data-container-for=recurrence]").length);
            });

            test("recurrence editor is rendered if recurrenceRule property exists", function() {
                var scheduler = setup({
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event", recurrenceRule: ""} ]
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div");

                ok(elements.filter("[data-container-for=recurrenceRule]").length);
            });

            module("recurrence editing", {
                setup: function() {
                    container = document.createElement("div");
                    document.body.appendChild(container);
                },
                teardown: function() {
                    kendo.destroy($(container).closest(".k-scheduler"));
                    $(".k-widget").remove();
                }
            });

            test("show recurring dialog", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");
                scheduler.editEvent(eventUID);

                ok($(".k-window").find(".k-window-title").text(), "Edit Recurring Item");
            });

            test("close recurring dialog on button click", 1, function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");

                stub(scheduler, {
                    addEvent: scheduler.addEvent
                });

                scheduler.editEvent(eventUID);

                var popup = $(".k-window");

                popup.find(".k-button:first").click();

                equal(popup.is(":visible"), false);
            });

            test("Set timezone to the RecurrenceEditor", function() {
                var scheduler = setup({
                    views: ["week"],
                    timezone: "Etc/UTC",
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                scheduler.editEvent(scheduler.element.find(".k-event:first").data("uid"));

                $(".k-window .k-button:last").click();

                var editor = scheduler._editContainer.find("[data-role=recurrenceeditor]").data("kendoRecurrenceEditor");

                equal(editor.options.timezone, "Etc/UTC");
            });

            test("create exception", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");

                stub(scheduler, {
                    addEvent: scheduler.addEvent
                });

                scheduler.editEvent(eventUID);

                //edit current instance
                $(".k-window .k-button:first").click();

                equal(scheduler.calls("addEvent"), 1);
            });

            test("creating exception using UTC timezone", function() {
                var scheduler = setup({
                    timezone: "Etc/UTC",
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid"),
                    origin = scheduler.dataSource.at(0),
                    exception;

                scheduler.editEvent(eventUID);
                $(".k-window .k-button:first").click();

                exception = scheduler.dataSource.at(1);

                ok(origin.recurrenceException);
                equal(origin.recurrenceException, kendo.toString(exception.start, "yyyyMMddTHHmmssZ") + ";");
            });

            test("creating exception sets event exception property", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid"),
                    origin = scheduler.dataSource.at(0),
                    exception;

                scheduler.editEvent(eventUID);

                $(".k-window .k-button:first").click();

                exception = scheduler.dataSource.at(1);

                ok(origin.recurrenceException);
                equal(origin.recurrenceException, kendo.toString(kendo.timezone.apply(exception.start, 0), "yyyyMMddTHHmmssZ") + ";");
            });

            test("created exception has no id and recurrenceRule property", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid"),
                    origin = scheduler.dataSource.at(0),
                    exception;

                scheduler.editEvent(eventUID);

                $(".k-window .k-button:first").click();

                exception = scheduler.dataSource.at(1);

                ok(exception.isNew())
            });

            test("creating exception adds exception date to event exception property", function() {
                var now = new Date("2013/6/6 10:00");
                now.setMilliseconds(0);

                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: now, end: now, title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var events = scheduler.element.find(".k-event"),
                    origin = scheduler.dataSource.at(0);

                scheduler.editEvent(events.last().data("uid"));

                $(".k-window .k-button:first").click();
                scheduler._editContainer.find("a.k-scheduler-update").click();

                events = scheduler.element.find(".k-event");

                scheduler.editEvent(events.first().data("uid"));

                $(".k-window .k-button:first").click();

                scheduler._editContainer.find("a.k-scheduler-update").click();

                var result = kendo.toString(kendo.timezone.apply(scheduler.dataSource.at(1).start, 0), "yyyyMMddTHHmmssZ") + ";" +
                             kendo.toString(kendo.timezone.apply(scheduler.dataSource.at(2).start, 0), "yyyyMMddTHHmmssZ") + ";";

                equal(origin.recurrenceException, result);
            });

            test("Editing exception opens recurring dialog", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var events = scheduler.element.find(".k-event"),
                    origin = scheduler.dataSource.at(0);

                scheduler.editEvent(events.last().data("uid"));

                $(".k-window .k-button:first").click();

                scheduler._editContainer.find("a.k-scheduler-update").click();

                events = scheduler.element.find(".k-event");

                stub(scheduler, {
                    addEvent: scheduler.addEvent,
                    _editEvent: scheduler._editEvent
                });

                scheduler.dataSource.at(1).set("id", 2);
                scheduler.editEvent(events.last().data("uid"));

                ok($(".k-window").find(".k-window-title").text(), "Edit Recurring Item");
                ok($(".k-window").is(":visible"));
            });

            test("open recurring window if editing old exception", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid"),
                    origin = scheduler.dataSource.at(0),
                    exception;

                scheduler.editEvent(eventUID);
                $(".k-window .k-button:first").click();

                exception = scheduler.dataSource.at(1);

                ok(origin.recurrenceException);
                equal(origin.recurrenceException, kendo.toString(kendo.timezone.apply(exception.start, 0), "yyyyMMddTHHmmssZ") + ";");
            });

            test("Normalize model if create exception from origin", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:first").data("uid"),
                    origin = scheduler.dataSource.at(0),
                    exception;

                scheduler.editEvent(eventUID);

                $(".k-window .k-button:first").click();

                exception = scheduler.dataSource.at(1);

                ok(origin.recurrenceException);
                equal(origin.recurrenceException, kendo.toString(kendo.timezone.apply(exception.start, 0), "yyyyMMddTHHmmssZ") + ";");
                equal(origin.id, exception.recurrenceId);
            });

            test("edit series", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");

                stub(scheduler, {
                    _editEvent: scheduler._editEvent
                });

                scheduler.editEvent(eventUID);

                //edit current instance
                $(".k-window .k-button:last").click();

                var model = scheduler.args("_editEvent", 0)[0];

                equal(scheduler.calls("_editEvent"), 1);
                equal(model.uid, scheduler.dataSource.at(0).uid);
            });

            test("edit series deletes created exceptions", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: 1, start: new Date(), end: new Date(), title: "my event", recurrenceRule: "FREQ=DAILY"} ]
                    }
                });

                var event = scheduler.element.find(".k-event:last");

                scheduler.editEvent(event.data("uid"));

                $(".k-window .k-button:first").click();

                scheduler._editContainer.find("a.k-scheduler-update").click();
                scheduler.dataSource.at(1).set("id", 2);

                var eventUID = scheduler.element.find(".k-event:last").data("uid");
                scheduler.editEvent(eventUID);

                //edit current instance
                $(".k-window .k-button:last").click();

                var model = scheduler.dataSource.at(0);

                equal(scheduler.dataSource.data().length, 1);
                equal(model.recurrenceException, "");
            });

            test("delete occurrence creates recurrenceException entry", function() {
                var date = new Date(2013, 10, 10, 15, 0, 0),
                    exceptionDate = new Date(2013, 10, 12, 15, 0, 0),
                    exceptionDate = kendo.timezone.apply(exceptionDate, 0),
                    recurrenceException = kendo.toString(exceptionDate, "yyyyMMddTHHmmssZ") + ";";

                var scheduler = setup({
                    views: ["week"],
                    date: date,
                    dataSource: {
                        data: [ { id: 1, start: date, end: date, title: "my event", recurrenceRule: "FREQ=DAILY" } ]
                    }
                });

                scheduler.removeEvent(scheduler.element.find(".k-event").eq(2).data("uid"));

                $(".k-window .k-button:first").click();

                $(document.body).find("[data-role=window]:visible").data("kendoWindow").destroy();

                var model = scheduler.dataSource.at(0);

                equal(model.recurrenceException, recurrenceException);
            });

            test("delete created exception", function() {
                var date = new Date(2013, 10, 10, 15, 0, 0),
                    nextDate = new Date(2013, 10, 11, 15, 0, 0),
                    recurrenceException = kendo.toString(kendo.timezone.apply(nextDate, 0), "yyyyMMddTHHmmssZ") + ";";

                var scheduler = setup({
                    views: ["week"],
                    date: date,
                    dataSource: {
                        data: [
                            { id: 1, start: date, end: date, title: "my event", recurrenceRule: "FREQ=DAILY", recurrenceException: recurrenceException},
                            { id: 2, start: nextDate, end: nextDate, title: "my event", recurrenceId: "1" }
                        ]
                    }
                });

                var event = scheduler.element.find(".k-event").eq(1);
                    origin = scheduler.dataSource.at(0);

                scheduler.removeEvent(event.data("uid"));

                $(".k-window .k-button:first").click(); //delete current occurrence
                $(document.body).find("[data-role=window]:visible").find(".k-button:first").click(); //accept deletion

                equal(scheduler.dataSource.data().length, 1);
                equal(origin.recurrenceException, recurrenceException);
            });

            test("canceling deletion of occurrence removes applied recurrenceException", function() {
                var date = new Date(2013, 10, 10, 15, 0, 0);

                var scheduler = setup({
                    views: ["week"],
                    date: date,
                    dataSource: {
                        data: [ { id: 1, start: date, end: date, title: "my event", recurrenceRule: "FREQ=DAILY" } ]
                    }
                });

                scheduler.removeEvent(scheduler.element.find(".k-event").eq(2).data("uid"));
                $(".k-window .k-button:first").click(); //delete current occurrence
                $(document.body).find("[data-role=window]:visible").find(".k-button:last").click(); //cancel deletion

                var model = scheduler.dataSource.at(0);

                ok(!model.recurrenceException);
            });

            test("canceling deletion of occurrence removes applied recurrenceException (UTC timezone)", function() {
                var date = new Date(2013, 10, 10, 15, 0, 0);

                var scheduler = setup({
                    views: ["week"],
                    timezone: "Etc/UTC",
                    date: date,
                    dataSource: {
                        data: [ { id: 1, start: date, end: date, title: "my event", recurrenceRule: "FREQ=DAILY" } ]
                    }
                });

                scheduler.removeEvent(scheduler.element.find(".k-event").eq(2).data("uid"));
                $(".k-window .k-button:first").click(); //delete current occurrence
                $(document.body).find("[data-role=window]:visible").find(".k-button:last").click(); //cancel deletion

                var model = scheduler.dataSource.at(0);

                ok(!model.recurrenceException);
            });

            test("deleting series wll delete all exceptions", function() {
                var date = new Date(2013, 10, 10, 15, 0, 0),
                    nextDate = new Date(2013, 10, 11, 15, 0, 0),
                    recurrenceException = kendo.toString(kendo.timezone.apply(nextDate, 0), "yyyyMMddTHHmmssZ") + ";";

                var scheduler = setup({
                    views: ["week"],
                    date: date,
                    dataSource: {
                        data: [
                            { id: 1, start: date, end: date, title: "my event", recurrenceRule: "FREQ=DAILY", recurrenceException: recurrenceException},
                            { id: 2, start: nextDate, end: nextDate, title: "my event", recurrenceId: 1 }
                        ]
                    }
                });

                var event = scheduler.element.find(".k-event").eq(1);

                scheduler.removeEvent(event.data("uid"));

                $(".k-window .k-button:last").click(); //delete series

                $(document.body).find("[data-role=window]:visible").find(".k-button:first").click(); //accept deletion

                equal(scheduler.dataSource.data().length, 0);
            });

            test("recurrenceRule is persisted after delete cancellation", function() {
                var date = new Date(2013, 10, 10, 15, 0, 0),
                    nextDate = new Date(2013, 10, 11, 15, 0, 0),
                    recurrenceException = kendo.toString(kendo.timezone.apply(nextDate, 0), "yyyyMMddTHHmmssZ") + ";";

                var scheduler = setup({
                    views: ["week"],
                    date: date,
                    dataSource: {
                        data: [
                            { id: 1, start: date, end: date, title: "my event", recurrenceRule: "FREQ=DAILY", recurrenceException: recurrenceException},
                            { id: 2, start: nextDate, end: nextDate, title: "my event", recurrenceId: "1" }
                        ]
                    }
                });

                var event = scheduler.element.find(".k-event").eq(2);

                scheduler.removeEvent(event.data("uid"));
                $(".k-window .k-button:first").click(); //delete current occurrence
                $(document.body).find("[data-role=window]:visible").find(".k-button:last").click(); //cancel deletion

                ok(scheduler.dataSource.at(0).recurrenceRule);
            });

            test("editEvent deletes startTime and endTime", function() {
                var scheduler = setup(),
                    model = scheduler.dataSource.data()[0],
                    uid = model.uid;

                model.startTime = new Date();
                model.endTime = new Date();

                scheduler.editEvent(uid);

                ok(!model.startTime);
                ok(!model.endTime);
            });

            test("editEvent returns startTime and endTime on cancel button", function() {
                var scheduler = setup(),
                    model = scheduler.dataSource.data()[0],
                    uid = model.uid;

                model.startTime = new Date();
                model.endTime = new Date();

                scheduler.editEvent(uid);
                scheduler._editContainer.data("kendoWindow").wrapper.find(".k-window-action").click();

                ok(model.startTime);
                ok(model.endTime);
            });

            module("Timezone editing", {
                setup: function() {
                    var scriptTag = $("script:last");

                    container = document.createElement("div");
                    document.body.appendChild(container);
                },
                teardown: function() {
                    kendo.destroy($(container).closest(".k-scheduler"));
                    $(".k-widget").remove();
                }
            });

            test("Render Timezone field", function() {
                var scheduler = setup(),
                    uid = scheduler.dataSource.data()[0].uid;

                scheduler.editEvent(uid);
                var anchor = scheduler._editContainer.find(".k-edit-field > a");

                ok(anchor[0]);
                equal(anchor.text(), "Time zone");
            });

            test("Render start and end timezone editors", function() {
                var scheduler = setup(),
                    uid = scheduler.dataSource.data()[0].uid;

                scheduler.editEvent(uid);
                var editors = scheduler._editContainer.find("[data-role=timezoneeditor]");

                equal(editors.length, 2);
                equal(editors.eq(0).attr("data-bind"), "value:startTimezone");
                equal(editors.eq(1).attr("data-bind"), "value:endTimezone");
            });

            test("Click Timezone anchor creates timezone popup", function() {
                var scheduler = setup(),
                    uid = scheduler.dataSource.data()[0].uid;

                scheduler.editEvent(uid);
                var editors = scheduler._editContainer.find(".k-edit-field > a").click();

                ok(scheduler._timezonePopup);
                ok(scheduler._timezonePopup.is(":visible"));
                ok(!scheduler._timezonePopup.find(".k-edit-field:last").is(":visible"));
            });

            test("Show second TimezoneEditor if model.endTimezone is defined", function() {
                var scheduler = setup(),
                    model = scheduler.dataSource.data()[0],
                    uid = model.uid;

                model.set("endTimezone", "America/Toronto");

                scheduler.editEvent(uid);
                var editors = scheduler._editContainer.find(".k-edit-field > a").click();

                ok(scheduler._timezonePopup.find("input[type=checkbox]").prop("checked"))
            });

            test("Select correct timezone if startTimezone is defined", function() {
                var scheduler = setup(),
                    model = scheduler.dataSource.data()[0],
                    uid = model.uid;

                model.set("startTimezone", "America/Toronto");

                scheduler.editEvent(uid);
                var editor = scheduler._editContainer.find("[data-role=timezoneeditor]:first").data("kendoTimezoneEditor");

                equal(editor.value(), "America/Toronto");
            });

            test("Click done closes timezone popup", function() {
                var scheduler = setup(),
                    model = scheduler.dataSource.data()[0],
                    uid = model.uid;

                scheduler.editEvent(uid);
                scheduler._editContainer.find(".k-edit-field > a").click();
                scheduler._timezonePopup.find(".k-scheduler-savetimezone").click();

                ok(!scheduler._timezonePopup.is(":visible"));
            });

            test("Click close reverts timezones to last selected", function() {
                var scheduler = setup(),
                    model = scheduler.dataSource.data()[0],
                    uid = model.uid;

                scheduler.editEvent(uid);
                scheduler._editContainer.find(".k-edit-field > a").click();

                var editor = scheduler._timezonePopup.find("[data-role=timezoneeditor]:first").data("kendoTimezoneEditor");
                editor.value("America/Toronto");

                equal(model.startTimezone, "America/Toronto");

                scheduler._timezonePopup.find(".k-scheduler-canceltimezone").click();

                ok(!model.startTimezone);
            });

            test("Click checkbox toggles endTimezone editor widget", function() {
                var scheduler = setup(),
                    model = scheduler.dataSource.data()[0],
                    uid = model.uid;

                scheduler.editEvent(uid);
                scheduler._editContainer.find(".k-edit-field > a").click();

                var editor = scheduler._timezonePopup.find("[data-role=timezoneeditor]:last").data("kendoTimezoneEditor");
                    checkbox = scheduler._timezonePopup.find("input[type=checkbox]");

                checkbox.click();
                editor.value("America/Toronto");

                equal(model.endTimezone, "America/Toronto");

                checkbox.click();

                ok(!editor.wrapper.closest(".k-edit-field").is(":visible"));
                ok(!model.endTimezone);
            });

            test("addEvent converts start/end event date UTC to startTimezone: Americ/New_York", function() {
                var scheduler = setup({ timezone: "Etc/UTC" }),
                    start = new Date(2013, 10, 10, 10),
                    end = new Date(2013, 10, 10, 11),
                    zone = "America/New_York";

                scheduler.addEvent({ start: start, end: end, startTimezone: zone });

                var model = scheduler.dataSource.data()[1];

                deepEqual(model.start, start);
                deepEqual(model.end, end);
            });

            test("editEvent converts start/end event date UTC to endTimezone: Americ/New_York", function() {
                var start = new Date(2013, 10, 10, 10),
                    end = new Date(2013, 10, 10, 11),
                    zone = "America/New_York";


                var scheduler = setup({
                    dataSource: {
                        data: [
                            { start: new Date(), end: new Date(), isAllDay: true, title: "my event" },
                            {
                                start: new Date(start),
                                end: new Date(end),
                                startTimezone: zone,
                                title: "my event"
                            }
                        ]
                    },
                    timezone: "Etc/UTC"
                });

                start.setTime(start.getTime() + (start.getTimezoneOffset() * (60 * 1000))); //simulate UTC
                end.setTime(end.getTime() + (end.getTimezoneOffset() * (60 * 1000))); //simulate UTC

                var model = scheduler.dataSource.data()[1];
                scheduler.editEvent(model.uid);

                deepEqual(model.start, timezone.convert(start, "Etc/UTC", zone));
                deepEqual(model.end, timezone.convert(end, "Etc/UTC", zone));
            });

            test("saveEvent reverts applied StartTimezone if no changes have been made", function() {
                var start = new Date(2013, 10, 10, 10),
                    end = new Date(2013, 10, 10, 11),
                    zone = "America/New_York";

                var scheduler = setup({
                    dataSource: {
                        data: [
                            { start: new Date(), end: new Date(), isAllDay: true, title: "my event" },
                            {
                                start: new Date(start),
                                end: new Date(end),
                                startTimezone: zone,
                                title: "my event"
                            }
                        ]
                    },
                    timezone: "Etc/UTC"
                });

                start.setTime(start.getTime() + (start.getTimezoneOffset() * (60 * 1000))); //simulate UTC
                end.setTime(end.getTime() + (end.getTimezoneOffset() * (60 * 1000))); //simulate UTC

                var model = scheduler.dataSource.data()[1];
                scheduler.editEvent(model.uid);
                scheduler.saveEvent();

                deepEqual(model.start, start);
                deepEqual(model.end, end);
            });

            test("saveEvent does not revert applied Start/EndTimezone if start/end was edited", function() {
                var start = new Date(2013, 10, 10, 10),
                    end = new Date(2013, 10, 10, 11),
                    zone = "America/New_York";

                var scheduler = setup({
                    dataSource: {
                        data: [
                            { start: new Date(), end: new Date(), isAllDay: true, title: "my event" },
                            {
                                start: new Date(start),
                                end: new Date(end),
                                startTimezone: zone,
                                title: "my event"
                            }
                        ]
                    },
                    timezone: "Etc/UTC"
                });

                start.setTime(start.getTime() + (start.getTimezoneOffset() * (60 * 1000))); //simulate UTC
                end.setTime(end.getTime() + (end.getTimezoneOffset() * (60 * 1000))); //simulate UTC

                var model = scheduler.dataSource.data()[1];
                scheduler.editEvent(model.uid);

                start.setHours(start.getHours() - 2);
                model.set("start", start);

                end.setHours(end.getHours() - 2);
                model.set("end", end);

                scheduler.saveEvent();

                deepEqual(model.start, timezone.convert(start, zone, "Etc/UTC"));
                deepEqual(model.end, timezone.convert(end, zone, "Etc/UTC"));
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
