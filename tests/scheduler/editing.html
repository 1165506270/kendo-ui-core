<!DOCTYPE html>
<html>
    <head>
        <title>Scheduler editing</title>
        <script src="../jquery-loader.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.validator.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <script src="../../src/kendo.editable.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.dropdownlist.js"></script>
        <script src="../../src/kendo.tooltip.js"></script>
        <script src="../../src/kendo.calendar.js"></script>
        <script src="../../src/kendo.datepicker.js"></script>
        <script src="../../src/kendo.window.js"></script>
        <script src="../../src/kendo.numerictextbox.js"></script>
        <script src="../../src/kendo.scheduler.view.js"></script>
        <script src="../../src/kendo.scheduler.dayview.js"></script>
        <script src="../../src/kendo.scheduler.recurrence.js"></script>
        <script src="../../src/kendo.scheduler.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">Scheduler editing</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var Scheduler = kendo.ui.Scheduler,
                container;

            function getDate(date) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
            }

            module("editing", {
                setup: function() {
                    container = document.createElement("div");
                    document.body.appendChild(container);
                },
                teardown: function() {
                    $(container).closest(".k-scheduler").kendoScheduler("destroy").remove();
                }
            });

            function setup(options) {
                return new Scheduler(container,
                    $.extend({
                        dataSource: {
                            data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event" } ]
                        }
                    }, options)
                );
            }

            test("adding model updates the view", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    render = stub(scheduler.view(), "render");

                dataSource.add({});

                equal(render.calls("render"), 1);
            });

            test("clicking view slot calls addEvent method", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    addEvent = stub(scheduler, "addEvent");

                scheduler.view().content.find("td").first().dblclick();

                equal(addEvent.calls("addEvent"), 1);
                ok(addEvent.args("addEvent")[0].start);
                ok(addEvent.args("addEvent")[0].end);
            });

            test("addEvent calls dataSource add method", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    add = stub(dataSource, "add");

                scheduler.addEvent();

                equal(add.calls("add"), 1);
            });

            test("addEvent with type allday creates allday event", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource;

                scheduler.addEvent({ isAllDay: true, start: new Date(2013, 1, 13, 0, 0, 0), end: new Date(2013, 1, 13, 0, 0, 0) });

                equal(dataSource.at(0).isAllDay, true);
            });

            test("dblclicking on event calls editEvent", function() {
                var scheduler = setup({
                        dataSource: {
                            data: [ { start: new Date(), end: new Date(), title: "my event" } ]
                        }
                    }),
                    dataSource = scheduler.dataSource,
                    editEvent = stub(scheduler, "editEvent");

                scheduler.view().content.find(".k-event").first().dblclick();

                equal(editEvent.calls("editEvent"), 1);
            });

            test("dblclicking on allday event calls editEvent", function() {
                var scheduler = setup(),
                    dataSource = scheduler.dataSource,
                    editEvent = stub(scheduler, "editEvent");

                scheduler.view().datesHeader.find(".k-event").first().dblclick();

                equal(editEvent.calls("editEvent"), 1);
            });

            test("editEvent creates window instance", function() {
                var scheduler = setup();

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                ok(scheduler._editContainer.data("kendoWindow"));
            });

            test("default settings are applied to the window", function() {
                var scheduler = setup();
                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var wnd = scheduler._editContainer.data("kendoWindow");

                ok(wnd.options.modal);
                ok(!wnd.options.resizable);
                ok(wnd.options.draggable);
                equal(wnd.options.title, "Event");
            });

            test("custom settings are applied to the window", function() {
                var scheduler = setup({ editable: { window: { title: "foo" } } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var wnd = scheduler._editContainer.data("kendoWindow");

                equal(wnd.options.title, "foo");
            });

            test("correct model is passed to the editable instance", function() {
                var scheduler = setup({ editable: { window: { title: "foo" } } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer;
                equal(container.data("kendoEditable").options.model, scheduler.dataSource.at(0));
            });

            test("custom template is used if specified", function() {
                var scheduler = setup({ editable: { template:"<div>#=title#</div>" } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                equal(container.find("div:first").text(), "my event");
            });

            test("custom template as function", function() {
                var scheduler = setup({ editable: { template: kendo.template("foo") } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                equal(container.text(), "fooSaveCancel");
            });

            test("edit event is raised when entering edit mode", 2, function() {
                var scheduler = setup({
                    edit: function(e) {
                        ok(e.container[0], scheduler._editContainer.children(".k-edit-form-container"));
                        equal(e.event, scheduler.dataSource.at(0));
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));
            });

            test("update and cancel buttons are added if template is set", function() {
                var scheduler = setup({ editable: { template:"<div>#=title#</div>" } });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");

                equal(container.find("a.k-scheduler-update").length, 1);
                equal(container.find("a.k-scheduler-cancel").length, 1);
            });

            test("Update and cancel button custom text", function() {
                var scheduler = setup({
                    messages: {
                        save: "myUpdate",
                        cancel: "myCancel"
                    },
                    editable: { template:"<div>#=title#</div>" },
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                equal(container.find("a.k-scheduler-update").text(), "myUpdate");
                equal(container.find("a.k-scheduler-cancel").text(), "myCancel");
            });

            test("clicking update buttons calls update event", function() {
                var scheduler = setup(),
                    saveEvent = stub(scheduler, "saveEvent");

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                scheduler._editContainer.find("a.k-scheduler-update").click();

                ok(saveEvent.calls("saveEvent"));
            });

            test("clicking cancel buttons calls cancel event", function() {
                var scheduler = setup(),
                    cancelEvent = stub(scheduler, "cancelEvent");

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                scheduler._editContainer.find("a.k-scheduler-cancel").click();

                ok(cancelEvent.calls("cancelEvent"));
            });

            test("clicking close button of the window calls cancelEvent", function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid"),
                    cancelEvent = stub(scheduler, "cancelEvent");

                scheduler.editEvent(eventElement);

                var wnd = scheduler._editContainer.data("kendoWindow");
                wnd.wrapper.find(".k-i-close").click();

                equal(cancelEvent.calls("cancelEvent"), 2);
            });

            test("editEvent call cancelEvent", function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid"),
                    cancelEvent = stub(scheduler, "cancelEvent");

                scheduler.editEvent(eventElement);

                equal(cancelEvent.calls("cancelEvent"), 1);
            });

            test("cancelEvent closes the popup", 2, function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                var wnd = scheduler._editContainer.data("kendoWindow");

                wnd.bind("close", function() {
                    ok(true, "Window is not been closed");
                });

                scheduler.cancelEvent();
                ok(!scheduler._editContainer);
            });

            test("cancel event is raised when cancel button is clicked", 2, function() {
                var scheduler = setup({
                        cancel: function(e) {
                            equal(e.event, this.dataSource.at(0));
                            ok(e.container.length);
                        }
                    }),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                $(".k-scheduler-cancel").click();
            });

            test("preventing the cancel event leaves the window open when cancel button is clicked", function() {
                var scheduler = setup({
                    cancel: function(e) {
                        e.preventDefault();
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                $(".k-scheduler-cancel").click();

                equal($(".k-scheduler-cancel:visible").length, 1);
            });

            test("cancel event is raised when window is closed", 2, function() {
                var scheduler = setup({
                    cancel: function(e) {
                        equal(e.event, this.dataSource.at(0));
                        ok(e.container.length);
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                $(scheduler._editContainer.parent().find(".k-i-close")).click();
            });

            test("preventing the cancel event leaves the window open when close button is clicked", function() {
                var scheduler = setup({
                    cancel: function(e) {
                        e.preventDefault();
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);
                scheduler._editContainer.parent().find(".k-i-close").click();

                equal($(".k-scheduler-cancel:visible").length, 1);
            });

            test("saveEvent calls validate", function() {
                 var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                var validate = stub(scheduler._editContainer.data("kendoValidator"), "validate");

                scheduler.saveEvent();

                ok(validate.calls("validate"));
            });

            test("saveEvent item does not leave edit mode if validation fails", function() {
                var scheduler = setup({
                    editable: {
                        template: "<input/>"
                    },
                    dataSource: {
                            data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event" } ],
                            schema: {
                                model: {
                                    fields: {
                                        title: { validation: { custom: function() { return false; } } }
                                    }
                                }
                    }}}),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                scheduler.saveEvent();

                ok(scheduler._editContainer.find(".k-scheduler-update").length);
            });

            test("saveEvent calls DataSource sync", function() {
                var scheduler = setup(),
                    eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                var sync = stub(scheduler.dataSource, "sync");

                scheduler.saveEvent();

                ok(sync.calls("sync"));
            });

            test("sync is not call if save event is canceled", function() {
                var scheduler = setup({
                    save: function(e) {
                        e.preventDefault();
                    }
                }),
                eventElement = scheduler.view().datesHeader.find(".k-event:first").data("uid");

                scheduler.editEvent(eventElement);

                scheduler.saveEvent();

                ok(scheduler._editContainer);
            });

            test("addEvent opens the edit form", function() {
                var scheduler = setup();

                scheduler.addEvent({ start: new Date(), end: new Date() });

                ok(scheduler._editContainer);
            });

            test("all fields are wrapped", function() {
                var scheduler = setup();

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div").not(".k-edit-buttons");

                equal(elements.length, 10);
                ok(elements.eq(0).hasClass("k-edit-label"));
                equal(elements.eq(0).find("label").attr("for"), "title");
                equal(elements.eq(1).data("container-for"), "title");
                ok(elements.eq(1).hasClass("k-edit-field"));
            });

            test("non editable field value is shown", function() {
                var scheduler = setup({
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event" } ],
                        schema: { model: { fields: { title: { editable:false } } } }
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div").not(".k-edit-buttons");

                equal(elements.length, 10);
                ok(elements.eq(0).hasClass("k-edit-label"));
                equal(elements.eq(0).find("label").attr("for"), "title");
                equal(elements.eq(1).text(), "my event");
                ok(elements.eq(1).hasClass("k-edit-field"));
            });

            test("description editor is not render is does not exist", function() {
                var scheduler = setup({
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event" } ]
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div");

                ok(!elements.filter("[data-container-for=description]").length);
            });

            test("render description editor if exists", function() {
                var scheduler = setup({
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), isAllDay: true, title: "my event", description: "foo" } ]
                    }
                });

                scheduler.editEvent(scheduler.view().datesHeader.find(".k-event:first").data("uid"));

                var container = scheduler._editContainer.children("div.k-edit-form-container");
                var elements = container.children("div");

                ok(elements.filter("[data-container-for=description]").length);
            });

            module("recurrence editing", {
                setup: function() {
                    container = document.createElement("div");
                    document.body.appendChild(container);
                },
                teardown: function() {
                    $(container).closest(".k-scheduler").kendoScheduler("destroy").remove();
                }
            });

            test("show recurring dialog", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), title: "my event", recurrence: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");
                scheduler.editEvent(eventUID);

                ok(scheduler._recurringDialog);
                ok(scheduler._recurringDialog.element.is(":visible"));
            });

            test("close recurring dialog on button click", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), title: "my event", recurrence: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");

                stub(scheduler, {
                    addEvent: scheduler.addEvent
                });

                scheduler.editEvent(eventUID);

                //edit current instance
                scheduler._recurringDialog.element.find("button:first").triggerHandler("click");

                equal(scheduler._recurringDialog, null);
            });

            test("create exception", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { start: new Date(), end: new Date(), title: "my event", recurrence: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");

                stub(scheduler, {
                    addEvent: scheduler.addEvent
                });

                scheduler.editEvent(eventUID);

                //edit current instance
                scheduler._recurringDialog.element.find("button:first").triggerHandler("click");

                equal(scheduler.calls("addEvent"), 1);
            });

            test("edit series", function() {
                var scheduler = setup({
                    views: ["week"],
                    dataSource: {
                        data: [ { id: "1", start: new Date(), end: new Date(), title: "my event", recurrence: "FREQ=DAILY"} ]
                    }
                });

                var eventUID = scheduler.element.find(".k-event:last").data("uid");

                stub(scheduler, {
                    _editEvent: scheduler._editEvent
                });

                scheduler.editEvent(eventUID);

                //edit current instance
                scheduler._recurringDialog.element.find("button:last").triggerHandler("click");

                var model = scheduler.args("_editEvent", 0)[0];

                equal(scheduler.calls("_editEvent"), 1);
                equal(model.uid, scheduler.dataSource.at(0).uid);
            });

        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
