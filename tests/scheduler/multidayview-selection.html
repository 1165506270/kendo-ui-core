<!DOCTYPE html>
<html>
    <head>
        <title>Scheduler MultidayView selection</title>
        <script src="../jquery-loader.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.calendar.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.window.js"></script>
        <script src="../../src/kendo.scheduler.view.js"></script>
        <script src="../../src/kendo.scheduler.dayview.js"></script>
        <script src="../../src/kendo.scheduler.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
        <link href="../../styles/web/kendo.common.min.css" rel="stylesheet" />
        <link href="../../styles/web/kendo.default.min.css" rel="stylesheet" />
    </head>
    <body>
        <h1 id="qunit-header">Scheduler MultidayView selection</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var MultiDayView = kendo.ui.MultiDayView,
                container;

            var MyDayView = MultiDayView.extend({
                init: function(element, options) {
                    var that = this;

                    MultiDayView.fn.init.call(that, element, options);
                },
                calculateDateRange: function() {
                    this._render(this.options.dates);
                }
            });

            function setup(options) {
                options = options || [];
                return new MyDayView(container, $.extend({ majorTick: 120 }, options));
            }

            function createSelection(options) {
                var start, end;
                if (options instanceof Date) {
                    start = new Date(options);
                    end = new Date(start.getTime() + (30 * kendo.date.MS_PER_MINUTE));
                    options = {
                        start: start,
                        end: end
                    };
                }

                return $.extend({ events: [] }, options);
            }

            module("Multi Day View selection", {
                setup: function() {
                    container = document.createElement("div");
                    document.body.appendChild(container);
                    container = $(container).addClass("k-scheduler").css({
                        width: 1000,
                        height: 800
                    });
                },
                teardown: function() {
                    $(container).remove();
                }
            });

            test("View moves selection by week length offset when navigate to future period", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] });
                var selection = {
                    start: new Date(2013, 6, 6),
                    end: new Date(2013, 6, 6, 0, 30)
                };

                view.moveSelectionByOffset(selection);

                deepEqual(selection.start, new Date(2013, 6, 8));
                deepEqual(selection.end, new Date(2013, 6, 8, 0, 30));
            });

            test("View moves selection by week length offset when navigate to past period", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] });
                var selection = {
                    start: new Date(2013, 6, 9),
                    end: new Date(2013, 6, 9, 0, 30)
                };

                view.moveSelectionByOffset(selection);

                deepEqual(selection.start, new Date(2013, 6, 7));
                deepEqual(selection.end, new Date(2013, 6, 7, 0, 30));
            });

            test("View move last selected slot when navigate to future period", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] });
                var selection = {
                    start: new Date(2013, 6, 6, 23, 30),
                    end: new Date(2013, 6, 7, 0, 0)
                };

                view.moveSelectionByOffset(selection);

                deepEqual(selection.start, new Date(2013, 6, 7, 23, 30));
                deepEqual(selection.end, new Date(2013, 6, 8, 0, 0));
            });

            test("View move last selected slot when navigate to past period", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] });
                var selection = {
                    start: new Date(2013, 6, 8, 23, 30),
                    end: new Date(2013, 6, 9, 0, 0)
                };

                view.moveSelectionByOffset(selection);

                deepEqual(selection.start, new Date(2013, 6, 7, 23, 30));
                deepEqual(selection.end, new Date(2013, 6, 8, 0, 0));
            });

            test("View moveSelectionByOffset clears selected events", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] });
                var selection = {
                    start: new Date(2013, 6, 8, 23, 30),
                    end: new Date(2013, 6, 9, 0, 0),
                    events: ["1"]
                };

                view.moveSelectionByOffset(selection);

                equal(selection.events.length, 0);
            });

            test("View adjust start/end date based on view.startDate/view.endDate when navigate to future", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] });
                var selection = {
                    start: new Date(2013, 6, 6, 23, 30),
                    end: new Date(2013, 6, 9, 0, 0)
                };

                view.moveSelectionByOffset(selection);

                deepEqual(selection.start, new Date(2013, 6, 7, 23, 30));
                deepEqual(selection.end, new Date(2013, 6, 8, 0, 0));
            });

            test("View adjust start/end date based on view.startDate/view.endDate when navigate to past", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] });
                var selection = {
                    start: new Date(2013, 6, 6, 23, 30),
                    end: new Date(2013, 6, 8, 0, 0)
                };

                view.moveSelectionByOffset(selection);

                deepEqual(selection.start, new Date(2013, 6, 7, 23, 30));
                deepEqual(selection.end, new Date(2013, 6, 8, 0, 0));
            });

            test("View selects cell", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] }),
                    selection = createSelection(new Date(2013, 6, 7));

                view.select(selection);

                ok(view.content.find("table td:first").hasClass("k-state-selected"));
            });

            test("View selects multiple cells", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] }),
                    selection = createSelection({ start: new Date(2013, 6, 7, 0, 30), end: new Date(2013, 6, 7, 2, 30) });

                view.select(selection);

                var allCells = view.content.find("table td"),
                    cells = allCells.filter("td.k-state-selected");

                equal(cells.length, 2);
                equal(cells[0], allCells[1]);
                equal(cells[1], allCells[2]);

            });

            test("View selects selection bigger than current column", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] }),
                    selection = createSelection({ start: new Date(2013, 6, 7, 0, 30), end: new Date(2013, 6, 8, 2, 30) });

                view.select(selection);

                var allCells = view.content.find("table td"),
                    cells = allCells.filter("td.k-state-selected");

                equal(cells.length, 26);
            });

            test("View selects selection between 3 columns", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8), new Date(2013, 6, 9)] }),
                    selection = createSelection({ start: new Date(2013, 6, 7, 0, 30), end: new Date(2013, 6, 9, 2, 30) });

                view.select(selection);

                var allCells = view.content.find("table td"),
                    cells = allCells.filter("td.k-state-selected");

                equal(cells.length, 50);
            });

            test("View selects header cells if multiple columns are selected", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8), new Date(2013, 6, 9)] }),
                    selection = createSelection({ start: new Date(2013, 6, 7, 0, 30), end: new Date(2013, 6, 9, 2, 30) });

                view.select(selection);

                var cells = view.datesHeader.find("td.k-state-selected");

                equal(cells.length, 3);
            });

            test("View does not select header cells if onlu one column is selected", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] }),
                    selection = createSelection({ start: new Date(2013, 6, 7, 0, 30), end: new Date(2013, 6, 7, 2, 30) });

                view.select(selection);

                var cells = view.datesHeader.find("td.k-state-selected");

                equal(cells.length, 0);
            });

            test("View clear selection before new select", function() {
                var view = setup({ dates: [new Date(2013, 6, 7)] });

                view.select(createSelection(new Date(2013, 6, 7)));
                view.select(createSelection(new Date(2013, 6, 7, 0, 30)));

                equal(view.content.find(".k-state-selected").length, 1);
            });

            test("View does not select content cells if selection starts from allDayEvent", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] }),
                    selection = createSelection({ start: new Date(2013, 6, 7, 0, 30), end: new Date(2013, 6, 8, 0, 30), isAllDay: true });

                view.select(selection);

                var cells = view.datesHeader.find("td.k-state-selected");

                equal(cells.length, 2);
                equal(view.content.find("table td.k-state-selected").length, 0);
            });

            test("View select event by uid", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] }),
                    uid = kendo.guid();

                view.render([
                    { uid: uid, start: new Date(2013, 6, 7, 2), end: new Date(2013, 6, 7, 4), title: "Test" }
                ]);

                var selection = createSelection({
                    start: new Date(2013, 6, 7, 2),
                    end: new Date(2013, 6, 7, 4),
                    events: [uid]
                });

                view.select(selection);

                equal(view.content.find("td.k-state-selected").length, 0);
                equal(view.content.find(".k-event").filter(".k-state-selected").length, 1);
            });

            test("View select multiple events by UIDs", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] }),
                    uid1 = kendo.guid(),
                    uid2 = kendo.guid();

                view.render([
                    { uid: uid1, start: new Date(2013, 6, 7, 2), end: new Date(2013, 6, 7, 4), title: "Test" },
                    { uid: uid2, start: new Date(2013, 6, 7, 6), end: new Date(2013, 6, 7, 8), title: "Test" }
                ]);

                var selection = createSelection({
                    start: new Date(2013, 6, 7, 6),
                    end: new Date(2013, 6, 7, 8),
                    events: [uid1, uid2]
                });

                view.select(selection);

                equal(view.content.find("td.k-state-selected").length, 0);
                equal(view.content.find(".k-event").filter(".k-state-selected").length, 2);
            });

            test("View select cells if cannot find one of the selected events", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] }),
                    uid1 = kendo.guid(),
                    uid2 = kendo.guid();

                view.render([
                    { uid: kendo.guid(), start: new Date(2013, 6, 7, 2), end: new Date(2013, 6, 7, 4), title: "Test" },
                    { uid: uid2, start: new Date(2013, 6, 7, 6), end: new Date(2013, 6, 7, 8), title: "Test" }
                ]);

                var selection = createSelection({
                    start: new Date(2013, 6, 7, 6),
                    end: new Date(2013, 6, 7, 8),
                    events: [uid1, uid2]
                });

                view.select(selection);

                equal(view.content.find("td.k-state-selected").length, 2);
                equal(view.content.find(".k-event").filter(".k-state-selected").length, 0);
            });

            test("View scrolls to the last selected event", function() {
                var view = setup({ dates: [new Date(2013, 6, 7), new Date(2013, 6, 8)] }),
                    uid1 = kendo.guid(),
                    uid2 = kendo.guid();

                view.render([
                    { uid: uid1, start: new Date(2013, 6, 7, 2), end: new Date(2013, 6, 7, 4), title: "Test" },
                    { uid: uid2, start: new Date(2013, 6, 7, 6), end: new Date(2013, 6, 7, 8), title: "Test" }
                ]);

                var selection = createSelection({
                    start: new Date(2013, 6, 7, 6),
                    end: new Date(2013, 6, 7, 8),
                    events: [uid1, uid2]
                });

                view.select(selection);

                stub(view, {
                    _scrollTo: view._scrollTo
                });

                view.select(selection);

                equal(view.calls("_scrollTo"), 1);
                equal(view.args("_scrollTo")[0], view.content.find(".k-event:last")[0]);
            });

        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
