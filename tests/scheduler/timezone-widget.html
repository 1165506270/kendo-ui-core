<!DOCTYPE html>
<html>
    <head>
        <title>Timezone widget</title>
        <script src="../jquery-loader.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.dropdownlist.js"></script>
        <script src="../../src/kendo.timezones.js"></script>
        <script src="../../src/kendo.scheduler.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">Timezone widget</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var TimezoneEditor = kendo.ui.TimezoneEditor,
                div;

            module("kendo.ui.TimezoneEditor initialization", {
                setup: function() {
                    div = $("<div />").appendTo(document.body);
                },
                teardown: function() {
                    div.data("kendoTimezoneEditor").destroy();
                    div.remove();
                }
            });

            test("kendoTimezoneEditor attaches a reccurrenceEditor object to target", function() {
                div.kendoTimezoneEditor();

               ok(div.data("kendoTimezoneEditor") instanceof TimezoneEditor);
            });

            test("TimezoneEditor creates query from countries_zones", function() {
                var widget = new TimezoneEditor(div);

                ok(widget._zonesQuery);
                equal(widget._zonesQuery.data.length, kendo.timezone.countries_zones.length);
            });

            test("TimezoneEditor renders countries dropdownlist", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first"),
                    ddl = country.data("kendoDropDownList");

                ok(country);
                ok(ddl);

                ok(country.attr("id"))
                equal(ddl.ul.children().length, kendo.timezone.countries.length + 1 /*option label*/);
            });

            test("TimezoneEditor renders zones dropdownlist", function() {
                var widget = new TimezoneEditor(div),
                    zone = div.find("[data-role=dropdownlist]:last"),
                    ddl = zone.data("kendoDropDownList");

                ok(zone);
                ok(ddl);

                ok(!ddl.wrapper.is(":visible"));
                equal(ddl.options.dataSource.length, kendo.timezone.countries_zones.length);
                equal(ddl.options.cascadeFrom, div.find("[data-role=dropdownlist]:first").attr("id"));
            });

            test("TimezoneEditor selects country based on timezone", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                widget.value("Europe/Sofia");

                equal(widget.value(), "Europe/Sofia");
                equal(zone.value(), "Europe/Sofia");
                equal(country.value(), "BG");

                ok(!zone.wrapper.is(":visible"));
            });

            test("TimezoneEditor shows second dropdownlist if more timezones are available", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                widget.value("America/New_York");

                ok(zone.wrapper.is(":visible"));
                equal(zone.value(), "America/New_York");
                equal(country.value(), "US");
            });

            test("TimezoneEditor clears selection if no such timezone", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                widget.value("America/New_York");
                widget.value("test");

                ok(!zone.wrapper.is(":visible"));
                equal(country.value(), "");
            });

            module("kendo.ui.TimezoneEditor interaction", {
                setup: function() {
                    div = $("<div />").appendTo(document.body);
                },
                teardown: function() {
                    div.data("kendoTimezoneEditor").destroy();
                    div.remove();
                }
            });

            test("Select country selects timezone", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                country.select(1);

                equal(widget.value(), zone.value());
            });

            test("Select option label clears widget value", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                country.select(1);
                country.select(0);

                equal(widget.value(), "");
                equal(widget.value(), zone.value());
            });

            test("Select specific value from second dropdownlist changes widget value", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                country.value("US");
                zone.select(2);

                equal(widget.value(), zone.value());
            });

            test("Select specific value from second dropdownlist changes widget value", function() {
                var widget = new TimezoneEditor(div),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                country.value("US");
                zone.select(2);

                equal(widget.value(), zone.value());
            });

            module("kendo.ui.TimezoneEditor events", {
                setup: function() {
                    div = $("<div />").appendTo(document.body);
                },
                teardown: function() {
                    div.data("kendoTimezoneEditor").destroy();
                    div.remove();
                }
            });

            test("Select country triggers change", 1, function() {
                var widget = new TimezoneEditor(div, {
                        change: function() {
                            ok(true);
                        }
                    }),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                country.value("US");
            });

            test("Clear timezone triggers change", 2, function() {
                var widget = new TimezoneEditor(div, {
                        change: function() {
                            ok(true);
                        }
                    }),
                    country = div.find("[data-role=dropdownlist]:first").data("kendoDropDownList"),
                    zone = div.find("[data-role=dropdownlist]:last").data("kendoDropDownList");

                country.value("US");
                country.value("");
            });

        </script>
    </body>
</html>
