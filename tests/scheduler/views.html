<!DOCTYPE html>
<html>
    <head>
        <title>Scheduler Views rendering</title>
        <link href="../../styles/web/kendo.common.min.css" rel="stylesheet" />
        <script src="../jquery-loader.js"></script>
        <script type="text/javascript" src="../qunit/qunit/qunit.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.scheduler.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" type="text/css" />
    </head>
    <body>
        <h1 id="qunit-header">Scheduler Views rendering</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var MultiDayView = kendo.ui.MultiDayView,
                container,
                rightOffset = 30;

            var MyDayView = MultiDayView.extend({
                init: function(element, options) {
                    var that = this;

                    MultiDayView.fn.init.call(that, element, options);
                },
                render: function() {
                    this._render(this.options.dates);
                }
            });

            function slotHeight(table, slotsCount) {
                var height = Math.floor(table.height() / table[0].rows.length);
                return Math.floor((height * slotsCount) - height * 0.10);
            }

            function setup(options) {
                return new MyDayView(container, $.extend({ majorTick: 120 }, options));
            }

            module("Multi Day View rendering", {
                setup: function() {
                    container = document.createElement("div");
                    document.body.appendChild(container);
                    container = $(container).addClass("k-scheduler");
                },
                teardown: function() {
                    $(container).remove();
                }
            });

            test("renders times header slots", function() {
                var view = setup();
                view.render();

                ok(container.find(".k-scheduler-times").length);
                equal(view.timesHeader[0], container.find(".k-scheduler-times")[0]);
            });

            test("renders headers for selected dates", function() {
                var view = setup({ dates: [new Date("1/2/2013"), new Date("2/1/2013")], allDaySlot: false });
                view.render();

                ok(view.datesHeader.hasClass("k-scheduler-header"));
                equal(view.datesHeader.find("col").length, 2);
                equal(view.datesHeader.find("th").length, 2);
            });

            test("k-today is render if date is today", function() {
                var view = setup({ dates: [new Date()] });

                view.render();

                equal(view.datesHeader.find("th.k-today").length, 1);
            });

            test("k-today is not render if date is not today", function() {
                var view = setup({ dates: [new Date("1/2/2013")] });

                view.render();

                ok(!view.datesHeader.find("th.k-today").length);
            });

            test("dates are formatted", function() {
                var view = setup({ dates: [new Date("1/26/2013")] });

                view.render();

                equal(view.datesHeader.find("th").text(), "Sat 1/26");
            });

            test("dates are formatted with custom format", function() {
                var view = setup({ headerDateFormat: "d", dates: [new Date("1/26/2013")] });

                view.render();

                equal(view.datesHeader.find("th").text(), "1/26/2013");
            });

            test("title is read from the options", function() {
                var view = setup({ title: "the title" });

                equal(view.title, "the title");
            });

            test("render time slots", function() {
                var view = setup({ });

                view.render();

                equal(view.times.find("th").length, 25);
                equal(view.times.find("th:first").text(), "00:00");
                equal(view.times.find("th:last").text(), "00:00");
            });

            test("render time slots with not exact start time", function() {
                var view = setup({
                    startTime: new Date(2001, 1, 1, 10, 10, 0)
                });

                view.render();

                equal(view.times.find("th").length, 15);
                equal(view.times.find("th:first").text(), "10:10");
            });

            test("time is show in major time slots", function() {
                var view = setup({
                        startTime: new Date(2000, 0, 1, 10, 0, 0),
                        endTime: new Date(2000, 0, 1, 11, 0, 0),
                        majorTick: 30
                    });

                view.render();
                var cells = view.times.find("th");

                equal(cells.first().text(), "10:00");
                equal(cells.eq(1).html(), "&nbsp;");
                equal(cells.eq(2).text(), "10:30");
                equal(cells.eq(3).html(), "&nbsp;");
                equal(cells.eq(4).text(), "11:00");
            });

            test("time slots does not overflow endTime", function() {
                var view = setup({
                        startTime: new Date(2000, 0, 1, 0, 0, 0),
                        endTime: new Date(2000, 0, 1, 23, 59, 0),
                        numberOfTimeSlots: 8
                    });

                view.render();

                equal(view.times.find("tr:not(.k-last) em:not(:empty):last").text(), "22:00");
                equal(view.times.find("tr.k-last").text(), "23:59");
                equal(view.times.find("th").length, 97);
            });

            test("start time is later than end time", function() {
                var view = setup({
                        startTime: new Date(2000, 0, 1, 13, 0, 0),
                        endTime: new Date(2000, 0, 1, 10, 0, 0),
                    });

                view.render();

                equal(view.times.find("tr:not(.k-last) em:not(:empty):last").text(), "09:00");
                equal(view.times.find("tr.k-last").text(), "10:00");
                equal(view.times.find("th").length, 22);
            });

            test("last time slot has k-last class applied", function() {
                 var view = setup({ });

                view.render();

                ok(view.times.find("tr:last").hasClass("k-last"));
            });

            test("render day slots", function() {
                var view = setup({
                    dates: [
                        new Date("1/26/2013"),
                        new Date("1/27/2013")
                    ]
                });

                view.render();

                equal(view.content.find("tr").length, 24);
                equal(view.content.find("col").length, 2);
                equal(view.content.find("td").length, 48);
            });

            test("apply css to day slot", function() {
                var view = setup({
                    dates: [
                        new Date("1/26/2013")
                    ]
                });

                view.render();

                equal(view.content.find("tr.k-middle-row").length, 12);
                equal(view.content.find("tr:not(.k-middle-row)").length, 12);
            });

            test("content is update on multiple render calls", function() {
                var view = setup({
                    dates: [
                        new Date("1/26/2013")
                    ]
                });

                view.render();
                view.render();
                equal(container.find(".k-scheduler-content").length, 1);
                equal(container.find(".k-scheduler-content > table").length, 1);
            });

            test("datesHeader is update on multiple render calls", function() {
                var view = setup({
                    dates: [
                        new Date("1/26/2013")
                    ],
                    allDaySlot: false
                });

                view.render();
                view.render();

                equal(container.find(".k-scheduler-header").length, 1);
                equal(container.find(".k-scheduler-header-wrap > table").length, 1);
            });

            test("destroy clears views html", function() {
                var view = setup({
                    dates: [
                        new Date("1/26/2013")
                    ]
                });

                view.render();
                view.destroy();

                ok(!view.content);
                ok(!view.times);
                ok(!view.timesHeader);
                ok(!view.datesHeader);
            });
/*
            test("view content height is set", function() {
                 container.css("height", 500);

                 var view = setup({
                    dates: [
                        new Date("1/26/2013")
                    ]
                });

                view.render();

                equal(view.content.height(), 500 - (view.datesHeader.height() - view.footer.height()));
            });
*/
            test("content and times heights are equal", function() {
                container.css("height", 500);

                 var view = setup({
                    dates: [
                        new Date("1/26/2013")
                    ]
                });

                view.render();

                equal(view.content.height(), view.times.height());
            });

            test("all day slot is rendered", function() {
                var view = setup({
                    dates: [
                        new Date("1/26/2013")
                    ]
                });

                view.render();

                equal(view.datesHeader.find(".k-scheduler-table").length, 2);
                equal(view.allDayHeader[0], view.datesHeader.find(".k-scheduler-table:last")[0]);
                equal(view.allDayHeader.find("td").length, 1);
            });

            test("all day slot is not rendered if disabled", function() {
                var view = setup({
                    allDaySlot: false,
                    dates: [
                        new Date("1/26/2013")
                    ]
                });

                view.render();

                equal(view.datesHeader.find(".k-scheduler-table").length, 1);
                ok(!view.allDayHeader);
            });

            test("render footer toolbar", function() {
                var view = setup();

                view.render();

                ok(view.footer);
                ok(view.footer.hasClass("k-scheduler-footer"));
            });

            test("display basic event", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").length, 1);
                equal(view.content.find(".k-appointment dd").text(), "my event");
            });

            test("uid is render", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{ uid: "foo", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                equal(view.content.find(".k-appointment").attr("data-uid"), "foo");
            });

            test("title attribute is set to the event wrapper element", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").attr("title"), "(10:00 - 11:00): my event");
            });


            test("multiple events are displayed", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "event1" },
                    {uid:"uid", start: new Date(2013, 1, 26, 13, 0, 0), end: new Date(2013, 1, 26, 14, 0, 0), title: "event2" }
                ];

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").length, 2);
                equal(view.content.find(".k-appointment:first dd").text(), "event1");
                equal(view.content.find(".k-appointment:last dd").text(), "event2");
            });

            test("old events are removed on multiple databind calls", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);
                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").length, 1);
                equal(view.content.find(".k-appointment dd").text(), "my event");
            });

            test("format event date", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment dt").text(), "10:00 - 11:00");
            });

            test("custom event date format", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        eventTimeFormat: "starts at: {0:H:mm} - ends at: {1:H:mm}",
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment dt").text(), "starts at: 10:00 - ends at: 11:00");
            });

            test("custom event template", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        eventTemplate: '<div class="k-appointment">${title}</div>',
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").text(), "my event");
            });

            test("get time slot index for date", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [ selectedDate ]
                    });

                view.render(selectedDate);
                var index = view._timeSlotIndex(new Date(2013, 1, 26, 10, 0, 0));

                equal(index, 10);
            });

            test("position basic event in the correct time slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    }),
                    events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }],
                    timeSlotPosition,
                    eventPosition;

                view.render(selectedDate);

                view.renderEvents(events);

                eventPosition = view.content.find("div.k-appointment").offset();
                timeSlotPosition = view.content.find("tr").eq(10).offset();

                equal(timeSlotPosition.top, eventPosition.top);
                equal(timeSlotPosition.left, eventPosition.left);
            });

            test("set the height of the event", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    }),
                    events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "my event" }];

                view.render(selectedDate);

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").height(), slotHeight(view.content.find(">table"), 2));

            });

            test("set the height of the event when end time is near the end of the slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    }),
                    events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 12, 40, 0), title: "my event" }];

                view.render(selectedDate);

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").height(), slotHeight(view.content.find(">table"), 3));
            });


            test("the height of the event with equal start and end is single row", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    }),
                    events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 10, 0, 0), title: "my event" }];

                view.render(selectedDate);

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").height(), slotHeight(view.content.find(">table"), 1));
            });

            test("the width of single event is the time slot without the offset", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    }),
                    events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 10, 0, 0), title: "my event" }];

                view.render(selectedDate);

                view.renderEvents(events);

                equal(view.content.find("div.k-appointment").width(), view.content.find("td:eq(10)").width() - rightOffset);
            });

            test("multiple day events are added to all day slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 27, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                equal(view.datesHeader.find("div.k-appointment").length, 1);
                equal(view.datesHeader.find(".k-appointment dd").text(), "my event");

            });

            test("events set as all day are added to all day slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), isAllDay: true, title: "all day event" }];

                view.renderEvents(events);

                equal(view.datesHeader.find("div.k-appointment").length, 1);
                equal(view.datesHeader.find(".k-appointment dd").text(), "all day event");

            });

            test("multiple day event position is set to the date slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 27, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);
                var eventOffset = view.datesHeader.find("div.k-appointment").offset();
                var slotOffset = view.allDayHeader.find("td").eq(0).offset();
                equal(eventOffset.top, slotOffset.top);
                equal(eventOffset.left, slotOffset.left);
            });

            test("multiple day event position is set to the date slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate,
                           new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 27, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);
                var eventOffset = view.datesHeader.find("div.k-appointment").offset();
                var slotOffset = view.allDayHeader.find("td").eq(0).offset();
                var slotWidth = view.allDayHeader.find("td").innerWidth();

                equal(eventOffset.top, slotOffset.top);

                equal(eventOffset.left, slotOffset.left);
                equal(view.datesHeader.find("div.k-appointment").width(), slotWidth * 2);
            });

            test("position multiday event which starts before the selected range", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 24, 10, 0, 0), end: new Date(2013, 1, 26, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var slotWidth = view.allDayHeader.find("td").width();

                equal(view.datesHeader.find("div.k-appointment").length, 1);
                equal(view.datesHeader.find("div.k-appointment").width(), slotWidth);
            });

            test("position multiday event which ends after the selected range", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 27, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var slotWidth = view.allDayHeader.find("td").width();

                equal(view.datesHeader.find("div.k-appointment").length, 1);
                equal(view.datesHeader.find("div.k-appointment").width(), slotWidth);
            });

            test("position multiday event which starts before and ends after the selected range", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 24, 10, 0, 0), end: new Date(2013, 1, 27, 11, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var slotWidth = view.allDayHeader.find("td").width();

                equal(view.datesHeader.find("div.k-appointment").length, 1);
                equal(view.datesHeader.find("div.k-appointment").width(), slotWidth);
            });

            test("position day event which starts before the slot start time", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        startTime: new Date(2013, 1, 26, 10, 0, 0),
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 9, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var eventElement = view.content.find("div.k-appointment");
                equal(eventElement.length, 1);
                equal(eventElement.offset().top, view.content.find("tr:first").offset().top);
                equal(eventElement.offset().left, view.content.find("tr:first").offset().left);
            });

            test("position day event which ends after the slot end time", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        endTime: new Date(2013, 1, 26, 11, 0, 0),
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 9, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "my event" }];

                view.renderEvents(events);
                var eventElement = view.content.find("div.k-appointment");

                equal(eventElement.length, 1);
                equal(eventElement.offset().top, view.content.find("tr").eq(9).offset().top);
                equal(eventElement.offset().left, view.content.find("tr").eq(9).offset().left);
                equal(eventElement.height(), slotHeight(view.content.find("table"), 2));
            });

            test("does not position day event which is same day but outside of the slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        startTime: new Date(2013, 1, 26, 9, 0, 0),
                        endTime: new Date(2013, 1, 26, 11, 0, 0),
                        dates: [
                           selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 7, 0, 0), end: new Date(2013, 1, 26, 8, 0, 0), title: "my event" }];

                view.renderEvents(events);
                ok(!view.content.find("div.k-appointment").length);
            });

            test("position day event which start before and ends after the slot end time", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        startTime: new Date(2013, 1, 26, 9, 0, 0),
                        endTime: new Date(2013, 1, 26, 11, 0, 0),
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var eventElement = view.content.find("div.k-appointment");
                equal(eventElement.length, 1);
                equal(eventElement.offset().top, view.content.find("tr").eq(0).offset().top);
                equal(eventElement.height(), slotHeight(view.content.find("table"), 2));
            });

            test("position day event which start in the last slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 27, 9, 0, 0), end: new Date(2013, 1, 27, 10, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var eventElement = view.content.find("div.k-appointment");
                equal(eventElement.length, 1);
                equal(eventElement.offset().top, view.content.find("tr").eq(9).offset().top);
                equal(eventElement.height(), slotHeight(view.content.find("table"), 1));
            });

            test("positon multiple single day events with same start time", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "second event" }
                ];

                view.renderEvents(events);

                var eventElements = view.content.find("div.k-appointment");
                var slot = view.content.find("tr").eq(8).find("td:first");

                equal(eventElements.length, 2);

                equal(eventElements.first().offset().top, slot.offset().top);
                equal(eventElements.first().offset().left, slot.offset().left);
                equal(eventElements.first().height(), slotHeight(view.content.find("table"), 4));
                equal(eventElements.first().width(), Math.round((slot.width() - rightOffset) / 2));
                equal(eventElements.last().offset().top, slot.offset().top);
                equal(eventElements.last().offset().left, slot.offset().left + eventElements.first().width());
                equal(eventElements.last().height(), slotHeight(view.content.find("table"), 4));
                equal(eventElements.last().width(), Math.floor((slot.width() - rightOffset) / 2));
            });

            test("events with same start time - does not move events from other date slots", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "second event" },
                    {uid:"uid", start: new Date(2013, 1, 27, 8, 0, 0), end: new Date(2013, 1, 27, 12, 0, 0), title: "other slot event" }
                ];

                view.renderEvents(events);

                var eventElements = view.content.find("div.k-appointment");
                var firstSlot = view.content.find("tr").eq(8).find("td:first");
                var secondSlot = view.content.find("tr").eq(8).find("td:last");

                equal(eventElements.length, 3);

                equal(eventElements.first().offset().top, firstSlot.offset().top);

                equal(eventElements.eq(1).offset().left, firstSlot.offset().left + eventElements.first().width());

                equal(eventElements.last().offset().top, secondSlot.offset().top);
            });

            test("events with same start time - does not move events from same date slots with which does not collide", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "second event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 13, 0, 0), end: new Date(2013, 1, 26, 14, 0, 0), title: "no collision" }
                ];

                view.renderEvents(events);

                var eventElements = view.content.find("div.k-appointment");
                var firstTimeSlot = view.content.find("tr").eq(8).find("td:first");
                var secondTimeSlot = view.content.find("tr").eq(13).find("td:first");

                equal(eventElements.length, 3);

                equal(eventElements.first().offset().top, firstTimeSlot.offset().top);

                equal(eventElements.eq(1).offset().left, firstTimeSlot.offset().left + eventElements.first().width());

                equal(eventElements.last().offset().top, secondTimeSlot.offset().top);
                equal(eventElements.last().offset().left, secondTimeSlot.offset().left);
            });

            test("long events reposition other events in the same date slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 16, 0, 0), title: "long event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "second event" }
                ];

                view.renderEvents(events);

                var eventElements = view.content.find("div.k-appointment");
                var firstTimeSlot = view.content.find("tr").eq(8).find("td:first");
                var secondTimeSlot = view.content.find("tr").eq(10).find("td:first");

                equal(eventElements.first().offset().top, firstTimeSlot.offset().top);
                equal(eventElements.last().offset().top, secondTimeSlot.offset().top);
                equal(eventElements.last().offset().left, secondTimeSlot.offset().left + eventElements.first().width());
            });

            test("long events reposition other events in the same time slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 16, 0, 0), title: "long event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 9, 0, 0), title: "same slot event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 9, 0, 0), title: "second same slot event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "second event" }
                ];

                view.renderEvents(events);

                var eventElements = view.content.find("div.k-appointment");
                var firstTimeSlot = view.content.find("tr").eq(8).find("td:first");
                var secondTimeSlot = view.content.find("tr").eq(10).find("td:first");

                equal(eventElements.first().offset().top, firstTimeSlot.offset().top);
                equal(eventElements.first().width(), Math.round((firstTimeSlot.width() - rightOffset) / 3));
                equal(eventElements.eq(1).offset().left, firstTimeSlot.offset().left + eventElements.first().width());
                equal(eventElements.last().offset().top, secondTimeSlot.offset().top);
                equal(eventElements.last().offset().left, secondTimeSlot.offset().left + eventElements.first().width());
            });

            test("long events reposition other events in the same date slot with multiple long overlapping event", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 16, 0, 0), title: "long event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 9, 0, 0), title: "same slot event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 9, 0, 0), title: "second same slot event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 9, 0, 0), title: "another second same slot event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "second event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 10, 0, 0), end: new Date(2013, 1, 26, 18, 0, 0), title: "another log event which overlaps the second one" },
                    {uid:"uid", start: new Date(2013, 1, 26, 17, 0, 0), end: new Date(2013, 1, 26, 19, 0, 0), title: "another log event" }
                ];

                view.renderEvents(events);

                var eventElements = view.content.find("div.k-appointment");
                var firstTimeSlot = view.content.find("tr").eq(8).find("td:first");
                var secondTimeSlot = view.content.find("tr").eq(10).find("td:first");
                var thirdTimeSlot = view.content.find("tr").eq(16).find("td:first");

                equal(eventElements.first().offset().top, firstTimeSlot.offset().top);
                equal(eventElements.first().width(), Math.round((firstTimeSlot.width() - rightOffset) / 4));

                equal(eventElements.eq(1).offset().left, firstTimeSlot.offset().left + eventElements.first().width());

                equal(eventElements.eq(4).offset().left, secondTimeSlot.offset().left + eventElements.first().width());
                equal(eventElements.eq(5).offset().left, eventElements.eq(4).offset().left + eventElements.eq(4).width());

                equal(eventElements.eq(6).offset().left, thirdTimeSlot.offset().left);
            });

            test("same time slot events are sorted by start time and end time", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 13, 0, 0), title: "second event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "same as first" }
                ];

                view.renderEvents(events);

                var eventElements = view.content.find("div.k-appointment");
                equal(eventElements.eq(0).find("dd").text(), "second event");
                equal(eventElements.eq(1).find("dd").text(), "first event");
                equal(eventElements.eq(2).find("dd").text(), "same as first");
            });


            test("slotindex is render as attribute", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var eventElement = view.content.find("div.k-appointment");

                equal(eventElement.attr("data-slot-idx"), 0);
            });

            test("start end index is render as attribute", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [{uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "my event" }];

                view.renderEvents(events);

                var eventElement = view.content.find("div.k-appointment");

                equal(eventElement.attr("data-start-end-idx"), "8-12");
            });

            test("position multiple overlapping all day events in a single slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 27, 12, 0, 0), title: "first event" },
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 27, 13, 0, 0), title: "second event" }
                ];

                view.renderEvents(events);

                var eventElements = view.datesHeader.find("div.k-appointment");

                var slotOffset = view.allDayHeader.find("td").eq(0).offset();
                var slotWidth = view.allDayHeader.find("td").innerWidth();

                equal(eventElements.first().offset().top, slotOffset.top);
                equal(eventElements.last().offset().top, slotOffset.top + eventElements.first().height());

                equal(eventElements.first().offset().left, slotOffset.left);
                equal(eventElements.last().offset().left, slotOffset.left);

                equal(eventElements.first().width(), slotWidth * 2);
                equal(eventElements.first().width(), eventElements.last().width());
            });

            test("position multiple not overlapping all day events", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0),
                            new Date(2013, 1, 28, 0, 0, 0),
                            new Date(2013, 1, 29, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 27, 12, 0, 0), title: "first event" },
                    {uid:"uid", start: new Date(2013, 1, 28, 8, 0, 0), end: new Date(2013, 1, 29, 13, 0, 0), title: "second event" }
                ];

                view.renderEvents(events);

                var eventElements = view.datesHeader.find("div.k-appointment");

                var firstEventSlotOffset = view.allDayHeader.find("td").eq(0).offset();
                var secondEventSlotOffset = view.allDayHeader.find("td").eq(2).offset();

                var slotWidth = view.allDayHeader.find("td").innerWidth();

                equal(eventElements.first().offset().top, firstEventSlotOffset.top);
                equal(eventElements.last().offset().top, secondEventSlotOffset.top);

                equal(eventElements.first().offset().left, firstEventSlotOffset.left);
                equal(eventElements.last().offset().left, secondEventSlotOffset.left);

                equal(eventElements.first().width(), slotWidth * 2);
                equal(eventElements.last().width(), eventElements.first().width());
            });

            test("set height of multiple overlapping all day events across multiple slots", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0),
                            new Date(2013, 1, 28, 0, 0, 0),
                            new Date(2013, 1, 29, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 27, 12, 0, 0), title: "first event" },
                    {uid:"uid", start: new Date(2013, 1, 27, 8, 0, 0), end: new Date(2013, 1, 28, 13, 0, 0), title: "second event" },
                    {uid:"uid", start: new Date(2013, 1, 28, 8, 0, 0), end: new Date(2013, 1, 29, 13, 0, 0), title: "third event" }
                ];

                view.renderEvents(events);

                var eventElements = view.datesHeader.find("div.k-appointment");

                var eventSlotOffset = view.allDayHeader.find("td").eq(0).offset();
                var eventSlotHeigth = view.allDayHeader.find("td").eq(0).height();
                var eventHeight = Math.floor((eventSlotHeigth - eventSlotHeigth * 0.10) / 3);

                equal(eventElements.eq(0).offset().top, eventSlotOffset.top);
                equal(eventElements.eq(1).offset().top, eventSlotOffset.top + eventHeight);

                equal(eventElements.eq(0).height(), eventHeight);
                equal(eventElements.eq(1).height(), eventHeight)
                equal(eventElements.eq(2).height(), eventHeight);
            });

            test("close button is rendered if set as editable", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        editable: true,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", isAllDay: true, start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "all day event" }
                ];

                view.renderEvents(events);

                equal(view.content.find(".k-appointment a>.k-i-close").length, 1);
                equal(view.datesHeader.find(".k-appointment a>.k-i-close").length, 1);
            });

            test("close button is not rendered if editable.destroy is false", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        editable: { destroy: false },
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", isAllDay: true, start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "all day event" }
                ];

                view.renderEvents(events);

                ok(!view.content.find(".k-appointment a>.k-i-close").length);
                ok(!view.datesHeader.find(".k-appointment a>.k-i-close").length);
            });

            test("close button is not visible by default if set as editable", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        editable: true,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", isAllDay: true, start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "all day event" }
                ];

                view.renderEvents(events);

                equal(view.content.find(".k-appointment a:has(.k-i-close)").css("display"), "none");
                equal(view.datesHeader.find(".k-appointment a:has(.k-i-close)").css("display"), "none");
            });

            test("close button is shown on all day event hover if set as editable", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        editable: true,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", isAllDay: true, start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "all day event" }
                ];

                view.renderEvents(events);

                view.datesHeader.find(".k-appointment").trigger("mouseover");

                notEqual(view.datesHeader.find(".k-appointment a:has(.k-i-close)").css("display"), "none");
            });

            test("close button is shown on event hover if set as editable", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        editable: true,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" }
                ];

                view.renderEvents(events);

                view.content.find(".k-appointment").trigger("mouseover");

                notEqual(view.content.find(".k-appointment a:has(.k-i-close)").css("display"), "none");
            });

            test("close button is hidden on event mouseleave if set as editable", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        editable: true,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" }
                ];

                view.renderEvents(events);

                view.content.find(".k-appointment").trigger("mouseleave");

                equal(view.content.find(".k-appointment a:has(.k-i-close)").css("display"), "none");
            });

            test("close button is not rendered if set to not editable", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        editable: false,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" },
                    {uid:"uid", isAllDay: true, start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "all day event" }
                ];

                view.renderEvents(events);

                ok(!view.content.find(".k-appointment a>.k-i-close").length);
                ok(!view.datesHeader.find(".k-appointment a>.k-i-close").length);
            });

            test("clicking on close button triggers destroy event", 1, function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        remove: function() {
                            ok(true);
                        },
                        editable: true,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var events = [
                    {uid:"uid", start: new Date(2013, 1, 26, 8, 0, 0), end: new Date(2013, 1, 26, 12, 0, 0), title: "first event" }
                ];

                view.renderEvents(events);

                view.content.find(".k-appointment a:has(.k-i-close)").click();
            });

            test("double clicking a cell triggers add event", 2, function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        add: function(e) {
                            equal(e.start.getTime(), new Date(2013, 1, 26, 2, 0, 0).getTime());
                            equal(e.end.getTime(), new Date(2013, 1, 26, 3, 0, 0).getTime());
                        },
                        editable: true,
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                view.content.find("td").eq(2).trigger("dblclick");
            });

            test("_rangeToDates returns date for slot", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate
                        ]
                    });

                view.render(selectedDate);

                var result = view._rangeToDates(view.content.find("td").eq(2));

                equal(result.start.getTime(), new Date(2013, 1, 26, 2, 0, 0).getTime());
                equal(result.end.getTime(), new Date(2013, 1, 26, 3, 0, 0).getTime());
            });

            test("_dateSlotIndex returns correct index if date midnight", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                    view = setup({
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);
                equal(view._dateSlotIndex(new Date(2013,1,27,0,0,0)), 1);
            });

            test("_dateSlotIndex returns correct index if date is same as endTime", function() {
                var selectedDate = new Date(2013, 1, 26, 0, 0, 0),
                view = setup({
                        endTime: new Date(2013, 1, 27, 10, 0, 0),
                        dates: [
                            selectedDate,
                            new Date(2013, 1, 27, 0, 0, 0)
                        ]
                    });

                view.render(selectedDate);
                equal(view._dateSlotIndex(new Date(2013,1,27,10,0,0)), 1);
            });

        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
