<!DOCTYPE html>
<html>
    <head>
        <title>kendo.ui.Draggable Tests</title>
        <script src="../../src/jquery.min.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.selectable.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">kendo.ui.Draggable Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>

        <script>
            var Selectable = kendo.ui.Selectable,
                ul,
                SELECTED = "k-state-selected",
                ACTIVE = "k-state-selecting",
                SELECTABLE = "k-selectable",
                UNSELECTING = "k-state-unselecting";

            module("kendo.ui.Selectable", {
                setup: function() {
                  ul = $("<ul><li>1</li><li>2</li><li>3</li></ul>").appendTo(document.body);  
                },
                teardown: function() {
                    ul.remove();
                }
            });

            function ev(options) {
                return $.extend(new $.Event, options);
            }
          
            test("selectable class is applied on the element when initialized", function() {
                var selectable = new Selectable(ul);                
                ok(ul.hasClass(SELECTABLE));
            });

            test("stores the current position on mousedown", function() {
                var selectable = new Selectable(ul);
                var selectee = $(ul.find(">li")[0]);

                $(selectee).trigger("mousedown");
                ok(selectable._originalPosition !== undefined);
            });

            test("single selection does not attach the marquee", function() {
                var selectable = new Selectable(ul);
                var selectee = $(ul.find(">li")[0]);

                $(selectee).trigger("mousedown");
                equal(selectable._marquee.parent().length, 0);
            });

            test("multiple selection attach the marquee to the document", function() {
                var selectable = new Selectable(ul, {multiple: true});
                var selectee = $(ul.find(">li")[0]);

                $(selectee).trigger("mousedown");
                ok(selectable._marquee.parent()[0] === document.body);
            });

            test("element get selected after mouseup", function() {
                var selectable = new Selectable(ul);
                var selectee = $(ul.find(">li")[0]);
                
                selectee.trigger("mousedown");
                $(document).trigger("mouseup");
               
                ok(selectee.hasClass(SELECTED));
            });

            test("unselect all previosly selected when select new element", function() {
                var selectable = new Selectable(ul);
                var selectees = ul.find(">li");
                
                $(selectees[0]).trigger("mousedown");
                $(document).trigger("mouseup");

                $(selectees[1]).trigger("mousedown");
                $(document).trigger("mouseup");

                equal($(selectees[0]).hasClass(SELECTED), false);
                equal($(selectees[1]).hasClass(SELECTED), true);
            });
           
            test("selecting css class is applied on mousedown", function() {
                var selectable = new Selectable(ul);
                var selectee = $(ul.find(">li")[0]);
                
                selectee.trigger("mousedown");
                ok(selectee.hasClass(ACTIVE));
            });

            test("mousemove on selectable element mark it as selecting", function() {
                var selectable = new Selectable(ul, {multiple: true});
                var selectees = ul.find(">li");
                var position = $(selectees[1]).offset();
                
                $(selectees[0]).trigger("mousedown");                
                selectable._move({ pageX: position.left, pageY: position.top});

                ok($(selectees[0]).hasClass(ACTIVE));
                ok($(selectees[1]).hasClass(ACTIVE));
            });

            test("mousemove away from  selectable element removes selecting class", function() {
                var selectable = new Selectable(ul, {multiple: true});
                var selectees = ul.find(">li");
                var position = $(selectees[1]).offset();
                
                $(selectees[0]).trigger("mousedown");               
                selectable._move({ pageX: position.left, pageY: position.top});                 
                selectable._move({ pageX: position.left, pageY: position.top - 1});

                ok($(selectees[0]).hasClass(ACTIVE));
                ok(!$(selectees[1]).hasClass(ACTIVE));
            });

            test("values returns all selected elements", function() {
                var selectable = new Selectable(ul);
                var selectees = ul.find(">li");
                
                $(selectees[0]).trigger("mousedown");
                $(document).trigger("mouseup");

                var values = selectable.value();
                equal(values.length, 1);
                ok(values[0], selectees[0]);
            });

            test("multiple selection click item with ctrl key pressed does not unselect previosly selected", function() {
                var selectable = new Selectable(ul, {multiple: true});
                var selectees = ul.find(">li");
                
                $(selectees[0]).trigger("mousedown");
                $(document).trigger("mouseup");
                $(selectees[1]).trigger(ev({ type: "mousedown", ctrlKey: true }));
                $(document).trigger("mouseup");
                
                ok($(selectees[0]).hasClass(SELECTED));
                ok($(selectees[1]).hasClass(SELECTED));
            });

            test("single selection click item with ctrl key pressed does unselect previosly selected", function() {
                var selectable = new Selectable(ul);
                var selectees = ul.find(">li");
                
                $(selectees[0]).trigger("mousedown");
                $(document).trigger("mouseup");
                $(selectees[1]).trigger(ev({ type: "mousedown", ctrlKey: true }));
                $(document).trigger("mouseup");
                
                ok(!$(selectees[0]).hasClass(SELECTED));
                ok($(selectees[1]).hasClass(SELECTED));
            });

            test("single selection mousedown on selected item with ctrl key pressed persist selected state", function() {
                var selectable = new Selectable(ul);
                var selectee = $(ul.find(">li")[0]);
                
                selectee.addClass(SELECTED);                
                selectee.trigger(ev({ type: "mousedown", ctrlKey: true }));                
                
                ok(selectee.hasClass(SELECTED));
                ok(!selectee.hasClass(ACTIVE));
            });

            test("multiple selection mousedown on selected item with ctrl key pressed persist selected state", function() {
                var selectable = new Selectable(ul, {multiple: true});
                var selectee = $(ul.find(">li")[0]);
                
                selectee.addClass(SELECTED);
                selectee.trigger(ev({ type: "mousedown", ctrlKey: true }));                
                
                ok(selectee.hasClass(SELECTED));
                ok(!selectee.hasClass(ACTIVE));
            });

            test("multiple selection click on selected item with ctrl key pressed unselect it", function() {
                var selectable = new Selectable(ul, {multiple: true});
                var selectee = $(ul.find(">li")[0]);
                
                selectee.addClass(SELECTED);               
                selectee.trigger(ev({ type: "mousedown", ctrlKey: true }));                
                $(document).trigger("mouseup");                
                
                ok(!selectee.hasClass(SELECTED));
                ok(!selectee.hasClass(ACTIVE));
            });

            test("mousemove on selected item with ctrl key pressed unselect it", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    firstSelectee = $(ul.find(">li")[0]),
                    secondSelectee = $(ul.find(">li")[1]),
                    position = secondSelectee.offset();;
                
                firstSelectee.addClass(SELECTED);
                secondSelectee.addClass(SELECTED);
                
                $(firstSelectee).trigger(ev({ type: "mousedown", ctrlKey: true }));
                selectable._move({ pageX: position.left, pageY: position.top, ctrlKey: true});
                selectable._move({ pageX: position.left, pageY: position.top + 10, ctrlKey: true});
                
                ok(firstSelectee.hasClass(SELECTED));
                ok(!secondSelectee.hasClass(ACTIVE));
                ok(!secondSelectee.hasClass(SELECTED));
            });    
            
            test("mousemove out of previosly selected item with ctrl key pressed restores selected state", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    firstSelectee = $(ul.find(">li")[0]),
                    secondSelectee = $(ul.find(">li")[1]),
                    position = secondSelectee.offset();
                
                firstSelectee.addClass(SELECTED);
                secondSelectee.addClass(SELECTED);
                
                $(firstSelectee).trigger(ev({ type: "mousedown", ctrlKey: true }));
                selectable._move({ pageX: position.left, pageY: position.top, ctrlKey: true});
                selectable._move({ pageX: position.left, pageY: position.top - 1, ctrlKey: true});
                
                ok(firstSelectee.hasClass(SELECTED));
                ok(!secondSelectee.hasClass(ACTIVE));
                ok(secondSelectee.hasClass(SELECTED));
                ok(!secondSelectee.hasClass(UNSELECTING));
            });     
            
            test("mouseup on selected item with ctrl key pressed unselect it on single selection", function() {
                var selectable = new Selectable(ul);
                var selectee = $(ul.find(">li")[0]);
                
                selectee.addClass(SELECTED);
                selectee.trigger(ev({ type: "mousedown", ctrlKey: true }));
                $(document).trigger(ev({ type: "mouseup", ctrlKey: true }));
                
                ok(!selectee.hasClass(SELECTED));
                ok(!selectee.hasClass(ACTIVE));
            });

            test("select range between two selected elements when shift key is pressed", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    firstSelectee = $(ul.find(">li")[0]),
                    secondSelectee = $(ul.find(">li")[2]);
                
                firstSelectee.addClass(SELECTED);
                secondSelectee.trigger(ev({ type: "mousedown", shiftKey: true }));
                $(document).trigger(ev({ type: "mouseup", shiftKey: true }));

                var selected = selectable.value();
                equal(selected.length, 3);              
            });

            test("select range when no item selected with shift key pressed select from first selectable", function() {
                var selectable = new Selectable(ul, {multiple: true}),                    
                    selectee = $(ul.find(">li")[2]);
                                               
                selectee.trigger(ev({ type: "mousedown", shiftKey: true }));
                $(document).trigger("mouseup");

                var selected = selectable.value();                
                equal(selected.length, 3);              
            });

            test("selectRange when start element is in oposite order in the DOM", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    start = ul.find(">li")[1],
                    end = ul.find(">li")[0];
                                
                selectable.selectRange(start, end);
                var selected = selectable.value();                
                equal(selected.length, 2);
            });

            test("shift and click clears selected items outside the selected range", function() {
                var selectable = new Selectable(ul, {multiple: true}),                    
                    selectees = ul.find(">li");

                $(selectees[0]).addClass(SELECTED);
                $(selectees[1]).addClass(SELECTED);
                $(selectees[1]).trigger(ev({ type: "mousedown", ctrlKey: true }));
                $(document).trigger("mouseup");
                $(selectees[2]).trigger(ev({ type: "mousedown", shiftKey: true }));
                $(document).trigger("mouseup");

                var selected = selectable.value();                
                equal(selected.length, 2);
                ok(selectees[1] === selected[0]);
                ok(selectees[2] === selected[1]);
            });

            test("selectRange when start and end are same element element selects it", function() {
                var selectable = new Selectable(ul, {multiple: true}),                    
                    selectee = $(ul.find(">li")[0]);
                
                $(ul.find(">li")).addClass(SELECTED);                                               
                selectee.trigger(ev({ type: "mousedown", shiftKey: true }));
                $(document).trigger("mouseup");

                var selected = selectable.value();                
                equal(selected.length, 1);
                equal(selected[0], selectee[0]);
            });

            test("selecting element fires select event", function() {
                 var selectable = new Selectable(ul),
                    selectee = $(ul.find(">li")[0]),
                    selectWasCalled = false;
                
                selectable.bind("select", function () { selectWasCalled = true; });
                selectee.trigger("mousedown");
                $(document).trigger("mouseup");

                ok(selectWasCalled);
            });

            test("select event recieve as argument element to be selected", function() {
                var selectable = new Selectable(ul),
                selectee = $(ul.find(">li")[0]),
                elementToSelect;
                
                selectable.bind("select", function (arg) { 
                    elementToSelect = arg.element;
                });
                selectee.trigger("mousedown");
                $(document).trigger("mouseup");

                ok(elementToSelect === selectee[0]);
            });

            test("cancel select event will prevent element selection", function() {
                var selectable = new Selectable(ul),
                selectee = $(ul.find(">li")[0]);
                
                selectable.bind("select", function (arg) {                                      
                    arg.preventDefault();                                            
                });
                selectee.trigger("mousedown");
                $(document).trigger("mouseup");

                var selected = selectable.value();
                equal(selected.length, 0);
                ok(!selectee.hasClass(SELECTED));
                ok(!selectee.hasClass(ACTIVE));
            });

            test("change fires when elements are selected", function() {
                 var selectable = new Selectable(ul),
                    selectee = $(ul.find(">li")[0]),
                    changetWasCalled = false;
                
                selectable.bind("change", function () { changetWasCalled = true; });
                selectee.trigger("mousedown");
                $(document).trigger("mouseup");

                ok(changetWasCalled);
                ok(selectee.hasClass(SELECTED));
            });

            test("selectRange accept arguments as jQuery object", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    start = $(ul.find(">li")[1]),
                    end = $(ul.find(">li")[0]);
                                
                selectable.selectRange(start, end);
                var selected = selectable.value();                
                equal(selected.length, 2);
            });

            test("selectRange accept arguments as jQuery selectors", function() {
                var selectable = new Selectable(ul, {multiple: true});
                         
                selectable.selectRange("ul>li", "ul>li");
                var selected = selectable.value();                
                equal(selected.length, 1);
            });

            test("clear unselect all selected elements", function() {
                var selectable = new Selectable(ul, {multiple: true});
                $(ul.find(">li")).addClass(SELECTED);

                selectable.clear();

                var selected = selectable.value();                
                equal(selected.length, 0);
            });

            test("set values to select through value method selects the elements", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    selectees = $(ul.find(">li"));

                selectable.value(selectees);

                var selected = selectable.value();                
                equal(selected.length, 3);
                ok(selected.first().hasClass(SELECTED));
            });

            test("set values to select through value method triggers select event", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    selectees = $(ul.find(">li")),
                    selectWasFired = false;
                
                selectable.bind("select", function () { 
                    selectWasFired = true;
                });
                selectable.value(selectees);

                ok(selectWasFired);
            });

            test("set null as value to select", function() {
                var selectable = new Selectable(ul),
                    selectees = null;
                                    
                selectable.value(selectees);

                ok(true);
            });

            test("set values to select through value method triggers change event", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    selectees = $(ul.find(">li")),
                    changeWasFired = false;
                
                selectable.bind("change", function () { 
                    changeWasFired = true;
                });
                selectable.value(selectees);

                ok(changeWasFired);
            });

            test("selectRange with shift key pressed triggers select event", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    start = $(ul.find(">li")[1]),
                    end = $(ul.find(">li")[0]),
                    selectWasFired = false;
                                           
                selectable.bind("select", function () { 
                    selectWasFired = true;
                });                         
                selectable.selectRange(start, end);
                
                equal(selectable.value().length, 2);
                ok(selectWasFired);
            });

            test("selectRange with shift key pressed triggers change event", function() {
                var selectable = new Selectable(ul, {multiple: true}),
                    start = $(ul.find(">li")[1]),
                    end = $(ul.find(">li")[0]),
                    changeWasFired = false;
                                           
                selectable.bind("change", function () { 
                    changeWasFired = true;
                });                         
                selectable.selectRange(start, end);
                
                equal(selectable.value().length, 2);
                ok(changeWasFired);
            });
        </script>
    </body>
</html>
