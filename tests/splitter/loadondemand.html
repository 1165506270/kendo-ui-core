<!DOCTYPE html>
<html>
    <head>
        <title>Splitter load on demand</title>
        <script src="../jquery-loader.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../kendo-test-helpers.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.resizable.js"></script>
        <script src="../../src/kendo.splitter.js"></script>
        <script src="../jquery.mockjax.js"></script>
        <script src="helper.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">Splitter load on demand</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var url = "foo";

            module("Splitter / LoadOnDemand", {
                setup: function() {
                    $.mockjaxSettings.responseTime = 0;
                    $.mockjaxSettings.contentType = "text/html";
                    $.mockjax({
                        url: url,
                        responseText: "foobar"
                    });
                },
                teardown: function() {
                    $.mockjaxClear();
                    $(document).off();
                    $(".k-splitter").remove();
                }
            });

            test("ajaxRequest loads custom urls", 1, function() {
                var customUrl = 'customUrl',
                    requestedUrl,
                    splitter = $(getSplitterHtml())
                        .appendTo(document.body)
                        .kendoSplitter().data("kendoSplitter");

                $(document).on("ajaxSend", function(e, request, settings) {
                    e.preventDefault();
                    requestedUrl = settings.url;
                });

                $.mockjax({
                    url: customUrl,
                    responseText: "foobar"
                });
                splitter.ajaxRequest(".k-pane:first", customUrl);

                equal(requestedUrl, customUrl);
            });

            asyncTest("ajaxRequest places loaded data in target pane", 1, function() {
                var splitter = $(getSplitterHtml())
                        .appendTo(document.body)
                        .kendoSplitter();

                $(document).on("ajaxComplete", function(e, request, settings) {
                    if (settings.url === url) {
                        start();
                        equal(splitter.find(".k-pane:first")[0].innerHTML, "foobar");
                    }
                });

                splitter.data("kendoSplitter").ajaxRequest(".k-pane:first", url);
            });

            test("splitter loads content for LoadOnDemand panes when initializing", 2, function() {
                var counter = 0,
                    requestedUrl;

                $(document).on("ajaxSend", function(e, request, settings) {
                    e.preventDefault();
                    counter++;
                    requestedUrl = settings.url;
                });

                $(getSplitterHtml())
                    .appendTo(document.body)
                    .kendoSplitter({
                        panes: [ {}, { contentUrl: url } ]
                    });

                equal(counter, 1);
                equal(requestedUrl, url);
            });

            asyncTest("ajaxRequest places loading icon in pane", 2, function() {
                var splitter = $(getSplitterHtml())
                        .appendTo(document.body)
                        .kendoSplitter();

                $(document).on("ajaxSend", function(e, request, settings) {
                    request.abort();
                });

                splitter.data("kendoSplitter").ajaxRequest(".k-pane:first", url);

                setTimeout(function() {
                    start();
                    equal(splitter.find(".k-pane-loading.k-loading").length, 1);
                    ok(splitter.find(".k-pane-loading.k-loading").parent().is(".k-pane:first"));
                }, 500);
            });

            test("ajaxRequest sends data to server", function() {
                expect(1);

                var data = { id: 1 },
                    splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter();


                $.mockjaxClear();
                $.mockjax(function(settings) {
                    deepEqual(settings.data, data);
                    return {};
                });

                splitter.data("kendoSplitter").ajaxRequest(".k-pane:first", url, data);
            });

        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
