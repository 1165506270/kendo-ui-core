<!DOCTYPE html>
<html>
    <head>
        <title>Splitter client creation</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.resizable.js"></script>
        <script src="../../src/kendo.splitter.js"></script>
        <script src="helper.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
        <link rel="stylesheet" href="../../styles/web/kendo.common.css" />

        <script src="../qunit/addons/close-enough/qunit-close-enough.js"></script>
    </head>
    <body>
        <h1 id="qunit-header">Splitter client creation</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>

            module("Splitter / PaneResizing / Horizontal", {
                teardown: function() {
                    $('.k-splitter').remove();
                }
            });

            function startResizing(splitter, options) {
                var resizingHandler = splitter.data("kendoSplitter").resizing;
                options = $.extend({ x: { location: 0 }, y: { location: 0 }, currentTarget: splitter.find(".k-splitbar") }, options)
                options.x.startLocation = options.x.location;
                options.y.startLocation = options.y.location;

                resizingHandler._resizable._start(options);
            }

            test("resizing is initialized along with splitter", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter(),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                ok(resizingHandler);
                equal(resizingHandler.owner.element[0], splitter[0]);
            });

            test("resizing.start creates splitbar ghost", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter();

                startResizing(splitter);

                var ghost = splitter.find(".k-ghost-splitbar");

                equal(ghost.length, 1);
            });

            test("resizing constraints calculated from previous pane", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({
                        panes: [ { min: "35px", max: "150px" }, {} ]
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter);

                equal(resizingHandler._min(), 35);
                equal(resizingHandler._max(), 150);
            });

            test("resizing constraints calculated from next pane", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({
                        panes: [ {}, { min: "35px", max: "150px" } ]
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter);

                // min and max will be calculated with the previous pane as the origin, taking splitbar width into account
                equal(resizingHandler._min(), 50);
                equal(resizingHandler._max(), 165);
            });

            test("resizing constraints calculated from splitbar width", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({
                        panes: [ {}, {} ]
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitbar = splitter.find(".k-splitbar");

                splitbar.width(15);
                splitter.data("kendoSplitter")._resize();

                startResizing(splitter);

                // min and max will be calculated with the previous pane as the origin, taking splitbar width into account
                equal(resizingHandler._min(), 0);
                equal(resizingHandler._max(), splitter.width() - splitbar.outerWidth());
            });

            test("resizing constraints calculated from splitbar width and pane extremes", function() {
                var splitter = $(getSplitterHtml()).width(210).appendTo(document.body).kendoSplitter({
                        panes: [ {}, { min: "35px", max: "150px" } ]
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitbar = splitter.find(".k-splitbar");

                splitbar.width(8);
                splitter.data("kendoSplitter")._resize();

                startResizing(splitter);

                // min and max will be calculated with the previous pane as the origin, taking splitbar width into account
                equal(resizingHandler._min(), 50);
                equal(resizingHandler._max(), 165);
            });

            test("resizing constraints calculated from pane extremes", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({
                        panes: [ { min: "60px", max: "200px" }, { min: "35px", max: "150px" } ]
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter);

                equal(resizingHandler._min(), 60);
                equal(resizingHandler._max(), 165);
            });

            test("resizing constraints for middle panes", function() {
                var splitter = $(getSplitterHtml(4)).width(421).appendTo(document.body).kendoSplitter(),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter, { currentTarget: splitter.find(".k-splitbar").eq(1) });

                equal(resizingHandler._min(), 107);
                equal(resizingHandler._max(), 307);
            });

            test("resizing.stop modifies pane sizes", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter(),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar"),
                    initialSplitBarPosition = splitBar.offset().left,
                    panes = splitter.find(".k-pane"),
                    initialPaneSizes = $.map(panes, function(x) { return parseInt(x.offsetWidth); });

                startResizing(splitter, { currentTarget: splitBar, x: { location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ x: { location : initialSplitBarPosition + 5} });
                resizingHandler._resizable._stop({ currentTarget: splitBar, x: { location: initialSplitBarPosition + 5 } });

                equal(parseInt(panes[0].offsetWidth), (initialPaneSizes[0] + 5));
                equal(parseInt(panes[1].offsetWidth), (initialPaneSizes[1] - 5));
            });

            test("resizing.stop for middle panes", function() {
                var splitter = $(getSplitterHtml(4)).width(421).appendTo(document.body).kendoSplitter(),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar").eq(1),
                    initialSplitBarPosition = splitBar.offset().left,
                    panes = splitter.find(".k-pane"),
                    initialPaneSizes = $.map(panes, function(x) { return parseInt(x.offsetWidth); });

                startResizing(splitter, { currentTarget: splitBar, x: { location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ x: { location : initialSplitBarPosition + 5} });
                resizingHandler._resizable._stop({ currentTarget: splitBar, x: { location: initialSplitBarPosition + 5 } });

                equal(panes[1].offsetWidth, initialPaneSizes[1] + 5);
                equal(panes[2].offsetWidth, initialPaneSizes[2] - 5);
            });

            test("resizing.stop with variable splitbar widths", function() {
                var splitter = $(getSplitterHtml(4)).width(424).appendTo(document.body).kendoSplitter(),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar").eq(1).width(8);

                splitter.data("kendoSplitter")._resize();

                var initialSplitBarPosition = splitBar.offset().left,
                    panes = splitter.find(".k-pane"),
                    initialPaneSizes = $.map(panes, function(x) { return parseInt(x.offsetWidth); });


                startResizing(splitter, { currentTarget: splitBar, x: { location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ x: { location : initialSplitBarPosition + 5} });
                resizingHandler._resizable._stop({ currentTarget: splitBar, x: { location: initialSplitBarPosition + 5 } });

                equal(panes[1].offsetWidth, initialPaneSizes[1] + 5);
                equal(panes[2].offsetWidth, initialPaneSizes[2] - 5);
            });

            test("resizing.stop fires splitter resize", function() {
                var triggered = false,
                    splitter = $(getSplitterHtml()).appendTo(document.body)
                        .kendoSplitter({resize: function() { triggered = true } }),
                    splitBar = splitter.find(".k-splitbar"),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter);
                resizingHandler._resizable._stop({ currentTarget: splitBar, x: { location :0 } });

                ok(triggered);
            });

            test("resizing.stop for panes with constraints", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({
                        panes: [{ min: "50px" }, {}]
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar"),
                    initialSplitBarPosition = splitBar.offset().left,
                    panes = splitter.find(".k-pane");

                startResizing(splitter, { currentTarget: splitBar, x: { location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ x : {location: 0} });
                resizingHandler._resizable._stop({ currentTarget: splitBar, x: {location: 0} });

                equal(panes[0].offsetWidth, 50);
                equal(panes[1].offsetWidth, 150);
            });

            function isPercentageSize(size) {
                return /^\d+(\.\d+)?%$/.test(size);
            }

            function isPixelSize(size) {
                return /^\d+px$/.test(size);
            }

            function isFluid(size) {
                return !isPercentageSize(size) && !isPixelSize(size);
            }

            test("resizing.stop assigns percentage sizes when resizing fluid panes", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({ panes: [{ size: "100px" }, {}] }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar"),
                    initialSplitBarPosition = splitBar.offset().left,
                    panes = splitter.find(".k-pane");

                startResizing(splitter, { currentTarget: splitBar, x: {location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ x: { location: initialSplitBarPosition + 5 } });
                resizingHandler._resizable._stop({ currentTarget: splitBar });

                ok(isPixelSize(panes.eq(0).data("pane").size));
                ok(isFluid(panes.eq(1).data("pane").size));
            });

            test("resizing.stop assigns percentage sizes when resizing fluid panes", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({ panes: [{}, { size: "100px" }] }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar"),
                    initialSplitBarPosition = splitBar.offset().left,
                    panes = splitter.find(".k-pane");

                startResizing(splitter, { currentTarget: splitBar, x: {location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ x: { location : initialSplitBarPosition + 5 } });
                resizingHandler._resizable._stop({ currentTarget: splitBar, x: { location: 0 } });

                ok(isFluid(panes.eq(0).data("pane").size));
                ok(isPixelSize(panes.eq(1).data("pane").size));
            });

            module("Splitter / PaneResizing / Vertical", {
                teardown: function() {
                    $('.k-splitter').remove();
                }
            });

            test("resizing is initialized along with splitter", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({ orientation: "vertical" }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                ok(resizingHandler);
                equal(resizingHandler.owner.element[0], splitter[0]);
            });

            test("resizing.start creates splitbar ghost", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({ orientation: "vertical" }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                    // startResizing(splitter);
                startResizing(splitter);

                var ghost = splitter.find(".k-ghost-splitbar");

                equal(ghost.length, 1);
            });

            test("resizing constraints calculated from previous pane", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).height(207).kendoSplitter({
                        panes: [ { min: "35px", max: "150px" }, {} ],
                        orientation: "vertical"
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter);

                equal(resizingHandler._min(), 35);
                equal(resizingHandler._max(), 150);
            });

            test("resizing constraints calculated from next pane", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).height(207).kendoSplitter({
                        panes: [ {}, { min: "35px", max: "150px" } ],
                        orientation: "vertical"
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter);


                // min and max will be calculated with the previous pane as the origin, taking splitbar height into account
                equal(resizingHandler._min(), 50);
                equal(resizingHandler._max(), 165);
            });

            test("resizing constraints calculated from pane extremes", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).height(207).kendoSplitter({
                        panes: [ { min: "60px", max: "200px" }, { min: "35px", max: "150px" } ],
                        orientation: "vertical"
                    }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter);

                equal(resizingHandler._min(), 60);
                equal(resizingHandler._max(), 165);
            });

            test("resizing constraints for middle panes", function() {
                var splitter = $(getSplitterHtml(4)).height(421).appendTo(document.body).kendoSplitter({ orientation: "vertical" }),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter, { currentTarget: splitter.find(".k-splitbar").eq(1) });

                equal(resizingHandler._min(), 107);
                equal(resizingHandler._max(), 307);
            });

            test("resizing.stop modifies pane sizes", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({ orientation: "vertical" }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar"),
                    initialSplitBarPosition = splitBar.offset().top,
                    panes = splitter.find(".k-pane"),
                    initialPaneSizes = $.map(panes, function(x) { return parseInt(x.offsetHeight); });

                    startResizing(splitter, { currentTarget: splitBar, y: {location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ y: {location: initialSplitBarPosition + 5 } });
                resizingHandler._resizable._stop({ currentTarget: splitBar, y: { location: initialSplitBarPosition + 5 } });

                QUnit.close(parseInt(panes[0].offsetHeight), initialPaneSizes[0] + 5, 1);
                QUnit.close(parseInt(panes[1].offsetHeight), initialPaneSizes[1] - 5, 1);
            });

            test("resizing.stop for middle panes", function() {
                var splitter = $(getSplitterHtml(4)).height(421).appendTo(document.body).kendoSplitter({ orientation: "vertical" }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar").eq(1),
                    initialSplitBarPosition = splitBar.offset().top,
                    panes = splitter.find(".k-pane"),
                    initialPaneSizes = $.map(panes, function(x) { return parseInt(x.offsetHeight); });

                startResizing(splitter, { currentTarget: splitBar, y: {location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ y: {location: initialSplitBarPosition + 5 } });
                resizingHandler._resizable._stop({ currentTarget: splitBar, y: { location: initialSplitBarPosition + 5 } });

                QUnit.close(parseInt(panes[1].offsetHeight), initialPaneSizes[1] + 5, 1);
                QUnit.close(parseInt(panes[2].offsetHeight), initialPaneSizes[2] - 5, 1);
            });

            test("resizing.stop fires splitter resize", function() {
                var triggered = false,
                    splitter = $(getSplitterHtml()).appendTo(document.body)
                        .kendoSplitter({ orientation: "vertical", resize: function() {triggered = true;}}),
                    splitBar = splitter.find(".k-splitbar"),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                startResizing(splitter, { currentTarget: splitBar, y: {location: 0 } });
                resizingHandler._resizable._stop({ currentTarget: splitBar, y: { location: 0 } });

                ok(triggered);
            });

            test("resizing.stop does not resize splitter if Esc key was hit", function() {
                var splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({ orientation: "vertical" }),
                    resizingHandler = splitter.data("kendoSplitter").resizing,
                    splitBar = splitter.find(".k-splitbar"),
                    initialSplitBarPosition = splitBar.offset().top,
                    panes = splitter.find(".k-pane"),
                    initialPaneSizes = $.map(panes, function(x) { return parseInt(x.offsetHeight); });

                    resizingHandler._resizable._start({ currentTarget: splitBar, y: { location: initialSplitBarPosition } });
                resizingHandler._resizable._resize({ y: {location: initialSplitBarPosition + 5 } });
                resizingHandler._resizable._stop({ keyCode: 27, currentTarget: splitBar });

                equal(parseInt(panes[0].offsetHeight), initialPaneSizes[0]);
                equal(parseInt(panes[1].offsetHeight), initialPaneSizes[1]);
            });

            test("resizing.stop does not fire resize when cancelling drag with Esc", function() {
                var triggered = false,
                    splitter = $(getSplitterHtml()).appendTo(document.body).kendoSplitter({ orientation: "vertical" }),
                    splitBar = splitter.find(".k-splitbar"),
                    resizingHandler = splitter.data("kendoSplitter").resizing;

                splitter.data("kendoSplitter").bind("resize", function() { triggered = true; });

                startResizing(splitter, { currentTarget: splitBar, y: {location: 0 } });
                resizingHandler._resizable._stop({ keyCode: 27, currentTarget: splitBar });

                ok(!triggered);
            });

            test("expanding an initially collapsed pane allows it to be resized", function() {
                var splitter = $(getSplitterHtml(2))
                        .appendTo(document.body)
                        .kendoSplitter({
                            panes: [
                                { collapsed: true, collapsible: true, size: "50px" },
                                { }
                            ]
                        }),
                    splitBar = splitter.find(".k-splitbar"),
                    panes = splitter.find(".k-pane");

                splitter.data("kendoSplitter").expand(".k-pane:first");

                var resizingHandler = splitter.data("kendoSplitter").resizing;
                ok(splitBar.is(resizingHandler._resizable.draggable.options.filter));
            });

            module("Nested splitters", {
                teardown: function() {
                    $('.k-splitter').remove();
                }
            });

            test("splitter is bound to parent splitter resize", function() {
                var outerSplitter = $(getSplitterHtml()).height(207).appendTo(document.body).kendoSplitter(),
                    innerSplitter =
                        outerSplitter.find(".k-pane").eq(0)
                            .html(getSplitterHtml())
                            .find("> div").css({
                                height: "100%",
                                width: "100%",
                                border: 0,
                                overflow: "hidden"
                            })
                            .kendoSplitter({ orientation: "vertical", resize: function(e) { triggered = true; } }),
                    triggered = false;


                outerSplitter.data("kendoSplitter").trigger("resize");

                ok(triggered);
            });
        </script>
        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
