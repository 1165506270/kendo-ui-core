<!doctype html>
<html>
    <head>
        <title>ThemeBuilder tests</title>

        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>

        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.userevents.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.window.js"></script>
        <script src="../../src/kendo.panelbar.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.popup.js"></script>
        <script src="../../src/kendo.list.js"></script>
        <script src="../../src/kendo.numerictextbox.js"></script>
        <script src="../../src/kendo.combobox.js"></script>
        <script src="../../src/kendo.dataviz.core.js"></script>
        <script src="../../src/kendo.dataviz.themes.js"></script>

        <link rel="stylesheet" href="../../tests/qunit/qunit/qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">ThemeBuilder tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>

        <script src="../../themebuilder/scripts/less.js"></script>
        <script src="../../themebuilder/scripts/themebuilder.js"></script>
        <script src="../../themebuilder/scripts/colorengine.js"></script>

        <script>
            var ThemeBuilder = kendo.ThemeBuilder,
                LessTheme = kendo.LessTheme,
                JsonConstants = kendo.JsonConstants,
                constant = function(target, property, values) {
                    return {
                        target: target,
                        property: property,
                        values: values
                    };
                },
                BGCOLOR = "background-color",
                BORDERCOLOR = "border-color",
                COLOR = "color",
                extend = $.extend;

            module("integration", {
                teardown: function() {
                    $("#kendo-themebuilder, head style").remove();
                }
            });

            function updateStyleSheet(cssText) {
                LessTheme.prototype._updateStyleSheet(cssText, document);
            }

            test("themebuilder object is available", function() {
                ok(typeof ThemeBuilder == "function");
            });

            test("updateStyleSheet() adds CSS to document", function() {
                updateStyleSheet(".foo { font-size: 8px; }");

                var element = $("<span class='foo' />").appendTo(document.body);

                equals(element.css("font-size"), "8px");
                equals($("style[title]").length, 1);
            });

            test("updateStyleSheet() updates existing stylesheet", function() {
                updateStyleSheet(".foo { font-size: 8px; }");

                updateStyleSheet("body { font-size: 10px; } .foo { color: #f00; }");

                var element = $("<span class='foo' />").appendTo(document.body);

                equals($("style[title]").length, 1);
                equals($(".foo").css("font-size"), "10px");
            });

            test("render() renders color picker for box-shadow-color properties", function() {
                var constants = new LessTheme({
                        constants: {
                            "@foo-color": constant(".k-widget", "box-shadow")
                        }
                    }),
                    themeBuilder = new ThemeBuilder({
                        webConstants: constants,
                        webConstantsHierarchy: {
                            "Foos": {
                                "@foo-color": "foo color"
                            }
                        }
                    }, document);

                equals(themeBuilder.element.find("span.ktb-colorpicker").length, 1)
            });

            test("value of box-shadow color picker gets processed as color", function() {

                var constants = new LessTheme({
                        constants: {
                            "@foo-color": constant(".k-widget", "box-shadow")
                        }
                    });

                updateStyleSheet(".k-widget { box-shadow: 1px 1px 1px #b4d455; }");

                constants.infer(document);

                equals(constants.serialize(), "@foo-color: #b4d455;");
            });

            test("value of box-shadow color picker with inset shadow", function() {

                var constants = new LessTheme({
                        constants: {
                            "@foo-color": constant(".k-widget", "box-shadow")
                        }
                    });

                updateStyleSheet(".k-widget { box-shadow: inset 1px 1px 1px #b4d455; }");

                constants.infer(document);

                equals(constants.serialize(), "@foo-color: #b4d455;");
            });

            test("LessTheme are inferred on init", function() {
                var constants = new LessTheme(),
                    inferred = false;

                constants.infer = function() {
                    inferred = true;
                };

                var themebuilder = new ThemeBuilder({ webConstants: constants }, document);

                ok(inferred);
            });

            test("_propertyChange updates constant", function() {
                var color = "#b4d455",
                    constants = new LessTheme({
                        constants: {
                            "@foo": constant(".k-widget", "background-color")
                        }
                    }),
                    themebuilder = new ThemeBuilder({
                        webConstants: constants
                    });

                themebuilder._propertyChange({
                    value: color,
                    name: "@foo"
                });

                equals(constants.constants["@foo"].value, color)
            });

            test("changing input value triggers _propertyChange", function() {
                expect(2);
                var color = "#b4d455",
                    themebuilder = new ThemeBuilder({
                        webConstants: new LessTheme({
                            constants: {
                                "@foo": constant(".k-widget", "background-color")
                            }
                        }),
                        webConstantsHierarchy: {
                            "Foos": {
                                "@foo": "foo color"
                            }
                        }
                    });

                themebuilder._propertyChange = function(e) {
                    equals(e.name, "@foo");
                    equals(e.value, color);
                };

                themebuilder.element.find("[id='@foo']").val(color)
                    .data("kendoColorPicker").trigger("change");
            });

            test("_propertyChange updates dataviz constant", function() {
                var color = "#b4d455",
                    constants = new JsonConstants({
                        constants: {
                            "title.color": { property: "color" }
                        }
                    }),
                    themebuilder = new ThemeBuilder({
                        datavizConstants: constants
                    });

                constants.applyTheme = function(){};

                themebuilder._propertyChange({
                    value: color,
                    name: "title.color"
                });

                equals(constants.constants["title.color"].value, color)
            });

        </script>

        <div id="qunit-fixture"> </div>
        <ul id="log"></ul>
    </body>
</html>

