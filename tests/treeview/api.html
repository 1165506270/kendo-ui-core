<!doctype html>
<html>
    <head>
        <title>TreeView API</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
        <link rel="stylesheet" href="../../styles/web/kendo.common.css" />
        <script src="test-helper.js"></script>
    </head>
    <body>
        <h1 id="qunit-header">TreeView API</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>

        <script>
            module("api", {
                teardown: function () {
                    $(".k-treeview,.k-item").remove();
                }
            });

            test("enable(node, false) disables node", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                var node = treeview.find(".k-item:first");

                treeviewObject.enable(node, false);

                equals(node.find(".k-plus-disabled").length, 1);
                ok(node.find(".k-in").hasClass("k-state-disabled"));
            });

            test("enable(node) enables node", function() {
                createTreeView([
                    { text: "foo", enabled: false, items: [
                        { text: "bar" }
                    ] }
                ]);

                var node = treeview.find(".k-item:first");

                treeviewObject.enable(node);

                equals(node.find(".k-plus").length, 1);
                ok(!node.find(".k-in").hasClass("k-state-disabled"));
            });

            test("select(node) selects node", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var node = treeview.find(".k-item:first");

                treeviewObject.select(node);

                ok(node.find(".k-in").hasClass("k-state-selected"));
            });

            test("select(node) works with inner elements", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var node = treeview.find(".k-item:first").find(".k-in");

                treeviewObject.select(node);

                ok(node.hasClass("k-state-selected"));
            });

            test("select(node) deselects other node", function() {
                createTreeView([
                    { text: "foo", selected: true },
                    { text: "bar" }
                ]);

                var node = treeview.find(".k-item:last");

                treeviewObject.select(node);

                equals(treeview.find(".k-state-selected").length, 1);
            });

            test("select(selector) limits selector to treeview", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                $("<div class='k-item' />").appendTo(document.body);

                treeviewObject.select(".k-item:last");

                equals(treeview.find(".k-state-selected").length, 1);
            });

            test("text(node) returns node text", function() {
                createTreeView([
                        { text: "foo", items: [
                            { text: "bar" }
                        ] }
                    ]);

                var node = treeview.find(".k-item:first");

                equals(treeviewObject.text(node), "foo");
                equals(treeviewObject.text(node.find(".k-in:first")), "foo");
            });

            test("text(node) returns node text if inner element is passed", function() {
                createTreeView([
                        { text: "foo", items: [
                            { text: "bar" }
                        ] }
                    ]);

                var node = treeview.find(".k-item .k-in:first");

                equals(treeviewObject.text(node), "foo");
            });

            test("text(node, 'text') sets node text", function() {
                createTreeView([
                        { text: "foo" }
                    ]);

                var node = treeview.find(".k-item .k-in");

                treeviewObject.text(node, "bar");

                equals(treeviewObject.text(node), "bar");
            });

            test("findByText(text) returns single node", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                var node = treeview.find(".k-item:first");

                equals(treeviewObject.findByText("foo")[0], node[0]);
            });

            test("findByText(text) returns multiple nodes", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" },
                    { text: "foo" }
                ]);

                var nodes = treeview.find(".k-item"),
                    result = treeviewObject.findByText("foo");

                equals(result[0], nodes[0]);
                equals(result[1], nodes[2]);
            });

            test("append(nodeData, root) appends new node to empty parent", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var root = treeview.find(".k-item:first");

                var appendedNode = treeviewObject.append({ text: "bar" }, root);

                equals(root.find(".k-group").length, 1);
                equals(root.find(".k-group").css("display"), "block");
                equals(root.find(".k-item").length, 1);
                equals(appendedNode[0], root.find(".k-item")[0]);
                equals(treeviewObject.text(appendedNode), "bar");
                ok(appendedNode.find(">div").hasClass("k-bot"));
                ok(appendedNode.hasClass("k-last"));
                equals(root.find(">div>.k-minus.k-icon").length, 1);
            });

            test("append(nodeData, parentNode) appends new node to parent with existing group", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar" }
                    ] }
                ]);

                var parentNode = treeview.find(".k-item:first");

                var appendedNode = treeviewObject.append({ text: "bar" }, parentNode);

                equals(parentNode.find(".k-group").length, 1);
                equals(parentNode.find(".k-group").css("display"), "block");
                equals(parentNode.find(".k-item").length, 2);
                equals(appendedNode[0], parentNode.find(".k-item:last")[0]);
                ok(!appendedNode.prev(".k-item").hasClass("k-last"));
                equals(appendedNode.find(">div.k-bot").length, 1);
            });

            test("append(nodeData) appends new node to root", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var rootGroup = treeview.find(".k-group");

                var appendedNode = treeviewObject.append({ text: "bar" });

                equals(rootGroup.length, 1);
                equals(treeview.find("div").length, 2);
                equals(rootGroup.find("> .k-item").length, 2);
                ok(rootGroup.find("> .k-item").hasClass("k-first"));
            });

            test("append(nodeElement, parentNode) appends node to parent", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "buzz" },
                        { text: "bar" }
                    ] },
                    { text: "baz" }
                ]);

                var rootGroup = treeview.find("> .k-group"),
                    subNode = treeviewObject.findByText("buzz"),
                    newParent = treeviewObject.findByText("baz");

                var appendedNode = treeviewObject.append(subNode[0], newParent);

                equals(appendedNode[0], newParent.find(".k-item")[0]);
                equals(rootGroup.children().length, 2);
                equals(treeviewObject.findByText("buzz").find(".k-bot").length, 1);
            });

            test("append(nodeElement) appends node to root", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar" }
                    ] }
                ]);

                var rootGroup = treeview.find("> .k-group"),
                    subNode = treeviewObject.findByText("bar");

                var appendedNode = treeviewObject.append(subNode[0]);

                equals(treeviewObject.findByText("bar")[0], appendedNode[0]);
                equals(rootGroup.children().length, 2);
                equals(treeview.find(".k-icon").length, 0);
                equals(rootGroup.find(".k-group").length, 0);
            });

            test("append() of single child to same parent does not remove it", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar" }
                    ] }
                ]);

                var rootGroup = treeview.find("> .k-group"),
                    subNode = treeviewObject.findByText("bar"),
                    rootNode = treeviewObject.findByText("foo");

                var appendedNode = treeviewObject.append(subNode, rootNode);

                subNode = treeviewObject.findByText("bar");

                equals(subNode[0], appendedNode[0]);
                equals(rootGroup.children().length, 1);
                equals(rootNode.find(".k-group").length, 1);
                equals(rootNode.find(".k-group").children().length, 1);

                appendedNode = treeviewObject.append(subNode[0], rootNode);

                subNode = treeviewObject.findByText("bar");

                equals(subNode[0], appendedNode[0]);
                equals(rootGroup.children().length, 1);
                equals(rootNode.find(".k-group").length, 1);
                equals(rootNode.find(".k-group").children().length, 1);
            });

            test("append() of array of items", function() {
                createTreeView({});

                var appendedNodes = treeviewObject.append([
                        { text: "foo" },
                        { text: "bar" }
                    ]);

                equals(treeview.find(".k-group").length, 1);
                equals(treeview.find(".k-group").children().length, 2);
            });

            test("append() uses item template when creating items", function() {
                createTreeView({
                    template: kendo.template("item: #= item.text #")
                });

                treeviewObject.append({ text: "foo" });

                equal(treeview.find(".k-in").text(), "item: foo");

                treeviewObject.remove(".k-item");

                treeviewObject.append([{ text: "foo" }]);

                equal(treeview.find(".k-in").text(), "item: foo");
            });

            test("append() of observable object", function() {
                createTreeView({});

                var obj = kendo.observable({ text: "foo" });

                treeviewObject.append(obj);

                equal(treeview.find(".k-in").text(), "foo");
            });

            test("append() of observable object to subnode", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var obj = kendo.observable({ text: "bar" });

                treeviewObject.append(obj, treeviewObject.findByText("foo"));

                equal(treeview.find(".k-item .k-item").text(), "bar");
            });

            test("append() of observable array", function() {
                createTreeView({});

                var array = new kendo.data.ObservableArray([{ text: "foo" }]);

                treeviewObject.append(array);

                equal(treeview.find(".k-in").text(), "foo");
            });

            test("append() adds element to dataSource", function() {
                createTreeView({});

                treeviewObject.append({ text: "foo" });

                var data = treeviewObject.dataSource.data();

                equal(data.length, 1);
                equal(data[0].text, "foo");
            });

            test("append() to unfetched parent", function() {
                createTreeView({
                    dataSource: {
                        data: [
                            { text: "foo", hasChildren: true }
                        ],
                        schema: {
                            model: {
                                hasChildren: "hasChildren",
                                children: {
                                    transport: {
                                        read: function(options) {
                                            options.success([ { text: "bar" } ]);
                                        }
                                    }
                                }
                            }
                        }
                    }
                });

                treeviewObject.append({ text: "baz" }, treeview.find(".k-item"));

                equal(treeview.find(".k-item .k-item").length, 2);
            });

            asyncTest("append() to unfetched async parent", function() {
                createTreeView({
                    dataSource: {
                        data: [
                            { text: "foo", hasChildren: true }
                        ],
                        schema: {
                            model: {
                                hasChildren: "hasChildren",
                                children: {
                                    transport: {
                                        read: function(options) {
                                            setTimeout(function() {
                                                options.success([ { text: "bar" } ]);
                                            }, 100);
                                        }
                                    }
                                }
                            }
                        }
                    }
                });

                treeviewObject.append({ text: "baz" }, treeview.find(".k-item"));

                setTimeout(function() {
                    start();
                    equal(treeview.find(".k-item .k-item").length, 2);
                }, 200);
            });

            test("detach() removes node and persists data", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" }
                ]);

                var foo = treeviewObject.findByText("foo");

                foo.data("id", 1);

                foo = treeviewObject.detach(foo);

                equal(foo.data("id"), 1);
            });

            test("insertAfter(nodeData, element) inserts new node after element", function() {
                createTreeView([
                    { text: "foo", expanded: true },
                    { text: "baz", expanded: true }
                ]);

                var rootItem = treeview.find(".k-item:first"),
                    rootGroup = treeview.find(".k-group");

                var insertedNode = treeviewObject.insertAfter({ text: "bar" }, rootItem);

                equals(rootGroup.find("> .k-item").length, 3);
                equals(rootGroup.find("> .k-item:contains('bar')").index(), 1);
                equals(insertedNode[0], rootGroup.find("> .k-item")[1]);
            });

            test("insertBefore(nodeData, element) inserts new node before element", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "baz" }
                ]);

                var treeviewObject = treeview.data("kendoTreeView"),
                    rootItem = treeview.find(".k-item:last"),
                    rootGroup = treeview.find(".k-group");

                var insertedNode = treeviewObject.insertBefore({ text: "bar" }, rootItem);

                equals(rootGroup.find("> .k-item").length, 3);
                equals(rootGroup.find("> .k-item:contains('bar')").index(), 1);
                equals(insertedNode[0], rootGroup.find("> .k-item")[1]);
            });

            test("insertBefore(nodeData, element) updates item classes", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var treeviewObject = treeview.data("kendoTreeView"),
                    rootItem = treeview.find(".k-item");

                var insertedNode = treeviewObject.insertBefore({ text: "bar" }, rootItem);

                ok(insertedNode.hasClass("k-first"));
                ok(!rootItem.hasClass("k-first"));
                ok(rootItem.hasClass("k-last"));
                ok(!rootItem.find(">div").hasClass("k-top"));
                ok(rootItem.find(">div").hasClass("k-bot"));
                equals(treeview.find("li").length, 2);
                equals(treeview.find("div").length, 2);
            });

            test("remove(node) removes nodes", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" }
                ]);

                var rootItems = treeview.find(".k-item"),
                    rootGroup = treeview.find(".k-group");

                treeviewObject.remove(rootItems[0]);

                rootItems = treeview.find(".k-item");

                equals(rootItems.length, 1);
                equals(rootGroup.find(".k-in:contains('bar')").length, 1);
                equals(treeview.find("li").length, 1);
                equals(treeview.find("div").length, 1);
            });

            test("remove(node) updates classes", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                treeviewObject.remove(treeviewObject.findByText("bar"));

                var items = treeview.find(".k-item");

                equals(items.length, 1);
                equals(items.find(".k-group").length, 0);
            });

            test("remove('.k-item') removes all items, but not root list", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                treeviewObject.remove(".k-item");

                equals(treeview.find(".k-item").length, 0);
                ok(treeview.find("> .k-group").length);
                ok(!treeview.hasClass("k-item"));
            });

            test("remove('.k-item') works only with own items", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                var arbitraryItem = $("<div class='k-item' />").appendTo(document.body);

                treeviewObject.remove(".k-item:last");

                equal(arbitraryItem.closest("body").length, 1);
            });

            test("expand() with selector string", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                var calls = 0;

                treeviewObject.toggle = function() {
                    calls++;
                };

                treeviewObject.expand(".k-item");

                equal(calls, 2);
            });

            test("expand() with DOM elements", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                var calls = 0;

                treeviewObject.toggle = function() {
                    calls++;
                };

                treeviewObject.expand($(".k-item:first")[0]);

                equal(calls, 1);
            });

            test("expand() on load-on-demand nodes", function() {
                createTreeView({
                    dataSource: {
                        transport: {
                            read: function(options) {
                                options.success([ { text: "foo", hasChildren: true } ]);
                            }
                        },
                        schema: {
                            model: {
                                hasChildren: "hasChildren"
                            }
                        }
                    }
                });

                equal(treeview.find(".k-item").length, 1);

                treeviewObject.expand(".k-item");

                equal(treeview.find(".k-item .k-item").length, 1);
            });

            test("toggle() toggles disabled nodes", function() {
                createTreeView([
                    { text: "foo", enabled: false, items: [
                        { text: "bar" }
                    ] }
                ]);

                treeviewObject.toggle(treeviewObject.findByText("foo"));

                equal(treeview.find(".k-group:last").css("display"), "block");
            });

            test("dataItem returns the ObservableObject that corresponds to a node", function() {
                createTreeView([
                    { id: 1, text: "foo" },
                    { id: 2, text: "bar" }
                ]);

                var foo = treeviewObject.dataItem(treeview.find(".k-item:first"));

                equal(foo.id, 1);
                equal(foo.text, "foo");
            });

            test("dataItem searches through child dataSources", function() {
                createTreeView([
                    { id: 1, text: "foo", baz: "qux", items: [
                        { id: 2, text: "bar", baz: "lux" }
                    ] }
                ]);

                treeviewObject.dataSource.data()[0].children.read();

                var bar = treeviewObject.dataItem(treeview.find(".k-item:last"));

                ok(bar);
                equal(bar.id, 2);
                equal(bar.text, "bar");
                equal(bar.baz, "lux");
            });

            test("remove() removes item from dataSource", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                treeviewObject.remove(".k-item");

                equal(treeviewObject.dataSource.data().length, 0);
            });

            test("insertBefore() moves item in the dataSource", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" }
                ]);

                treeviewObject.insertBefore(treeviewObject.findByText("bar"), treeviewObject.findByText("foo"));

                var data = treeviewObject.dataSource.data();

                equal(data.length, 2);
                equal(data[0].text, "bar");
                equal(data[1].text, "foo");
            });

            test("insertAfter() moves item in the dataSource", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" }
                ]);

                treeviewObject.insertAfter(treeviewObject.findByText("foo"), treeviewObject.findByText("bar"));

                var data = treeviewObject.dataSource.data();

                equal(data.length, 2);
                equal(data[0].text, "bar");
                equal(data[1].text, "foo");
            });

            test("API methods work after initialization from rendered treeview", function() {
                treeview = $('<div class="k-widget k-treeview" id="treeview">' +
                    '<ul class="k-group">' +
                        '<li class="k-item k-first">' +
                            '<div class="k-top k-top"><span class="k-in">foo</span></div>' +
                        '</li>' +
                        '<li class="k-item k-last">' +
                            '<div class="k-top k-bot"><span class="k-in">bar</span></div>' +
                        '</li>' +
                    '</ul>' +
                '</div>').kendoTreeView();

                treeviewObject = treeview.data("kendoTreeView");

                treeviewObject.insertAfter(treeviewObject.findByText("foo"), treeviewObject.findByText("bar"));

                var data = treeviewObject.dataSource.data();

                equal(data.length, 2);
                equal(data[0].text, "bar");
                equal(data[1].text, "foo");
            });

            test("API methods work after initialization from empty rendered treeview", function() {
                treeview = $('<div class="k-widget k-treeview" id="treeview"></div>').kendoTreeView();

                treeviewObject = treeview.data("kendoTreeView");

                treeviewObject.append({ text: "foo" });

                var data = treeviewObject.dataSource.data();

                equal(data.length, 1);
                equal(data[0].text, "foo");
            });

            test("removing all items from an item does not re-initialize it after move", function() {
                createTreeView([
                    { text: "foo", items: [
                        { text: "bar" }
                    ] }
                ]);

                var bar = treeviewObject.findByText("bar");

                bar = treeviewObject.append(bar);

                var foo = treeviewObject.findByText("foo");

                foo = treeviewObject.append(foo, bar);

                equal(foo.find(".k-item").length, 0);
            });
        </script>

        <div id="qunit-fixture"> </div>
        <ul id="log"></ul>
    </body>
</html>


