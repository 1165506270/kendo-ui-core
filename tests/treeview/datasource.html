<!doctype html>
<html>
    <head>
        <title>TreeView DataSource binding</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <script src="../../src/kendo.binder.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
        <link rel="stylesheet" href="../../styles/web/kendo.common.css" />
    </head>
    <body>
        <h1 id="qunit-header">TreeView DataSource binding</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>

        <script>
            var treeview, treeviewObject;

            function createTreeView(options) {
                treeview = $("<div />").appendTo(document.body).kendoTreeView(options);
                treeviewObject = treeview.data("kendoTreeView");
            }

            var HierarchicalDataSource = kendo.data.HierarchicalDataSource;

            module("DataSource binding", {
                teardown: function () {
                    $(".k-treeview,.k-item").remove();
                }
            });

            test("Initializing from JSON creates HierarchicalDataSource", function() {
                createTreeView({
                    dataSource: []
                });

                ok(treeviewObject.dataSource instanceof HierarchicalDataSource);
            });

            test("Initializing from JSON populates dataSource", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo" },
                        { text: "bar" }
                    ]
                });

                equal(treeviewObject.dataSource.view().length, 2);
            });

            test("Adding items to the datasource adds them to the treeview", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo" }
                    ]
                });

                treeviewObject.dataSource.add({ text: "bar" });

                equal(treeview.find(".k-item").length, 2);
            });

            test("Adding items to the datasource adds them to the proper level", function() {
                createTreeView({
                    dataSource: [
                        { id: 1, text: "foo" },
                        { id: 2, text: "bar" }
                    ]
                });

                var foo = treeviewObject.dataSource.get(1);

                foo.children.add({ id: 3, text: "baz" });

                equal(treeview.find(".k-item").length, 3);
                equal(treeview.find(".k-item:first .k-item").length, 1);
            });

            test("Removing items from the datasource removes them from the treeview", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo" }
                    ]
                });

                var dataItem = treeviewObject.dataItem(treeview.find(".k-item"));

                treeviewObject.dataSource.remove(dataItem);

                equal(treeview.find(".k-item").length, 0);

            });

            test("DataSource as an object", 2, function() {
                createTreeView({
                    dataSource: {
                        data: [
                            { text: "foo" }
                        ]
                    }
                });

                var item = treeview.find(".k-item");

                equal(item.length, 1);
                equal(treeviewObject.text(item), "foo");
            });

            test("Passing existing dataSource", function() {
                var dataSource = new HierarchicalDataSource({
                    data: [
                        { text: "foo" }
                    ]
                });

                createTreeView({
                    dataSource: dataSource
                });

                var item = treeview.find(".k-item");

                equal(item.length, 1);
                equal(treeviewObject.text(item), "foo");
            });
            /*
            test("Removing items from the datasource removes them from the treeview at the proper level", function() {
                createTreeView({
                    dataSource: [
                        { id: 1, text: "foo", items: [
                            { id: 2, text: "bar" }
                        ] }
                    ]
                });

                var uid = treeview.find(".k-item:last").data("uid");

                //treeviewObject.dataSource.remove({ uid: uid });
                treeviewObject.dataSource.get(1).children.remove({ uid: uid });

                equal(treeview.find(".k-item").length, 1);

            });
            */

            test("Loading root nodes from remote datasource inserts them in the TreeView", function() {
                createTreeView({
                    dataSource: {
                        transport: {
                            read: function(options) {
                                options.success([ { id: 1, text: "foo" } ]);
                            }
                        }
                    }
                });

                var item = treeview.find(".k-item");

                equal(item.length, 1);
                equal(treeviewObject.text(item), "foo");
            });

            test("Non-leaf nodes are rendered as expandable", function() {
                var i = 1;

                createTreeView({
                    dataSource: {
                        transport: {
                            read: function(options) {
                                options.success([ { id: i++, leaf: false, text: "foo" } ]);
                            }
                        }
                    }
                });

                var icon = treeview.find(".k-plus");

                equal(icon.length, 1);
            });

            test("Expanding non-leaf nodes loads subgroups", function() {
                var i = 0;

                function readAction(options) {
                    i++;

                    options.success([
                        { id: i, leaf: false, text: "foo " + i }
                    ]);
                }

                createTreeView({
                    dataSource: {
                        transport: {
                            read: readAction
                        },
                        schema: {
                            model: {
                                children: {
                                    transport: {
                                        read: readAction
                                    }
                                }
                            }
                        }
                    },
                    animation: false
                });

                treeviewObject.toggle(treeview.find(".k-item"));

                equal(treeview.find(".k-item").length, 2);
                equal(treeview.find(".k-minus").length, 1);
            });
        </script>

        <div id="qunit-fixture"> </div>
        <ul id="log"></ul>
    </body>
</html>


