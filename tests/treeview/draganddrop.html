<!DOCTYPE html>
<html>
    <head>
        <title>TreeView : Drag and Drop</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <link rel="stylesheet" href="../qunit.css" />
        <link rel="stylesheet" href="../../styles/kendo.common.css" />
        <link rel="stylesheet" href="../../styles/kendo.vista.css" />
    </head>
    <body>
        <h1 id="qunit-header">Drag and Drop</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>

        <!-- replace this with client-side rendering -->
        <div class="t-widget t-treeview t-reset" id="myTreeView"></div>

        <script>
            var TreeView = kendo.ui.TreeView,
                treeview, onDataBindingCalled;

            function findItemByText(text) {
                return $('.t-in:contains(' + text + ')').closest('.t-item');
            }

            function createTreeView(data) {
                var rendering = new kendo.ui.TreeView.TreeViewRendering();

                return $(rendering.renderGroup({
                    group: {
                        isFirstLevel: true,
                        isExpanded: true
                    },
                    items: data
                })).appendTo(document.body).kendoTreeView();
            }

            function moveTreeViewNode(sourceNode, destinationNode) {
                var source = findItemByText(sourceNode),
                    destination = findItemByText(destinationNode),
                    sourceNode = source.find('.t-in:first'),
                    destinationNode = destination.find('.t-in:first'),
                    startOffset = sourceNode.offset(),
                    endOffset = destinationNode.offset();

                sourceNode
                    .trigger({ type: "mousedown", pageX: startOffset.left + 5, pageY: startOffset.top + 5, relatedTarget: sourceNode[0] });

                destinationNode
                    .trigger({ type: "mousemove", pageX: endOffset.left + 5, pageY: endOffset.top + 7, target: destinationNode[0] })
                    .trigger({ type: "mousemove", pageX: endOffset.left + 5, pageY: endOffset.top + 7, target: destinationNode[0] })
                    .trigger({ type: "mouseup",   pageX: endOffset.left + 5, pageY: endOffset.top + 7, target: destinationNode[0] })
            }

            module("TreeView / DragAndDrop", {
                setup: function () {
                    treeview = createTreeView([
                        { text: "Product 1", expanded: true,
                            items: [
                              { text: "Subproduct 1.1", expanded: true,
                                  items: [
                                    { text: "Subsubproduct 1.1.1" },
                                    { text: "Subsubproduct 1.1.2" }
                                  ]
                              }
                            ]
                        },
                        { text: "Product 2", enabled: false },
                        { text: "Product 3" },
                        { text: "Product 4", expanded: true,
                            items: [
                              { text: "Subproduct 4.1", expanded: true },
                              { text: "Subproduct 4.2", expanded: true }
                            ]
                        }
                    ]);

                    onDataBindingCalled = false;

                    treeview.onDataBinding = function (e) {
                        onDataBindingCalled = true;
                        if (e.item != treeview.element) {
                            treeview.dataBind(e.item, [{ text: "Abyss Node", loadOnDemand: true, value: "abyss"}]);
                        }
                    };
                },
                teardown: function() {
                    treeview.remove();
                }
            });

            test('moving parent to child item does not move it', function () {
                moveTreeViewNode('Product 1', 'Subproduct 1.1');

                ok(findItemByText('Product 1').parent().hasClass('t-treeview-lines'));
            });

            test('cancelling OnNodeDragStart prevents drag', function () {
                $(treeview.element).bind('nodeDragStart', function (e) { e.preventDefault(); });

                moveTreeViewNode('Subproduct 1.1', 'Product 3');

                equal(findItemByText('Subproduct 1.1').parent().closest('.t-item')[0], findItemByText('Product 1')[0]);
            });

/*
            test('dragging nodes triggers nodeDragging event', function() {
                var triggered;
                
                treeview.bind('nodeDragging', function (e) {
                    triggered = true;
                });

                moveTreeViewNode('Subproduct 1.1', 'Product 3');

                ok(triggered);
            });
*/

            test('setting hint to denied in nodeDragging prevents nodeDropped event', function() {
                var triggered;
                
                $(treeview.element)
                    .bind({
                        nodeDragging: function (e) {
                            e.setStatusClass("t-denied");
                        },
                        nodeDropped: function (e) {
                            triggered = true;
                        }
                    });

                moveTreeViewNode('Subproduct 1.1', 'Product 3');

                ok(!triggered);
            });

            test('setting hint to denied in nodeDragging prevents node movement', function() {
                $(treeview.element)
                    .bind({
                        nodeDragging: function (e) {
                            e.setStatusClass("t-denied");
                        }
                    });

                moveTreeViewNode('Subproduct 1.1', 'Product 3');

                equal(findItemByText('Subproduct 1.1').parent().closest('.t-item')[0], findItemByText('Product 1')[0]);

            });

            /*
            test('move item to collapsed lod sibling triggers onDataBinding handler', function () {
                treeview.data("kendoTreeView").bindTo([
                    { text: "Product 1", expanded: false, loadOnDemand: true, value: "abyss" },
                    { text: "Product 2", expanded: false,
                        items: [
                            { text: "Subproduct 2.1" },
                            { text: "Subproduct 2.2" }
                        ]
                    }
                ]);

                ok(!!treeview.data("kendoTreeView").isAjax());

                $(treeview.element).bind('dataBinding', treeview.onDataBinding);

                moveTreeViewNode('Product 2', 'Product 1');

                ok(!!onDataBindingCalled, 'onDataBinding handler not called');
                equal(findItemByText('Product 1').find('> .t-group').children().length, 2, 'items not appended');
            });

            test('move item to collapsed lod node rendered on client triggers onDataBinding handler', function () {
                treeview.data("kendoTreeView").bindTo([
                    { text: "Product 1", expanded: false, loadOnDemand: true, value: "abyss" },
                    { text: "Product 2", expanded: false,
                        items: [
                            { text: "Subproduct 2.1" },
                            { text: "Subproduct 2.2" }
                        ]
                    }
                ]);

                ok(!!treeview.data("kendoTreeView").isAjax());

                $(treeview.element).bind('dataBinding', treeview.onDataBinding);

                findItemByText('Product 1').find('> div > .t-plus').trigger('click');

                moveTreeViewNode('Product 2', 'Abyss Node');

                ok(!!onDataBindingCalled, 'onDataBinding handler not called');
                equal(findItemByText('Abyss Node').find('> .t-group').children().length, 2, 'items not appended');
            });
            */
        </script>

        <div id="qunit-fixture"> </div>
        <ul id="log"></ul>
    </body>
</html>

