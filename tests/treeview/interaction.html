<!DOCTYPE html>
<html>
    <head>
        <title>TreeView interaction</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
        <link rel="stylesheet" href="../../styles/web/kendo.common.css" />
        <link rel="stylesheet/less" href="../../styles/web/kendo.default.less" />
        <script src="../../demos/mvc/content/shared/js/less.js"></script>
        <script src="test-helper.js"></script>
    </head>
    <body>
        <h1 id="qunit-header">TreeView interaction</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>

        <script>
            function removeTreeViews() {
                $(".k-treeview,.k-drag-clue").remove();
            }

            $.fn.press = function(key) {
                return this.trigger({ type: "keydown", keyCode: key } );
            };

            var keys = kendo.keys;

            module("expand / collapse", {
                teardown: removeTreeViews
            });

            test("expanding disabled items does not expand them", function() {
                createTreeView([
                    { text: "foo", enabled: false, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-plus")
                    .toggleClass("k-plus-disabled", true)
                    .trigger("click");

                equal(item.find(".k-group").css("display"), "none");
            });

            test("clicking plus icon should toggle minus icon and show subgroup", function() {
                createTreeView([
                    { text: "foo", items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-plus")
                    .trigger("click");

                ok(item.find(".k-icon").hasClass("k-minus"));
                equal(item.find(".k-group").css("display"), "block");
            });

            test("clicking minus icon should toggle plus icon and collaspe subgroup", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-minus")
                    .trigger("click");

                ok(item.find(".k-icon").hasClass("k-plus"));
                equal(item.find(".k-group").css("display"), "none");
            });

            test("double clicking disabled items does not expand them", function() {
                createTreeView([
                    { text: "foo", disabled: true, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-in.k-state-disabled")
                    .trigger("dblclick");

                equal(item.find(".k-group").css("display"), "none");
            });

            module("selection", {
                teardown: removeTreeViews
            });

            test("clicking nodes selects them", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var item = treeview.find(".k-item:first .k-in");

                item.trigger("click");

                ok(item.hasClass("k-state-selected"));
            });

            test("clicking disabled nodes does not select them", function() {
                createTreeView([
                    { text: "foo", enabled: false }
                ]);

                var item = $(".k-item:first", treeview).find(".k-in");

                item.trigger("click");

                ok(!item.hasClass("k-state-selected"));
            });

            module("drag & drop", {
                teardown: removeTreeViews
            });

            function moveNode(treeview, sourceText, destinationText, dropPosition) {
                var sourceNode = treeview.findByText(sourceText).find(".k-in:first"),
                    destinationNode = treeview.findByText(destinationText).find(".k-in:first"),
                    startOffset = sourceNode.offset(),
                    endOffset = destinationNode.offset(),
                    extend = $.extend,
                    sourcePosition = {
                        pageX: startOffset.left + 5,
                        pageY: startOffset.top + 5,
                        relatedTarget: sourceNode[0]
                    },
                    nodeHeight = destinationNode.height(),
                    endOffsetDelta = dropPosition == "below" ? nodeHeight-1 :
                                     dropPosition == "above" ? 1 :
                                     nodeHeight / 2,
                    destinationPosition = {
                        pageX: endOffset.left + 5,
                        pageY: endOffset.top + endOffsetDelta,
                        target: destinationNode[0]
                    };

                sourceNode
                    .trigger(extend({ type: "mousedown" }, sourcePosition));

                $(document.documentElement)
                    .trigger(extend({ type: "mousemove"}, destinationPosition))
                    .trigger(extend({ type: "mouseup"}, destinationPosition));
            }

            test("moving item across parents", function () {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "foo", expanded: true, items: [
                            { text: "bar" }
                        ] },
                        { text: "baz" }
                    ]
                });

                moveNode(treeviewObject, "bar", "baz");

                equals(treeviewObject.findByText("foo").find(".k-item").length, 0);
                equals(treeviewObject.findByText("baz").find(".k-item").length, 1);
            });

            test("moving parent to child item does not move it", function () {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar" }
                    ] }
                ]),

                moveNode(treeviewObject, "foo", "bar");

                ok(treeviewObject.findByText("foo").parent().hasClass("k-treeview-lines"));
            });

            test("moving node above another", function() {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "foo" },
                        { text: "bar" },
                        { text: "baz" }
                    ]
                });

                moveNode(treeviewObject, "foo", "baz", "above");

                equal(treeview.text(), "barfoobaz");
            });

            test("moving nodes updates toggle button and group visibility", function() {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "bar" },
                        { text: "foo", expanded: true, items: [
                            { text: "baz" },
                            { text: "qux" }
                        ] }
                    ]
                });

                moveNode(treeviewObject, "baz", "bar");

                ok(treeviewObject.findByText("bar").find(".k-icon:first").hasClass("k-minus"));
                ok(treeviewObject.findByText("bar").find(".k-group").is(":visible"));
            });

            test("moving nodes to last child", function() {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "foo", expanded: true, items: [
                            { text: "baz" },
                            { text: "qux" }
                        ] },
                        { text: "bar", items: [
                            { text: "cat" }
                        ] }
                    ]
                });

                moveNode(treeviewObject, "baz", "bar");

                ok(treeviewObject.findByText("bar").find(".k-icon:first").hasClass("k-minus"));
                ok(treeviewObject.findByText("bar").find(".k-group").is(":visible"));
            });

            module("keyboard support", {
                teardown: removeTreeViews
            });

            test("right arrow expands node", 1, function() {
                createTreeView({
                    dataSource: [
                        { selected: true, text: "foo", items: [
                            { text: "bar" }
                        ] }
                    ],
                    expand: function(e) {
                        ok(true);
                    }
                });

                treeview.press(keys.RIGHT);
            });

            test("right arrow at expanded node moves to first child", function() {
                createTreeView([
                    { selected: true, text: "foo", expanded: true, items: [
                        { text: "bar" }
                    ] }
                ]);

                treeview.press(keys.RIGHT);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[1]);
            });

            test("left arrow collapses expanded nodes", 1, function() {
                createTreeView({
                    dataSource: [
                        { selected: true, expanded: true, text: "foo", items: [
                            { text: "bar" }
                        ] }
                    ],
                    collapse: function(e) {
                        ok(true);
                    }
                });

                treeview.press(keys.LEFT);
            });

            test("left arrow selects parent node of already collapsed nodes", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { selected: true, text: "bar", items: [
                            { text: "baz" }
                        ] }
                    ] }
                ]);

                treeview.press(keys.LEFT);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[0]);
            });

            test("down arrow moves selection to next sibling", function() {
                createTreeView([
                    { text: "foo", selected: true },
                    { text: "baz" }
                ]);

                treeview.press(keys.DOWN);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[1]);
            });

            test("down arrow moves selection to first child, if expanded", function() {
                createTreeView([
                    { text: "foo", expanded: true, selected: true, items: [
                        { text: "bar" }
                    ] },
                    { text: "baz" }
                ]);

                treeview.press(keys.DOWN);

                equal(treeviewObject.select()[0], treeview.find(".k-item .k-item")[0]);
            });

            test("down arrow moves selection to next parent, if there are no more siblings left", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar", selected: true }
                    ] },
                    { text: "baz" }
                ]);

                treeview.press(keys.DOWN);

                equal(treeviewObject.select()[0], treeview.find(".k-item:last")[0]);
            });

            test("down arrow moves selection to next grandparent, if there are no more siblings left", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar", expanded: true, items: [
                            { text: "baz", selected: true }
                        ] }
                    ] },
                    { text: "qux" }
                ]);

                treeview.press(keys.DOWN);

                equal(treeviewObject.select()[0], treeview.find(".k-item:last")[0]);
            });

            test("down arrow does not change selection when hitting the last item", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "qux", selected: true }
                ]);

                treeview.press(keys.DOWN);

                equal(treeviewObject.select()[0], treeview.find(".k-item:last")[0]);
            });

            test("down arrow in treeview without selection selects first node", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" }
                ]);

                treeview.press(keys.DOWN);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[0]);
            });

            test("up arrow in treeview without selection selects last node", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" }
                ]);

                treeview.press(keys.UP);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[1]);
            });

            test("up arrow moves selection to previous node", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar", selected: true }
                ]);

                treeview.press(keys.UP);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[0]);
            });

            test("up arrow moves selection to last expanded node of previous node", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar" }
                    ] },
                    { text: "baz", selected: true }
                ]);

                treeview.press(keys.UP);

                equal(treeviewObject.select()[0], treeview.find(".k-item .k-item")[0]);
            });

            test("up arrow moves selection to previous grandparent, when parents are expanded", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar", expanded: true, items: [
                            { text: "baz" }
                        ] }
                    ] },
                    { text: "qux", selected: true }
                ]);

                treeview.press(keys.UP);

                equal(treeviewObject.select()[0], treeview.find(".k-item .k-item .k-item")[0]);
            });

            test("up arrow moves selection to parent node when out of previous nodes", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar", selected: true }
                    ] }
                ]);

                treeview.press(keys.UP);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[0]);
            });

            test("home key moves selection to first node", function() {
                createTreeView([
                    { text: "foo" },
                    { text: "bar" },
                    { text: "baz", selected: true }
                ]);

                treeview.press(keys.HOME);

                equal(treeviewObject.select()[0], treeview.find(".k-item")[0]);
            });

            test("end key moves selection to last node", function() {
                createTreeView([
                    { text: "foo", selected: true },
                    { text: "bar" },
                    { text: "baz" }
                ]);

                treeview.press(keys.END);

                equal(treeviewObject.select()[0], treeview.find(".k-item:last")[0]);
            });

            test("end key moves to last child node", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar", expanded: true, items: [
                            { text: "baz" }
                        ] }
                    ] }
                ]);

                treeview.press(keys.END);

                equal(treeviewObject.select()[0], treeview.find(".k-item .k-item .k-item")[0]);

            });

            test("enter key triggers select event after changing selection", 1, function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                        { text: "bar" }
                    ],
                    select: function(e) {
                        equal(e.node, treeview.find(".k-item:last")[0]);
                    }
                });

                treeview.press(keys.DOWN);
                treeview.press(keys.ENTER);
            });

            test("enter key does not trigger select event if selection was not changed", function() {
                var triggered = false;

                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                        { text: "bar" }
                    ],
                    select: function() {
                        triggered = true;
                    }
                });

                treeview.press(keys.ENTER);

                ok(!triggered);
            });

            test("enter key triggers select event after a sequential selection has been made", function() {
                var triggeredCount = 0;

                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                        { text: "bar" }
                    ],
                    select: function() {
                        triggeredCount++;
                    }
                });

                treeview.press(keys.DOWN);
                treeview.press(keys.ENTER);
                treeview.press(keys.UP);
                treeview.press(keys.ENTER);

                equal(triggeredCount, 2);
            });

            test("space key toggles checkbox state", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                    ],
                    checkboxTemplate: "<input type='checkbox' />"
                });

                treeview.press(keys.SPACEBAR);

                ok(treeview.find(":checkbox").is(":checked"));

                treeview.press(keys.SPACEBAR);

                ok(!treeview.find(":checkbox").is(":checked"));
            });

            test("space on item without checkbox does nothing", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                    ]
                });

                treeview.press(keys.SPACEBAR);

                ok(true);
            });

            test("blurring the treeview triggers select event", function() {
                var triggeredCount = 0;

                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                        { text: "bar" }
                    ],
                    select: function() {
                        triggeredCount++;
                    }
                });

                treeview.focus();
                treeview.press(keys.DOWN);
                treeview.blur();

                equal(triggeredCount, 1);

            });

            test("blurring the treeview does not trigger select event, if selection has not changed", function() {
                var triggeredCount = 0;

                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                        { text: "bar" }
                    ],
                    select: function() {
                        triggeredCount++;
                    }
                });

                treeview.focus();
                treeview.press(keys.DOWN);
                treeview.press(keys.UP);
                treeview.blur();

                equal(triggeredCount, 0);
            });

            test("blurring without changing the selection does not trigger select event", function() {
                var triggeredCount = 0;

                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                        { text: "bar" }
                    ],
                    select: function() {
                        triggeredCount++;
                    }
                });

                treeview.focus();
                treeview.blur();

                equal(triggeredCount, 0);
            });

            test("checking checkboxes sets indeterminate state of parents", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", items: [
                            { text: "bar", selected: true },
                            { text: "baz" }
                        ] },
                    ],
                    checkboxes: {
                        checkChildren: true
                    }
                });

                treeview.press(keys.SPACEBAR);

                ok(treeview.find(":checkbox:first").prop("indeterminate"));
            });

            test("checking checkboxes sets checked state of parents", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", items: [
                            { text: "bar", selected: true }
                        ] },
                    ],
                    checkboxes: {
                        checkChildren: true
                    }
                });

                treeview.press(keys.SPACEBAR);

                ok(treeview.find(":checkbox:first").prop("checked"));
            });

            test("checking checkboxes sets checked state of children", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true, items: [
                            { text: "bar" },
                            { text: "baz" }
                        ] },
                    ],
                    checkboxes: {
                        checkChildren: true
                    }
                });

                treeview.press(keys.SPACEBAR);

                var checkboxes = treeview.find(":checkbox");

                ok(checkboxes.eq(1).prop("checked"));
                ok(checkboxes.eq(2).prop("checked"));
            });

            test("checking checkboxes clears indeterminate flag", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", items: [
                            { text: "bar", selected: true },
                            { text: "baz" }
                        ] },
                    ],
                    checkboxes: {
                        checkChildren: true
                    }
                });

                // check selected item
                treeview.press(keys.SPACEBAR);

                // move to 'foo'
                treeview.press(keys.UP);

                // check 'foo'
                treeview.press(keys.SPACEBAR);

                ok(!treeview.find(":checkbox:first").prop("indeterminate"));
            });

            test("checking parent clears indeterminate state of children", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", items: [
                            { text: "bar", items: [
                                { text: "baz", selected: true },
                                { text: "cat" }
                            ] }
                        ] }
                    ],
                    checkboxes: {
                        checkChildren: true
                    }
                });

                // check selected item
                treeview.press(keys.SPACEBAR);

                // move to 'foo'
                treeview.press(keys.UP);
                treeview.press(keys.UP);

                // check 'foo'
                treeview.press(keys.SPACEBAR);

                ok(!treeview.find(":checkbox").eq(1).prop("indeterminate"));
                ok(!treeview.find(":checkbox").eq(1).data("indeterminate"));
            });

            test("down arrow skips disabled items on same level", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true },
                        { text: "bar", enabled: false },
                        { text: "baz" }
                    ]
                });

                treeview.press(keys.DOWN);

                equal(treeview.find(".k-state-selected").text(), "baz");
            });

            test("down arrow skips disabled child items", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true, expanded: true, items: [
                            { text: "bar", enabled: false },
                            { text: "baz" }
                        ] }
                    ]
                });

                treeview.press(keys.DOWN);

                equal(treeview.find(".k-state-selected").text(), "baz");
            });

            test("right arrow skips disabled first child", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true, expanded: true, items: [
                            { text: "bar", enabled: false },
                            { text: "baz" }
                        ] }
                    ]
                });

                treeview.press(keys.RIGHT);

                equal(treeview.find(".k-state-selected").text(), "baz");
            });

            test("right arrow skips disabled first child", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", selected: true, expanded: true, items: [
                            { text: "bar", enabled: false, expanded: true, items: [
                                { text: "baz" }
                            ] }
                        ] }
                    ]
                });

                treeview.press(keys.RIGHT);

                equal(treeview.find(".k-state-selected").text(), "baz");
            });

            test("up arrow skips disabled items", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", expanded: true, items: [
                            { text: "bar", enabled: false, expanded: true, items: [
                                { text: "baz", selected: true }
                            ] }
                        ] }
                    ]
                });

                treeview.press(keys.UP);

                equal(treeview.find(".k-state-selected").text(), "foo");
            });

            test("left arrow does nothing when going to disabled parent", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", expanded: true, items: [
                            { text: "bar", enabled: false, expanded: true, items: [
                                { text: "baz", selected: true }
                            ] }
                        ] }
                    ]
                });

                treeview.press(keys.LEFT);

                equal(treeview.find(".k-state-selected").text(), "baz");
            });

            test("down arrow without selection goes to first non-disabled item", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo", enabled: false },
                        { text: "baz" }
                    ]
                });

                treeview.press(keys.DOWN);

                equal(treeview.find(".k-state-selected").text(), "baz");
            });

            test("up arrow without selection goes to last non-disabled item", function() {
                createTreeView({
                    dataSource: [
                        { text: "foo" },
                        { text: "baz", enabled: false }
                    ]
                });

                treeview.press(keys.UP);

                equal(treeview.find(".k-state-selected").text(), "foo");
            });

            module("drag & drop with load-on-demand", {
                setup: function() {
                    var i = 1;

                    createTreeView({
                        dragAndDrop: true,
                        dataSource: {
                            transport: {
                                read: function(options) {
                                    if (i == 1) {
                                        options.success([
                                            { text: "Item " + (i++), hasChildren: true },
                                            { text: "Item " + (i++), hasChildren: false }
                                        ]);
                                    } else {
                                        setTimeout(function() {
                                            options.success([
                                                { text: "Item " + (i++), hasChildren: true },
                                                { text: "Item " + (i++), hasChildren: false }
                                            ]);
                                        }, 100);
                                    }
                                }
                            },
                            schema: {
                                model: {
                                    hasChildren: "hasChildren"
                                }
                            }
                        }
                    });
                },
                teardown: removeTreeViews
            });

            asyncTest("dropping items over unfetched nodes fetches and appends node", function() {
                moveNode(treeviewObject, "Item 2", "Item 1");

                setTimeout(function() {
                    equal(treeview.find(".k-item .k-item").length, 3);
                    start();
                }, 200);
            });
        </script>

        <div id="qunit-fixture"> </div>
        <ul id="log"></ul>
    </body>
</html>
