<!DOCTYPE html>
<html>
    <head>
        <title>TreeView interaction</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
        <link rel="stylesheet" href="../../styles/web/kendo.common.css" />
        <link rel="stylesheet/less" href="../../styles/web/kendo.default.less" />
        <script src="../../demos/mvc/content/shared/js/less.js"></script>
        <script src="test-helper.js"></script>
    </head>
    <body>
        <h1 id="qunit-header">TreeView interaction</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>

        <script>
            function removeTreeViews() {
                $(".k-treeview,.k-drag-clue").remove();
            }

            module("expand / collapse", {
                teardown: removeTreeViews
            });

            test("expanding disabled items does not expand them", function() {
                createTreeView([
                    { text: "foo", enabled: false, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-plus")
                    .toggleClass("k-plus-disabled", true)
                    .trigger("click");

                equal(item.find(".k-group").css("display"), "none");
            });

            test("clicking plus icon should toggle minus icon and show subgroup", function() {
                createTreeView([
                    { text: "foo", items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-plus")
                    .trigger("click");

                ok(item.find(".k-icon").hasClass("k-minus"));
                equal(item.find(".k-group").css("display"), "block");
            });

            test("clicking minus icon should toggle plus icon and collaspe subgroup", function() {
                createTreeView([
                    { text: "foo", expanded: true, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-minus")
                    .trigger("click");

                ok(item.find(".k-icon").hasClass("k-plus"));
                equal(item.find(".k-group").css("display"), "none");
            });

            test("double clicking disabled items does not expand them", function() {
                createTreeView([
                    { text: "foo", disabled: true, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-in.k-state-disabled")
                    .trigger("dblclick");

                equal(item.find(".k-group").css("display"), "none");
            });

            module("selection", {
                teardown: removeTreeViews
            });

            test("clicking nodes selects them", function() {
                createTreeView([
                    { text: "foo" }
                ]);

                var item = treeview.find(".k-item:first .k-in");

                item.trigger("click");

                ok(item.hasClass("k-state-selected"));
            });

            test("clicking disabled nodes does not select them", function() {
                createTreeView([
                    { text: "foo", enabled: false }
                ]);

                var item = $(".k-item:first", treeview).find(".k-in");

                item.trigger("click");

                ok(!item.hasClass("k-state-selected"));
            });

            module("drag & drop", {
                teardown: removeTreeViews
            });

            function moveNode(treeview, sourceText, destinationText, dropPosition) {
                var sourceNode = treeview.findByText(sourceText).find(".k-in:first"),
                    destinationNode = treeview.findByText(destinationText).find(".k-in:first"),
                    startOffset = sourceNode.offset(),
                    endOffset = destinationNode.offset(),
                    extend = $.extend,
                    sourcePosition = {
                        pageX: startOffset.left + 5,
                        pageY: startOffset.top + 5,
                        relatedTarget: sourceNode[0]
                    },
                    nodeHeight = destinationNode.height(),
                    endOffsetDelta = dropPosition == "below" ? nodeHeight-1 :
                                     dropPosition == "above" ? 1 :
                                     nodeHeight / 2,
                    destinationPosition = {
                        pageX: endOffset.left + 5,
                        pageY: endOffset.top + endOffsetDelta,
                        target: destinationNode[0]
                    };

                sourceNode
                    .trigger(extend({ type: "mousedown" }, sourcePosition));

                $(document.documentElement)
                    .trigger(extend({ type: "mousemove"}, destinationPosition))
                    .trigger(extend({ type: "mouseup"}, destinationPosition));
            }

            test("moving item across parents", function () {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "foo", expanded: true, items: [
                            { text: "bar" }
                        ] },
                        { text: "baz" }
                    ]
                });

                moveNode(treeviewObject, "bar", "baz");

                equals(treeviewObject.findByText("foo").find(".k-item").length, 0);
                equals(treeviewObject.findByText("baz").find(".k-item").length, 1);
            });

            test("moving parent to child item does not move it", function () {
                createTreeView([
                    { text: "foo", expanded: true, items: [
                        { text: "bar" }
                    ] }
                ]),

                moveNode(treeviewObject, "foo", "bar");

                ok(treeviewObject.findByText("foo").parent().hasClass("k-treeview-lines"));
            });

            test("moving node above another", function() {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "foo" },
                        { text: "bar" },
                        { text: "baz" }
                    ]
                });

                moveNode(treeviewObject, "foo", "baz", "above");

                equal(treeview.text(), "barfoobaz");
            });

            test("moving nodes updates toggle button and group visibility", function() {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "bar" },
                        { text: "foo", expanded: true, items: [
                            { text: "baz" },
                            { text: "qux" }
                        ] }
                    ]
                });

                moveNode(treeviewObject, "baz", "bar");

                ok(treeviewObject.findByText("bar").find(".k-icon:first").hasClass("k-minus"));
                ok(treeviewObject.findByText("bar").find(".k-group").is(":visible"));
            });

            test("moving nodes to last child", function() {
                createTreeView({
                    dragAndDrop: true,
                    dataSource: [
                        { text: "foo", expanded: true, items: [
                            { text: "baz" },
                            { text: "qux" }
                        ] },
                        { text: "bar", items: [
                            { text: "cat" }
                        ] }
                    ]
                });

                moveNode(treeviewObject, "baz", "bar");

                ok(treeviewObject.findByText("bar").find(".k-icon:first").hasClass("k-minus"));
                ok(treeviewObject.findByText("bar").find(".k-group").is(":visible"));
            });

            module("drag & drop with load-on-demand", {
                setup: function() {
                    var i = 1;

                    createTreeView({
                        dragAndDrop: true,
                        dataSource: {
                            transport: {
                                read: function(options) {
                                    if (i == 1) {
                                        options.success([
                                            { text: "Item " + (i++), hasChildren: true },
                                            { text: "Item " + (i++), hasChildren: false }
                                        ]);
                                    } else {
                                        setTimeout(function() {
                                            options.success([
                                                { text: "Item " + (i++), hasChildren: true },
                                                { text: "Item " + (i++), hasChildren: false }
                                            ]);
                                        }, 100);
                                    }
                                }
                            },
                            schema: {
                                model: {
                                    hasChildren: "hasChildren"
                                }
                            }
                        }
                    });
                },
                teardown: removeTreeViews
            });

            asyncTest("dropping items over unfetched nodes fetches and appends node", function() {
                moveNode(treeviewObject, "Item 2", "Item 1");

                setTimeout(function() {
                    equal(treeview.find(".k-item .k-item").length, 3);
                    start();
                }, 200);
            });
        </script>

        <div id="qunit-fixture"> </div>
        <ul id="log"></ul>
    </body>
</html>
