<!DOCTYPE html>
<html>
    <head>
        <title>TreeView interaction</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit/qunit/qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.data.js"></script>
        <script src="../../src/kendo.draganddrop.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <link rel="stylesheet" href="../qunit/qunit/qunit.css" />
        <link rel="stylesheet" href="../../styles/web/kendo.common.css" />
        <link rel="stylesheet/less" href="../../styles/web/kendo.default.less" />
        <script src="../../demos/mvc/content/shared/js/less.js"></script>
    </head>
    <body>
        <h1 id="qunit-header">TreeView interaction</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>

        <script>
            function createTreeView(options) {
                return $("<div />").appendTo(document.body).kendoTreeView(options);
            }

            function removeTreeViews() {
                $(".k-treeview").remove();
            }

            module("expand / collapse", {
                teardown: removeTreeViews
            });

            test("expanding disabled items does not expand them", function() {
                var treeview = createTreeView([
                    { text: "foo", enabled: false, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-plus")
                    .toggleClass("k-plus-disabled", true)
                    .trigger("click");

                equal(item.find(".k-group").css("display"), "none");
            });

            test("clicking plus icon should toggle minus icon and show subgroup", function() {
                var treeview = createTreeView([
                    { text: "foo", items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-plus")
                    .trigger("click");

                ok(item.find(".k-icon").hasClass("k-minus"));
                equal(item.find(".k-group").css("display"), "block");
            });

            test("clicking minus icon should toggle plus icon and collaspe subgroup", function() {
                var treeview = createTreeView([
                    { text: "foo", expanded: true, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-minus")
                    .trigger("click");

                ok(item.find(".k-icon").hasClass("k-plus"));
                equal(item.find(".k-group").css("display"), "none");
            });

            test("double clicking disabled items does not expand them", function() {
                var treeview = createTreeView([
                    { text: "foo", disabled: true, items: [ { text: "bar" } ] }
                ]);

                var item = $(".k-item:first", treeview);

                item.find(".k-in.k-state-disabled")
                    .trigger("dblclick");

                equal(item.find(".k-group").css("display"), "none");
            });

            module("selection", {
                teardown: removeTreeViews
            });

            test("clicking nodes selects them", function() {
                var treeview = createTreeView([
                    { text: "foo" }
                ]);

                var item = treeview.find(".k-item:first .k-in");

                item.trigger("click");

                ok(item.hasClass("k-state-selected"));
            });

            test("clicking disabled nodes does not select them", function() {
                var treeview = createTreeView([
                    { text: "foo", enabled: false }
                ]);

                var item = $(".k-item:first", treeview).find(".k-in");

                item.trigger("click");

                ok(!item.hasClass("k-state-selected"));
            });

            module("drag & drop", {
                teardown: removeTreeViews
            });

            function moveNode(treeview, sourceText, destinationText, dropPosition) {
                var sourceNode = treeview.findByText(sourceText).find(".k-in:first"),
                    destinationNode = treeview.findByText(destinationText).find(".k-in:first"),
                    startOffset = sourceNode.offset(),
                    endOffset = destinationNode.offset(),
                    extend = $.extend,
                    sourcePosition = {
                        pageX: startOffset.left + 5,
                        pageY: startOffset.top + 5,
                        relatedTarget: sourceNode[0]
                    },
                    nodeHeight = destinationNode.height(),
                    endOffsetDelta = dropPosition == "below" ? nodeHeight-1 :
                                     dropPosition == "above" ? 1 :
                                     nodeHeight / 2,
                    destinationPosition = {
                        pageX: endOffset.left + 5,
                        pageY: endOffset.top + endOffsetDelta,
                        target: destinationNode[0]
                    };

                sourceNode
                    .trigger(extend({ type: "mousedown" }, sourcePosition));

                $(document.documentElement)
                    .trigger(extend({ type: "mousemove"}, destinationPosition))
                    .trigger(extend({ type: "mouseup"}, destinationPosition));
            }

            test("moving item across parents", function () {
                var treeview = createTreeView({
                        dragAndDrop: true,
                        dataSource: [
                            { text: "foo", expanded: true, items: [
                                { text: "bar" }
                            ] },
                            { text: "baz" }
                        ]
                    }),
                    treeviewObject = treeview.data("kendoTreeView");

                moveNode(treeviewObject, "bar", "baz");

                equals(treeviewObject.findByText("foo").find(".k-item").length, 0);
                equals(treeviewObject.findByText("baz").find(".k-item").length, 1);
            });

            test("moving parent to child item does not move it", function () {
                var treeview = createTreeView([
                        { text: "foo", expanded: true, items: [
                            { text: "bar" }
                        ] }
                    ]),
                    treeviewObject = treeview.data("kendoTreeView");

                moveNode(treeviewObject, "foo", "bar");

                ok(treeviewObject.findByText("foo").parent().hasClass("k-treeview-lines"));
            });

            test("moving node above another", function() {
                var treeview = createTreeView({
                        dragAndDrop: true,
                        dataSource: [
                            { text: "foo" },
                            { text: "bar" },
                            { text: "baz" }
                        ]
                    }),
                    treeviewObject = treeview.data("kendoTreeView");

                moveNode(treeviewObject, "foo", "baz", "above");

                equal(treeview.text(), "barfoobaz");
            });

            test("moving nodes updates toggle button correctly", function() {
                var treeview = createTreeView({
                        dragAndDrop: true,
                        dataSource: [
                            { text: "bar" },
                            { text: "foo", expanded: true, items: [
                                { text: "baz" },
                                { text: "qux" }
                            ] }
                        ]
                    }),
                    treeviewObject = treeview.data("kendoTreeView");

                moveNode(treeviewObject, "baz", "bar");

                ok(treeviewObject.findByText("foo").find(".k-icon:first").hasClass("k-minus"));
            });
        </script>

        <div id="qunit-fixture"> </div>
        <ul id="log"></ul>
    </body>
</html>
