<!DOCTYPE html>
<html>
    <head>
        <title>TreeView Rendering</title>
        <script src="../../src/jquery.js"></script>
        <script src="../qunit.js"></script>
        <script src="../qunit-runner.js"></script>
        <script src="../../src/kendo.core.js"></script>
        <script src="../../src/kendo.treeview.js"></script>
        <link rel="stylesheet" href="../qunit.css" />
    </head>
    <body>
        <h1 id="qunit-header">TreeView Rendering</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar"></div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests"></ol>
        <script>
            var TreeView = kendo.ui.TreeView;

            module("rendering", {
                teardown: function() {
                    $(".t-treeview").remove();
                }
            });

            function treeviewFromHtml(html) {
                return $(html).appendTo(document.body).kendoTreeView().parent();
            }

            test("basic classes", function() {
                var element = treeviewFromHtml("<ul><li>item</li></ul>");

                ok(element.is("div"));
                ok(element.is(".t-widget.t-treeview"));
                ok(element.find("ul").is(".t-group"));
                ok(element.find("li").is(".t-item"));
            });

            test("first level group sets lines", function() {
                var element = treeviewFromHtml("<ul><li>item<ul><li>subitem</li></ul></li></ul>");

                ok(element.find("ul:first").is(".t-treeview-lines"));
                ok(element.find("ul:last").is(":not(.t-treeview-lines)"));
                ok(element.find("ul:last").is(".t-group"));
            });

            test("collapsed groups", function() {
                var element = treeviewFromHtml("<ul><li data-expanded='false'>item<ul><li>subitem</li></ul></li></ul>");

                equals(element.find("ul:last").css("display"), "none");
            });

            test("node wrappers", function() {
                var element = treeviewFromHtml("<ul><li>item  </li></ul>"),
                    wrapper = element.find("div:first");

                equals(wrapper.length, 1);
                ok(wrapper.hasClass("t-top"));
                equals(wrapper.find("span.t-in").length, 1);
                equals(wrapper.find("span.t-in").text(), "item");
            });

            test("moves arbitrary content in the text wrapper", function() {
                var element = treeviewFromHtml("<ul><li>item<span class='status'></span></li></ul>"),
                    wrapper = element.find("div:first");

                equals(wrapper.find("span.t-in").text(), "item");
                equals(wrapper.find("span.status").length, 1);
                ok(wrapper.find("span.status").parent().hasClass("t-in"));
            });

            module("group");

            var rendering = new kendo.ui.TreeView.TreeViewRendering();

            test("renders empty group when there are no items", function() {
                var html = rendering.renderGroup({
                    items: [],
                    group: {
                        isExpanded: true
                    }
                });

                equal(html, "<ul class='t-group'></ul>");
            });

            test("renders lines class for first level", function() {
                var html = rendering.renderGroup({ 
                    items: [],
                    group: {
                        isFirstLevel: true,
                        isExpanded: true
                    }
                });

                equal(html, "<ul class='t-group t-treeview-lines'></ul>");
            });

            test("renders hidden group if it is not expanded", function() {
                var html = rendering.renderGroup({
                    items: [],
                    group: {
                        isExpanded: false
                    }
                });

                equal(html, "<ul class='t-group' style='display:none'></ul>");
            });

            test("renders items, if any", function() {
                var html = rendering.renderGroup({ 
                    items: [
                        { text: "foo" }
                    ],
                    group: {
                        isFirstLevel: true,
                        isExpanded: true
                    }
                });

                equal($(html).find(".t-item").length, 1);
            });

            module("item");

            test("renders list items with t-item class", function() {
                var $item = $(rendering.renderItem({
                    item: {}
                }));

                ok($item.is("li.t-item"));
            });

            test("renders list items with t-first class for first item in first-level groups", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 0
                    },
                    group: {
                        isFirstLevel: true
                    }
                }));

                ok($item.is(".t-first"));
            });

            test("renders list items with t-last class for last item", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 0
                    },
                    group: {
                        length: 1,
                        isFirstLevel: true
                    }
                }));

                ok($item.is(".t-last"));
            });

            test("renders div elements with t-top class for first item in group", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 0
                    },
                    group: {
                        length: 2
                    }
                }));

                equals($item.find("div.t-top").length, 1);
            });

            test("renders div elements with t-bot class for last item in group", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 1
                    },
                    group: {
                        length: 3
                    }
                }));

                equals($item.find("div.t-mid").length, 1);
            });

            test("renders div elements with t-mid class for items in middle of group", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 1
                    },
                    group: {
                        length: 2
                    }
                }));

                equals($item.find("div.t-bot").length, 1);
            });

            test("does not render t-top class for last items in group", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 0
                    },
                    group: {
                        length: 1
                    }
                }));

                equals($item.find("div.t-top").length, 0);
            });

            test("does not render t-top class for single items in root group", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 0
                    },
                    group: {
                        isFirstLevel: true,
                        length: 1
                    }
                }));

                equals($item.find("div.t-top").length, 1);
            });

            test("renders of links for items with NavigateUrl", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        url: "http://kendoui.com/"
                    }
                }));

                equal($item.find("a[href='http://kendoui.com/']").length, 1);
            });

            test("renders disabled state on disabled items", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        enabled: false
                    }
                }));

                equal($item.find(".t-in.t-state-disabled").length, 1);
            });

            test("renders selected state on selected items", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        selected: true
                    }
                }));

                equal($item.find(".t-in.t-state-selected").length, 1);
            });

            test("renders collapsed subgroups by default", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "Collapsed",
                        items: [
                            { text: "Should not be visible" }
                        ]
                    }
                }));
                
                equal($item.find(".t-group").css("display"), "none");
            });


            test("renders spriteCssClass", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        spriteCssClass: "cssClass1"
                    }
                }));

                equal($item.find('.t-sprite').length, 1);
                ok($item.find('.t-sprite').hasClass('cssClass1'));
            });

            test("renders images", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        imageUrl: "foo"
                    }
                }));

                var image = $item.find(".t-image");

                equal(image.length, 1);
                equal(image.attr("src"), "foo");
            });

            test("renders item value", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        value: "foo"
                    }
                }));

                var input = $item.find(".t-input");

                equal(input.length, 1);
                equal(input.val(), "foo");
                equal(input.attr("type"), "hidden");
            });

            test("renders text", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "foo"
                    }
                }));

                equal($item.text(), "foo");
            });

            test("renders text encoded", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "foo>>"
                    }
                }));

                equal($item.text(), "foo>>");
            });

            test("renders encoded text as html", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "<span class='foo'></span>",
                        encoded: false
                    }
                }));

                equal($item.find(".foo").length, 1);
            });

            test("renders plus icon if item contains items", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "foo",
                        items: [
                            { text: "bar" }
                        ]
                    }
                }));

                equal($item.find(".t-icon.t-plus").length, 1);
            });

            test("renders minus icon if item is expanded", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "foo",
                        expanded: true,
                        items: [
                            { text: "bar" }
                        ]
                    }
                }));

                equal($item.find(".t-icon.t-minus").length, 1);
            });

            test("renders disabled plus icon if item is disabled", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "foo",
                        enabled: false,
                        items: [
                            { text: "bar" }
                        ]
                    }
                }));

                equal($item.find(".t-icon.t-plus-disabled").length, 1);
                equal($item.find(".t-icon.t-plus").length, 0);
            });

            test("renders disabled minus icon if item is disabled and expanded", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "foo",
                        enabled: false,
                        expanded: true,
                        items: [
                            { text: "bar" }
                        ]
                    }
                }));

                equal($item.find(".t-icon.t-minus-disabled").length, 1);
                equal($item.find(".t-icon.t-minus").length, 0);
            });

            test("does not render group, if there are no sub-items", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "foo"
                    },
                    treeview: {}
                }));

                equal($item.find(".t-group").length, 0);
            });

            module("checkboxes");

            test("should be rendered when showCheckboxes is true", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text"
                    },
                    treeview: {
                        showCheckboxes: true
                    }
                }));

                equal($item.find('> div > .t-checkbox').length, 1);
            });

            test("should not be rendered if checkable is false", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        checkable: false
                    },
                    treeview: {
                        showCheckboxes: true
                    }
                }));

                equal($item.find('> div > .t-checkbox').length, 0);
            });

            test("should render checkbox and hidden input", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text"
                    },
                    treeview: {
                        showCheckboxes: true
                    }
                }));

                equal($item.find('.t-checkbox .t-input[type="hidden"]').length, 1);
                equal($item.find('.t-checkbox .t-input[type="checkbox"]').length, 1);
            });

            test("should render hidden input with correct name", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text"
                    },
                    treeview: {
                        showCheckboxes: true,
                        id: "foo"
                    }
                }));

                equal($item.find(".t-input[type='hidden']").attr("name"), "foo_checkedNodes.Index");
            });

            test("should render correct index value for first level", function() {
                
                var $item = $(rendering.renderItem({
                    item: {
                        index: 0
                    },
                    treeview: {
                        showCheckboxes: true
                    }
                }));

                equal($item.find(".t-input[type='hidden']").attr("value"), "0");
            });

            test("should render index based on group level", function() {

                var $item = $(rendering.renderItem({
                    item: {
                        index: 2
                    },
                    treeview: {
                        showCheckboxes: true
                    },
                    group: {
                        level: "1:0"
                    }
                }));

                equal($item.find('.t-input[type="hidden"]').attr('value'), "1:0:2");
            });

            test("should render checkbox input with correct name", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        index: 0
                    },
                    treeview: {
                        showCheckboxes: true,
                        id: "foo"
                    },
                    group: {
                        level: "0"
                    }
                }));

                equal($item.find('.t-input[type="checkbox"]').attr('name'), "foo_checkedNodes[0:0].Checked");
            });

            test("should render checkbox input with value true if item is checked", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        checked: true
                    },
                    treeview: {
                        showCheckboxes: true
                    }
                }));

                equal($item.find('.t-input[type="checkbox"]').attr('value'), "True");
            });

            test("disabled items should render disabled checkbox attribute", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        checked: true,
                        enabled: false
                    },
                    treeview: {
                        showCheckboxes: true
                    },
                    group: {
                        level: "0"
                    }
                }));

                equal($item.find(".t-input[type='checkbox']").attr("disabled"), "disabled");
            });

            test("checked nodes should render checked checkboxes", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        checked: true
                    },
                    treeview: {
                        showCheckboxes: true
                    }
                }));

                equal($item.find("[type=checkbox]").attr("checked"), "checked");
            });

            test("renders hidden inputs containing dataItem values in checked items", function() {
                var $item = $(rendering.renderItem({
                    item: {
                        text: "text",
                        value: "1",
                        checked: true
                    },
                    treeview: {
                        showCheckboxes: true
                    }
                }));

                equal($item.find('.t-checkbox [type=hidden]').eq(1).val(), "1");
                equal($item.find('.t-checkbox [type=hidden]').eq(2).val(), "text");
            });
        </script>

        <div id="qunit-fixture">test markup, will be hidden</div>
        <ul id="log"></ul>
    </body>
</html>
